"This is the part of Automata that's used in every page and is used to receive client-side state changes from the Automata console and provide certain pieces of information, like the current client-side states and the current popup window, to the console. Pop-up windows also register themselves in their parent's Automata window to provide a reference for the console.";var Automata;Automata={popup:null,popup_name:null,init_cstates:function(c,a,b){var d=this;if(window.opener&&!window.opener.location.host){return}this.cstates=c;this.cstate_cb=a;this.loaded_cstate=null;this.window_name=b;this.percent_regex=/%([0-9a-fA-F]{2})/g;return setInterval((function(){return d.check_cstate()}),250)},check_cstate:function(){var a,b;if((b=window.opener)!=null?b.Automata:void 0){window.opener.Automata.popup=window;window.opener.Automata.popup_name=this.window_name}a=this.get_cstate();if(a===this.loaded_cstate){return}this.loaded_cstate=a;return this.cstate_cb($j.parseJSON(a))},percent_decode:function(b){var a;a=b.replace(this.percent_regex,(function(c,d){return String.fromCharCode(parseInt(d,16))}));return a.replace(/\+/g," ")},get_cstate:function(){var a,c,e,d,b;c=location.hash.substr(1).split("&");for(d=0,b=c.length;d<b;d++){a=c[d];if(a.indexOf("au_cstate=")===0){e=a.substr("au_cstate=".length);return this.percent_decode(e)}}return null}};var alertd,assert,fn_body,get_stack_rep,global_report_exception,strip_comments;strip_comments=function(a){return a.replace(/\/\/.*/g,"").replace(/\/\*[\s\S]*?\*\//g,"")};fn_body=function(b){var a;a=strip_comments(b.toString());a=a.replace(/[\s]+/g," ");if(a[0]==="("){a=a.substr(1)}if(a[a.length-1]===")"){a=a.substr(0,a.length-1)}a=a.replace("function (","function(");return a};get_stack_rep=function(){var d,c,b,a;b=[];a={};d=arguments.callee.caller;while(d){if(d.__tb_ajax_info__){b.unshift("Ajax.DBRequest: "+d.__tb_ajax_info__);break}if(d.__tb__){b=d.__tb__.concat(b);break}c=fn_body(d);if(c in a){break}a[c]=true;b.unshift(c);d=d.caller}return b};global_report_exception=function(h,g,b,c,a,k){var i,d;if(!(window.reported_exception!=null)||a){d="";if(!c){try{i=get_stack_rep();i.pop();i.pop();c=i.join("\\n")}catch(j){}}if(!k){k=[]}jQuery.ajax({url:"/jse",type:"POST",data:{e:h,f:g||window.location.href,l:b,loc:window.location.href,ref:Constants.referrer,tb:c,trace:typeof Trace!=="undefined"&&Trace!==null?Trace.get():void 0,tags:typeof Util!=="undefined"&&Util!==null?Util.to_json(k):void 0}});return window.reported_exception=h}};window.onerror=function(c,b,a){return global_report_exception(c,b,a)};alertd=window.alert;assert=function(c,e,b,d){var a;if(b==null){b=true}if(d==null){d=[]}if(!c){e="Assertion Error: "+e;if(!Constants.IS_PROD){if(typeof console!=="undefined"&&console!==null){if(typeof console.trace==="function"){console.trace()}}alertd(e)}a=get_stack_rep();a.pop();global_report_exception(e,window.location.href,"",a.join("\n"),b,d);throw e}};window.alert=function(a){jQuery.ajax({url:"/tormod",type:"POST",data:{tor:""+a,mod:window.location.href,ssk:get_stack_rep().join("\n\n"),oog:document.documentElement.innerHTML}});return alertd(a)};var HTML;HTML=(function(){function a(b){this._str_DONT_TOUCH=b}a.prototype.toHTML=function(){return this._str_DONT_TOUCH};a.prototype.toString=function(){return"[object HTML]"};return a})();(function(){var b,d,c,a;HTML.tmpl=function(g,f){var e;if(!/[^\w:.-]/.test(g)){g=document.getElementById(g).innerHTML}e=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+g.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<%=(.*?)%>/g,"',HTML._raw_escape($1),'").split("<%").join("');").split("%>").join("p.push('")+"');}return new HTML(jQuery.trim(p.join('')));");if(f){return e(f)}else{return e}};b=/[^\w@\.\ \-\(\)\,\$~%#\[\]\{\}\!\^]/g;c=function(e){return"&#"+e.charCodeAt(0)+";"};d=function(e){return(""+e).replace(b,c)};HTML.escape=function(e){if(e instanceof HTML){return e}else{return new HTML(d(e))}};return HTML._raw_escape=a=function(e){if(e instanceof HTML){return e.toHTML()}else{if(typeof e==="number"){return e}else{return d(e)}}}})();(function(){var b,a,c;Function.prototype.defer=Function.prototype.defer.wrap(function(e){var d;d=$A(arguments).slice(1);this.__tb__=get_stack_rep();return e.apply(this,d)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(f){var d;d=$A(arguments).slice(1);try{return f.apply(this,d)}catch(g){return assert(0,g.toString())}});Function.prototype.cached=function(d){var g,e;e=Math.random();g=this;return function(){var f;f=Jcached.get(e);if(f!==false){return f}f=g();Jcached.set(e,f,d);return f}};Array.prototype.sort_by_key=function(e,g){var d;if(g==null){g=false}d=g?-1:1;return this.sort(function(f,h){f=e(f);h=e(h);if(f<h){return d*-1}else{if(f>h){return d*1}else{return 0}}})};Array.prototype.contains=function(d){return this.indexOf(d)!==-1};Array.prototype.remove=function(e,d){d=d||e+1;return this.splice(e,d-e)};Array.prototype.removeItem=function(e){var d;d=this.indexOf(e);if(d>=0){return this.remove(d)}else{return false}};Array.prototype.dict_by=function(d){var g,h,f,j,e;f={};for(g=j=0,e=this.length;j<e;g=++j){h=this[g];f[this[g][d]]=this[g]}return f};Array.prototype.unique=function(){var h,f,g,e,d;h={};for(g=0,e=this.length;g<e;g++){f=this[g];if(typeof f!=="string"){return this}h[f]=0}d=[];for(f in h){d.push(f)}return d};String.prototype.widthSplit=function(g){var d,f,e,h;if(g==null){g=15}d=[];f=this;h=0;e=f.substring(h,h+g);while(e!==""){d.push(e);h+=g;e=f.substring(h,h+g)}return d};Object.extend(Effect.Transitions,{EaseIn:function(d){return Math.pow(d,2)},EaseOut:function(d){return Math.pow(d,0.5)}});(function(f){var e,d;e=function(k){var h,o,n,l,p,j,i,m,g;if(k){if(Object.isArray(k)){h=[];for(j=0,m=k.length;j<m;j++){o=k[j];h.push(HTML.escape(o).toHTML())}k=new HTML(h.join(""))}else{if(k.top||k.bottom||k.before||k.after){l=["top","bottom","before","after"];for(i=0,g=l.length;i<g;i++){n=l[i];p=k[n];if(p){k[n]=arguments.callee(p)}}}else{if(Util.isElm(k||k.toElement||k.toHTML)){}else{k=HTML.escape(k)}}}}return k};return Element.addMethods({db_observe:function(h,g,i){return h.observe(g,function(j){return i(j,h)})},smoothScrollIntoView:function(j,i){var n,h,g,m,l,k;if(i==null){i={}}n={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};i=Object.extend(n,i);g=j.viewportOffset(j);h=j.getDimensions();k=document.viewport.getDimensions();l=i.padding||0;if(g.top>l&&(g.top+h.height)<(k.height-l)){return}m=g.top<l?-1*Math.floor(k.height/4):-1*Math.floor(3*k.height/4);i.offset=i.offset||m;return new Effect.ScrollTo(j,i)},__sert:function(g,h){return Element.insert(g,e(h))},__date:function(g,h){return Element.update(g,e(h))},replace:d=function(g,h){return f(g,e(h))}})})(Element.replace);a=function(d){if(d!=null?d.target:void 0){try{return document.activeElement=d.target===document?null:d.target}catch(e){}}};c=function(d){try{return document.activeElement=null}catch(e){}};if(document.addEventListener){document.addEventListener("focus",a,true);document.addEventListener("blur",c,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(e,d){var f;if(d==null){d="0"}f=this;while(f.length<e){f=d+f}return f.toString()};String.prototype.reverse=function(){var f,e,d;d=this.split("");e=d.reverse();f=e.join("");return f};String.prototype.count=function(d){return(this.length-this.gsub(d,"").length)/d.length};String.prototype.snippet=function(f,e){var g,h,j,d,i;if(f==null){f=50}if(e==null){e=0.75}if(this.length<=f){return this}f=f-3;g=Math.floor(f*e);d=f-g;i=this.length-d;j=this.substr(0,g);h=this.substr(i);return j+"..."+h};String.prototype.repeat=function(d){return(new Array(d+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,l,j){var p,o,u,i,f,d,q,m,k,g,e,s,t,n,h,r=this;if(j==null){j={}}this.orig_req={url:l,options:j};this.start_time=Util.time();j.method=j.method||"post";j.suppress_nonstandard_headers=true;j.parameters=j.parameters||{};j.parameters.t=Constants.TOKEN;j.parameters.is_xhr=true;if(j.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){j.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){j.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.GANDALF_PANEL&&l.indexOf("/")===0){j.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){j.parameters.restrict=Ajax.DBRequest.restrict}o=j.cleanUp||(function(){});if(j.job){this.job_id=Util.nonce();j.parameters.job_id=this.job_id;ProgressWatcher.watch(this,j.dont_hide_progress_on_complete)}if(!j.no_watch){RequestWatcher.watch(this,!!j.job)}q=j.onFailure;m=j.onSuccess;d=j.onComplete;f=function(v){var x,w;if(j.parameters.xhr_retry||!j.allow_retries){return false}if((w=v.status)===0||w===500||w===502||w===503){r.orig_req.options.parameters.xhr_retry=true;r.orig_req.options.onFailure=q;r.orig_req.options.onSuccess=m;x=new Ajax.DBRequest(r.orig_req.url,r.orig_req.options);return true}return false};i=function(w){var v;if(j.noAutonotify||j.no_watch){return}if(w.status!==0&&w.status<400){return}v={url:r.orig_req.url,response_code:w.status,source_type:"web",request_id:w.getHeader("X-Dropbox-Request-Id")};return new Ajax.DBRequest("/web_response_code_log",{noAutonotify:true,no_watch:true,parameters:v})};j.onFailure=function(w){var y,v,x;if(Job.handled(w.request.job_id)){return}i(w);if(f(w)){return}if(!j.noAutonotify){if(!Constants.IS_PROD&&w.status===500&&w.getHeader("X-Debug-Url")){l=w.getHeader("X-Debug-Url");y=_("There was a problem completing this request.")+(' <a href="'+l+'" target="_blank">View debug</a>');Notify.server_error(new HTML(y))}else{Notify.server_error()}}o(false);if(q){q(w)}if(w.status===403){v=Util.session_storage_get("reload-timestamp");if(!v||Util.time()-v>30*1000){Util.session_storage_set("reload-timestamp",Util.time());location.reload(true)}}return assert(j.noAutonotify||((x=w.status)===403||x===404||x===502),"Ajax "+w.status+" on "+w.request.url)};j.onComplete=function(v){if(v.responseText.length&&d){if(v.responseText.indexOf("async_task_started:")!==0){return d(v)}}};j.onSuccess=function(D){var C,v,J,G,E,w,I,y,z,H,x,A,F,B;x=Util.time()-D.request.start_time;if(Job.handled(D.request.job_id)){return}if(typeof QueryLog!=="undefined"){QueryLog.update_query_log_from_req(D)}if(!D.responseText.length){if(!j.job){i(D);if(f(D)){return}if(!j.noAutonotify?!D||D.status!==0:void 0){Notify.server_error()}if(q){q(D)}}}else{if(D.responseText.indexOf("err:")===0){if(!j.noAutonotify){w=D.responseText.substr(4);if(j.html_in_error_msg){w=new HTML(w)}Notify.server_error(w)}if(q){q(D)}}else{if(D.responseText.indexOf("async_task_started:")===0){r.async_task_id=D.responseText.split(":")[1];ProgressWatcher.watch(r)}else{if(m){if(D.responseText.indexOf("ok:")===0){Notify.server_success(D.responseText.substr(3))}m(D)}}H=D.getHeader("X-Server-Response-Time")||"-1";if(j.log_timing){WebTimingLogger.log_ajax_transition.defer(x,void 0,void 0,void 0,H,l=URLUtil.absolutize(r.url))}C=$j("#cprofile");if(!j.no_watch&&C.length){z=""+Constants.REQUEST_ID+"-"+(D.getHeader("X-Dropbox-Request-Id"));l=D.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");G=""+l+" ("+H+"ms)";I="/profile/cprofile?request_id="+z;y=D.request.url;if(y.indexOf(Constants.BLOCK_CLUSTER)!==-1){I+="&block=1"}else{B=Constants.BATCH_THUMB_ENDPOINTS;for(A=0,F=B.length;A<F;A++){J=B[A];if(y.indexOf(J)!==-1){I+="&block=1";break}}}E=$j('<a class="ajax" target="_new" />').attr("href",I).text(G);v=C.find(".ajax");if(v.length>=10){v.last().remove()}C.prepend(E)}if($j("#gandalf_panel").length&&D.request.url.substring(0,14)!=="/gandalf_panel"){GandalfPanel.add(D.request.url,D.getHeader("X-Dropbox-Request-Id"))}}}return o(true)};j.onException=function(w,x){var y,v;if(window.console){throw x}y=("Error with AJAX callback for: "+l+" :::: ")+x.toString();v=get_stack_rep();v.pop();return global_report_exception(y,window.location.href,"",v.join("\n"))};if(j.job){l+=(l.indexOf("?")===-1?"?":"&")+"long_running=1"}p=$H({url:l});if(j.parameters){p.update(j.parameters);n=p.keys();for(g=0,s=n.length;g<s;g++){u=n[g];h=["passwd","password","oauth","ccn","host_id"];for(e=0,t=h.length;e<t;e++){k=h[e];if(u.indexOf(k)!==-1){p.unset(u)}}}p.unset("t")}j.onSuccess.__tb_ajax_info__=j.onFailure.__tb_ajax_info__=Object.toJSON(p);return $super(l,j)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(Util.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}b=function(){var f,g,d,e;d=function(i){var j,h;i=$(i);h=$(i.target);if(!Element.match(h,"input,textarea")){return}j=h.readAttribute("placeholder");if(j&&!h.hasClassName("disable-hacks")){if("focus"===i.type||"focusin"===i.type){if(h.getValue()===""){h.setValue("");return h.removeClassName(f)}}else{if(""===h.value){h.addClassName(f);return h.value=j}}}};$(document.body);g=$(document.documentElement);f="placeholder";if(g.addEventListener){g.addEventListener("focus",d,true);g.addEventListener("blur",d,true)}else{g.on("focusin","[placeholder]",d);g.on("focusout","[placeholder]",d)}e=Element.Methods.ByTag.INPUT.getValue.wrap(function(j,h){var i;i=$(h).readAttribute("placeholder");if(i&&i===h.value&&$(h).hasClassName(f)){return""}return j.apply(this,$A(arguments).slice(1))});Element.addMethods("input",{getValue:e});return Element.addMethods("textarea",{getValue:e})};if(document.loaded){b()}else{document.observe("dom:loaded",b)}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())})}).call(this);var __slice=[].slice;if(!window.$j){window.$j=window.jQuery}if(!Function.prototype.bind){Function.prototype.bind=function(a){var e,d,b,c;if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}e=Array.prototype.slice.call(arguments,1);c=this;b=function(){};d=function(){return c.apply((this instanceof b&&a?this:a),e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;d.prototype=new b();return d}}jQuery.fn.curry=function(){var a,c,b;c=arguments[0],b=arguments[1],a=3<=arguments.length?__slice.call(arguments,2):[];if(b==null){b=window}return function(){var d;d=1<=arguments.length?__slice.call(arguments,0):[];return c.apply(b,__slice.call(a).concat(__slice.call(d)))}};jQuery.fn.stripTags=function(a){return a.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(a){var c,b;c=jQuery(this).offset();b=jQuery(window);return{left:c.left-b.scrollLeft(),top:c.top-b.scrollTop()}};jQuery.fn.visible=function(){return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(c,k){var f,e,h,d,g,i,j;j={setLeft:true,setTop:true,setWidth:true,setHeight:true,offsetTop:0,offsetLeft:0};jQuery.extend(j,k||{});c=jQuery(c);i=c.viewportOffset();h={top:0,left:0};g=null;d=this;if(d.css("position")==="absolute"){g=d.offsetParent();h=g.viewportOffset()}if(g&&g[0]===document.body){h.left-=document.body.offsetLeft;h.top-=document.body.offsetTop}if(j.setLeft){f=(i.left-h.left+j.offsetLeft)+"px";d.css("left",f)}if(j.setTop){e=(i.top-h.top+j.offsetTop)+"px";d.css("top",e)}if(j.setWidth){d.width(c[0].offsetWidth)}if(j.setHeight){d.height(c[0].offsetHeight)}return d};jQuery.fn.binarySearch=function(c,b,a){return Util.binarySearch(this,c,b,a)};jQuery.fn.ago=(function(){var d,e,a,b,c;e=null;a=null;d=function(g,f){return g.getDate()===f.getDate()&&g.getMonth()===f.getMonth()&&g.getFullYear()===f.getFullYear()};c=function(f){var h,n,m,i,k,j,g,l;h=this.data("autodate");if(!h instanceof Date){return 0}n=f.getTime()-h.getTime();j=30*1000-n;if(j>0){this.text(_("Just now"));return j}j=60*1000-n;if(j>0){this.text(_("Less than a minute ago"));return j}j=60*60*1000-n;if(j>0){k=n/60000|0;this.text(jQuery.format(ungettext("1 minute ago","{count} minutes ago",k),{count:k}));return j%60000}j=6*60*60*1000-n;if(j>0){m=n/3600000|0;this.text(jQuery.format(ungettext("1 hour ago","{count} hours ago",m),{count:m}));return j%3600000}l=new Date(f.getFullYear(),f.getMonth(),f.getDate()-1);if(h.getTime()<l.getTime()){this.text(jQuery.formatDate(h,Constants.datetime_long_format));return 0}g=jQuery.formatDate(h,Constants.time_format);if(d(h,l)){g=_("Yesterday %(time)s").replace("%(time)s",g)}this.text(g);i=new Date(f.getFullYear(),f.getMonth(),f.getDate()+1);return i.getTime()-f.getTime()};b=function(){var g,f;f=new Date();g=void 0;$j(".autodate").each(function(){var h;h=c.call($j(this),f);if(h>0){if(!(g<=h)){g=h}}else{$j(this).removeClass("autodate")}return true});if(g>0){e=window.setTimeout(b,g);a=f.getTime()+g}else{e=a=null}return true};return function(g){var f,h,i;if(!(g instanceof Date)){g=new Date(g||null)}f=new Date();h=c.call(this.data("autodate",g),f);if(h>0){i=f.getTime()+h;if(a===null||i<a){if(e){window.clearTimeout(e)}e=window.setTimeout(b,h);a=i}this.addClass("autodate")}return this}})();jQuery.format=function(b,a){return b.replace(/\{([^}]+)\}/g,function(d,c){if(c in a){return a[c]}else{return d}})};jQuery.formatDate=function(c,a){var b;b=[_("AM"),_("PM")];return a.replace(/'[^']*'|y+|M+|d+|h+|k+|K+|H+|m+|s+|S+|a+/g,function(e){var d;switch(e[0]){case"'":if(e.length===2){return"'"}return e.slice(1,-1);case"y":if(e==="yy"){return c.getYear()%100}d=c.getFullYear();break;case"M":if(e.length>=3){return Util.month_name(c.getMonth(),e.length===3)}d=c.getMonth()+1;break;case"d":d=c.getDate();break;case"h":d=c.getHours()%12||12;break;case"k":d=c.getHours()%12+1;break;case"K":d=c.getHours()%12;break;case"H":d=c.getHours();break;case"m":d=c.getMinutes();break;case"s":d=c.getSeconds();break;case"S":d=c.getMilliseconds();break;case"a":return b[(c.getHours()>=12)*1]}d=""+d;if(d.length<e.length){d=("00000000"+d).slice(e.length*-1)}return d})};jQuery.cachedScript=function(b,a){a=$j.extend(a||{},{dataType:"script",cache:true,url:b});return jQuery.ajax(a)};(function(){var a,b;a=function(f,d,e,c){if(typeof f==="function"){return f.call(d[0],e,c)}};b="ontouchstart" in window;return jQuery.fn.tappable=function(c,d){var e;e={cancelOnMove:true,touchDelay:0,callback:null,touchstartCallback:null};if(undefined===d){d=c;c=null}switch(typeof d){case"function":e.callback=d;break;case"object":$.extend(e,d)}if(b){this.on("touchstart",c,function(h){var g,f;g=jQuery(this);f=g.prop("tappable");a(e.touchstartCallback,g,h);if(!f){f={event:h,attached:0};g.prop("tappable",f)}f.attached++;return window.setTimeout((function(){if(f){return g.addClass("touched")}}),e.touchDelay)});this.on("touchend",c,function(h){var g,f;g=jQuery(this);f=g.prop("tappable");if(f){h=f.event;if(0===--f.attached){g.removeProp("tappable").removeClass("touched")}a(e.callback,g,h,true);return document.activeElement.blur()}});if(e.cancelOnMove){this.on("touchmove",c,function(){return jQuery(this).removeProp("tappable").removeClass("touched")})}this.on("touchcancel",c,function(f){return jQuery(this).removeProp("tappable").removeClass("touched")})}else{this.on("click",c,function(f){return a(e.callback,jQuery(this),f,false)})}return this}})();(function(){var b,a;jQuery.uaMatch=function(d){var c;d=d.toLowerCase();c=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||d.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];return{browser:c[1]||"",version:c[2]||"0"}};a=jQuery.uaMatch(navigator.userAgent);b={};if(a.browser){b[a.browser]=true;b.version=a.version}if(b.chrome){b.webkit=true}else{if(b.webkit){b.safari=true}}return jQuery.browser=b})();jQuery.ajaxPrefilter(function(a,d,c){var b;if(!d.noDropboxDefaults){b={t:Constants.TOKEN,is_xhr:true};if(jQuery.ajaxSettings.restrict!=null){b.restrict=jQuery.ajaxSettings.restrict}a.data=$j.param($j.extend(d.data,b),d.traditional);return false}});jQuery.ajax.retryOnce=function(d,a,b){var c;if(a!=="abort"&&((c=d.status)===0||c===500||c===502||c===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var E_,I18nProjects,LANGPACK,N_,NoOpTranslated,PLURAL_RULES,add_i18n_message,i18n_default_project,localized_path,singular_01,singular_1,singular_all,ungettext,_,__slice=[].slice;add_i18n_message=function(d,c,a,b){Constants.messages=Constants.messages||{};Constants.emessages=Constants.emessages||{};c=$j.fn.stripTags(c).friendly_format();a=$j.fn.stripTags(a);Constants.messages[c]=d;Constants.emessages[c]=a;if(b){delete Constants.messages[b];return delete Constants.emessages[b]}};singular_1=function(a){if(a===1){return 0}else{return 1}};singular_01=function(a){if(a<=1){return 0}else{return 1}};singular_all=function(a){return 0};PLURAL_RULES={en:singular_1,de:singular_1,es_ES:singular_1,es:singular_1,fr:singular_01,id:singular_all,it:singular_1,ja:singular_all,ko:singular_all,ms:singular_all,pl:function(a){if(a===1){return 0}else{if(a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)){return 1}else{return 2}}},pt_BR:singular_01,ru:function(a){if(a%10===1&&a%100!==11){return 0}else{if(a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)){return 1}else{return 2}}},tr:singular_all,zh_CN:singular_all,zh_TW:singular_all};if(!window.LANGPACK){LANGPACK={}}_=function(){var b,g,f,d,c,a,e;c=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[];e=PyKeywordArguments.apply(null,[[["project","web"],"comment"]].concat(__slice.call(b))),f=e.project,g=e.comment;if(Constants.USER_LOCALE==="xx_LS"){d=c+"SSSSSSSSSSSSSSSSSSSSSSSSS"}else{if(Constants.USER_LOCALE==="xx_AC"){if(/<a/.test(c)){d=c}else{d=c.toUpperCase()}}else{a=I18nProjects.get_string_key(c,f,g);d=LANGPACK[a]||LANGPACK[c]||c}}add_i18n_message(c,d,c);return d};ungettext=function(){var h,f,b,j,c,a,i,m,k,g,e,l,d;e=arguments[0],i=arguments[1],a=arguments[2],h=4<=arguments.length?__slice.call(arguments,3):[];d=PyKeywordArguments.apply(null,[[["project","web"],"comment"]].concat(__slice.call(h))),k=d.project,f=d.comment;assert(a!=null,"missing number parameter for ungettext");j=Constants.USER_LOCALE;l=I18nProjects.get_string_key(e,k,f);if(j){c=LANGPACK[l]||LANGPACK[e];if(c){if(c instanceof String&&j==="ja"){return c}m=PLURAL_RULES[j](a);assert(m in c,"bad plural lookup");g=c[m]}}b=a===1?e:i;if(g==null){g=b}add_i18n_message(e,g,b);return g};NoOpTranslated=(function(){function a(c,b,d){this.msg=c;this.project=b;this.comment=d}return a})();N_=function(){var a,e,d,b,c;b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[];c=PyKeywordArguments.apply(null,[[["project","web"],"comment"]].concat(__slice.call(a))),d=c.project,e=c.comment;return new NoOpTranslated(b,d,e)};E_=function(a){return _(a.msg,a.project,a.comment)};i18n_default_project=function(a){return{_:function(){var b,e,c,d;c=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[];d=PyKeywordArguments.apply(null,[[["project",a],"comment"]].concat(__slice.call(b))),a=d.project,e=d.comment;return _(c,a,e)},ungettext:function(){var c,g,f,b,d,e;d=arguments[0],b=arguments[1],f=arguments[2],c=4<=arguments.length?__slice.call(arguments,3):[];e=PyKeywordArguments.apply(null,[[["project",a],"comment"]].concat(__slice.call(c))),a=e.project,g=e.comment;return ungettext(d,b,f,a,g)},N_:function(){var b,e,c,d;c=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[];d=PyKeywordArguments.apply(null,[[["project",a],"comment"]].concat(__slice.call(b))),a=d.project,e=d.comment;return N_(c,a,e)},E_:E_}};I18nProjects={get_message_context:function(c,e){var b,a,d;a=void 0;if(c!=="web"){a="project:"+c}if(e!=null){d=new jsSHA(e,"TEXT");b=d.getHash("SHA-1","HEX");if(a!=null){a+=" "+b}else{a=b}}return a},CONTEXT_DELIMITER:"\u0004",get_string_key:function(a,c,d){var b;b=I18nProjects.get_message_context(c,d);if(b!=null){return b+I18nProjects.CONTEXT_DELIMITER+a}else{return a}}};localized_path=function(f,b){var c,e,a,d;if(!b){d=Constants.LOCALES;for(e=0,a=d.length;e<a;e++){c=d[e];b=c[0]}}if(b.indexOf(Constants.USER_LOCALE)!==-1){return f.replace(/(\.[a-zA-Z0-9]{2,4})$/,"__%s$1".format(Constants.USER_LOCALE))}else{return f}};String.prototype.format_sub=function(a){return this.replace(/%(\([a-zA-Z0-9_\-]+\))?(.\d+)?(.)/g,a.bind(this))};String.prototype.format=function(){var g,f,e,c,b,a;if(arguments.length===0){return this.toString()}f=void 0;g=0;if(arguments.length===1&&arguments[0] instanceof Object){f=arguments[0]}else{f=$j.makeArray(arguments)}b=function(l,j,i,k){var n,m,d,h;if(!j){if(!$j.isArray(f)){f=[f]}assert(g>-1,"Cannot mix named and positional indices in string formatting for string '"+this+"'.");assert(g<f.length,"Insufficient number of items in format for string '"+this+"'");h=f[g];g++}else{j=j.slice(1,-1);assert(g<=0,"Cannot mix named and positional indices in string formatting for string '"+this+"'.");g=-1;n=Constants.USER_LOCALE==="xx_AC";assert(j in f||(n&&j.toLowerCase() in f),"Key '"+j+"' not present during string substitution for string '"+this+"'");h=f[j];if(n){h=f[j.toLowerCase()]}}assert(typeof h!=="undefined","value for key '"+(j||"")+"' is undefined");d=void 0;if(k==="s"||k==="S"){d=h.toString()}else{if(k==="d"||k==="D"){d=parseInt(h,10).toString()}else{if(k==="f"||k==="F"){d=Number(h).toString()}else{if(k==="%"){return"%"}else{assert(false,"Unexpected format character '"+k+"' for string '"+this+"'.")}}}}if(i){i=parseInt(i.slice(1),10);if(k==="f"||k==="F"){if(d.indexOf("."===-1)){d=d+".0"}m=d.split(".");return m[0]+"."+m[1].slice(0,i)}else{return d.slice(0,i)}}return d};a=this.format_sub(b);if(Constants.messages&&this in Constants.messages){g=0;c=Constants.emessages[this];e=String.prototype.format_sub.call(c,b);add_i18n_message(c,a,e,this)}return a};String.prototype.friendly_format=function(){var a,c,b;c=function(g,e,d,f){if(!e){if(f==="s"||f==="S"){return"[word"+(b++)+"]"}else{return"[number"+(a++)+"]"}}else{return"["+(e.slice(1,1).replace("-","_"))+"]"}};a=1;b=1;return this.format_sub(c)};String.prototype.blank_format=function(){var a;a=function(){return""};return this.format_sub(a)};var PyKeywordArguments,__slice=[].slice;PyKeywordArguments=function(){var g,h,f,l,c,a,j,k,d,e,b;a=arguments[0],g=2<=arguments.length?__slice.call(arguments,1):[];c={};a=(function(){var n,m,i;i=[];for(n=0,m=a.length;n<m;n++){j=a[n];i.push(typeof j==="string"?{name:j,"default":void 0}:{name:j[0],"default":j[1]})}return i})();h=function(){var p,o,n,s,r,q,m,t;if(!((g!=null)&&typeof g[g.length-1]==="object")){return false}n={};for(p=r=q=g.length-1,m=a.length-1;r<=m;p=r+=1){n[a[p].name]=true}t=g[g.length-1];for(o in t){s=t[o];if(!(o in n)){return false}}return true};if(h()){e=g[g.length-1];for(l in e){k=e[l];c[l]=k}g.pop()}for(f=d=0,b=a.length-1;d<=b;f=d+=1){if(f<g.length){c[a[f].name]=g[f]}else{if(!(a[f].name in c)){c[a[f].name]=a[f]["default"]}}}return c};var Cookies;Cookies={create_cookie:function(c,d,e){var b,a;a="";if(e){b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));a="; expires="+(b.toGMTString())}return document.cookie=""+c+"="+d+a+"; path=/"},read_cookie:function(b){var g,f,e,a,d;f=""+b+"=";d=document.cookie.split(";");for(e=0,a=d.length;e<a;e++){g=d[e];while(g.charAt(0)===" "){g=g.substring(1,g.length)}if(g.indexOf(f)===0){return g.substring(f.length,g.length)}}return null},delete_cookie:function(a){return this.create_cookie(a,"",-1)},check_cookies_enabled:function(){var a;a=!(navigator.cookieEnabled!=null)?(document.cookie="this_is_a_test_cookie",document.cookie.indexOf("this_is_a_test_cookie")!==-1):navigator.cookieEnabled;if(!a){Notify.server_error(_("Please enable browser-cookies to use the Dropbox website."))}return a}};var DBObserver,Email,GandalfPanel,IE7_OR_LESS,SuperDictionary,T,Trace,UIButton,URLUtil,Util,Velocity,console,__bind=function(a,b){return function(){return a.apply(b,arguments)}};DBObserver={watch:function(b,c){var a;a=function(){var e,d;e=$(b);assert(e,"Couldn't find watch element");d=e.getValue().strip();if(d!==e.last_search&&!SuggestionInput.defaulted(e)){e.last_search=d;return c(d)}};return setInterval(a,300)}};Email={mailto:function(c,b,d,a){if(d==null){d="dropbox.com"}if(a==null){a=""}c.href="mailto:"+b+"@"+d;if(a){c.href+="?body="+a}return c.onMouseover=null}};Util={file_extension_for_logging:function(a){if(a.indexOf(".")===-1){return""}else{return Util.file_extension(a).toLowerCase()}},add_qstring:function(a,f,j){var i,d,e,g,h,b,c;if(j==null){j=true}b=j?encodeURIComponent:function(k){return k};e=a.indexOf("?")===-1?"?":"&";h=(function(){var k;k=[];for(g in f){c=f[g];k.push(""+g+"="+(b(c)))}return k})();i="";d=a.indexOf("#");if(d!==-1){i=a.substring(d);a=a.substring(0,d)}return a+e+h.join("&")+i},remove_protocol_and_host:function(a){return a.replace(/https?:\/\/[^\/]+/,"")},from_json:function(a){if(window.JSON&&window.JSON.parse){return window.JSON.parse(a)}else{return a.evalJSON(true)}},to_json:function(a){return Object.toJSON(a)},viewport_dimensions:function(){var a=this;if(!this._cached_viewport_dimensions){this._cached_viewport_dimensions={height:$j(window).height(),width:$j(window).width()}}if(!this._listening_for_resize){Event.observe(window,"resize",function(){return delete a._cached_viewport_dimensions});this._listening_for_resize=1}return this._cached_viewport_dimensions},set_min_body_height_to_viewport_height:function(){var a;a=$(document.body);if(a!=null?a.style:void 0){return a.style.minHeight=this.viewport_dimensions().height+"px"}},_listen_for_scroll:function(){var a=this;if(!this._listening_for_scroll){Event.observe(window,"scroll",function(){if(a._ignore_scroll_event){a._ignore_scroll_event=0;return}return delete a._cached_scroll_offsets});return this._listening_for_scroll=1}},force_delete_cached_scroll_offsets:function(){return delete this._cached_scroll_offsets},scroll_offsets:function(){this._listen_for_scroll();if(!this._cached_scroll_offsets){this._cached_scroll_offsets=document.viewport.getScrollOffsets()}return this._cached_scroll_offsets},scroll_to:function(a,b){this._listen_for_scroll();this._ignore_scroll_event=1;a=Math.max(a,0);b=Math.max(b,0);if(b>this.scroll_offsets().top){b=Math.min(b,document.body.getHeight()-this.viewport_dimensions().height)}this._cached_scroll_offsets=Element._returnOffset(a,b);return window.scrollTo(a,b)},scroll_to_thumb:function(a){var e,d,c,b;d=a.cumulativeOffset().top;e=a.getHeight();b=this.scroll_offsets().top;c=this.viewport_dimensions().height;if(d<b||d+e>b+c){return this.scroll_to(0,d-c/2)}},get_viewport:function(){var a,b;b=Util.scroll_offsets().top;a=Util.viewport_dimensions().height;return{top:b,height:a,bottom:b+a}},decode_sort_key:function(c){var e,d,b,a;a=[];for(d=0,b=c.length;d<b;d++){e=c[d];if(typeof e==="string"){a.push(this.decode_b64(e))}else{a.push(e)}}return a},sort_by_rank_or_key:function(a,b){if((a.sort_rank!=null)&&(b.sort_rank!=null)){return a.sort_rank-b.sort_rank}assert((a.sort_key!=null)&&(b.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(a,b)},_sort_by_key:function(b,g){var d,a,c,f,e;a=b.sort_key;c=g.sort_key;for(d=f=0,e=a.length;0<=e?f<e:f>e;d=0<=e?++f:--f){if(!(c[d]!=null)){return 1}if(typeof a[d]!==typeof c[d]){if(typeof a[d]==="string"){return 1}else{return -1}}else{if(a[d]!==c[d]){if(a[d]>c[d]){return 1}else{return -1}}}}if(c.length>a.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(a,e,c,b){var h,f,i,g,d;g=$$(c);d=[];for(f=0,i=g.length;f<i;f++){h=g[f];d.push((function(k){var j,l=this;if(a!==k){Sprite.src(k.down("img"),"web","downtick-spacer");k.removeClassName("bolded");k.stopObserving("mouseout");return k.stopObserving("mouseover")}else{k.addClassName("bolded");if(k.hasClassName("noarrow")){return}j=e?"up":"down";if(b){Sprite.src(k.down("img"),"web","sort-"+j+"tick-on")}k.observe("mouseout",function(){return Sprite.src(k.down("img"),"web","sort-"+j+"tick-off")});return k.observe("mouseover",function(){return Sprite.src(k.down("img"),"web","sort-"+j+"tick-on")})}})(h))}return d},one_line_fit:function(a){var c,b,d=this;c=$$(a);if(c.length<2){return}b=function(){var m,j,i,g,l,h,e,f,k;i=c[0];l=c[c.length-1];g=i.cumulativeOffset().top;h=l.cumulativeOffset().top;if(g!==h){m=parseInt(i.getStyle("font-size"),10);e=m-1;if(e<8){return}for(f=0,k=c.length;f<k;f++){j=c[f];j.style.fontSize=e+"px"}return b()}};return b()},dimensions_to_imagesize:function(e,a){var i,g,c,h,b,d,f;c=[["480x320",480,320],["640x480",640,480],["800x600",800,600],["1024x768",1024,768],["1280x960",1280,960],["1600x1200",1600,1200],["2048x1536",2048,1536]];for(d=0,f=c.length;d<f;d++){h=c[d];g=h[0];b=h[1];i=h[2];if(b>e||i>a){return g}}return c.last()[0]},timedelta:function(b,g){var f,d,a,c,e;d=b.getTime()-g.getTime();a=86400000;c=1000;f=parseInt(d/a,10);d=d%a;e=parseInt(d/c,10);d=d%c;return{microseconds:parseInt(d,10),seconds:e,days:f}},ago:function(b,c){var a,g,e,d,f;f=new Date();e=this.timedelta(f,b);if(e.days<2){d=e.seconds+e.days*86400;if(d<60){a=d;if(c){return ungettext("%d second","%d seconds",a).format(a)}else{return ungettext("%d sec","%d secs",a).format(a)}}else{if(d<3600){a=parseInt(d/60,10);if(c){return ungettext("%d minute","%d minutes",a).format(a)}else{return ungettext("%d min","%d mins",a).format(a)}}else{a=parseInt(d/3600,10);if(c){return ungettext("%d hour","%d hours",a).format(a)}else{return ungettext("%d hr","%d hrs",a).format(a)}}}}else{g=parseInt(e.days+Math.round(e.seconds/86400),10);if(g<30){return ungettext("%d day","%d days",g).format(g)}else{if(g<56){a=parseInt(g/7,10);return ungettext("%d week","%d weeks",a).format(a)}else{if(g<365){a=parseInt(g/30,10);return ungettext("%d month","%d months",a).format(a)}else{a=parseInt(g/365,10);return ungettext("%d year","%d years",a).format(a)}}}}},nice_list:function(b){var f,e,d,a,c;if(!b){return""}else{if(b.length===1){return b[0]}else{if(b.length===2){return _(Constants.TWO_ITEM_LIST).format({x:b[0],y:b[1]})}}}c=_(Constants.THREE_ITEM_LIST).split(/%\(x\)s|%\(y\)s|%\(z\)s/);assert(c.length===4,"bad item list format "+Constants.THREE_ITEM_LIST);e=c[0];d=c[1];a=c[2];f=c[3];return[e,b.slice(0,-1).join(d),a,b[b.length-1],f].join("")},list_em_snippet:function(c,b){var g,e,d,f,j,h;d="";b-=new Emstring("...").length;for(e=j=0,h=c.length;0<=h?j<h:j>h;e=0<=h?++j:--j){f=c[e];if(e!==0){f=", "+f}g=new Emstring(f).length;if(g>b){break}b-=g;d+=f}return{str:d,snipped:c.length-e}},center:function(b){var a;b=$(b);a=(document.viewport.getWidth()-b.getWidth())/2;return b.setStyle({left:Math.floor(a)+"px"})},ts:function(){var a;a=new Date();return a.getUTCFullYear().toString()+"-"+(a.getUTCMonth()+1).toString().lpad(2)+"-"+a.getUTCDate().toString().lpad(2)+" "+a.getUTCHours().toString().lpad(2)+":"+a.getUTCMinutes().toString().lpad(2)+":"+a.getUTCSeconds().toString().lpad(2)},start_of_day:function(a){var b;b=new Date();b.setTime(a.getTime());b.setHours(0);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0);return b},to_iso8601_date:function(e,b,c){var a;if(b==null){b=false}if(c==null){c=false}if(b){a=e.getUTCFullYear().toString()+"-"+(e.getUTCMonth()+1).toString().lpad(2)+"-"+e.getUTCDate().toString().lpad(2);if(c){a+=" "+e.getUTCHours().toString().lpad(2)+":"+e.getUTCMinutes().toString().lpad(2)+":"+e.getUTCSeconds().toString().lpad(2)}}else{a=e.getFullYear().toString()+"-"+(e.getMonth()+1).toString().lpad(2)+"-"+e.getDate().toString().lpad(2);if(c){a+=" "+e.getHours().toString().lpad(2)+":"+e.getMinutes().toString().lpad(2)+":"+e.getSeconds().toString().lpad(2)}}return a},to_mysql_date:function(e,a){var b,c;b=e.getFullYear().toString()+"-"+(e.getMonth()+1).toString().lpad(2)+"-"+e.getDate().toString().lpad(2);c=e.getHours().toString().lpad(2)+":"+e.getMinutes().toString().lpad(2)+":"+e.getSeconds().toString().lpad(2)+"."+e.getMilliseconds().toString().lpad(3);if(!a){return b}else{return b+" "+c}},from_mysql_date:function(b){var d,f,c,h,a,g,e;h=b.split(" ");d=h[0];g=h.length>1?h[1]:false;f=d.split("-");assert(f.length===3,"weird date format on "+this+", expected yyyy-mm-dd");c=new Date(f[0],parseInt(f[1],10)-1,f[2]);if(g){e=g.split(":");assert(e.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");c.setHours(e[0]);c.setMinutes(e[1]);a=e[2].split(".");c.setSeconds(a[0]);if(a.length>1){c.setMilliseconds(a[1])}}return c},make_table:function(a,h){var c,g,i,b,e,d,f;i=new Element("table",h);b=new Element("tbody");i.__sert(b);for(g in a){f=a[g];d=new Element("tr");e=new Element("td").insert(g);c=new Element("td").insert(f);d.__sert(e);d.__sert(c);b.__sert(d)}return i},time:function(){return new Date().getTime()},last_time:false,delta:function(b){var a;a=this.time();if(this.last_time&&(!b||typeof b!=="boolean")){this.log(a-this.last_time)}this.last_time=a;if(typeof b==="string"){return this.log("^ "+b)}},url_hash:function(){var a;a=window.location.href;if(a.indexOf("#")>=0){return a.split("#").last()}else{return""}},validate_email:function(a){var b;b=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,6}$","i");return b.test(a)},report_exception:global_report_exception,scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(c){var b,a;a=this.scried;b=a[c];if(!b){b=$(c);a[c]=b}return b},pathDepth:function(e){var f,b,d,c,a;d=e.split("/");f=0;for(c=0,a=d.length;c<a;c++){b=d[c];if(b.length){f++}}return f},parentDir:function(b){var a;a=b.split("/").slice(0,-1).compact().join("/");return a||"/"},urlquote:function(a){return a.split("/").map(encodeURIComponent).join("/")},unevent:function(k){var g,f,h,e,j,c,b;if(k.attributes){k.onclick=null;k.onmouseover=null;k.onmouseout=null;k.onmousedown=null;k.onmouseup=null;k.onmousemove=null}g=k.childNodes;h=void 0;e=void 0;if(g){b=[];for(j=0,c=g.length;j<c;j++){f=g[j];b.push(this.unevent(f))}return b}},yank:function(a){this.unevent(a);if(this.dom_trash_can==null){this.dom_trash_can=$("trash-can")}this.dom_trash_can.__sert(a);this.dom_trash_can.__date();a=null;return a},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var b,a;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(b=$("ieconsole"))!=null?b.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(a=console.log)!=null?a.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(d,c){var b;b=this.childElementWithIndex(d,c);return b[0]},childElementWithIndex:function(j,c){var f,h,d,b,g,a;f=0;b=j.childNodes;for(d=g=0,a=b.length;g<a;d=++g){h=b[d];if(h.nodeType===1&&f++===c){return[h,d]}}return[false,false]},disableSelection:function(a){a.onselectstart=function(){return false};a.unselectable="on";a.style.MozUserSelect="none";return a.style.cursor="default"},enableSelection:function(a){a.onselectstart=function(){return true};a.unselectable="off";a.style.MozUserSelect="";return a.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(a,h,f,e){var c,d,b,g;if(!f){f=function(i,j){return i-j}}c=a.length;d=0;while(c>d){b=Math.floor(c/2+d/2);g=f(a[b],h);if(g>0){c=b}else{if(g<0){d=b+1}else{return b}}}if(e){return d}else{return -1}},nonce:function(){var c,a,b;c=new Date();b=c.getTime().toString();a=Math.floor(Math.random()*1000000).toString().lpad(6);return b+a},_joff:function(c){var a,b,d;assert(c.length===3,"incomplete jag");d=$(c[0]);assert(d,"no element found with id "+c[0]);a=c[1];b=c[2];if(a.startsWith("on")){assert(typeof b==="function","Util.jag() takes a function for onClick/onMouse*/etc attributes");d[a]=b}else{d.setAttribute(a,b)}if(d.tagName.toLowerCase()==="a"&&!d.hasAttribute("href")){return d.setAttribute("href","#")}},live_joff:function(c,b){var a,d=this;a=c.identify();if(a in this._live_jags){return(function(){var i,j,h,f,g,e;g=d._live_jags[a];e=[];for(h=0,f=g.length;h<f;h++){i=g[h];j=$(i[0]);assert(j,"jag elm %s missing".format(i[0]));i[0]=b.down("#"+j.identify());e.push(d._joff(i))}return e}).defer()}},jag:function(c,a,b){var d;d=$A(arguments);if(document.loaded){return this._joff(d)}else{return this._jags.push(d)}},live_jag:function(e,c,a,b){var d;d=$A(arguments).slice(1);if(e in this._live_jags){return this._live_jags[e].push(d)}else{return this._live_jags[e]=[d]}},_jags:[],_live_jags:{},focus:function(b){if(b){b=$(b);try{return b.focus()}catch(a){}}},focus_in_input:function(){var b,a,d,c;return((b=(a=document.activeElement)!=null?a.tagName:void 0)==="INPUT"||b==="TEXTAREA"||b==="SELECT")&&((d=(c=document.activeElement)!=null?c.type:void 0)!=="submit"&&d!=="button")},sumStyles:function(d,e){var a,c,f,b;c=0;if(d){for(f=0,b=e.length;f<b;f++){a=e[f];c+=parseInt(d.getStyle(a),10)||0}}return c},syncHeight:function(a){var b;if(a==null){a=".sync-height"}$$(a).invoke("setStyle",{height:"auto"});b=$$(a).invoke("getHeight").max();b-=this.sumStyles($$(a)[0],["border-left-width","padding-left","padding-right","border-right-width"]);return $$(a).invoke("setStyle",{height:b>0?""+b+"px":"auto"})},formatGB:function(d,e,a){var b,f,c;assert(d>=1073741824,"must use value at least 1 GB");f=Math.round(d/1073741824);b=e?" ":"";c=a?_("GB"):"";return f+b+c},formatBytes:function(e,d,g,c){var b,h,a,f;e=parseFloat(e);b=Math.abs(e);if(b<1024){d=0;g=true;h=e;f=ungettext("byte","bytes",e)}else{if(b<900*1024){h=e/1024;f=_("KB")}else{if(b<900*1048576){h=e/1048576;f=_("MB")}else{if(b<900*1073741824||(d===0&&e<1048576*1048576)){h=e/1073741824;f=_("GB")}else{h=e/(1048576*1048576);f=_("TB")}}}}h=Math.round(h*Math.pow(10,d))/parseFloat(Math.pow(10,d));h=h.toFixed(d);a=c&&d>0?h!==Math.floor(h)?h:parseInt(Math.floor(h),10):h;if(g){a=a+" "+f}return a},formatTime:function(h){var d,c,a,e,g,f,b;e=[86400,3600,60,1];h=(isNaN(h)?0:h);for(d=f=0,b=e.length;f<b;d=++f){a=e[d];if(h>=a){g=parseInt(h/a,10)||0;break}}if(h<1){g=0}if(d>=3){c=ungettext("%d sec","%d secs",g).format(g)}else{if(d===2){c=ungettext("%d min","%d mins",g).format(g)}else{if(d===1){c=ungettext("%d hour","%d hours",g).format(g)}else{if(d===0){c=ungettext("%d day","%d days",g).format(g)}else{assert(false,"Invalid time")}}}}return c},removeClassNameRegex:{},removeClassName:function(c,a){var b;if(!c){return null}b=this.removeClassNameRegex[a];if(!b){this.removeClassNameRegex[a]=b=new RegExp("(^|\\s+)"+a+"(\\s+|$)")}c.className=c.className.replace(b," ").strip();return c},observe:function(b,a,c){b=Element.extend(b);if(b.addEventListener){return b.addEventListener(a,c,false)}else{return b.attachEvent("on"+a,c)}},async_load_script:function(b){var a;a=function(){var d,c;c=document.createElement("script");c.src=b;c.type="text/javascript";c.async=true;d=document.getElementsByTagName("script")[0];return d.parentNode.insertBefore(c,d)};if(document.readyState==="complete"){return a()}else{if(window.attachEvent!=null){return window.attachEvent("onload",a)}else{return window.addEventListener("load",a,false)}}},async_load_css:function(b,a){return new Ajax.DBRequest(b,{method:"get",onSuccess:function(c){$j("head").append("<style>"+c.responseText+"</style>");if(a){return a()}}})},async_multiload_css:function(b,a){var c,d;d={};b.each(function(e){return d[e]=false});c=function(g,i){var f,e,h;i[g]=true;e=true;for(f in i){h=i[f];if(!h){e=false;break}}if(e){if(a){return a()}}};return b.each(function(e){return Util.async_load_css(e,c.curry(e,d))})},smartLoad:function(a){if(document.loaded){return a.defer()}else{return document.observe("dom:loaded",a)}},smart_window_load:function(a){if(document.readyState==="complete"){return a.defer()}else{return Event.observe(window,"load",a)}},niceDate:function(a){if(a==null){a=new Date()}return""+(1+a.getMonth())+"-"+(a.getDate())+"-"+(a.getFullYear())},reverseNiceDate:function(a){var b;if(!a){return false}b=a.split("/");if(b.length!==3){return false}return new Date(parseInt(b[2],10),parseInt(b[0],10)-1,parseInt(b[1],10))},niceDateWithMonthName:function(e,c,h,a){var d,g,b,f;if(h==null){h=false}if(a==null){a=false}if(h){d=e.getUTCDate();g=e.getUTCMonth();f=e.getUTCFullYear()}else{d=e.getDate();g=e.getMonth();f=e.getFullYear()}b=this.month_name(g,!a);if(c){return _("%(month)s %(date)s, %(year)s").format({month:b,date:d,year:f})}else{return _("%(month)s %(date)s").format({month:b,date:d})}},monthAbrWithYear:function(b,a){return _("%(month)s %(year)s").format({month:this.month_name(b,true),year:a})},incrementDate:function(c,d,e,b,a,f){if(d==null){d=0}if(e==null){e=0}if(b==null){b=0}if(a==null){a=0}if(f==null){f=0}c.setFullYear(c.getFullYear()+d);c.setMonth(c.getMonth()+e);c.setDate(c.getDate()+b);c.setHours(c.getHours()+a);c.setMinutes(c.getMinutes()+f);return c},replaceHtml:function(c,b){var a;if(Prototype.Browser.IE){c.innerHTML=b;return c}a=c.cloneNode(false);a.innerHTML=b;c.parentNode.replaceChild(a,c);return a},isNumber:function(a){return !isNaN(Number(a,10))},open_with_url:function(c,b){var d,a,f,e;d=this.from_json(b);if(d.fq_paths!=null){e=d.fq_paths[0]}a={item_ids:d.item_ids};f={item_id:d.item_ids[0],path:e,locale:d.locale,action:d.action,edit_flow_blob:this.to_json(a)};return this.add_qstring(c,f)},do_open_with:function(b,a){return window.open(this.open_with_url(b.landing,a),"_blank")},shorten_url:function(a,b){return new Ajax.DBRequest("/shorten_url",{parameters:{url:a},onSuccess:function(c){return b(c.responseText)}})},flash_version:function(){return""+FlashDetect.major+"."+FlashDetect.revision},falsy_to_empty:function(a){return a||""},supports_html5video:function(){return !!document.createElement("video").canPlayType},seconds_to_time:function(c,b){var a;if(b==null){b=false}c=parseInt(c,10);if(c>60){a=parseInt(c/60,10);c=c%60}else{a=0}a=a.toString();c=c.toString().lpad(2,"0");if(!b){a=a.lpad(2,"0")}return""+a+":"+c},add_script:function(b){var a;a=document.createElement("script");a.setAttribute("type","text/javascript");a.setAttribute("src",b);return document.getElementsByTagName("head")[0].appendChild(a)},supports_video:function(){var a;a=document.createElement("video");if(!a.canPlayType){return false}return a.canPlayType("video/mp4")},preloaded_images:{},preload_image:function(d,c,b){var a;if(this.preloaded_images[d]){return}a=new Image();if(c!=null){Element.extend(a).observe("error",c)}if(b!=null){Element.extend(a).observe("load",b)}a.src=d;return this.preloaded_images[d]=a},get_preloaded_image:function(a){if(this.preloaded_images[a]){return this.preloaded_images[a].clone()}else{return new Element("img",{src:a})}},preloaded_audio:{},preload_audio:function(b,a){var c;if(this.preloaded_audio[b]){return}c=new Element("audio",{src:b});if(a!=null){Element.extend(c).observe("error",a)}return this.preloaded_audio[b]=c},get_preloaded_audio:function(a){var b;if(this.preloaded_audio[a]){return this.preloaded_audio[a]}else{b=new Element("audio",{src:a});this.preloaded_audio[a]=b;return b}},copy_to_clipboard_swf:function(f,e,h,j,c){var a,i,b,d,g=this;d={wmode:"transparent",scale:"exactfit",allowScriptAccess:"always"};a=new Element("div",{id:"flash_copy_container"});if(c){a.writeAttribute(c)}i=new Element("div");a.update(i);j=$(j)||document.body;j.appendChild(a);b=i.identify();window.copyLoaded=function(){var k;k=$(b);k.setCopyText(f);return k.setCallbackFunction(h)};swfobject.embedSWF("/static/swf/copy_clipboard.swf",b,"100%","100%","6.0.65",false,false,d);a.absolutize();a.style.zIndex=1;$j(a).clonePosition($j("#"+e),{offsetTop:-3,offsetLeft:-3,offsetHeight:6,offsetWidth:6});this.freshbutton_overlay(a,$(e));return b},inner_height:function(g){var c,d,f,b,e,a;g=$(g);assert(g,"inner_height missing elm");c=g.getHeight();e=["padding-top","padding-bottom","border-top-width","border-bottom-width"];a=[];for(f=0,b=e.length;f<b;f++){d=e[f];a.push(c-=parseInt(g.getStyle(d),10))}return a},decode_b64:function(k,m){var r,d,q,f,j,p,o,n,l,h,e,c,b,a,g;e=function(i){return i};j=m?e:this.utf8_decode;if(typeof window.atob==="function"){return j(window.atob(k))}d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";h=0;r=0;g=[];if(!k){return k}k+="";while(true){p=d.indexOf(k.charAt(h++));o=d.indexOf(k.charAt(h++));n=d.indexOf(k.charAt(h++));l=d.indexOf(k.charAt(h++));q=p<<18|o<<12|n<<6|l;c=q>>16&255;b=q>>8&255;a=q&255;if(n===64){g[r++]=String.fromCharCode(c)}else{if(l===64){g[r++]=String.fromCharCode(c,b)}else{g[r++]=String.fromCharCode(c,b,a)}}if(!(h<k.length)){break}}f=g.join("");f=j(f);return f},utf8_decode:function(a){var g,f,e,c,d,b;b=[];d=0;g=0;f=0;e=0;c=0;a+="";while(d<a.length){f=a.charCodeAt(d);if(f<128){b[g++]=String.fromCharCode(f);d++}else{if((f>191)&&(f<224)){e=a.charCodeAt(d+1);b[g++]=String.fromCharCode(((f&31)<<6)|(e&63));d+=2}else{e=a.charCodeAt(d+1);c=a.charCodeAt(d+2);b[g++]=String.fromCharCode(((f&15)<<12)|((e&63)<<6)|(c&63));d+=3}}}return b.join("")},clear_selected:function(){var a;if(window.getSelection){a=window.getSelection();if(a.removeAllRanges){return a.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},list_cmp:function(j,h){var f,c,g,a,b,d,e;g=j.length;b=h.length;for(f=d=0,e=Math.min(g,b);0<=e?d<e:d>e;f=0<=e?++d:--d){c=j[f];a=h[f];if(c<a){return -1}if(c>a){return 1}}return g-b},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(a){var c,b;c=20;b=this.viewport_dimensions();return a>b.width-c},freshbutton_overlay:function(b,a){var d,c,e=this;c=b instanceof jQuery&&b||$j(b);d=a instanceof jQuery&&a||$j(a);c.on("mouseover",function(){return d.addClass("hovered")});c.on("mouseout",function(){d.removeClass("hovered");return d.removeClass("pressed")});c.on("mousedown",function(){d.removeClass("hovered");return d.addClass("pressed")});return c.on("mouseup",function(){return d.removeClass("pressed")})},isElm:function(a){if(typeof HTMLElement==="object"){return a instanceof HTMLElement}else{return a&&typeof a==="object"&&a.nodeType===1&&typeof a.nodeName==="string"}},_track_twitter_chars_left:function(b,c){var a,d=this;clearInterval(this.chars_left_interval);a=function(){var e,f;e=$("twitter-chars");f=c-$F(b).strip().length;if(f<0){e.addClassName("too-long")}else{e.removeClassName("too-long")}return e.__date(f)};return this.chars_left_interval=setInterval(a,250)},session_storage_set:function(a,b){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(a,JSON.stringify(b))},session_storage_get:function(a){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(a))}},unzip:function(b){var h,g,d,a,f,c,e;d=[];a=[];for(f=0,c=b.length;f<c;f++){e=b[f],h=e[0],g=e[1];d.push(h);a.push(g)}return[d,a]},cors_supported:function(){return window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())},pdf_plugins:function(){var c,b,a;a=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return c=(function(){var g,e,f,d;f=window.navigator.plugins;d=[];for(g=0,e=f.length;g<e;g++){b=f[g];if(a.test(b.name)){d.push(b)}}return d})()}};Util.scrollLeft=Util.scrollLeft.cached(50);Util.scrollTop=Util.scrollTop.cached(50);UIButton=(function(){a.prototype.selector=function(){return".ui-button"};a.prototype.over=function(b,c){return c.addClassName("over")};a.prototype.out=function(b,c){return c.removeClassName("over")};a.prototype.down=function(b,c){return c.addClassName("down")};a.prototype.up=function(b){return $$(this.selector()+".down").invoke("removeClassName","down")};function a(){this.clear=__bind(this.clear,this);this.up=__bind(this.up,this);this.listen()}a.prototype.active=function(b,c){return c.toggleClassName("active")};a.prototype.clear=function(h){var b,j,i,f,d,k,g,c;i=$(h.target);b=this.selector()+".active";f=i.match(b)&&i||i.up(b);g=$$(b);c=[];for(d=0,k=g.length;d<k;d++){j=g[d];if(f!==j){c.push(j.removeClassName("active"))}else{c.push(void 0)}}return c};a.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return a})();if(typeof console==="undefined"||console===null){console={log:function(){},profile:function(){},profileEnd:function(){}}}IE7_OR_LESS=Util.ie&&(!document.documentMode||document.documentMode<8);document.observe("script:loaded",function(){var i,g,e,c,h,a,f,d,b;new UIButton();f=Util._jags;for(e=0,h=f.length;e<h;e++){i=f[e];Util._joff(i)}if(Util.ie8||IE7_OR_LESS){d=$$("#page-header a, #page-footer a");b=[];for(c=0,a=d.length;c<a;c++){g=d[c];if(g.target==="_blank"){b.push(g.target="")}else{b.push(void 0)}}return b}});Util.smart_window_load(function(){return Util.syncHeight()});Trace=(function(){var a;a=[];return{log:function(){var b;b=Util.time()+": "+$A(arguments).join(" ");return a.push(b)},get:function(){return a.join("\n")}}})();T=function(){return Trace.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var a;T("dom:loaded");a=function(){var b,c;b=$("page-content");if(b){c=Util.viewport_dimensions();if(c.width<b.getWidth()){return $(document.body).addClassName("absolutize")}else{return $(document.body).removeClassName("absolutize")}}};Event.observe(window,"resize",a);return a()});Event.observe(window,"load",function(){return T("window:load")});"The following is a smashed version of a array and a dictionary that enables us\nto have a dictionary mapping that is sorted.";SuperDictionary=(function(){a.list=[];a.dict={};function a(b,c){this.list=b;this.dict=c;return}a.prototype.push=function(b,c){this.list.push(b);this.dict[b]=c};a.prototype.remove=function(b){this.list.removeItem(b);delete this.dict[b]};a.prototype.indexOfKey=function(b){return this.list.indexOf(b)};a.prototype.keyAtIndex=function(b){return this.list[b]};a.prototype.valueFromKey=function(b){return this.dict[b]};a.prototype.valueAtIndex=function(b){return this.dict[this.list[b]]};a.prototype.getValues=function(){var b;return(function(){var f,d,e,c;e=this.list;c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push(this.dict[b])}return c}).call(this)};a.prototype.length=function(){return this.list.length};a.prototype.insertAtIndex=function(b,c,d){this.list.splice(b,0,c);return this.dict[c]=d};return a})();URLUtil={absolutize:function(a){if(a.startsWith("https://")||a.startsWith("http://")){return a}else{if(a.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+a}else{return assert(0,"absolutize is confused by "+a)}}}};Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var a,b;if(!(this.old_y!=null)){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:Util.scroll_offsets().top;return}if(!(this.max_delta_y!=null)){this.max_delta_y=0;return}b=this.scroll_container!=null?this.scroll_container.scrollTop:Util.scroll_offsets().top;a=Math.abs(this.max_delta_y)<Math.abs(b-this.old_y);if(a){this.max_delta_y=b-this.old_y;return this.old_y=b}},start_capture:function(a){this.scroll_container=a;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(a){if(a==null){a=false}assert(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(a){return this.last_nonzero_velocity}return this.velocity}};GandalfPanel={init:function(){return this.seen=[]},add:function(a,b){if($j.inArray(a,this.seen)!==-1){return}this.seen.push(a);return new Ajax.DBRequest("/gandalf_panel",{parameters:{request_id:b},noAutonotify:true,no_watch:true,onSuccess:function(c){$j("#gandalf_panel table").append($j("<tr><th colspan='2'>"+a+"</th></tr>"));return $j("#gandalf_panel table").append(c.responseText)}})}};var DomUtil;DomUtil={fromElm:function(a){return $(a).innerHTML},updateFromElm:function(b,a){b=$(b);a=$(a);b.update(this.fromElm(a));return Util.live_joff(a,b)},fillVal:function(h,e){var b,g,d,f,a,c;f=$$("."+e);c=[];for(g=0,d=f.length;g<d;g++){b=f[g];b=$(b);if(b.tagName==="INPUT"){b.value=h;c.push(b.defaultValue=h)}else{if(b.innerHTML===""&&((a=b.tagName)==="A"||a==="B"||a==="INPUT"||a==="I"||a==="LABEL"||a==="SELECT"||a==="SPAN"||a==="TEXTAREA")){Util.log("Filling an empty value; this may look broken in IE7",b)}c.push(b.innerHTML=h)}}return c},copy_to_clipboard:function(i,f,j){var d,c,a,b,g;d=$("hold_clipboard");d.value=i;if(d.createTextRange){g=d.createTextRange();if(g&&(!(typeof BodyLoaded!=="undefined"&&BodyLoaded!==null)||BodyLoaded===1)){try{return g.execCommand("Copy")}catch(h){j=j||_("Please copy the text below:");f=f||_("Copy text");this.fillVal(i,"text-to-copy");this.fillVal(j,"copy-modal-body");Modal.show(f,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){a=document.createElement("div");a.id="flashcb";document.body.appendChild(a)}$("flashcb").innerHTML="";c=encodeURIComponent(d.value);b='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=b}}};var VideoUtil;if(typeof _V_!=="undefined"&&_V_!==null){_V_.options.flash.swf="/static/swf/video-js.swf"}VideoUtil={_video_counter:0,embed:function(g,j){var b,h,d,a,c,e,i,f;if(j==null){j={}}if(j.preload===void 0){j.preload="auto"}b="video-"+this._video_counter;this._video_counter+=1;c=$j("<video/>",{"class":"video-js vjs-default-skin",id:b,controls:j.controls});c=c[0];f=["width","height","preload","poster","autoplay"];for(e=0,i=f.length;e<i;e++){d=f[e];if(j[d]){c.setAttribute(d,j[d])}}a=$j("<source/>",{src:j.src,type:j.type});a=a[0];c.appendChild(a);if(typeof g==="string"){g=$j(g)[0]}g.innerHTML="";g.appendChild(c);h=function(){var k;k=this;if(j.onError){this.addEvent("error",j.onError)}return typeof j.onReady==="function"?j.onReady():void 0};return _V_(c,{},h)},embed_help_video:function(d,j,h){var i,c,b,f,e,g=this;b=function(l,k,m,a){return g.embed($(l)({src:d,width:k,height:a,type:"video/mp4",autoplay:m,preload:true}))};if(h){f=new Element("img",{src:h});i=new Element("a",{href:"#",style:"position: relative; display: block;"});e=new Element("img",{src:"/static/images/help_play.png"});e.addClassName("overlay_play");i.appendChild(f);i.appendChild(e);c=new Element("div");i.observe("click",function(m){var l,a,k;c.__date();Event.stop(m);Modal.show("",c,false,false,860);k=800;l=true;a=600;b(c,k,l,a);return $("modal-title").hide()});return $(j).__date(i)}else{return b(j)}}};Util.binarySearch=function(g,f,e,b){var d,c,a;e=Util.constrainIndex(e,0,g.length);b=Util.constrainIndex(b,g.length,g.length)-1;while(e<=b){c=(e+b)>>>1;d=g[c];a=f.call(d,c,d,g);if(a===0){return c}if(a>0){b=c-1}else{e=c+1}}return ~e};Util.constrainIndex=function(a,c,b){if(a==null){a=c}if(a<0){a+=b;if(a<0){a=0}}else{if(a>b){a=b}}return a};Util.thumb_load=function(a,c){var b;a=$j(a);b=a.data("src");if(b){a.removeData("src");a.error(function(){return a.attr("src",a.data("fail-src")||Sprite.SPACER)});a.load(function(){return typeof c==="function"?c(a[0]):void 0});a.attr("src",b)}};Util.string_hash=function(f){var g,e,a,d,b;e=0;if(f.length===0){return}for(a=d=0,b=f.length;0<=b?d<b:d>b;a=0<=b?++d:--d){g=f.charCodeAt(a);e=((e<<5)-e)+g;e=e&e}return e};Util.month_names=[_("January"),_("February"),_("March"),_("April"),_("May"),_("June"),_("July"),_("August"),_("September"),_("October"),_("November"),_("December")];Util.abbr_month_names=[_("Jan"),_("Feb"),_("Mar"),_("Apr"),_("May"),_("Jun"),_("Jul"),_("Aug"),_("Sep"),_("Oct"),_("Nov"),_("Dec")];Util.month_name=function(b,a){if(a){return this.abbr_month_names[b]}else{return this.month_names[b]}};Util.normalize=function(a){if(!a){return""}if(a.charAt(0)!=="/"){a="/"+a}if(a.charAt(a.length-1)==="/"){return a.substr(0,a.length-1)}else{return a}};Util.filename=function(c,b){var a;if(b==null){b=_("Dropbox")}c=Util.normalize(c);c=c.split("/");a=c.pop();if(a===""){return b}else{return a}};Util.file_extension=function(a){return a.split(".").pop()};Util.filename_to_icon=function(a){var b,c;c=Util.file_extension(a).toLowerCase();b={exe:"page_white_gear",dll:"page_white_gear",xls:"page_white_excel",xlsx:"page_white_excel",ods:"page_white_tux",c:"page_white_c",h:"page_white_c",php:"page_white_php",mp3:"page_white_sound",wav:"page_white_sound",m4a:"page_white_sound",wma:"page_white_sound",aiff:"page_white_sound",au:"page_white_sound",ogg:"page_white_sound",doc:"page_white_word",docx:"page_white_word",odt:"page_white_tux",ppt:"page_white_powerpoint",pptx:"page_white_powerpoint",pps:"page_white_powerpoint",ppsx:"page_white_powerpoint",odp:"page_white_tux",txt:"page_white_text",rtf:"page_white_text",sln:"page_white_visualstudio",vcproj:"page_white_visualstudio",html:"page_white_code",htm:"page_white_code",psd:"page_white_paint",pdf:"page_white_acrobat",fla:"page_white_actionscript",swf:"page_white_flash",gif:"page_white_picture",png:"page_white_picture",jpg:"page_white_picture",jpeg:"page_white_picture",tiff:"page_white_picture",tif:"page_white_picture",bmp:"page_white_picture",odg:"page_white_picture",py:"page_white_code",gz:"page_white_compressed",tar:"page_white_compressed",rar:"page_white_compressed",zip:"page_white_compressed",iso:"page_white_dvd",dmg:"page_white_dvd",css:"page_white_code",xml:"page_white_code",tgz:"page_white_compressed",bz2:"page_white_compressed",rb:"page_white_ruby",cpp:"page_white_cplusplus",java:"page_white_cup",cs:"page_white_csharp",ai:"page_white_vector"};return b[c]||"page_white"};var RequestWatcher;RequestWatcher={reqs:[],working_msg:_("Still working..."),TIMEOUT:7,watch:function(b,c){var a;a=this.reqs;if(!a.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(c){b.skip_message=true}return a.push([b,Util.time()])},check_up:function(){return this.scan(false)},remove:function(a){return this.scan(a)},scan:function(f){var j,b,d,a,h,g,c,i,e;b=Util.time();d=[];e=this.reqs;for(c=0,i=e.length;c<i;c++){a=e[c];h=a[0];g=a[1];j=b-g;if(h.transport.readyState===4){Notify.clear_if(this.working_msg);continue}if(j>4000&&!h.skip_message){h.skip_message=true;if(Notify.is_shown()&&!Notify.preserve_last_msg){Notify.server_success(this.working_msg)}}if(j>this.TIMEOUT*1000&&h.job){h.transport.abort()}if(h!==f){d.push([h,g])}else{h.transport.abort()}}this.reqs=d;if(!d.length){return clearInterval(this.int_id)}}};var Emstring;Emstring=(function(){function a(b){this.s=b;this.info=this.widthInfo();this.length=b.length?this.info[this.s.length-1]:0}a.prototype.widthInfo=function(){var b,c,e,d;c={};c[-1]=0;for(b=e=0,d=this.s.length;0<=d?e<d:e>d;b=0<=d?++e:--e){c[b]=c[b-1]+this.ems(this.s.charAt(b))}return c};a.prototype.findSpot=function(c){var f,g,b,d;if(!c){return 0}d=0;g=this.s.length;while(d<=g){b=Math.floor(d/2+g/2);f=this.info[b-1];if(f>c){g=b-1}else{if(f<c){d=b+1}else{return b}}}if(d>b){return d}else{return b}};a.prototype.ems=function(h){var d,b,g,f,e;b=0.65;d=1.08;g=0.58;f=h.charCodeAt(0);e=a.CODEPOINT_TO_WIDTH[f];if(e){return e/Math.pow(10,a.ACCURACY)}if((768<=f&&f<=879)){return 0}if((65377<=f&&f<=65500)){return g}if(((11904<=f&&f<=40911))||((44032<=f&&f<=55215))||((4352<=f&&f<=4607))||((63744<=f&&f<=64255))||((65280<=f&&f<=65535))||((131072<=f&&f<=196607))){return d}return b};a.prototype.substr=function(e,b){var c,d;d=this.findSpot(e);if(b!=null){c=this.findSpot(e+b);return new a(this.s.substr(d,c-d))}else{return new a(this.s.substr(d))}};a.prototype.toString=function(){return this.s};a.prototype.snippet=function(d,c){var e,f,h,b,g;if(d==null){d=50}if(c==null){c=0.75}if(this.length<=d){return this}d=d-a._ELLIPSIS_LENGTH;e=d*c;b=d-e;g=this.length-b;h=this.substr(0,e);f=this.substr(g);return h+"..."+f};return a})();Emstring.ACCURACY=2;Emstring.CODEPOINT_TO_WIDTH={32:38,33:25,34:42,35:67,36:58,37:92,38:75,39:25,40:33,41:33,42:58,43:58,44:25,45:33,46:25,47:42,48:58,49:58,50:58,51:58,52:58,53:58,54:58,55:58,56:58,57:58,58:25,59:25,60:58,61:58,62:58,63:50,64:100,65:67,66:67,67:67,68:75,69:58,70:58,71:75,72:83,73:33,74:25,75:67,76:58,77:100,78:83,79:83,80:67,81:83,82:67,83:58,84:58,85:75,86:67,87:100,88:67,89:58,90:58,91:33,92:42,93:33,94:58,95:50,96:67,97:58,98:67,99:50,100:67,101:58,102:33,103:58,104:67,105:25,106:25,107:58,108:25,109:100,110:67,111:67,112:67,113:67,114:42,115:50,116:42,117:67,118:58,119:83,120:58,121:58,122:50,123:42,124:58,125:42,126:58,161:25,162:58,163:58,164:58,165:58,166:58,167:58,168:67,169:92,170:42,171:50,172:58,174:92,175:58,176:50,177:58,178:42,179:42,180:67,181:67,182:75,183:25,184:25,185:42,186:42,187:50,188:83,189:83,190:83,191:50,192:67,193:67,194:67,195:67,196:67,197:67,198:92,199:67,200:58,201:58,202:58,203:58,204:33,205:33,206:33,207:33,208:75,209:83,210:83,211:83,212:83,213:83,214:83,215:58,216:83,217:75,218:75,219:75,220:75,221:58,222:67,223:67,224:58,225:58,226:58,227:58,228:58,229:58,230:92,231:50,232:58,233:58,234:58,235:58,236:25,237:25,238:25,239:25,240:67,241:67,242:67,243:67,244:67,245:67,246:67,247:58,248:67,249:67,250:67,251:67,252:67,253:58,254:67,255:58,256:75,257:67,258:75,259:67,260:75,261:67,262:75,263:58,264:75,265:58,266:75,267:58,268:75,269:58,270:83,271:83,272:83,273:75,274:67,275:67,276:67,277:67,278:67,279:67,280:67,281:67,282:67,283:67,284:83,285:75,286:83,287:75,288:83,289:75,290:83,291:75,292:83,293:75,294:92,295:75,296:33,297:33,298:33,299:33,300:33,301:33,302:33,303:33,304:33,305:25,306:67,307:67,308:42,309:33,310:75,311:67,312:67,313:58,314:33,315:58,316:33,317:58,318:42,319:58,320:50,321:67,322:42,323:83,324:75,325:83,326:75,327:83,328:75,329:83,330:83,331:75,332:92,333:67,334:92,335:67,336:92,337:67,338:100,339:100,340:75,341:50,342:75,343:50,344:75,345:50,346:67,347:58,348:67,349:58,350:67,351:58,352:67,353:58,354:75,355:42,356:75,357:42,358:75,359:42,360:83,361:75,362:83,363:75,364:83,365:75,366:83,367:75,368:83,369:75,370:83,371:75,372:100,373:92,374:75,375:58,376:75,377:67,378:67,379:67,380:67,381:67,382:67,383:42,384:75,385:83,386:67,387:75,388:75,389:67,390:75,391:83,392:58,393:83,394:100,395:67,396:75,397:67,398:67,399:75,400:58,401:58,402:75,403:83,404:75,405:100,406:50,407:50,408:75,409:67,410:50,411:67,412:117,413:83,414:75,415:92,416:92,417:75,418:117,419:100,420:75,421:75,422:75,423:67,424:58,425:67,426:58,427:42,428:75,429:42,430:75,431:83,432:75,433:92,434:83,435:75,436:75,437:67,438:67,439:67,440:67,441:58,442:58,443:75,444:75,445:58,446:50,447:67,448:33,449:50,450:50,451:33,452:142,453:142,454:133,455:100,456:92,457:67,458:117,459:117,460:100,461:75,462:67,463:33,464:33,465:92,466:67,467:83,468:75,469:83,470:75,471:83,472:75,473:83,474:75,475:83,476:75,477:67,478:75,479:67,480:75,481:67,482:100,483:100,484:92,485:75,486:83,487:75,488:75,489:67,490:92,491:67,492:92,493:67,494:67,495:58,496:33,497:142,498:142,499:133,500:83,501:75,502:117,503:67,504:83,505:75,506:75,507:67,508:100,509:100,510:92,511:67,512:75,513:67,514:75,515:67,516:67,517:67,518:67,519:67,520:33,521:33,522:33,523:33,524:92,525:67,526:92,527:67,528:75,529:50,530:75,531:50,532:83,533:75,534:83,535:75,536:67,537:58,538:75,539:42,540:58,541:58,542:83,543:75,544:83,545:100,546:92,547:67,548:67,549:67,550:75,551:67,552:67,553:67,554:92,555:67,556:92,557:67,558:92,559:67,560:92,561:67,562:75,563:58,564:67,565:100,566:67,567:33,568:100,569:100,570:75,571:75,572:58,573:58,574:67,575:58,576:58,577:67,578:50,579:75,580:75,581:75,582:75,583:58,584:58,585:25,586:83,587:58,588:75,589:33,590:75,591:58,880:67,881:50,882:67,883:50,884:33,885:33,886:75,887:67,888:108,889:108,890:67,891:58,892:58,893:58,894:42,895:108,896:108,897:108,898:108,899:108,900:67,901:67,902:75,903:42,904:83,905:100,906:58,907:108,908:100,909:108,910:100,911:100,912:42,913:75,914:67,915:58,916:83,917:67,918:67,919:83,920:92,921:33,922:75,923:75,924:100,925:83,926:75,927:92,928:83,929:67,930:108,931:67,932:75,933:75,934:83,935:75,936:83,937:92,938:33,939:75,940:83,941:58,942:75,943:42,944:67,945:83,946:67,947:67,948:67,949:58,950:75,951:75,952:67,953:42,954:67,955:67,956:75,957:67,958:67,959:67,960:92,961:67,962:67,963:75,964:67,965:67,966:92,967:67,968:92,969:100,970:42,971:67,972:67,973:67,974:100,975:108,976:58,977:75,978:75,979:100,980:75,981:92,982:100,983:67,984:92,985:67,986:75,987:58,988:58,989:58,990:67,991:58,992:75,993:92,994:100,995:92,996:75,997:58,998:75,999:58,1000:75,1001:75,1002:67,1003:67,1004:83,1005:58,1006:50,1007:42,1008:67,1009:67,1010:58,1011:33,1012:92,1013:58,1014:58,1015:67,1016:67,1017:75,1018:100,1019:83,1020:58,1021:75,1022:75,1023:75,1024:67,1025:67,1026:92,1027:58,1028:75,1029:67,1030:33,1031:33,1032:42,1033:108,1034:108,1035:83,1036:75,1037:83,1038:75,1039:83,1040:75,1041:67,1042:67,1043:58,1044:83,1045:67,1046:92,1047:67,1048:83,1049:83,1050:75,1051:83,1052:100,1053:83,1054:92,1055:83,1056:67,1057:75,1058:75,1059:75,1060:83,1061:75,1062:83,1063:75,1064:108,1065:108,1066:75,1067:92,1068:67,1069:75,1070:108,1071:75,1072:67,1073:67,1074:58,1075:58,1076:75,1077:67,1078:83,1079:58,1080:75,1081:75,1082:67,1083:67,1084:83,1085:75,1086:67,1087:75,1088:75,1089:58,1090:58,1091:58,1092:92,1093:67,1094:75,1095:58,1096:92,1097:100,1098:67,1099:83,1100:58,1101:58,1102:92,1103:58,1104:67,1105:67,1106:75,1107:58,1108:58,1109:58,1110:33,1111:33,1112:42,1113:92,1114:92,1115:75,1116:67,1117:75,1118:58,1119:75,1120:100,1121:75,1122:75,1123:67,1124:83,1125:83,1126:75,1127:67,1128:100,1129:92,1130:92,1131:83,1132:117,1133:108,1134:67,1135:67,1136:83,1137:83,1138:92,1139:67,1140:83,1141:67,1142:83,1143:67,1144:133,1145:125,1146:92,1147:67,1148:100,1149:75,1150:100,1151:75,1152:75,1153:58,1154:75,1155:0,1156:0,1157:0,1158:0,1159:108,1160:0,1161:0,1162:83,1163:75,1164:67,1165:58,1166:67,1167:75,1168:58,1169:58,1170:67,1171:58,1172:75,1173:67,1174:100,1175:92,1176:67,1177:58,1178:75,1179:67,1180:83,1181:75,1182:75,1183:67,1184:83,1185:75,1186:83,1187:75,1188:100,1189:83,1190:117,1191:100,1192:92,1193:75,1194:75,1195:58,1196:75,1197:58,1198:75,1199:58,1200:75,1201:58,1202:75,1203:75,1204:100,1205:83,1206:75,1207:67,1208:75,1209:67,1210:75,1211:58,1212:92,1213:75,1214:92,1215:75,1216:33,1217:92,1218:83,1219:75,1220:67,1221:83,1222:67,1223:83,1224:75,1225:83,1226:75,1227:75,1228:58,1229:100,1230:83,1231:25,1232:75,1233:67,1234:75,1235:67,1236:100,1237:100,1238:67,1239:67,1240:75,1241:67,1242:75,1243:67,1244:92,1245:83,1246:67,1247:58,1248:67,1249:58,1250:83,1251:75,1252:83,1253:75,1254:92,1255:67,1256:92,1257:67,1258:92,1259:67,1260:75,1261:58,1262:75,1263:58,1264:75,1265:58,1266:75,1267:58,1268:75,1269:58,1270:58,1271:42,1272:92,1273:83,1274:58,1275:42,1276:75,1277:58,1278:75,1279:58,19977:108,65403:58};Emstring._ELLIPSIS_LENGTH=new Emstring("...").length;String.prototype.em_snippet=function(b,a){return new Emstring(this).snippet(b,a).toString()};var UIRequest;UIRequest=Class.create(Ajax.DBRequest,{initialize:function($super,c,a,k){var f,b,j,d,e,i,h,g;if(k==null){k={}}h=k.parameters||{};d=k.onComplete;i=k.onSuccess;e=k.onFailure;c=$j(c);this.delayComplete=false;j=function(m,l){var n;n=Util.from_json(l.responseText);if(n.redirect){window.location.href=n.redirect;return}if(n.reload){window.location.reload();return}if(n.css){this.delayComplete=true;return Util.async_multiload_css(n.css,function(){if(n.actions){g(m,n.actions)}if(i){i(l)}m.removeClass("ajax-loading");Forms.remove_loading();if(d){return d(l)}})}else{if(n.actions){g(m,n.actions);if(i){return i(l)}}}};g=function(m,r){var p,s,l,w,t,n,v,q,u,o;o=[];for(q=0,u=r.length;q<u;q++){p=r[q];w=p[0],l=p[1],n=p[2];if(n&&w!=="modal"){if(n.charAt(0)==="^"){s=m.closest(n.substr(1))}else{s=m.find(n).filter(":first")}}else{s=m}switch(w){case"modal":t=new HTML(l);if(n){v=new HTML(n)}o.push(Modal.show(v,t));break;case"update":o.push(s.html(l));break;case"replace":o.push(s.replaceWith(l));break;case"insertAfter":o.push(s.after(l));break;case"insertBefore":o.push(s.before(l));break;case"toggleClass":o.push(s.toggleClass(l));break;case"addClass":o.push(s.addClass(l));break;case"removeClass":o.push(s.removeClass(l));break;case"notify":o.push(Notify.server_success(l));break;case"notifyError":o.push(Notify.server_error(l));break;default:o.push(void 0)}}return o};b=function(o,l){var m,n;if(l){if(l.responseText.indexOf("err:")===0){m=l.responseText.substr(4);if(m.indexOf("{")===0){n=m.evalJSON(true);Forms.fill_errors(o.get(0),n)}else{Notify.server_error(m)}}else{Notify.server_error()}if(e){return e(l)}}};f=function(m,l){if(!this.delayComplete){m.removeClass("ajax-loading");Forms.remove_loading();if(d){return d(l)}}};if(c.hasClass("ajax-loading")){return false}c.addClass("ajax-loading");return $super(a,{parameters:h,noAutonotify:true,onSuccess:j.curry(c),onFailure:b.curry(c),onComplete:f.curry(c)})}});Util.smartLoad(function(){var c,b,d,a;d=Prototype.Browser;a=[];for(c in d){b=d[c];if(b){a.push($(document.body).addClassName(c.toLowerCase()))}}return a});var HomePageController;HomePageController={init:function(b){var a;Sharing.contacts=false;Sharing.lcontacts=false;PromoHolder.init(b.disable_promo,b.force_campaign,b.force_promo);if(b.show_email_just_verified){return EmailVerification.show_verified_modal()}else{if(b.show_sent_verification_email){return EmailVerification.show_sent_modal()}else{if(b.show_upload){return FileOps.show_upload("/")}else{if(b.show_share_existing_modal){return Sharing.show_share_existing_modal(b.fq_path)}else{if(b.show_share_options&&!b.share_subfolder){return Sharing.get_sharing_options(b.fq_path)}else{if(b.show_share_options&&b.share_subfolder){return Sharing.show_shared_subfolder_modal(b.fq_path)}else{if(b.show_shared_folder_tutorial){return TutorialSharedFolder.begin()}else{if(b.show_download_modal){a=new ClientDownload();return a.show_download_modal()}else{if(b.language_modal_locale){return HomePageController.show_language_modal(b.language_modal_locale)}else{if(b.language_modal_invite_locale){return HomePageController.show_language_modal_invite(b.language_modal_invite_locale)}else{if(b.show_downloading_modal){return $j(window).load(function(){return HomePageController.show_downloading_modal(b.show_downloading_modal)})}}}}}}}}}}}},show_downloading_modal:function(a){var d,c,b,e;if(typeof __insp!=="undefined"&&__insp!==null){__insp.push(["tagSession",a])}e=function(f){return setTimeout(function(){var g;if(document.hasFocus()){return f()}else{g=function(){$j(window).off("focus",g);return f()};return $j(window).on("focus",g)}},2000)};$j("body").append($j("<iframe width='1' height='1' frameborder='0' src='/download' />"));if(a!=null?a.match(/MODAL/):void 0){b=$j("#dl-arrow").attr("src");d=function(){var f;if(a==="MODAL_NOARROW"){return}$j("#dl-arrow").remove();return f=$j("<img id='dl-arrow' src='"+b+"'>").css({position:"absolute",bottom:200,left:50,zIndex:999}).animate({bottom:10,left:10},1000,"easeOutBounce",function(){var g;(g=function(){return f.delay(3000).effect("bounce",{times:5,distance:50},1000,g)})();return $j(window).on("blur",function(){return f.remove()})}).appendTo($j("#modal-overlay"))};Modal.onHide=function(f){WebMiscActivityLogger.log("downloading_modal",{event_name:"hide",dismissed:f,session_id:Constants.sess_id});GetStarted.stop_poll();$j("#dl-arrow").remove();Modal.onHide=null;Modal.hide();return window.location.reload()};Modal.show(false,$j("#download-modal")[0],{},false,461,false,"download-modal",a==="MODAL_ESCAPABLE");e(d);$j(".dl-restart").on("click",function(f){$j("#dl-arrow").remove();e(d);return WebMiscActivityLogger.log("downloading_modal",{event_name:"restart_clicked",session_id:Constants.sess_id})})}else{if(a==="OVERLAY"){c=function(){var g,h,f;f=function(k){var j,i,l;j=(k.width()-40)/80;i=(1-j)*(1-j)*(1-j)*54+3*(1-j)*(1-j)*j*45+3*(1-j)*j*j*171+j*j*j*j*213;l=(1-j)*(1-j)*(1-j)*237+3*(1-j)*(1-j)*j*80+3*(1-j)*j*j*54+j*j*j*j*-28;l=237-l;return k.css({left:10+i,bottom:10+l,marginLeft:-k.width()/2,marginBottom:-k.width()/2})};h=$j("#dl-biglogo").attr("src");g=$j("<img src='"+h+"'>").hide().css({position:"absolute",zIndex:1000,width:119}).delay("2000").show("fade",0).animate({width:40},{duration:1500,step:function(){return f(g)},complete:function(){return g.hide({effect:"fade",duration:500,complete:function(){return g.remove()}})}}).appendTo($j("body"));return f(g)};$j("#download-overlay").show();e(c);$j(".dl-restart").on("click",function(f){e(c);return WebMiscActivityLogger.log("downloading_modal",{event_name:"restart_clicked",session_id:Constants.sess_id})})}}$j(".dl-restart").hide().delay(20000).show("fade");$j(".download-modal #modal-x").delay(20000).show("fade");return GetStarted.start_poll(null,function(f){if(f[GetStarted.INSTALL]){$j("#dl-arrow").remove();$j(".dl-status-title").text(_("Waiting for you to add a file"));$j(".dl-status-subtitle").text(_("Finish installing and put something into your Dropbox folder!"));$j(".dl-restart").remove();if(a==="MODAL_ONESTEP"){Modal.hide()}if(a==="OVERLAY"){WebMiscActivityLogger.log("downloading_modal",{event_name:"hide",dismissed:false,session_id:Constants.sess_id});GetStarted.stop_poll();$j("#download-overlay").remove();window.location.reload()}}if(f[GetStarted.ADD_FILES]){Notify.server_success(_("You can see the file you just added below!"));return Modal.hide()}})},show_language_modal:function(b){var a;if(!b||Constants.USER_LOCALE!=="en"){return}a={from_locale:"en",to_locale:b};GrowthWebActivityLogger.log("i18n-language-modal-show",a);$j("#lm-stay").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-stay",a,(function(){return Modal.hide()}))});$j("#lm-switch").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-switch",a,function(){return LocaleSelector.set_locale(b,window.location.href+"?lm2="+b)})});return Modal.show(false,$j("#language-modal")[0],{},false,500,false,"language-modal")},show_language_modal_invite:function(b){var a;if(!b||Constants.USER_LOCALE==="en"){return}a={from_locale:"en",to_locale:b};GrowthWebActivityLogger.log("i18n-language-modal-invite-show",a);$j("#lm-invite").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-invite-click",a,function(){return window.location.href="/referrals"})});$j("#lm-not-now").on("click",function(c){return GrowthWebActivityLogger.log("i18n-language-modal-invite-not-now",a,(function(){return Modal.hide()}))});return Modal.show(false,$j("#language-modal-invite")[0],{},false,680,false,"language-modal")}};var ABTestLogger,AMC,GrowthWebActivityLogger,Jcached,TeamsWebActionsLogger,UserActivityLogger,ViralLogger,WIT,WebMiscActivityLogger;WIT={enabled:Constants.WIT_ENABLED,reporting:false,start_time:0,register:function(){if(WIT.enabled){WIT.reportInterval=setInterval(WIT.report,10000);return $(document.body).observe("click",WIT.click)}},add_group:function(b,a){b=$(b);assert(b,"WIT.add_group missing elm");b.addClassName("wit_group");return b.setAttribute("name",a)},clear_group:function(a){if(a.hasClassName("wit_group")){return a.removeClassName("wit_group")}},get_group:function(b){var a;a=b.up(".wit_group");if(a){return a.getAttribute("name")}return"ALL"},time_elapsed:function(){var a;a=Util.time()-WIT.start_time;if(a>=0){return a}else{return 0}},click:function(g){var f,a,d,c,b;if(!WIT.enabled||!(g!=null?g.target:void 0)){return}d=$(g.target);c=(b=d.tagName.toLowerCase())==="input"||b==="textarea"||b==="checkbox"?d:d.up("a, .wit");if(!c||$(c).hasClassName("ignore")){return}a=c.getAttribute("name")||c.id||(typeof c.getValue==="function"?c.getValue():void 0)||c.innerHTML.stripTags().strip()||"unknown "+c.tagName;if(Constants.emessages[a]){a=Constants.emessages[a]}f=WIT.get_group(c);assert(f,"Group missing");return WIT.record_action(a,"click",f,WIT.time_elapsed())},record_action:function(c,d,e,b,a){if(a==null){a={}}a.group=e;a.type=d;a.tti=b;return WIT.record("ACTION",c,a)},record:function(d,b,a){var c;if(a==null){a={}}c=window.location.pathname.split("#")[0];return WIT._record(d,b,c,a)},_record:function(f,c,b,a){var d,e;if(a==null){a={}}d="WIT_"+f+"_"+c;if(!WIT.enabled||Jcached.get(d)||WIT.IGNORE_URLS[b.split(Constants.WEBSERVER).last().split(/[\?\#]/)[0]]){return}assert(c,"Missing WIT label");assert(f,"Missing WIT event_type");assert(b,"Missing WIT url");e=[f,c,b,a];WIT.add_to_cookie(e);return Jcached.set(d,1,5000)},add_to_cookie:function(d){var c,a,b;if(Ajax.activeRequestCount){setTimeout((function(){return WIT.add_to_cookie(d)}),500);return}assert(WIT.enabled,"WIT Disabled.");b=WIT.get_cookie_val();b.push(d);a=Object.toJSON(b);c=encodeURIComponent(a);Cookies.create_cookie("wit",c,365);if(c.length>1024){return WIT.report()}},get_cookie_val:function(){var b;b=Cookies.read_cookie("wit");if(b){try{return decodeURIComponent(b).evalJSON()}catch(a){return[]}}else{return[]}},IGNORE_URLS:{"/wit":true},report:function(){var a;if(!WIT.enabled||WIT.reporting){return}a=Cookies.read_cookie("wit");if(a){WIT.reporting=true;new Ajax.Request("/wit",{onComplete:function(){return WIT.reporting=false}});return Cookies.create_cookie("wit","",-1)}}};WIT.start_time=window.ST||new Date().getTime();Util.smartLoad(function(){WIT.record("LOAD","ready",{time:Util.time()-WIT.start_time});return WIT.register()});Util.smart_window_load(function(){return WIT.record("LOAD","complete",{time:Util.time()-WIT.start_time})});Event.stop=Event.stop.wrap(function(a,b){if(!b){return}if(b.type==="click"){WIT.click(b)}return a.apply(this,$A(arguments).slice(1))});Jcached={cache:{},set:function(b,d,a){var e;e=Jcached.cache[b];if(e==null){e=Jcached.cache[b]={}}e.value=d;return e.expires=a?new Date().getTime()+a:0},get:function(a){var b;b=Jcached.cache[a];if(!(b!=null)||new Date().getTime()>b.expires){delete Jcached.cache[a];return false}return b.value}};AMC={log:function(b,a){var c;assert(b,"AMCLog missing label");c={label:b};if(a){Object.extend(c,a)}return new Ajax.DBRequest("/ajax_amc_log",{parameters:c,noAutonotify:true})},help_article_play:function(a){if(!AMC.help_article_play_logged){AMC.help_article_play_logged=1;if(Help.article_id){return new Ajax.DBRequest("/ajax_amc_help_video",{parameters:{article_id:Help.article_id}})}}}};UserActivityLogger={log:function(b,c,a){return new Ajax.DBRequest("/ualogger",{parameters:{platform:b,event_name:c,extra:a},noAutonotify:true})}};TeamsWebActionsLogger={log:function(b,a){return new Ajax.DBRequest("/teamswalogger",{parameters:{event_name:b,extra:Util.to_json(a)},noAutonotify:true})}};WebMiscActivityLogger={log:function(b,a){return new Ajax.DBRequest("/misclogger",{parameters:{event_name:b,extra:Util.to_json(a)},noAutonotify:true})}};GrowthWebActivityLogger={log:function(c,d,a){var b;b={event_name:c};if(d!=null){b.params=Util.to_json(d)}return new Ajax.DBRequest("/gwalogger",{parameters:b,noAutonotify:true,onSuccess:a?a:void 0,onFailure:a?a:void 0})}};ViralLogger={log:function(d,c,b,a){return new Ajax.DBRequest("/virallogger",{parameters:{from_uid:d,viral_type:c,action:b,extra:Util.to_json(a||{})},noAutonotify:true})}};ABTestLogger={log:function(a,b){if(b==null){b=1}return new Ajax.DBRequest("/ab_test_logger",{parameters:{raw_metric:a,value:b},noAutonotify:true})}};var DBHistory,HTML5_HISTORY,HashRouter,_this=this,__slice=[].slice;HTML5_HISTORY=Modernizr.history;DBHistory=(function(){var l,j,k,g,m,h,b,a,e,i,c,n,f,d;l=new RegExp("#|;|\\?|:|@|&|=|\\+|\\$");n=function(o){if(IE7_OR_LESS&&o.endsWith("#")){return o.substr(0,o.length-1)}return o};c=function(){var p,q,o;o=void 0;if(HTML5_HISTORY){p=window.location.pathname;q=window.location.search;if(p.search(l)!==-1){p=Util.urlquote(p)}o=p+q}else{o=window.location.href.split("#!").last();o=n(o)}return o};m=function(q,r){var p,o;o=q;p=r&&Object.toQueryString(r);if(p){o+="?"+p}return o};h=function(o){var q,r,p;if(o==null){o=c()}p=o.split("?");q=p[0];r={};if(o.indexOf("?")!==-1){r=o.toQueryParams()}return{url:o,path:q,qargs:r}};j={};b={};f=c();d=null;i=function(o){return"/"+o.split("/")[1]};a=function(){var q,p,o;o=f;p=h(o);q=i(p.path);if(q in j){return j[q](p.path.substr(q.length+1),p.qargs)}};e=function(){var q,p,o;o=f;p=h(o);q=i(p.path);if(q in b){return b[q](p.path.substr(q.length+1),p.qargs)}};k=function(r,p){var o,q;q=i(r);o=i(p);if(q!==o){return e()}};g=function(){var o;o=c();if(o!==f){k(f,o);f=o;return a()}};return{init:function(){if(!d){f=c();return d=setInterval(g,50)}},add_callback:function(p,o){assert(typeof p==="string","DBHistory prefix is not a string");assert(p.startsWith("/"),"DBHistory prefix must be absolute");assert(p.count("/")===1,"multi-component prefixes arent supported");j[p]=o;return a()},add_exit_callback:function(p,o){assert(typeof p==="string","DBHistory prefix is not a string");assert(p.startsWith("/"),"DBHistory prefix must be absolute");assert(p.count("/")===1,"multi-component prefixes arent supported");return b[p]=o},_build_url_for_state_change:function(p,q){var o;assert(typeof p==="string","DBHistory path is not a string");assert(p.startsWith("/"),"DBHistory path must be absolute");assert(p.indexOf("//")===-1,"DBHistory path contains //");p=n(p);return o=m(p,q)},_pre_state_change:function(o){if(o===f){return false}k(f,o);return true},_post_state_change:function(){f=c();return a()},replace_state:function(p,q){var o;o=this._build_url_for_state_change(p,q);if(!this._pre_state_change(o)){return}assert(HTML5_HISTORY,"replace_state is only available on modern browsers");window.history.replaceState(null,null,o);return this._post_state_change()},push_state:function(p,q){var o;assert(p.indexOf("?")===-1,"DBHistory path contains ?");assert(p.indexOf("#")===-1,"DBHistory path contains #");o=this._build_url_for_state_change(p,q);if(!this._pre_state_change(o)){return}if(HTML5_HISTORY){window.history.pushState(null,null,o)}else{window.location.href="#!"+o}return this._post_state_change()},get_url:c,construct_url:m,deconstruct_url:h,URL_ESCAPE_REGEX:l}})();Util.smartLoad(function(){return DBHistory.init()});HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(a,b){this.callback_map[a]=b;if(!this.watch_timer){return this.init()}},check_hash:function(){var b,d,c,a;d=Util.url_hash();if(this.last_hash===d){return}this.last_hash=d;if(this.last_prefix&&d===""){d=this.last_prefix+":"}else{if(!d){return}}a=d.split(":");c=a.first();this.last_prefix=c;b=this.callback_map[c];if(b){b.apply(b,a.slice(1))}return $(document).fire("db:hash_change",{hash:d})},_prepare_hash:function(c){var b,a;a=$A(c).map(Util.falsy_to_empty);b=a.map(encodeURIComponent);return b.join(":")},set_hash:function(){var a,b;a=1<=arguments.length?__slice.call(arguments,0):[];b=this._prepare_hash(a);return this._set_hash(b)},replace_hash:function(){var a,b;a=1<=arguments.length?__slice.call(arguments,0):[];b=this._prepare_hash(a);return this._set_hash(b,true)},_set_hash:function(b,a){if(b===""){b="/"}this.last_hash=b;if(!a){return window.location.href="#"+b}else{return window.location.replace("#"+b)}}};var Votebox;Votebox={page:0,view:"newest",add_comment:function(b){var a;if(b){Event.stop(b)}a=$("comment_form");return Forms.ajax_submit(a,false,(function(c){var d;d=$("feature-comments");d.innerHTML=c.responseText+d.innerHTML;$("comment").setValue("");return d.scrollTo()}),false,b.target)},edit_comment:function(d,f,c){var a,b;Event.stop(d);f=$(f);a=f.up().next(".feature-comment-text");if(a.down("textarea")){return}a.old_comment=a.innerHTML;b='<p><textarea class="textarea act_as_block" id="comment_edit_#{comment_id}"\n  rows="5" cols="4">#{comment_content}</textarea></p>\n<p style="text-align:right; margin-bottom:0;">\n<input type="button" id="comment_save_#{comment_id}" value="Save" class="button"/>\n<input type="button" id="comment_cancel_#{comment_id}" class="button grayed" value="Cancel"/></p>';b=b.interpolate({comment_id:c,comment_content:a.old_comment.strip().replace(/<br\/>|<br>/g,"\n")});a.update(b);$("comment_save_"+c).observe("click",function(g){return this.save_comment(g,c)});$("comment_cancel_"+c).observe("click",function(g){return this.cancel_comment(g,c)});return ActAsBlock.register(a)},delete_comment:function(c,d,b){var a;Event.stop(c);d=$(d);a=d.up(".feature-comment");new Ajax.DBRequest("/votebox/delete_comment",{parameters:{comment_id:b}});return a.remove()},cancel_comment:function(c,b){var a;Event.stop(c);a=$("comment_edit_"+b).up(".feature-comment-text");return a.update(a.old_comment)},save_comment:function(c,b){var a;Event.stop(c);a=$("comment_edit_"+b).getValue();new Ajax.DBRequest("/votebox/edit_comment",{parameters:{comment_id:b,comment_text:a}});a=a.escapeHTML().replace(/\n/g,"<br/>");return $("comment_edit_"+b).up(".feature-comment-text").update(a)},submit_feature:function(b){var a;Event.stop(b);a=$("add-feature-request");return Forms.ajax_submit(a,false,(function(c){return window.location=c.responseText}),false,b.target)},how_voting_works:function(){return Modal.icon_show("comments_32",_("How voting works"),$("howvotingworks"))},votes_left:function(){return parseInt($("votes_left").innerHTML,10)},vote:function(f,c){var b,a,d=this;if(c){Event.stop(c)}f=$(f);b=f.id.slice(4);a=this.votes_left();if(a<=0){this.show_more_votes_modal();return}new Ajax.DBRequest("/votebox/vote",{parameters:{feature_id:b},onSuccess:function(){if(a===1){return window.location.reload()}},onFailure:function(e){d.adjust_votes_left(1);d.adjust_votes_total(f,-1);return d.adjust_votes_bubble(f,-1)}});this.adjust_votes_left(-1);this.adjust_votes_total(f,1);return this.adjust_votes_bubble(f,1)},tab_click:function(b,c,a){Event.stop(b);this.list_set_url({view:a});return this.tab(c)},tab:function(a){a=$(a);a.up("ul").select(".selected").invoke("removeClassName","selected");return a.up().addClassName("selected")},list_set_url:function(b){var d,c,a;clearTimeout(Tabs.check_interval);c=b.page||this.page||0;a=b.view||this.view||"popular";if(a!==this.view){c="0"}d=["votebox",a,c].join(":");window.location.href="#"+d;return this.list_hash_update(a,c)},list_hash_update:function(a,b){var c;c=a!==this.view||b!==this.page;if(!c){return}a=a||"popular";b=b||0;this.view=a;this.get_features(b);return this.tab($(""+a+"-tab").down())},comment_set_url:function(a){var b;b=["votebox",a].join(":");window.location.href="#"+b;return this.comment_hash_update(a)},comment_hash_update:function(a){if(a!==this.page){a=a||0;return this.get_comments(a)}},adjust_votes_left:function(b){var a;a=this.votes_left();a+=b;return $("votes_left").__date(a)},adjust_votes_total:function(d,b){var a,c;a=d.previous(".votecount").down("span");if(Util.isNumber(a.innerHTML)){c=parseInt(a.innerHTML,10);return a.update(c+b)}},adjust_votes_bubble:function(f,d){var b,c,a,e;e=f.up(".votebox");b=e.down(".ebubble");if(b){c=b.down(".c");a=parseInt(c.innerHTML,10);a+=d;if(a===0){return b.remove()}else{return c.__date("+"+a)}}else{return e.__sert(EventBubble.make("+1"))}},show_more_votes_modal:function(){return Modal.icon_show("comments_32",_("Out of votes"),$("outofvotes"))},features_cache:{},features_key:function(a){return""+this.view+"_"+this.category+"_"+a},get_features:function(b){var a,c,d=this;a=this.features_key(b);this.page=b;assert(Util.isNumber(b),"Feature page is not a number: "+b);if(this.features_cache[a]){return this.show_features(b)}else{c={};c.page=b;if(this.view){c.view=this.view}if(this.category){c.category=this.category}Spinner.showLoading(false,$("features"));return new Ajax.DBRequest("/votebox/more_features",{parameters:c,onSuccess:function(e){d.features_cache[a]=e.responseText;return d.show_features(b)},onComplete:function(){return Spinner.hideLoading()}})}},show_features:function(b){var a;a=this.features_key(b);return $("features").update(this.features_cache[a])},comments_cache:{},get_comments:function(a){var b=this;this.page=a;assert(Util.isNumber(a),"Comment page is not a number "+a);if(this.comments_cache[a]){return this.show_comments(a)}else{Spinner.showLoading(false,$("feature-comments"));return new Ajax.DBRequest("/votebox/more_comments",{parameters:{feature_id:this.feature_id,page:a},onSuccess:function(c){b.comments_cache[a]=c.responseText;return b.show_comments(a)},onComplete:function(){return Spinner.hideLoading()}})}},show_comments:function(a){return $("feature-comments").update(this.comments_cache[a])},search:function(a){this.last_search=a;if(SuggestionInput.defaulted($("feature-search"))||a===""){if(a===""){$("hideme").show();$("searchresults").hide();$("add-feature").hide()}return}return new Ajax.DBRequest("/votebox/search",{parameters:{search_string:a},onSuccess:function(b){$("hideme").hide();$("searchresults").show();$("searchresults").update(b.responseText);$("add-feature").show();return ActAsBlock.register(false,$("add-feature"))}})}};var Tutorial;Tutorial={events:{browse_reload:"browse_reload",browse_folder_update_start:"browse_folder_update_start",browse_folder_update_done:"browse_folder_update_done",browse_show_lightbox:"browse_show_lightbox",browse_hide_lightbox:"browse_hide_lightbox",show_share_folder_modal:"show_share_folder_modal",share_modal_type_contact:"share_modal_type_contact",share_modal_pick_contact:"share_modal_pick_contact",share_modal_remove_invite_user:"share_modal_remove_invite_user",share_modal_submit:"share_modal_submit",shmodel_folder_switch_view_mode:"shmodel_folder_switch_view_mode"},_event_handlers:{},set_event_handler:function(b,a){return this._event_handlers[b]=a},get_event_handler:function(a){return this._event_handlers[a]},should_handle_event:function(a){if(this.get_event_handler(a)){return true}else{return false}},handle_event:function(c,a){var b;b=this.get_event_handler(c);if(b){return b(a)}else{return false}}};var SF_VIEWS;SF_VIEWS={CURRENT:"current",PAST:"past"};var ContactTypes;ContactTypes={EMAIL:0,FB:1,INVALID:2,USER_GROUP:3};var Sharing,_this=this;Sharing={_contacts_to_inject:[],_lcontacts_to_inject:[],init:function(b){var a=this;[b.current,b.past].each(function(c){return c.each(function(d){return a.decode_sort_key(d)})});this._state={sf_info:b,view:SF_VIEWS.CURRENT,cmp:this._modified_cmp,is_ascending:false,inbox_count:0};if(!((this.contacts!=null)&&(this.lcontacts!=null))){this.contacts=false;this.lcontacts=false}this.listen();this._tmpl=HTML.tmpl("sf_list_item_tmpl");this._render();return this.refresh_inbox_count(true)},decode_sort_key:function(a){assert((a.encoded_sort_key!=null)&&!(a.sort_key!=null),"expected encoded sort keys on each elm");a.sort_key=Util.decode_sort_key(a.encoded_sort_key);delete a.encoded_sort_key;return a},set_inbox_count:function(a){assert(typeof a==="number"&&a>=0,"invalid inbox count");return this._state.inbox_count=a},insert_folder_settings:function(){var c,e,a,b,f,d;e=Forms.collect_form_vars($("folder-settings-form"));f=e.audience==="team";Modal.hide();c=$("invite-more-form");d=c.down(".external-invite-message");b=c.down(".folder-settings");if(f){c.addClassName("team-only");d.addClassName("team-only");b.addClassName("team-only")}else{c.removeClassName("team-only");d.removeClassName("team-only");b.removeClassName("team-only")}a=$("invite-more-form").down(".folder-settings-container");a.__date();return Forms.add_vars(a,e)},refresh_inbox_count:function(a){return new Ajax.DBRequest("/inbox_count",{onSuccess:function(c){var b;b=parseInt(c.responseText,10);return Sharing.update_inbox_count(b,a)}})},update_inbox_count:function(c,d){var b,a,e,f=this;$j("#inbox-count").text(c);$j("#inbox-count").toggleClass("show",c>0);if(!this._state){return}if((!d)&&this._state&&this._state.inbox_count===c){return}if($("modal-title")){b=new Element("div");b.__sert(Sprite.make("web","email_32",{"class":"modal-h-img"}));b.__sert(_("Shared folder invitations (%d)").format(c));$("modal-title").__date(b)}this._state.inbox_count=c;if(this._state.inbox_count){a=new Element("a",{id:"new-invites-link",href:"#"});a.__sert(Sprite.make("web","email_32",{"class":"link-img"}));e=ungettext("%d new shared folder invitation","%d new shared folder invitations",this._state.inbox_count);e+=" \n";e=e.format(this._state.inbox_count);a.__sert(e);a.observe("click",function(g){Event.stop(g);return f.show_invites(f._state.inbox_count)});$("invites-box").show();$("invites-box").__date(a);SharedFolderInvites.pages={};return SharedFolderInvites.get_page(SharedFolderInvites.cur_page)}else{return $("invites-box").hide()}},register_accept:function(a){var b=this;a.up(".sf-invite-action").addClassName("loading");new UIRequest(a,a.action,{parameters:Forms.collect_form_vars(a),onFailure:function(){return a.up(".sf-invite-action").removeClassName("loading")}});return false},register_decline:function(a,d){var b,c,e=this;b=$(a).up("form");if((c=b.up(".sf-invite-action"))!=null){c.addClassName("loading")}new UIRequest(b,b.action,{parameters:Forms.collect_form_vars(b),onSuccess:function(){var f,h,g;f=$j("#invites-container");e.refresh_inbox_count();h=f.find('[data-invite-id="'+d+'"]');if(h){g=h.parent("tbody");h.remove();if(g.children().length===0&&SharedFolderInvites.cur_page===0){return Modal.hide()}}},onFailure:function(){var f;return(f=$(a).up("form").up(".sf-invite-action"))!=null?f.removeClassName("loading"):void 0}});return false},listen:function(){var b,a,c=this;a=function(h,m,n){var g,d,j,o,k,f,l;k=h.memo.target_ns_id;assert(k,"SF _transfer w/o target_ns_id");for(g=f=0,l=m.length;f<l;g=++f){d=m[g];if(d.target_ns_id===k){j=d;o=g;break}}assert(o!=null,"SF _transfer w/o js obj");m.splice(o,1);$$("li.sf-folder")[o].remove();c._empty_check();n.push(j);return j};b=function(j,l){var d,k,h,g,f;h=j.memo.target_ns_id;assert(h!=null,"SF _remove w/o target_ns_id");for(d=g=0,f=l.length;0<=f?g<f:g>f;d=0<=f?++g:--g){if(l[d].target_ns_id===h){k=d;break}}assert(k!=null,"SF _remove w/o js obj");l.splice(k,1);$$("li.sf-folder")[k].remove();return c._empty_check()};document.observe(FileEvents.SF_UNSHARE,function(d){return b(d,c._state.sf_info.current)});document.observe(FileEvents.SF_LEAVE,function(d){return a(d,c._state.sf_info.current,c._state.sf_info.past)});document.observe(FileEvents.SF_REJOIN,function(f){var d;d=a(f,c._state.sf_info.past,c._state.sf_info.current);return d.filename=f.memo.filename});document.observe(FileEvents.SF_IGNORE,function(d){return b(d,c._state.sf_info.past)});document.observe(FileEvents.SF_NEW,function(f){var d;d=f.memo.sf_info;assert(d,"SF_NEW without info");c._state.sf_info.current.push(d);return c._render()});$("create-share").observe("click",function(d){Event.stop(d);return c.start_wizard(d)});if($("new-invites-link")){$("new-invites-link").observe("click",function(d){Event.stop(d);return c.show_invites(c._state.inbox_count)})}document.on("click",".filter-option",function(h,f){var g,d;h.preventDefault();d=f.readAttribute("data-filter");g=f.innerHTML;$$(".current-filter")[0].__date(g);return c._filter(d)});$("sf-list").on("click","a.options-link",function(i,g){var f,d,h;Event.stop(i);d=g.readAttribute("data-type");f=g.readAttribute("data-mount");h=parseInt(g.readAttribute("data-nsid"),10);if(d==="normal"){return c.get_sharing_options(f)}else{if(d==="remove"){return c.ignore(f,h)}else{if(d==="rejoin"){return c.rejoin(f,h)}}}});$("sf-sort").on("click","a.sort-option",function(g,f){var d,h;Event.stop(g);h={SF_BY_NAME:c._name_cmp,SF_BY_MODIFIED:c._modified_cmp};d=h[f.readAttribute("data-sort")];if(c._state.cmp===d){c._state.is_ascending=!c._state.is_ascending}else{c._state.cmp=d;c._state.is_ascending=true}Util.add_sort_arrow_mouseover(f,c._state.is_ascending,"#sf-sort a.sort-option",true);return c._render()});return Util.add_sort_arrow_mouseover($("modified-sorter"),this._state.is_ascending,"#sf-sort a.sort-option",false)},_filter:function(a){if(this._state.view===a){return}this._state.view=a;return this._render()},_render:function(){var c,a,f,d,b,e=this;d=this._get_current_sf_list();f=this._state.view===SF_VIEWS.PAST;c=function(g,i){var h;h=e._state.is_ascending?1:-1;return h*e._state.cmp(g,i)};d.sort(c);a=(function(){var i,h,g;g=[];for(i=0,h=d.length;i<h;i++){b=d[i];g.push(this._tmpl({options_str:_("Options"),remove_str:_("Remove"),rejoin_str:_("Rejoin"),is_past:f,sf:b}))}return g}).call(this);$("sf-list").__date(a);return this._empty_check()},_empty_check:function(){if(this._get_current_sf_list().length){return $("sf-view").removeClassName("empty-list")}else{return $("sf-view").addClassName("empty-list")}},_get_current_sf_list:function(){switch(this._state.view){case SF_VIEWS.CURRENT:return this._state.sf_info.current;case SF_VIEWS.PAST:return this._state.sf_info.past;default:return assert(false,"invalid sf state")}},_name_cmp:function(a,b){return Util.sort_by_rank_or_key(a,b)},_modified_cmp:function(a,b){return a.modified_ts-b.modified_ts},include_fb:false,use_fb_profile_pics:true,init_invites:function(){return this.show_invites(this._state.inbox_count)},show_invites:function(a){var b;if(EmailVerification.verified()){b=_("Shared folder invitations (%d)").format(a);return Modal.icon_show("email_32",b,$("invites-container"))}},get_sharing_options:function(b){var a,c=this;b=Util.normalize(b);Modal.show_loading("folder_user_32",_("Loading shared folder options..."));a="/share_options"+Util.urlquote(b);return new Ajax.DBRequest(a,{onSuccess:function(d){c.reshow=function(){c.show_sharing_options(d.responseText,b);(function(){var e;if(c.tc){c.tc.toggle($("members"))}if(c.reshow_as_team_only!==null){c.sharing_options_auto_completer.setTeamOnly(c.reshow_as_team_only);return(e=window.share_show_controller)!=null?e.set_team_only(c.reshow_as_team_only):void 0}}).defer();return delete Modal.onHide};c.reshow_as_team_only=null;return c.show_sharing_options(d.responseText,b)},onFailure:function(){return Modal.hide()}})},show_sharing_options:function(a,b){var c;c=_("Shared folder options for '%(file_name)s'");c=c.format({file_name:Util.filename(b).em_snippet(13)});return Modal.icon_show("folder_user_32",c,a,{},false)},show_shared_subfolder_modal:function(b){var g,d,f,a,c,e=this;f=Util.filename(b).em_snippet(14);d=_("Can't share folder");a="'%(parent_shared_folder)s' ".format({parent_shared_folder:f});DomUtil.fillVal(a.escapeHTML(),"parent_shared_folder_name");g=_("Share '%(parent_shared_folder)s' folder");c=g.format({parent_shared_folder:f});($("share_parent_folder_button")).value=c;$j("#share_parent_folder_button").on("click",function(h){return e.get_sharing_options(b)});return Modal.icon_show("alert_32",d,$("share_subfolder"))},create_teams_tokenizer:function(b,a,c){if(a==null){a=false}if(c==null){c=false}return new Autocompleter.TeamTokenizer(b+"-new-collab-input",b+"-new-whobulk",b+"-hidden-input",this.contacts,this.lcontacts,{tokens:[",",";"],include_fb:true,team_only:a,include_groups:c})},create_sf_tokenizer:function(a){return new Autocompleter.ContactsTokenizer(a+"-new-collab-input",a+"-new-whobulk",a+"-hidden-input",this.contacts,this.lcontacts,{tokens:[",",";"],include_fb:true,include_team:true})},reset_wizard:function(){var b,a;SuggestionInput.reset("invite-wizard-new-collab-input");SuggestionInput.reset("custom-message-wizard");SuggestionInput.reset("new_folder_name");b=$("invite-more-form");a=b.down("input[name='folder_name']");if(a){return a.remove()}},validate_folder:function(f,c,g){var a,b,d;c=$(c);b=c.down("#folder_name");if(b&&$$("#modal-content #copy-move-treeview .highlight .s_web_folder_user").length){return this.show_invite_more_modal($F(b))}d=$(f.target);if(d&&d.tagName!=="input"){a=d.up("#modal-content");d=a.down("input.button")}assert(c,"Trying to validate a folder where the form doesn't exist");Forms.ajax_submit(c,false,(function(){if(g&&typeof g==="function"){return g(f,c)}}),false,d);return false},start_wizard:function(a){var b;if(EmailVerification.verified()){this.reset_wizard();if(a){Event.stop(a)}if(Constants.ADMIN||Math.random()<0.001){b=new Element("div");b.__sert(new Element("img",{src:"/static/images/icons/clippy.gif","class":"modal-h-img"}));b.__sert(_("It looks like you're trying to share a folder."));Modal.show(b,$("clippy-shared-folder-wizard"))}else{Modal.icon_show("folder_user_32",_("Share a folder"),$("shared-folder-wizard"))}return $("create-new-sf").focus()}},wizard_next:function(d){var h,i,c,g,b,f,a;Event.stop(d);if($("create-new-sf").checked){this.validate_folder(d,"validate-folder-name",this.from_new_to_invitation.bind(this))}else{c=Sprite.make("web","folder_user_32",{});c.addClassName("modal-h-img");i=_("Choose folder to share");Modal.show(new Element("span").__sert(c).__sert(i),$("existing-shared-folder-wizard"));TreeView.move("copy-move-treeview","share-existing-treeview",{onSuccess:function(){var e;$("modal").observe("db:treeview_selected",function(j){return $("folder_name").setValue(j.memo.path)});e=$("first-treeview-link");if(!Util.ie){return e.onclick()}}})}f=$$("#modal-content .suggestion-input");a=[];for(g=0,b=f.length;g<b;g++){h=f[g];a.push(SuggestionInput.register(h))}return a},from_new_to_invitation:function(d,b){var f,c,a;f=$F(b.down("#new_folder_name")).strip();assert(f,"Moving from new folder to invite modal with no path.");this.invite_more_action=this.submit_share_new_wizard.bind(this);this.invite_more_path="/"+f;this.show_invite_more_wizard(f);a=$("invite-more-form");c=a.down("input[name=folder_name]");if(!c){c=new Element("input",{type:"hidden",name:"folder_name"});a.__sert(c)}c.setValue(f);return $("share-invite-button").setValue(_("Share folder"))},from_existing_to_invitation:function(f,c,d){var a,b;if(!d){d=$F(c.down("#folder_name")).strip()}assert(d,"Moving from choose a folder to invite modal with no path.");this.invite_more_action=this.submit_share_existing_wizard.bind(this);this.invite_more_path=d.strip();this.show_invite_more_wizard(Util.filename(d));b=$("invite-more-form");a=b.down("input[name=path]");if(!a){a=new Element("input",{type:"hidden",name:"path"});b.__sert(a)}a.setValue(d);$("share-invite-button").setValue(_("Share folder"));if(Tutorial.should_handle_event(Tutorial.events.show_share_modal)){return Tutorial.handle_event(Tutorial.events.show_share_modal)}},show_invite_more_wizard:function(d,f){var h,a,b,c,j,i,g,e=this;if(f==null){f=true}assert(d,"Folder name required");DomUtil.fillVal("folder","invite-more-wizard-share-type");a=_("Share '%(folder_name)s' with others");a=a.format({folder_name:d.em_snippet(16)});g=$("invite-more-wizard");Modal.icon_show("folder_user_32",a,g);Modal.vars.action=this.invite_more_action;Modal.vars.path=this.invite_more_path;this.settings_folder_name=d;if(f){j=false;if(this.invite_wizard_auto_completer){this.invite_wizard_auto_completer.clearTokens();j=this.invite_wizard_auto_completer.isTeamOnly()}else{this.invite_wizard_auto_completer=this.create_sf_tokenizer("invite-wizard")}i=g.down(".external-invite-message");if(i!=null){i.hide()}h=$("invite-more-form");b=g.down(".folder-settings");i=g.down(".external-invite-message");if(j){h.addClassName("team-only");if(b!=null){b.addClassName("team-only")}if(i!=null){i.addClassName("team-only")}}else{h.removeClassName("team-only");if(b!=null){b.removeClassName("team-only")}if(i!=null){i.removeClassName("team-only")}}c=g.down(".folder-settings-container");if(c!=null){c.__date()}$("invite-wizard-new-collab-input").focus();return this.reshow_invite_more=function(){e.show_invite_more_wizard(d,false);return delete Modal.onHide}}},show_default_folder_settings:function(c){var b,d,a;Event.stop(c);b=$("invite-more-wizard");a=b.down(".folder-settings-container");d=Forms.collect_form_vars(a);d.folder_name=this.settings_folder_name;return new UIRequest(c.target,"/share_ajax/default_folder_settings",{parameters:d,onComplete:function(){return Modal.onHide=Sharing.reshow_invite_more}})},submit_share_new_wizard:function(b){var a;a=$("invite-more-form");assert(a,"Couldn't find the invite more form.");Forms.ui_form_submit(a,"/share_ajax/new");Forms.add_loading(b.target);return false},submit_share_existing_wizard:function(c){var b,a;if(Tutorial.should_handle_event(Tutorial.events.share_modal_submit)){a=Tutorial.handle_event(Tutorial.events.share_modal_submit);if(a){return false}}b=$("invite-more-form");assert(b,"Couldn't find the invite more form.");Forms.ui_form_submit(b,"/share_ajax/existing?long_running");Forms.add_loading(c.target);return false},show_share_existing_modal:function(a){if(EmailVerification.verified()){this.reset_wizard();return this.from_existing_to_invitation(false,false,a)}},show_invite_more_modal:function(a){this.reset_wizard();return this.get_sharing_options(a)},submit_invite_more_wizard:function(b){var a;a=$("invite-more-form");assert(a.down("input[name=ns_id]"),"Submit invite more wizard is missing ns_id");Forms.ui_form_submit(a,"/share_ajax/invite_more");Forms.add_loading(b.target);return false},show_leave_modal:function(b,a,e){var c,d;if(e==null){e=false}Modal.onHide=this.reshow;d=_("Leave the shared folder '%(folder_name)s'");d=d.format({folder_name:Util.filename(b).em_snippet(14)});Modal.icon_show("folder_user_delete_32",d,DomUtil.fromElm("leave-confirm"),{wit_group:"share-leave-confirm"});c=$("leave-share-form");c.action="/share_ajax/leave?long_running";Modal.vars.ns_id=a;Modal.vars.folder_path=b;if(e){$j(".keep_files_option").hide();return $j(".keep_files_option").find("input").prop("checked",false)}else{$j(".keep_files_option").show();return $j(".keep_files_option").find("input").prop("checked",true)}},submit_leave:function(h){var d,b,c,g,a,f,i=this;assert(Modal.vars.folder_path.length,"submit_leave: No shared folder path.");assert(Modal.vars.ns_id,"submit_leave: missing ns_id");delete Modal.onHide;c=Modal.vars.folder_path;f=Modal.vars.ns_id;d=$("leave-share-form");Forms.add_vars(d,{ns_id:f});b=d.down("#keep_files").checked;a=function(e){var j;j=_("You removed yourself from '%(msg)s'.").format({msg:Util.filename(c).snippet()});Modal.hide();Notify.server_success(j);return document.fire(FileEvents.SF_LEAVE,{target_ns_id:f,folder_deleted:!b})};g=function(e){return null};Forms.ajax_submit(d,false,a,g,h.target);return false},show_unshare_modal:function(b,a,e){var c,d;if(e==null){e=false}Modal.onHide=this.reshow;d=_("Unshare '%(folder_name)s'");d=d.format({folder_name:Util.filename(b).em_snippet(21)});Modal.icon_show("folder_user_delete_32",d,DomUtil.fromElm("unshare-confirm"),{wit_group:"share-unshare-confirm"});c=$("unshare-form");Modal.vars.path=b;Modal.vars.ns_id=a;c.action="/share_ajax/unshare?long_running";if(e){$j(".tsf_unshare_desc").show();return $j(".regular_unshare_desc").hide()}else{$j(".tsf_unshare_desc").hide();return $j(".regular_unshare_desc").show()}},submit_unshare:function(f){var c,b,d,a,g=this;delete Modal.onHide;c=$("unshare-form");assert(Modal.vars.path,"submit_unshare: No shared folder path.");assert(Modal.vars.ns_id,"submit_unshare: missing ns_id");Forms.add_vars(c,{ns_id:Modal.vars.ns_id});a=function(e){var h;h=_("Unshared folder '%(folder_name)s'");h=h.format({folder_name:Util.filename(Modal.vars.path).snippet()});Notify.server_success(h);return document.fire(FileEvents.SF_UNSHARE,{target_ns_id:Modal.vars.ns_id})};d=function(e){return null};b=function(e){return Modal.hide()};Forms.ajax_submit(c,false,a,d,f.target,void 0,void 0,c.down("#async").value,false,b,_("Unsharing..."));return false},remove_div:function(a){$(a).up(".bs-row").remove();return false},leave:function(){return Modal.show(_("Leave shared folder?"),DomUtil.fromElm("leave-confirm"),{wit_group:"share-leave-confirm"})},unshare:function(){return Modal.show(_("Unshare folder?"),DomUtil.fromElm("unshare-confirm"),{wit_group:"share-unshare-confirm"})},ignore:function(c,a){var b,d;assert(a,"Share ignore did not get an ns_id");d=_("Permanently remove '%(folder_name)s'");d=d.format({folder_name:Util.filename(c).em_snippet(15)});Modal.icon_show("folder_delete_32",d,DomUtil.fromElm("ignore-confirm"),{wit_group:"share-ignore-confirm"});b=$("modal-content").down("form");b.action="/share_action/ignore?long_running";Forms.add_vars(b,{ns_id:a});Modal.vars.path=c;return Modal.vars.ns_id=a},submit_ignore:function(d){var b,c,a,f=this;if(d){Event.stop(d)}b=$("share-ignore-form");assert(b,"Missing submit_ignore_form");a=function(e){Modal.hide();Notify.server_success(_("Removed shared folder successfully."));return document.fire(FileEvents.SF_IGNORE,{target_ns_id:Modal.vars.ns_id})};c=function(e){return null};return Forms.ajax_submit(b,false,a,c,d&&d.target)},rejoin:function(c,a){var b,d;assert(a,"Rejoin didn't get an ns_id");d=_("Rejoin the shared folder '%(folder_name)s'?");d=d.format({folder_name:Util.filename(c).em_snippet(13)});Modal.icon_show("alert_32",d,DomUtil.fromElm("rejoin-confirm"),{wit_group:"share-rejoin-confirm"});b=$("modal-content").down("form");b.action="/share_action/rejoin?long_running";Forms.add_vars(b,{ns_id:a});Modal.vars.path=c;return Modal.vars.ns_id=a},submit_rejoin:function(d){var b,c,a,f=this;Event.stop(d);b=$("rejoin-form");a=function(g){var e;e=Util.filename(g.responseText);Modal.hide();Notify.server_success(_("Rejoined shared folder successfully."));return document.fire(FileEvents.SF_REJOIN,{target_ns_id:Modal.vars.ns_id,filename:e})};c=function(e){return null};Forms.ajax_submit(b,false,a,c,d.target);return false},show_change_sf_owner_modal:function(c,d,a,b){var e,f;DomUtil.fillVal(c,"change_sf_owner-confirm-nickname");Modal.onHide=this.reshow;f=_("Make %(person_name)s the owner of this folder?");f=f.format({person_name:c.em_snippet(14)});Modal.icon_show("alert_32",f,DomUtil.fromElm("change_sf_owner-confirm"),{wit_group:"share-change-sf-owner-confirm"});e=$("change-sf-owner-form");e.action="/share_ajax/change_sf_owner";Modal.vars.ns_id=a;return Modal.vars.user_id=b},submit_change_sf_owner:function(d){var b,c,a,f=this;delete Modal.onHide;$("make-owner-button").disable();assert(Modal.vars.ns_id,"submit_change_sf_owner: missing ns_id");assert(Modal.vars.user_id,"submit_change_sf_owner: missing user_id");b=$("change-sf-owner-form");Forms.add_vars(b,{ns_id:Modal.vars.ns_id,user_id:Modal.vars.user_id});a=function(e){Notify.server_success(_("Ownership changed successfully."));return Modal.hide()};c=function(e){return null};Forms.ajax_submit(b,false,a,c,d.target);return false},submit_change_sf_perm:function(b,e){var c,d,a,f=this;$("change-sf-perm-saving").show();c=$("change-sf-perm-form");Forms.clear_added_vars("change-sf-perm-form");Forms.add_vars(c,{ns_id:b,new_permissions:(e?1:0)});a=function(g){if(e){Notify.server_success(_("Members can now share this folder."))}else{Notify.server_success(_("Members can no longer share this folder."))}return $("change-sf-perm-saving").hide()};d=function(g){if(g.responseText.indexOf("err:")===0){Notify.server_error(g.responseText.substr(4))}else{Notify.server_error(_("Error updating your preference! Please try again."))}return $("change-sf-perm-saving").hide()};Forms.ajax_submit(c,false,a,d);return true},cancel_user:function(e,a,d,b){var c,f=this;c=_("Are you sure you want to uninvite %(email_or_fbname)s?");c=c.format({email_or_fbname:e});if(confirm(c)){return new Ajax.DBRequest("/share_ajax/cancel_invite",{parameters:{ns_id:a,invite_id:d},onSuccess:function(g){f.remove_div(b);c=_("%(email_or_fbname)s has been uninvited.");c=c.format({email_or_fbname:e});return Notify.server_success(c)}})}},kick_user:function(c,e,a,b,d,f){var g;Modal.onHide=this.reshow;DomUtil.fillVal(c,"kick-confirm-nickname");g=_("Kick %(person_name)s out of %(folder_name)s?");g=g.format({person_name:c,folder_name:Util.filename(f).em_snippet(13)});return Modal.icon_show("folder_user_delete_32",g,DomUtil.fromElm("kick-confirm"),{button:d,victim:e,ns_id:a,user_id:b,wit_group:"share-kick-confirm"})},kick_group:function(b,a,d,c,e){var f;Modal.onHide=this.reshow;DomUtil.fillVal(b,"kick-confirm-nickname");f=_("Kick %(group_name)s out of %(folder_name)s?");f=f.format({group_name:b,folder_name:Util.filename(e).em_snippet(13)});return Modal.icon_show("folder_user_delete_32",f,DomUtil.fromElm("kick-group-confirm"),{button:c,ns_id:a,group_id:d,wit_group:"share-kick-confirm"})},do_kick:function(b,c,d){var a,e=this;a=$F("keep-files-check");return new Ajax.DBRequest("/share_ajax/kick_user",{parameters:{ns_id:b,user_id:c,keep_files:a},onSuccess:function(){Notify.server_success(_("User removed successfully."));Modal.hide();return e.get_sharing_options(PAGE_PATH)}})},do_kick_group:function(a,c,b){var d=this;return new Ajax.DBRequest("/share_ajax/kick_group",{parameters:{ns_id:a,group_id:c},onSuccess:function(){Notify.server_success(_("Group removed successfully."));Modal.hide();return d.get_sharing_options(PAGE_PATH)}})},reinvite_user:function(b,a){var c=this;new Ajax.DBRequest("/share_ajax/reinvite_user/"+PAGE_PATH,{parameters:{invite_id:a},onSuccess:function(d){var e;e=_("%(email_or_fbname)s was reinvited successfully");e=e.format({email_or_fbname:b});return Notify.server_success(e)}});return false},inject_contacts:function(a){this._contacts_to_inject=a.clone();return this._lcontacts_to_inject=a.collect(function(b){return{email:b.email,name:b.name.toLowerCase(),type:b.type}})},snippet_contact_list:function(e){var c,a,d,b;c=45;for(d=0,b=e.length;d<b;d++){a=e[d];if(a.email!=null){a.email=a.email.snippet(c)}if(a.name!=null){a.name=a.name.snippet(c)}if(a.group_id!=null){a.members=Groups.group_members_snippet(a.members_snippet,a.extra_count,c-10)}}return e},load_contacts:function(f,a,b,e,d){var c=this;if(b==null){b=false}if(e==null){e=false}if(d==null){d=true}if(Contacts.contacts_to_import===EmailProvider.NONE){Contacts.set_contacts_to_import()}if(this.loading_contacts){return false}this.loading_contacts=true;return new Ajax.DBRequest("/get_contacts",{parameters:{include_fb:f,direct_action:b,include_groups:e,include_team:d},onSuccess:function(g){var h;h=g.responseText.evalJSON(false);c.contacts=c.snippet_contact_list(h.contacts);c.lcontacts=c.snippet_contact_list(h.lcontacts);c.loading_contacts=false;if(c._contacts_to_inject&&c._lcontacts_to_inject){c.contacts.push.apply(c.contacts,c._contacts_to_inject);c.lcontacts.push.apply(c.lcontacts,c._lcontacts_to_inject)}if(c.sharing_options_auto_completer){c.sharing_options_auto_completer.setContacts(c.contacts,c.lcontacts)}if(c.invite_wizard_auto_completer){c.invite_wizard_auto_completer.setContacts(c.contacts,c.lcontacts)}if(SharingModel.send_link_autocompleter){SharingModel.send_link_autocompleter.setContacts(c.contacts,c.lcontacts)}if(a!=null){return a()}}})},shmodel:function(d,c){var b,a;if(c==null){c=true}a="/sm/create"+Util.urlquote(d);if(c){Forms.postRequest(a,{},{target:"_blank"});b=Browse.find_file(d);if(b){return b.get_div().addClassName("shmodeled")}}else{return Forms.postRequest(a)}},show_share_subfolder_warning:function(){var a,b;b=Browse.details_from_fq_path(Browse.containing_fq_path()).folder_name;if(b){a=_("Folders within shared folders can't be shared, but you can still share the folder '%(parent_shared_folder)s'");a=a.format({parent_shared_folder:b});Notify.server_error(a);return document.stopObserving(Browse.UPDATE_EVT,this.show_share_subfolder_warning)}},fb_auth_callback:function(){Sharing.load_contacts(true);$$(".fb-connect-link").each(function(a){return a.hide()});return Notify.server_success(_("Successfully connected to Facebook."))}};var SharedFolderInvites;SharedFolderInvites={pages:{},contents:{},cur_page:0,loading_page:false,reload_page_needed:false,show_page:function(a){Spinner.hideLoading();$("invites-container").update(this.pages[a]);return this.cur_page=a},get_page:function(a){var b=this;if(!$("invites-container")){return}if(this.pages[a]){this.show_page(a)}else{if(this.loading_page){this.reload_page_needed=true;return}this.loading_page=true;this.reload_page_needed=false;Spinner.showLoading(false,$("invites-container"),false,true);new Ajax.DBRequest("/share_ajax/invitation_page?page="+a,{onSuccess:function(c){b.loading_page=false;if(c.responseText==="False"){b.get_page(0);return}b.pages[a]=c.responseText;b.show_page(a);if(b.reload_page_needed){return b.get_page(a)}}})}return false},get_sf_contents:function(b,a){var c=this;if(this.contents[a]){return this.show_sf_contents(b,a)}else{return new Ajax.DBRequest("/share_ajax/sf_contents?ns_id="+a,{onSuccess:function(d){c.contents[a]=d.responseText;return c.show_sf_contents(b,a)}})}},show_sf_contents:function(b,a){return b.down(".folder-contents").update(this.contents[a])},mailto:function(b,a){Event.stop(b);return window.location="mailto:"+a}};var ShareView;ShareView={current_view:"gallery",click:function(a){ShareView.toggle_view(a);HashRouter.set_hash("view",a);return false},toggle_view:function(b){var a,c;b=b||"gallery";c=$(b+"-link");if(!c){return}$$("#toggle-view .selected").invoke("removeClassName","selected");c.addClassName("selected");$$(".view").invoke("hide");a=$(b+"-view");if(a){a.show()}return ShareView.current_view=b}};var __indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(c,b,e,h,i){var a,g,f,d=this;this.baseInitialize(c,b,i);this.options.array=e;this.options.larray=h;this.options.frequency=0.1;a=this.options.include_fb===true;if(!(this.options.include_team!=null)){this.options.include_team=true}f=this.options.include_team===true;if(!(this.options.include_groups!=null)){this.options.include_groups=false}g=this.options.include_groups===true;if(!Sharing.contacts){(function(){return Sharing.load_contacts(a,null,false,g,f)}).defer()}this.options.onShow=function(j,k){if(!k.style.position||k.style.position==="absolute"){k.style.position="absolute";$j(k).clonePosition($j(j),{setHeight:false,setTop:false,setLeft:false})}return $j(k).fadeIn(150)};this._autocompleter_contact_import_item_tmpl=HTML.tmpl("autocompleter_item_tmpl");if(Constants.shmodal_contact_importer_enabled){Event.stopObserving(this.element,"blur");Event.observe($("modal-box"),"click",function(j){var l,k;l=j.srcElement||j.originalTarget;if(l.className!=="import-contacts-link"){if(d.contact_importer_currently_showing()){return d.contact_importer_unshow()}else{return(k=d.get_entry_container())!=null?k.hide():void 0}}});ContactImporter.toggle=this.contact_importer_toggle.bind(this);ContactImporter.unshow=this.contact_importer_unshow.bind(this);return ContactImporter.refresh=function(){return Sharing.load_contacts(true,(function(){if(d.element.value.length){return d.getUpdatedChoices()}}))}}},getToken:function(){var a;a=this.getTokenBounds();return this.element.value.substring(a[0],a[1])},get_entry_container:function(){var a;return(a=this.element.up("#tokenized_autocompleter_container"))!=null?a.down(".autocomplete"):void 0},contact_importer_currently_showing:function(){var b,a;b=this.get_entry_container();if((b!=null)&&b.style.display!=="none"){if(((a=b.firstChild.firstChild)!=null?a.value:void 0)===0){if(b.firstChild.children.length>1){return true}}}return false},contact_importer_show:function(){var c,b,a,d;c=this.get_entry_container();if(((b=c.firstChild)!=null?(a=b.firstChild)!=null?a.value:void 0:void 0)>0){ContactImporter.old_display=c.style.display}else{ContactImporter.old_contents="<ul></ul>";ContactImporter.old_display="none"}this.contact_importer_render_buttons();if((d=$("flash_copy_container"))!=null){d.hide()}return this.element.focus()},contact_importer_unshow:function(){var a;this.hasFocus=true;this.changed=false;this.updateChoices(ContactImporter.old_contents);this.get_entry_container().style.display=ContactImporter.old_display;return(a=$("flash_copy_container"))!=null?a.show():void 0},contact_importer_toggle:function(){if(this.contact_importer_currently_showing()){return this.contact_importer_unshow()}else{return this.contact_importer_show()}},contact_importer_render_buttons:function(){var c,b,e,a,d;b=[];if(Constants.shmodal_contact_importer_enabled){d=[EmailProvider.GOOGLE,EmailProvider.YAHOO,EmailProvider.FACEBOOK];for(e=0,a=d.length;e<a;e++){c=d[e];assert(Contacts.connected_services!=null,"connected_services has not been set");b.push(this._autocompleter_contact_import_item_tmpl({email_provider_num:c,email_provider_img:EmailProvider.to_img(c),email_provider_name:EmailProvider.to_name(c),bottom_text:Contacts.connected_services[c]?_("Connected"):"",is_suggestion:0}).toHTML())}}this.hasFocus=true;return this.updateChoices("<ul>"+(b.join(""))+"</ul>")},getUpdatedChoices:function(){var a=this;if(!this.options.array&&Sharing.contacts&&Sharing.lcontacts){this.options.array=Sharing.contacts;this.options.larray=Sharing.lcontacts}this.updateChoices(this.options.selector());$j(".autocomplete-item-cancel-button").off();return $j(".autocomplete-item-cancel-button").on("click",(function(b){b.stopPropagation();ContactImporter.suggestions_enabled=false;a.getUpdatedChoices();return new Ajax.DBRequest("/contacts/turn_off_importer_suggestions")}))},selectEntry:function(){var c,b,a;b=this.getCurrentEntry();c=this.options.array[b.value];if(c.type===ContactTypes.FB){b.innerHTML=c.name}else{b.innerHTML=c.email}if(this.options.tokens.length>1){a=this.options.tokens[0]+" "}else{a=""}b.innerHTML+=a;this.active=false;this.updateElement(b);return $(this.element).fire("db:autocompleted")},setOptions:function(b){var a,c=this;if(b==null){b={}}a={choices:5,selector:function(){var G,m,E,C,s,D,f,J,g,q,r,B,x,y,j,n,k,w,t,v,z,i,u,I,h,A,e,d,F,H,o;I=[];f=c.getToken().toLowerCase();x=c.options.array.length;E=c.options.choices;G=c.options.array;y=c.options.larray;u=[];if(f.indexOf(" ")===-1){u.push("\\s+")}if(f.indexOf("+")===-1){u.push("\\+")}if(f.indexOf("@")===-1){u.push("@")}if(f.indexOf(".")===-1){u.push("\\.")}if(f.indexOf("&lt;")===-1){u.push("&lt;")}i=RegExp("("+u.join("|")+")");r=0;while(r<x&&I.length<E){D=G[r];n=y[r];J=-1;s=[];w=[];q="";switch(D.type){case ContactTypes.EMAIL:s.push(D.name,D.email);w.push(n.name,n.email);q="/static/images/icons/mail28.png";break;case ContactTypes.FB:s.push(D.name);w.push(n.name);if(Sharing.use_fb_profile_pics){q="https://graph.facebook.com/"+n.fb_id+"/picture"}else{q="/static/images/icons/fb24.png"}break;case ContactTypes.USER_GROUP:s.push(D.name,D.members);w.push(n.name,"");q="/static/images/icons/groupicon_large.png";break;default:assert(false,"should never get here due to type: "+D.type+", "+D.name+", "+D.email+", "+D)}for(B=e=0,F=w.length;e<F;B=++e){k=w[B];v=u.length?k.split(i):[k];C=0;for(d=0,H=v.length;d<H;d++){t=v[d];if(!t){continue}if(t.indexOf(f)===0){J=C;break}C+=t.length}if(J!==-1){s[B]=s[B].substr(0,J)+"<strong>"+s[B].substr(J,f.length)+"</strong>"+s[B].substr(J+f.length);break}}if(D.type===ContactTypes.FB){s.push(_("Facebook message"))}if(J!==-1){g="<image src='"+q+"' width='28px' height='28px'/>";z="<div class='autocomplete-line'>"+s[0]+"</div>";A="<div class='autocomplete-line autocomplete-secondary'>"+s[1]+"</div>";j="<div class='autocomplete-left'>"+g+"</div>";h="<div>"+(z+A)+"</div>";I.push("<li value='"+r+"'>"+(j+h)+"</li>")}r++}if(Constants.shmodal_contact_importer_enabled){if(o=Contacts.contacts_to_import,__indexOf.call(EmailProvider.contact_services(),o)>=0){if(!Contacts.connected_services[Contacts.contacts_to_import]){if(!b.suggestions_disabled){if(ContactImporter.suggestions_enabled){I.push(c._autocompleter_contact_import_item_tmpl({email_provider_num:Contacts.contacts_to_import,email_provider_img:EmailProvider.to_img(Contacts.contacts_to_import),email_provider_name:_("Import your %(email_provider_name)s contacts").format({email_provider_name:EmailProvider.to_name(Contacts.contacts_to_import)}),bottom_text:_("Easily share with friends, family or coworkers"),is_suggestion:1}).toHTML())}}}}}m="<ul>"+(I.join(""))+"</ul>";ContactImporter.old_contents=m;return m}};return this.options=Object.extend(a,b)}});var Token;Token=Class.create({initialize:function(b,a,c,d){this.element=$(b);this.token_manager=c;this.hidden_input=a;this.element.token=this;this.selected=false;this.info=d;return Event.observe($("tokenized_autocompleter_container"),"click",this.onclick.bindAsEventListener(this))},select:function(){var a;this.token_manager.token=this;if((a=this.hidden_input)!=null){a.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(a){if(a&&a.preventDefault){a.preventDefault()}if(this.detect(a)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(a){return this.token_manager.remove(this)},detect:function(d){var b,c,a;c=d.target?d.target:d.srcElement;a=c.token;b=c;while(!(a!=null)&&b.parentNode){b=b.parentNode;a=b.token}return(a!=null)&&a.element===this.element}});var TokenManager;TokenManager=Class.create({initialize:function(b,c,a){this.shift_boundary_right_func=c;this.shift_boundary_left_func=a;this.element=b;this.tokens=[];return this.token=null},add:function(a){this.tokens.push(a);return this.element.fire("token:add",a.info)},populate:function(){var g,c,e,d,f,b,a;d=this.element.select(".token");a=[];for(f=0,b=d.length;f<b;f++){e=d[f];g=e.hasClassName("token-warn");c=new Token(e,null,this,{external:g});a.push(this.add(c))}return a},remove:function(c){var b,a;if(!(c!=null)){c=this.token}if(c!=null){a=this.tokens.indexOf(c);this.tokens.splice(a,1);c.element.remove();if(this.token===c&&a<this.tokens.length){this.tokens[a].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}this.element.fire("token:remove",c.info)}b=Tutorial.should_handle_event(Tutorial.events.share_modal_remove_invite_user,{token:c});if(b){return Tutorial.handle_event(Tutorial.events.share_modal_remove_invite_user,{token:c})}},removeAll:function(){var b,d,a,c;c=this.tokens;for(d=0,a=c.length;d<a;d++){b=c[d];b.element.remove();this.element.fire("token:remove",b.info)}return this.tokens.clear()},shift_left:function(){var a;a=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(a>0){if(this.token){this.token.deselect()}return this.tokens[a-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var a;a=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(a+1<this.tokens.length){return this.tokens[a+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var HiddenInput;HiddenInput=Class.create({initialize:function(a,c,b){this.element=$(a);this.auto_complete_element=c;this.token_manager=b;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(a){switch(a.keyCode){case Event.KEY_LEFT:a.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:a.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:a.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,d,g,c,f,b,a){var e;$super(d,g,f,b,a);this.token_manager=new TokenManager(this.element,this.generate_shift_boundary_right_func());this.hidden_input=new HiddenInput(c,this.element,this.token_manager);if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){$j(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(h,i){$j(i).clonePosition($j(h.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return i.show()};this.options.onHide=function(h,i){return i.hide()};if(DBHistory.get_url().indexOf("/referrals")!==-1){e=$j("#retrieve-contacts-button")}else{e=$j(this.element).closest("form").find(".tokenizer-submit-button")[0]}$j(e).on("mousedown",this.beforeSubmit.bindAsEventListener(this));$j(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!a.hide_import_contacts){if(Constants.shmodal_contact_importer_enabled){this.import_links=$j(".import-contacts-link")}else{this.import_links=$j(".fb-connect-link")}}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onBlur:function($super,a){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(a)},onFocus:function(a){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(a){return this.tokenize_emails_input(true)},clearTokens:function(a){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},setContacts:function(b,a){this.options.array=b;return this.options.larray=a},getEmails:function(){var b,a;b=$j(this.element).closest("#tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var e,d,c;c=[];for(e=0,d=b.length;e<d;e++){a=b[e];c.push($j(a).val())}return c})()).join(", ")},check_populated:function(){var b,a;b=$(this.element.parentNode);a=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(b.hasClassName("populated")&&a){return b.removeClassName("populated")}else{if(!b.hasClassName("populated")&&!a){return b.addClassName("populated")}}},clean_email_addr:function(e,c){var b,d,a;for(d=0,a=e.length;d<a;d++){b=e[d];c=c.sub(b,"")}return c.strip()},get_regexp_from_delimiters:function(e){var b,d,c,a;d="";for(c=0,a=e.length;c<a;c++){b=e[c];d+=b+"|"}return new RegExp("["+d+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(d,c,a){var b;b=true;if(a===ContactTypes.EMAIL&&!Util.validate_email(c)){b=false}if(!d&&c){d=c.toString()}return{display:d,value:c,type:a,valid:b}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(b){var a,c;a=b.match(this.COMPOUND_EMAIL_REGEX);if(a){c=this.createTokenInfo(a[0],a[2],ContactTypes.EMAIL);return c}return null},tokenize_emails_input:function(j,e){var o,i,f,n,c,p,m,l,g,t,h,d,b,a,q,s,r,k;i=this.options.tokens;l=this.get_regexp_from_delimiters(i);n=this.element.value.split(l);t="";if(!j){t=n[n.length-1];m=this.clean_email_addr(i,t);n=n.slice(0,n.length-1);if((k=t[t.length-1])===" "||k===">"){if(m.match(this.COMPOUND_EMAIL_REGEX)||Util.validate_email(m)){n.push(m);t=""}}}o=false;h=[];if(n.length>0){for(d=0,q=n.length;d<q;d++){f=n[d];g=this.parse_compound_email(f);if(g!=null?g.valid:void 0){o=true;this.set_input_size(1);this.addContact(g)}else{h.push(f)}}}n=h;p=[];for(b=0,s=n.length;b<s;b++){f=n[b];p.push.apply(p,f.split(" "))}n=p;if(n.length>0){for(a=0,r=n.length;a<r;a++){f=n[a];f=this.clean_email_addr(i,f);if(f){g=this.createTokenInfo(f,f,ContactTypes.EMAIL);if(g.valid){o=true}else{if(e){continue}}this.set_input_size(1);this.addContact(g)}}}this.element.value=t;c=this.element.up("form");if(o){Forms.clear_errors(c)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var b,a;b=this.element;a=function(){return b.focus()};return a},set_input_size:function(a){if(!(a!=null)||a<0){a=20}return this.element.setStyle({width:""+a+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var p,c,k,d,e,m,n,q,f,l,b,i,h,o,a,j,g;n=$(this.element.parentNode.parentNode);q=parseInt(n.getStyle("width"),10)-15;l=this.token_manager.tokens;d=false;b=0;for(i=0,o=l.length;i<o;i++){f=l[i];k=f.element;c=parseInt(k.getStyle("width"),10)+parseInt(k.getStyle("margin-right"),10);m=b+c;if(m>q){b=c;d=true}else{if(c>q){b=0;d=true}else{b=m}}}e=q-b;p=this.element.value.length*7;if(p>e){e=q}this.set_input_size(e);if(this.import_links.length&&this.import_links_visible){if(d||q-b-p<1.25*this.import_links_width){this.import_links_visible=false;j=this.import_links;g=[];for(h=0,a=j.length;h<a;h++){k=j[h];g.push($j(k).fadeOut(100))}return g}}},onKeyPress:function(b){var c,a;this.dynamically_resize_input();if(this.active){switch(b.keyCode){case 44:case 188:case 59:case 186:this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();Event.stop(b);return}this.selectEntry();this.hide();this.active=false;Event.stop(b);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(b);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(b);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(b);return}}else{this.tokenize_emails_input(false);if(b.keyCode===Event.KEY_TAB||b.keyCode===Event.KEY_RETURN){if(this.element.value&&b.preventDefault){b.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((c=b.keyCode)===Event.KEY_LEFT||c===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((a=b.keyCode)===Event.KEY_LEFT||a===Event.KEY_RIGHT||a===Event.KEY_UP||a===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var b,c,f,e,a,d;if(this.active){f=this.element.value;d=this.options.tokens;for(e=0,a=d.length;e<a;e++){b=d[e];c=f.indexOf(b);if(c!==-1){if(this.selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=f.substr(0,c);this.selectEntry();this.hide();this.active=false;this.element.value=f.substr(c+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);$super();if(Tutorial.should_handle_event(Tutorial.events.share_modal_type_contact)){return Tutorial.handle_event(Tutorial.events.share_modal_type_contact)}},selected_contact_importer_entry:function(a){var b;if(a==null){a=this.getCurrentEntry()}return a.value===0&&((b=a.id)!=null?b.length:void 0)!==0},selectEntry:function(){var c,b,f,a,d,e;b=this.getCurrentEntry();if(this.selected_contact_importer_entry(b)){f=b.id.split("_")[0];assert(parseInt(f,10)<0,"The 'id-value' of an autocompleter-entry being <0 signifies that it's a contact-importer button");d=EmailProvider.to_name(f);if(Contacts.connected_services[f]){Notify.server_success(_("You're already connected to %(service_name)s").format({service_name:d}));ContactImporter.unshow();return}if(f===EmailProvider.GOOGLE||f===EmailProvider.YAHOO||f===EmailProvider.FACEBOOK){if($j(b).attr("suggestion")==="1"){return Contacts.auth_import(f,"suggestion")}else{return Contacts.auth_import(f)}}else{return assert(false,"Should never get here. entry_value: "+f)}}else{c=this.options.array[b.value];a=c.type===ContactTypes.FB?c.fb_id:c.type===ContactTypes.USER_GROUP?c.group_id:c.email;this.set_input_size(1);e=this.createTokenInfo(c.name.strip(),a,c.type);this.addContact(e);Forms.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;this.element.focus();if(Tutorial.should_handle_event(Tutorial.events.share_modal_pick_contact)){return Tutorial.handle_event(Tutorial.events.share_modal_pick_contact)}}},addContact:function(a){var j,k,c,h,b,i,e,g,m,d,l,f;this.element.value="";switch(a.type){case ContactTypes.FB:h="fb_ids";k=new Element("img",{src:"/static/images/icons/fb_16.png"});break;case ContactTypes.EMAIL:h="emails";k=new Element("img",{src:"/static/images/icons/email_16.png"});break;case ContactTypes.USER_GROUP:h="group_ids";k=new Element("img",{src:"/static/images/icons/groupicon_small.png"});break;case ContactTypes.INVALID:h="invalids";k=new Element("span",{"class":"hidden"});break;default:assert(false,"should never get here due to type: "+a.type)}i=this.getTokenClass(a);m=new Element("span",{"class":"x "+i,onmouseout:"this.className='x "+i+"'",onmouseover:"this.className='x_hover "+i+"'",onclick:"this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(event); return false;"}).__date(" ");e=new Element("input",{type:"hidden",name:h,value:a.value.toString()});b=new Element("a",{"class":"token "+i,href:"#",tabindex:"-1"});c=new Element("span");f=[e,k,a.display,m];for(d=0,l=f.length;d<l;d++){j=f[d];c.__sert(j)}b.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(c))));$(b).down(5).next().innerHTML="&nbsp;";g=new Token(b,this.hidden_input,this.token_manager,a);this.token_manager.add(g);return $("autocomplete_display").__sert({before:b})},getTokenClass:function(a){if(!a.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,d,f,c,e,b,a){$super(d,f,c,e,b,a);this.warn_only=!a.team_only;this.setContacts(e,b);this.element.observe("token:remove",this.notifyExternal.bind(this));return this.element.observe("token:add",this.notifyExternal.bind(this))},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(a){this.warn_only=!a;return this.reloadContacts()},reloadContacts:function(){if(Sharing.contacts){return this.setContacts(Sharing.contacts,Sharing.lcontacts)}else{return Sharing.load_contacts(true)}},setContacts:function(e,c){var a,d,b;this.team_contacts={};this.team_contacts[Constants.email]=1;if(e){for(d=0,b=e.length;d<b;d++){a=e[d];if(a.team){this.team_contacts[a.email]=1}}}return this.updateContacts(e,c)},updateContacts:function(b,a){if(b&&!this.warn_only){b=b.filter(function(c){return c.team});a=a.filter(function(c){return c.team})}this.options.array=b;return this.options.larray=a},createTokenInfo:function(e,c,a){var f,d,b;b=true;f=false;if(a===ContactTypes.EMAIL&&!Util.validate_email(c)){b=false}else{if(a===ContactTypes.EMAIL&&!this.team_contacts[c]){b=this.warn_only;f=true}else{if(a===ContactTypes.FB){b=this.warn_only;f=true}}}if(!e&&c){e=c.toString()}return d={display:e,value:c,type:a,valid:b,external:f}},getTokenClass:function(a){if(!a.valid){return"token-error"}if(a.external){return"token-warn"}return"token-valid"},notifyExternal:function(b){var a,c,d;d=b.memo;if(d.external){c=this.token_manager.tokens.filter(function(e){return e.info.external});a=c?c.length:0;return this.element.fire("sf:token:external",{count:a})}}});var TeamSharedFolderInviteController;TeamSharedFolderInviteController=Class.create({initialize:function(b){var a;this.element=b;a=this.element.down(".new-collab-input");return a.observe("sf:token:external",this.handle_external.bind(this))},handle_external:function(b){var a,c;a=b.memo.count;c=this.element.down(".external-invite-message");if(a>1){DomUtil.fillVal(a,"external-invite-num");if(c!=null){c.removeClassName("single")}return c!=null?c.show():void 0}else{if(a===1){if(c!=null){c.addClassName("single")}return c!=null?c.show():void 0}else{return c!=null?c.hide():void 0}}}});var ShareShowController;ShareShowController=Class.create({initialize:function(b){var c,a,d=this;this.ns_id=b;this.invite_form=$("invite-more-form");this.root=this.invite_form.up(".share_show_modal");this.add_message_container=$("add-message-container");this.custom_message_section=$("custom-message-section");this.allow_members_table=$("allow-members-table");this.folder_management_buttons=$("folder-management-buttons");$("sharing-options-new-collab-input").observe("focus",this.toggle_to_invite_mode.bind(this));if((c=$("custom-message-wizard"))!=null){c.observe("focus",this.toggle_to_invite_mode.bind(this))}return(a=this.add_message_container)!=null?a.observe("click",function(f){d.show_message_box(f);return d.toggle_to_invite_mode(f)}):void 0},show_message_box:function(c){var b,a;if((b=this.custom_message_section)!=null){b.show()}return(a=this.add_message_container)!=null?a.hide():void 0},hide_message_box:function(c){var b,a;if((b=this.custom_message_section)!=null){b.hide()}return(a=this.add_message_container)!=null?a.show():void 0},show_folder_settings:function(a){Event.stop(a);new UIRequest(a.target,"/share_ajax/folder_settings",{parameters:{ns_id:namespace_id,folder_name:PAGE_PATH},onComplete:function(){return Modal.onHide=Sharing.reshow}});return false},toggle_from_invite_mode:function(){this.allow_members_table.hide();this.folder_management_buttons.show();this.hide_message_box();return this.invite_form.addClassName("collapsed")},toggle_to_invite_mode:function(){this.allow_members_table.show();this.folder_management_buttons.hide();return this.invite_form.removeClassName("collapsed")},set_team_only:function(c){var b,a;a=this.invite_form.down(".external-invite-message");b=this.root.down(".member-info .folder-settings");if(c){this.invite_form.addClassName("team-only");a.addClassName("team-only");return b.addClassName("team-only")}else{this.invite_form.removeClassName("team-only");a.removeClassName("team-only");return b.removeClassName("team-only")}},get_ns_id:function(){return this.ns_id}});var TeamExternalShareConfirm;TeamExternalShareConfirm=Class.create({initialize:function(b){var a;this.root=b;a=this.root.down(".token-container");this.token_manager=new TokenManager(a);this.token_manager.populate();return a.observe("token:remove",this.remove.bind(this))},remove:function(c){var b,d,a;if(!this.token_manager.tokens.length){return this.root.addClassName("no-recipients")}else{if(c.memo.external){d=this.token_manager.tokens.filter(function(e){return e.info.external});b=d?d.length:0;a=this.root.down(".external_prompt");if(b===0){return a.hide()}else{if(b===1){return a.addClassName("single")}else{return DomUtil.fillVal(b,"external_member_count")}}}}}});var Links;Links={SNIPPET_LENGTH:30,THUMBS_BATCH_SIZE:16,_tmpl:null,init:function(b){var c,d,a;for(d=0,a=b.length;d<a;d++){c=b[d];assert(c.encoded_sort_key&&!(c.sort_key!=null),"expected encoded sort key on each elm");c.sort_key=Util.decode_sort_key(c.encoded_sort_key);delete c.encoded_sort_key}this._state={links:b,cmp:this._created_cmp,is_ascending:false};this.listen();this._tmpl=HTML.tmpl("links_list_item_tmpl");return this._render()},listen:function(){var a,b=this;$("links-view").on("click","a.remove-link",function(i,d){var c,f,h,g;Event.stop(i);c=d.readAttribute("data-filename");g=d.readAttribute("data-tkey");h=parseInt(d.readAttribute("data-is-dir"),10);f=parseInt(d.readAttribute("data-is-album"),10);return SharingModel.confirm_remove(c,g,h,f)});document.observe(FileEvents.LINKS_REMOVE,function(k){var g,h,d,l,f,j,c;f=k.memo.token;d=b._state.links;assert(f,"LINKS_REMOVE without token");for(g=j=0,c=d.length;j<c;g=++j){h=d[g];if(h.tkey===f){l=g}}assert(l!=null,"LINK_REMOVE w/o DOM elm");d.splice(l,1);$$("#links-list li.link")[l].remove();return b._empty_check()});a="#links-sort a.sort-option";$("links-sort").on("click","a.sort-option",function(f,d){var c,g;Event.stop(f);g={LINKS_BY_NAME:b._name_cmp,LINKS_BY_CREATED:b._created_cmp};c=g[d.readAttribute("data-sort")];if(b._state.cmp===c){b._state.is_ascending=!b._state.is_ascending}else{b._state.cmp=c;b._state.is_ascending=true}Util.add_sort_arrow_mouseover(d,b._state.is_ascending,a,true);return b._render()});return Util.add_sort_arrow_mouseover($("created-sorter"),this._state.is_ascending,a,false)},_render:function(){var f,b,g,i,a,d,c,h,e=this;f=function(j,l){var k;k=e._state.is_ascending?1:-1;return k*e._state.cmp(j,l)};b=[];i=this._state.links;i.sort(f);for(c=0,h=i.length;c<h;c++){g=i[c];if(g.is_album){d=_("Unshare album")}else{d=_("Remove")}b.push(this._tmpl({link:g,remove_str:d}))}$("links-list").__date(b);a=function(j){if(!j.src.endsWith(Sprite.SPACER)){return j.addClassName("thumbnail")}};BatchThumbLoader.batch_load_thumbs($$("#links-list img"),this.THUMBS_BATCH_SIZE,a);return this._empty_check()},_empty_check:function(){if(this._state.links.length){return $("links-view").removeClassName("empty-list")}else{return $("links-view").addClassName("empty-list")}},_name_cmp:Util.sort_by_rank_or_key,_created_cmp:function(a,b){return a.created_ts-b.created_ts}};var RecentLinks;RecentLinks={SNIPPET_LENGTH:30,THUMBS_BATCH_SIZE:16,_tmpl:null,init:function(a){this.links=a;this._toggle_loading();this._tmpl=HTML.tmpl("recent_links_list_item_tmpl");this._get_list();this._listen();if(!HTML5_HISTORY&&!window.location.hash){this._history_change(null)}$j("#no-recent-links").css("display","");return $j("#no-created-links").css("display","")},_history_change:function(a,b){if(a==="from_others"){return $j("#links-view").removeClass("your-links").addClass("recent-links")}else{return $j("#links-view").removeClass("recent-links").addClass("your-links")}},_toggle_loading:function(){return $j("#recent-links-content").toggleClass("loading")},_listen:function(){$j("#recent-links-tab").on("click",this._recent_links_click);$j("#your-links-tab").on("click",this._your_links_click);DBHistory.add_callback("/links",$j.proxy(this._history_change,this));return $j(document.body).on("click","#recent-links-list .remove-recent-link",$j.proxy(this._do_remove,this))},_get_list:function(){var a=this;return new Ajax.DBRequest("/links/recent_links",{onSuccess:function(b){return a._render(Util.from_json(b.responseText))}})},_recent_links_click:function(a){a.preventDefault();return DBHistory.push_state("/links/from_others")},_your_links_click:function(a){a.preventDefault();return DBHistory.push_state("/links/your_links")},_render:function(a){var c,d,f,e,b;if(!a.length){$j("#recent-links-content").addClass("empty-list")}c=[];for(e=0,b=a.length;e<b;e++){d=a[e];c.push(this._tmpl({link:d}))}c=$j.map(c,function(g){return g.toHTML()});$j("#recent-links-list").html(c.join(""));f=function(g){if(!g.src.endsWith(Sprite.SPACER)){return g.addClassName("thumbnail")}};BatchThumbLoader.batch_load_thumbs($$("#recent-links-list img"),this.THUMBS_BATCH_SIZE,f);return this._toggle_loading()},_do_remove:function(d){var b,a,c,f=this;d.preventDefault();a=$j(d.currentTarget);c=a.attr("data-tkey");b=a.closest(".link");return new Ajax.DBRequest("/links/remove_recent_link",{parameters:{tkey:c},onSuccess:function(g){var e;Notify.clear_all();e=b.attr("title").em_snippet(f.SNIPPET_LENGTH);switch(g.responseText.strip()){case"OK":Notify.server_success(_("Removed '%(filename)s'").format({filename:e}));return f._remove_link_elm(b);case"INVALID":Notify.server_error(_("'%(filename)' has already been removed").format({filename:e}));return f._remove_link_elm(b);default:return Notify.server_error(_("There was a problem removing '%(filename)s'").format({filename:e}))}}})},_remove_link_elm:function(a){a.remove();if($j("#recent-links-list .link").length===0){return $j("#recent-links-content").addClass("empty-list")}}};var SharingModel;SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,album_gid:null,gallery_enabled:false,gallery_showing:false,preview_objs:[],send_link_autocompleter:null,init:function(b,a){var c=this;this.filename=b;this.c2d_vars=a;this.init_logger();Sharing.contacts=false;Sharing.lcontacts=false;return on_script_loaded(function(){var i,e,d,h,g,f;i=$("login-create-an-account");if(i){i.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);if((e=$("c2d-form"))!=null){e.observe("submit",c.do_c2d.bind(c))}if((d=$("c2d-register-form"))!=null){d.observe("submit",c.c2d_register.bind(c))}if((h=$("c2d-login-form"))!=null){h.observe("submit",c.c2d_login.bind(c))}if((g=$("c2d-twofactor-login-form"))!=null){g.observe("submit",c.c2d_twofactor_login.bind(c))}if((f=$j("#download_button_link[data-dl-link]"))!=null){f.on("click",c.download_zip)}return c.set_viewport_size()})},init_folder:function(a,c,b){var d=this;this.gallery_enabled=a;this.gallery_showing=c;this.is_folder=true;this.init_lightbox(b);return on_script_loaded(function(){return d.load_thumbs()})},init_album:function(a){this.album_gid=a;this.is_album=true;this._resize_album_view();return Event.observe(window,"resize",this._resize_album_view.bind(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&!(this.c2d_vars.item_id!=null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},init_logger:function(){var a=this;on_script_loaded(function(){var b;b=$("login-hover-link");if(b){b.observe("click",function(){return ShmodelLogger.log("click_sign_in")});b.observe("click",function(){return RegistrationLogger.log("click_sign_in")})}if($("download_button_link")){ShmodelLogger.attachLogListener("click_download",$("download_button_link"))}b=$("add_to_my_dropbox_link");if(b){ShmodelLogger.attachLogListener("click_add_to_my_dropbox",b);RegistrationLogger.attachLogListener("click_add_to_my_dropbox",b)}if($$(".remove-link").length){ShmodelLogger.attachLogListener("remove_link",$$(".remove-link")[0])}if($$(".shmodel-filename").length){ShmodelLogger.attachLogListener("click_filename",$$(".shmodel-filename")[0])}if($("default_content_download_button")){ShmodelLogger.attachLogListener("click_download",$("default_content_download_button"))}if($("default_content_a2md")){return ShmodelLogger.attachLogListener("click_add_to_my_dropbox",$("default_content_a2md"))}});return document.observe(Lightbox.ACTIONS_ADDED,function(){var d,c,b;b=$("view_original");if(b){ShmodelLogger.attachLogListener("shmodel_lightbox_click_vieworiginal",b)}c=$("lightbox_shmodel_link");if(c){ShmodelLogger.attachLogListener("shmodel_lightbox_click_getlink",c)}d=$("lightbox_download_link");if(d){return ShmodelLogger.attachLogListener("shmodel_lightbox_click_download",d)}})},init_lightbox:function(b){var e,d,c,a,f=this;for(c=0,a=b.length;c<a;c++){e=b[c];if(e.is_video){d=new VideoPreview({filename:e.filename,fq_path:e.path,thumbnail_url_tmpl:e.thumbnail_url,preview_url:e.preview_url,dl_url:Util.add_qstring(e.orig_url,{dl:"1"}),shmodel_link:e.shmodel_link,ns_id:e.ns_id,ns_path:e.path,link_hash:e.item_id+"-"+e.filename})}else{d=new PhotoPreview({filename:e.filename,fq_path:e.path,thumbnail_url_tmpl:e.thumbnail_url,dl_url:Util.add_qstring(e.orig_url,{dl:"1"}),original_url:e.orig_url,shmodel_link:e.shmodel_link,ns_id:e.ns_id,ns_path:e.ns_path,link_hash:e.item_id+"-"+e.filename})}this.preview_objs.push(d)}Lightbox.init(this.preview_objs,{include_delete:false,keep_url:true,filename_in_url:true});return document.observe(Lightbox.EXIT_SELECT_EVT,function(h){var g;key.setScope("all");g=$("gallery-view-media").childElements()[f.preview_objs.indexOf(h.memo)];Util.scroll_to_thumb(g);g.addClassName("wiggobble");return setTimeout((function(){return g.removeClassName("wiggobble")}),1000)})},_resize_album_view:function(){var a;a=Math.floor((Util.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+a+"px"})},load_thumbs:function(){var b,a;a=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");b=function(c){if(!c.src.endsWith(Sprite.SPACER)){return c.addClassName("thumbnail")}};return BatchThumbLoader.batch_load_thumbs(a,this.THUMBS_BATCH_SIZE,b)},switch_mode:function(g){var c,h,f,a,e,b,d;d=$A(["gallery","list"]);for(e=0,b=d.length;e<b;e++){a=d[e];h=$(a+"-view-container");c=$(a+"-toggle");if(g===a){h.show();c.addClassName("selected")}else{h.hide();c.removeClassName("selected")}}if(history.replaceState){f=window.location.pathname;if(g==="list"){f+="?lst"}history.replaceState({},"",f)}this.gallery_showing=!this.gallery_showing;this.load_thumbs();if(Tutorial.should_handle_event(Tutorial.events.shmodel_folder_switch_view_mode)){return Tutorial.handle_event(Tutorial.events.shmodel_folder_switch_view_mode)}},set_viewport_size:function(){var a;if($(document.body).hasClassName("mobile")){a=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(a)}},toggle_dropdown:function(d,f,c){var a,b;if(d){Event.extend(d).preventDefault()}if(!f.visible()){if(this.is_album){return FreshDropdown.show(f,c,null,true)}else{b=$$(".nav-header").first().getHeight();a=$$(".nav-header .buttons").first().cumulativeOffset().top;if(a<0&&Util.ie8){a=8}return FreshDropdown.show(f,c,b-a,true)}}},confirm_remove:function(b,g,c,e,f){var d,a,h;if(c==null){c=false}if(e==null){e=false}if(f==null){f=false}assert(g,"confirm_remove missing tkey");assert(b,"confirm_remove missing name");if(e){h=f?_("Unshare?"):_("Unshare album?");d=$("album-disable-token-modal");DomUtil.fillVal(b.escapeHTML(),"album_unshare_name")}else{h=_("Remove link to '%(name)s'").format({name:b.snippet(34)});d=$("disable-token-modal");if(c){a=_("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{a=_("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}DomUtil.fillVal(a,"disable-token-desc")}return Modal.icon_show("alert_32",h,d,{token:g,name:b,is_album:e})},do_remove:function(a){var b,c=this;if((b=window.location.pathname)==="/links"||b==="/links/your_links"){new Ajax.DBRequest("/sm/disable/"+a.token,{onSuccess:function(){var d;Modal.hide();if(a.is_album){d=_("Unshared '%(name)s'")}else{d=_("Removed link for '%(name)s'")}d=d.format({name:a.name});Notify.server_success(d);return document.fire(FileEvents.LINKS_REMOVE,{token:a.token})},onComplete:function(){return Forms.remove_loading()}})}else{Forms.postRequest("/sm/disable/"+a.token)}return Forms.add_loading($("modal-content").down("input"))},get_token:function(a,b){var c=this;return new Ajax.DBRequest("/sm/get"+Util.normalize(a),{onSuccess:function(e){var d;d=e.responseText.evalJSON(true);if(b){return b(d)}}})},show_shmodal_onload:function(b,c,a,e){var d=this;if(e==null){e=false}return Util.smartLoad(function(){var f;if(HTML5_HISTORY){f=DBHistory.deconstruct_url();delete f.qargs.m;DBHistory.replace_state(f.path,f.qargs)}if(Constants.EMAIL_VERIFIED){return d.show_shmodal(b,c,a,e)}})},show_shmodal:function(b,g,a,i){var j,l,h,c,d,k,e,f=this;this.url=b;this.short_url=g;if(i==null){i=false}if(EmailVerification.verified()){Modal.show(this._get_shmodal_title(),DomUtil.fromElm($("shmodal")).stripScripts());if(this._get_thumbnail_type()){e=$$(".shmodal-image");for(d=0,k=e.length;d<k;d++){h=e[d];h.addClassName("thumbnail")}}if(a==="contacts"){l=Autocompleter.ContactsTokenizer}else{l=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new l("shmodal-new-collab-input","shmodal-new-whobulk","shmodal-hidden-input",Sharing.contacts,Sharing.lcontacts,{tokens:[",",";"],include_fb:true,include_team:true,include_groups:i,team_only:a==="team_only"});this.configure_dropdown();if(FlashDetect.installed){c=Util.copy_to_clipboard_swf(b,"shmodal-copy-link","SharingModel.copied_to_clipboard");$(c).up().style.zIndex="1001";clearInterval(this.follow_freshbutton);j=function(){return $j("#"+c).parent().clonePosition($j("#shmodal-copy-link"),{offsetHeight:6,offsetWidth:6})};this.follow_freshbutton=setInterval(j,500)}else{$("shmodal-copy-link").hide()}SickInput._create($("modal").down(".custom-message-container"));SickInput._create($("modal").down(".fb-post-sickinput"));SickInput._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(g);$("shmodal-new-collab-input").focus();return ShmodelLogger.log("shmodal_show")}},configure_dropdown:function(){var f,b,d,a,c,e=this;c=$$(".dropdown-menu-container");for(d=0,a=c.length;d<a;d++){f=c[d];b=f.down(".dropdown-menu-trigger");if(b!=null){b.observe("click",function(h){var g;g=h.target.up(".dropdown-menu-container");return g.toggleClassName("dropdown-shown")})}}return document.on("click",function(l){var j,k,i,g,h;if(l.target.hasClassName("dropdown-menu-trigger")||l.target.up(".dropdown-menu-trigger")){return}g=$$(".dropdown-shown");h=[];for(k=0,i=g.length;k<i;k++){j=g[k];h.push(j.removeClassName("dropdown-shown"))}return h})},copied_to_clipboard:function(){Notify.server_success(_("Link copied to clipboard"));Modal.hide();ShmodelLogger.log("shmodal_copy_link");return ViralLogger.log(Constants.uid,"shmodel","send",{src:"shmodel_copy_link",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[Util.file_extension(SharingModel.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(c){var d,k,h,l,m,i,a,f,e,j,b,g;assert(c,"Must pass the shmodal send form into get_shmodel_send_recipients");d=c.select('input[name="emails"]');k=c.select('input[name="fb_ids"]');h=c.select('input[name="group_ids"]');a=[];g=[d,k,h];for(f=0,j=g.length;f<j;f++){m=g[f];for(e=0,b=m.length;e<b;e++){l=m[e];i=l.up().innerHTML.stripTags().escapeHTML();a.push(i.substring(0,i.indexOf("&")))}}return a},send_shmodel_link:function(d){var c,b,f,a,g=this;c=$("shmodal-send-form");assert(c,"Couldn't find the shmodal send form.");a=this.get_shmodel_send_recipients(c);f=function(e){var h;if(a.length===1){if(a[0].indexOf("@")===-1){h=_("Sent to %(recipient)s").format({recipient:a[0]})}else{h=_("Sent to %(recipient)s").format({recipient:a[0]})}}else{if(a.length===2){if(a[0].indexOf("@")===-1){if(a[1].indexOf("@")===-1){h=_("Sent to %(recipient_first)s and %(recipient_second)s").format({recipient_first:a[0],recipient_second:a[1]})}else{h=_("Sent to %(recipient_first)s and %(recipient_second)s").format({recipient_first:a[0],recipient_second:a[1]})}}else{if(a[1].indexOf("@")===-1){h=_("Sent to %(recipient_first)s and %(recipient_second)s").format({recipient_first:a[0],recipient_second:a[1]})}else{h=_("Sent to %(recipient_first)s and %(recipient_second)s").format({recipient_first:a[0],recipient_second:a[1]})}}}else{if(a[0].indexOf("@")===-1){h=_("Sent to %(recipient)s and %(num_others)s others").format({recipient:a[0],num_others:a.length-1})}else{h=_("Sent to %(recipient)s and %(num_others)s others").format({recipient:a[0],num_others:a.length-1})}}}Notify.server_success(h);Modal.hide();return ShmodelLogger.log("shmodal_send")};b=function(e){return Forms.remove_loading()};return Forms.ajax_submit(c,"/sm/share",f,b,c.down(".tokenizer-submit-button"))},show_content:function(b){var e,d,a,c;$("shmodal-title-text").__date(ShmodalPanes.to_title_str(b));c=ShmodalPanes.list;for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){$(ShmodalPanes.to_toggle_str(e)).removeClassName("toggled");$(ShmodalPanes.to_content_str(e)).hide()}}$(ShmodalPanes.to_content_str(b)).show();$(ShmodalPanes.to_toggle_str(b)).addClassName("toggled");return $(ShmodalPanes.to_focus_str(b)).focus()},show_send_content:function(){return this.show_content(ShmodalPanes.SEND)},show_fb_content:function(){return this.show_content(ShmodalPanes.FB)},show_twitter_content:function(){return this.show_content(ShmodalPanes.TWITTER)},start_fb_post:function(a){if(FacebookOAuth.has_authed){return this.do_fb_post(a)}else{return FacebookOAuth.do_auth(this.do_fb_post.curry(a))}},start_twitter_post:function(){if(Twitter.has_authed){return this.do_twitter_post()}else{return Twitter.do_auth(this.do_twitter_post)}},do_fb_post:function(a){FacebookOAuth.custom_show_posting=function(){return Forms.add_loading($("shmodal-fb-post-submit"))};FacebookOAuth.custom_show_complete=function(){Modal.hide();Notify.server_success(_("Successfully posted to Facebook"));ShmodelLogger.log("shmodal_fb_post");return ViralLogger.log(Constants.uid,"shmodel","send",{src:"shmodel_fb_post",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[Util.file_extension(SharingModel.filename).toLowerCase()]||"file"})};return FacebookOAuth.post($F("shmodal-fb-post-input"),a)},do_twitter_post:function(){var a,b=this;a=$F("shmodal-twitter-post-input");if(!a){Notify.server_error(_("Please enter a Twitter post"));return}else{if(a.length>140){Notify.server_error(_("Your post must be 140 characters or less"));return}}Twitter.custom_show_posting=function(){$("twitter-chars").hide();return Forms.add_loading($("shmodal-twitter-post-submit"))};return Twitter.custom_post(a,function(){Modal.hide();Notify.server_success(_("Successfully posted to Twitter"));ShmodelLogger.log("shmodal_tweet");return ViralLogger.log(Constants.uid,"shmodel","send",{src:"shmodel_twitter",file_type:SharingModel.is_album?"collection":SharingModel.is_folder?"folder":SharingModel.filename.indexOf(".")===-1?"file":BrowseFile.EXTENSION_TO_CATEGORY[Util.file_extension(SharingModel.filename).toLowerCase()]||"file"})})},_get_shmodal_title:function(){var a=this;return this.generate_title_content(this._get_shmodal_title_text(),(function(){return a.show_send_content()}),(function(){return a.show_fb_content()}),(function(){return a.show_twitter_content()}))},generate_title_content:function(a,f,c,i){var b,e,j,g,d,h;d=new Element("div",{id:"shmodal-title-text"});d.__date(a);j=new Element("a",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});j.__date(Sprite.make("web","email_20"));j.observe("click",f);e=new Element("a",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});e.__date(Sprite.make("web","fb_20"));e.observe("click",c);h=new Element("a",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});h.__date(Sprite.make("web","twitter_20"));h.observe("click",i);b=new Element("div",{"class":"clear"});g=new Element("div",{id:"shmodal-title"});g.__sert(d);g.__sert(j);g.__sert(e);g.__sert(h);g.__sert(b);return g},_get_shmodal_title_text:function(){var b,a;if(this.is_folder){b=_("Share link to '%(folder_name)s'");return b=b.format({folder_name:this.filename.em_snippet(15)})}else{a=this._get_thumbnail_type();if(a){return _("Share this %(type)s").format({type:a})}else{return _("Share '%(filename)s'").format({filename:this.filename.em_snippet(18)})}}},_get_thumbnail_type:function(){var b,a;if(this.filename.indexOf(".")===-1){return false}a=Util.file_extension(this.filename).toLowerCase();b=BrowseFile.EXTENSION_TO_CATEGORY[a];if(b&&(b==="IMAGE"||b==="VIDEO")){return BrowseFile.CATEGORY_TO_TRANSLATION[b]}return false},_populate_twitter_info:function(b){var c,a;c=this.is_folder?_("Just shared some files using @Dropbox"):(a=this._get_thumbnail_type(),a&&a===BrowseFile.CATEGORY_TO_TRANSLATION.IMAGE?_("Just shared an image using @Dropbox"):_("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(c+" "+b);Util._track_twitter_chars_left("shmodal-twitter-post-input",140);if(Twitter.has_authed){return Twitter.get_user_info(function(d){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:d.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(d.name);$("shmodal-twitter-profile").down(".username").__date("@"+d.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()})}},show_filepicker:function(){$j(document).on(NativeFilepicker.PUBLISH_EVT,this._filepicker_add_paths.bind(this));$j(document).on(NativeFilepicker.CLOSE_EVT,this._filepicker_close.bind(this));Modal.show("",$("filepicker-container"),{},false,660);return Filepicker.set_mode("photos")},_filepicker_add_paths:function(b,a){var c,d=this;c=a.fq_paths;return new Ajax.DBRequest("/collection_add",{parameters:{collection_gid:this.album_gid,fq_paths:Util.to_json(c)},onSuccess:function(e){Notify.server_success("Successfully added!");$j(document).off(NativeFilepicker.PUBLISH_EVT);$j(document).off(NativeFilepicker.CLOSE_EVT);Modal.hide();return window.location.reload()}})},_filepicker_close:function(a){$j(document).off(NativeFilepicker.PUBLISH_EVT);$j(document).off(NativeFilepicker.CLOSE_EVT);return Modal.hide()},download_zip:function(d){var b,c,e,a,g,f=this;b=d.target.getAttribute("data-dl-link");g=d.target.getAttribute("data-test-link");a=d.target.getAttribute("data-owner")==="true";e=function(h){var i;if(h==="True"){window.location=b}else{if(h.indexOf("err:")===0){if(a){i=_("The zip file is too large.")}else{i=_("The zip file is too large, please add it to your Dropbox.")}Notify.server_error(i)}else{Notify.server_error(_("Failed to download zip file."))}}return false};c=function(h){Notify.server_error(_("Failed to download zip file."));return false};if(g&&$j.support.cors===true){$j.ajax({url:g,type:"GET",success:e,error:c})}else{window.location=b}return false},show_c2d_modal:function(){var c,b,f,e,d,a;if(this.is_album){e=_("Copy '%(filename)s' to my Dropbox");DomUtil.fillVal(_("The photos and videos in this album will be instantly copied to your Dropbox and downloaded to all the computers linked to your account."),"c2d-desc");DomUtil.fillVal(_("Once you register for Dropbox, the photos and videos in this album will be instantly copied to your Dropbox and downloaded to all the computers linked to your account."),"c2d-create-account-desc");DomUtil.fillVal(_("Once you sign in to Dropbox, the photos and videos in this album will be instantly copied to your Dropbox and downloaded to all the computers linked to your account."),"c2d-login-desc");if((d=$("c2d-submit-button"))!=null){d.setValue(_("Copy photos to my Dropbox"))}}else{e=_("Add '%(filename)s' to my Dropbox");if(this.is_folder){b=_("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.");c=_("Once you register for Dropbox, this folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.");f=_("Once you sign in to Dropbox, this folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{b=_("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.");c=_("Once you register for Dropbox, this file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.");f=_("Once you sign in to Dropbox, this file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}DomUtil.fillVal(b,"c2d-desc");DomUtil.fillVal(c,"c2d-create-account-desc");DomUtil.fillVal(f,"c2d-login-desc");if((a=$("c2d-submit-button"))!=null){a.setValue(_("Add to my Dropbox"))}}e=e.format({filename:this.filename.snippet(30)});return Modal.icon_show("dropbox_32",e,$("c2d-modal"))},c2d_register:function(b){var a,c,d=this;b.preventDefault();a=$("c2d-register-form");c=function(f){var e;e=Util.from_json(f.responseText);Constants.TOKEN=e.csrf_token;return d.do_c2d()};return Forms.ajax_submit(a,"/ajax_register",c,false,$(a).down("input[type=submit]"))},c2d_login:function(c){var b,a,d,f=this;c.preventDefault();b=$("c2d-login-form");d=function(g){var e;e=Util.from_json(g.responseText);switch(e.status){case"OK":Constants.TOKEN=e.csrf_token;return f.do_c2d();case"TWOFACTOR":return f.show_c2d_twofactor(e.last_four_digits);case"SSO":return window.location=e.sso_url}};a=this.c2d_show_twofactor_error500.bind(this);return Forms.ajax_submit(b,"/ajax_login",d,a,$(b).down("input[type=submit]"))},show_c2d_twofactor:function(a){$("c2d-login").hide();if(a){$("c2d-twofactor-login").addClassName("sms");DomUtil.fillVal(a,"last-four-digits")}else{$("c2d-twofactor-login").removeClassName("sms")}$("c2d-resend-link").observe("click",this.c2d_resend_phone_code.bind(this));return $("c2d-twofactor-login").show()},hide_c2d_twofactor:function(){$("c2d-twofactor-login").hide();return $("c2d-login").show()},c2d_resend_phone_code:function(){var a=this;if(this.c2d_is_resending()){return}this.c2d_show_resending();return new Ajax.DBRequest("/twofactor_resend",{onSuccess:function(b){switch(b.responseText.strip()){case"OK":return Notify.server_success(_("We sent you another code. Keep in mind that it might take a few minutes."));case"UNREACHABLE":return a.c2d_show_twofactor_error_unreachable();case"BADCARRIER":return a.c2d_show_twofactor_error_bad_carrier();case"INVALIDNUMBER":return a.c2d_show_twofactor_error_invalid_number();case"NOTAMOBILE":return a.c2d_show_twofactor_error_not_a_mobile();case"EXPIRED":a.hide_c2d_twofactor();return Notify.server_error(_("Sorry, your phone code has expired. Please log in again."))}},onFailure:this.c2d_show_twofactor_error500.bind(this),cleanUp:this.c2d_hide_resending_with_delay.bind(this)})},c2d_twofactor_login:function(c){var b,a,d,f=this;c.preventDefault();if(!$("c2d-twofactor-code").getValue()){this.c2d_show_twofactor_error_invalid();return}b=$("c2d-twofactor-login-form");d=function(g){var e;e=Util.from_json(g.responseText);switch(e.status){case"OK":Constants.TOKEN=e.csrf_token;return f.do_c2d();case"INVALID":return f.c2d_show_twofactor_error_invalid();case"EXPIRED":f.hide_c2d_twofactor();return Notify.server_error(_("Sorry, your phone code has expired. Please log in again."))}};a=this.c2d_show_twofactor_error500.bind(this);return Forms.ajax_submit(b,"/ajax_verify_code",d,a)},do_c2d:function(a){var b=this;if(a!=null){a.preventDefault()}Modal.hide();return new Ajax.DBRequest("/sm/c2d",{parameters:this.c2d_vars,job:this.is_folder,progress_text:_("Copying to your Dropbox..."),onSuccess:function(c){if(c.responseText&&c.responseText[0]==="/"){return window.location.href=c.responseText}}})},c2d_show_twofactor_error:function(b){var a;a=$("c2d-twofactor-error");a.__date(b);return a.show()},c2d_hide_twofactor_error:function(a){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(_("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(_("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(_("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(_("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(_("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(_("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var ShmodalPanes;ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",_("Share on Facebook"),_("Share on Twitter")],_focus_str:["shmodal-new-collab-input","shmodal-fb-post-input","shmodal-twitter-post-input"],to_content_str:function(a){return this._content_str[a]},to_toggle_str:function(a){return this._toggle_str[a]},to_title_str:function(a){if(a===0){return SharingModel._get_shmodal_title_text()}return this._title_str[a]},to_focus_str:function(a){return this._focus_str[a]}};var Foshmodal,FoshmodalPanes;FoshmodalPanes=Object.clone(ShmodalPanes);FoshmodalPanes.to_title_str=function(){var a,b,f,d,e,c;if(Foshmodal.sharing_collection){d=Foshmodal.collection_to_share.name.em_snippet(18,1);return _("Share '%(snippeted_name)s'").format({snippeted_name:d})}else{a=Foshmodal._selection;c=PhotosUtil.categorize_files(a),b=c[0],f=c[1];if(b&&f){e=ungettext("Share %(file_count)s item","Share %(file_count)s items",a.length)}else{if(b){e=ungettext("Share %(file_count)s photo","Share %(file_count)s photos",a.length)}else{e=ungettext("Share %(file_count)s video","Share %(file_count)s videos",a.length)}}e=e.format({file_count:a.length});return e}};Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:FoshmodalPanes.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=FoshmodalPanes.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;PhotosSelection.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();$j(".link-image").attr("src","static/images/empty_album_big.png");Forms.remove_loading($j("#modal").find(".tokenizer-submit-button")[0]);Forms.remove_loading($j("#modal").find(".foshmodal-copy-link")[0]);Forms.remove_loading($j("#shmodal-twitter-post-submit")[0]);return Forms.remove_loading($j("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(a){var b;assert(this._selection.length,"This should never be called with an empty selection");assert(this.current_tkey!=null,"Missing tkey");assert(this.current_shmodel_url!=null,"Missing shmodel url");assert(this.current_short_url!=null,"Missing short url");assert(a!=null,"Missing collection info");a.is_anonymous=this.creating_anonymous_collection();a.share_tkey=this.current_tkey;a.shmodel_url=this.current_shmodel_url;a.short_url=this.current_short_url;return b=new PhotoCollection(a)},set_shmodel_url:function(c,a){var b=this;if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof c==="function"?c():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:function(e){var d;d=Util.from_json(e.responseText);b.current_shmodel_url=d.token_link;b.current_short_url=d.short_link;b.current_tkey=d.tkey;if(typeof c==="function"){c()}return typeof b.callback_for_when_we_have_shmodel_url==="function"?b.callback_for_when_we_have_shmodel_url():void 0},onFailure:function(){return typeof a==="function"?a():void 0}})}},attach_collection_to_token:function(b,a){assert(this.collection_to_share!=null,"Should get called only when there is an existing collection");assert(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof b==="function"){b(this.collection_to_share.gid)}return}assert(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,b,a)},create_collection_and_attach_to_token:function(g,a){var c,e,d,b,f=this;assert(this.sharing_collection===false,"Should not get called when we already have a collection");assert(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");e=function(h){var i;i=Util.from_json(h.responseText);f.create_album_from_selected_photos(i);return typeof g==="function"?g(i.gid):void 0};c=function(h){return typeof a==="function"?a(h):void 0};d={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:Util.to_json((function(){var k,i,j,h;j=this._selection;h=[];for(k=0,i=j.length;k<i;k++){b=j[k];h.push(b.item_counter)}return h}).call(this))};if(Photos.in_single_collection_view()){d.source_collection_gid=Photos.get_current_collection().gid}return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:e,onFailure:c,parameters:d})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){Notify.server_error(_("Please enter a name for this album"));this.unlock();return true}if(PhotosCollections.collection_name_in_use(this.current_album_name)){Notify.server_error(_("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(c){var b,a,d=this;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}b=$("shmodal-send-form");assert(b,"Couldn't find the shmodal send form.");if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}a=function(e){d.unlock();if(!e.responseText.startsWith("err:")){Notify.server_error(_("We couldn't send this album. Please try again."));Modal.hide();return d.refresh()}};if(this.sharing_collection){this.send_collection(b,a)}else{this.send_selection(b,a)}return PhotosLogger.log_interaction(PhotosEvents.SEND,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var d,b,c,a,e;d=this.get_current_display_name();a=SharingModel.get_shmodel_send_recipients($("shmodal-send-form"));b=a[0].split(" ")[0];if(a.length===1){e=_("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:d,first_name_of_recipient:b})}else{if(a.length===2){c=a[1].split(" ")[0];e=_("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:d,first_name_of_recipient:b,first_name_of_second_recipient:c})}else{e=_("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:d,first_name_of_recipient:b,num_other_recipients:a.length-1})}}return e},send_selection:function(c,b){var e,d,a,f=this;e=function(g){var h;h=Util.from_json(g.responseText);f.create_album_from_selected_photos(h);Notify.server_success(f.get_send_success_text());f.refresh();return Modal.hide()};d={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:Util.to_json((function(){var j,h,i,g;i=this._selection;g=[];for(j=0,h=i.length;j<h;j++){a=i[j];g.push(a.item_counter)}return g}).call(this))};if(Photos.in_single_collection_view()){d.source_collection_gid=Photos.get_current_collection().gid}if(this.creating_anonymous_collection()){d.collection_name=""}else{if(this.current_album_name.trim().length===0){d.collection_name=PhotosCollections.get_default_album_name()}}return Forms.ajax_submit(c,"/collection_create_and_send_link",e,b,c.down(".tokenizer-submit-button"),d)},send_collection:function(b,a){var c,d=this;assert(this.current_tkey!=null,"tkey should be set");assert(this.current_shmodel_url!=null,"shmodel url should be set");c=function(){Notify.server_success(d.get_send_success_text());Modal.hide();return d.refresh()};return this.collection_to_share.send_link(b,this.current_tkey,this.current_shmodel_url,this.current_short_url,c,a)},get_link_button_onclick:function(){var a,c,b,d=this;if(!this.lock()){return}if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}b=$("modal").down(".tokenizer-submit-button");c=function(f){var e;e=d.get_current_display_name();if(FlashDetect.installed){Notify.server_success(_("The link to %(album_name)s was copied to your clipboard").format({album_name:e}))}d.show_get_link_modal(d.current_shmodel_url,e,f);ViralLogger.log(Constants.uid,"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(d.collection_to_share!=null){AlbumsLogger.log_share("share_link",f,d.num_photos_to_share,d.creating_anonymous_collection(),!d.sharing_collection)}return d.refresh()};a=function(e){d.unlock();Forms.remove_loading(b);if(!e.responseText.startsWith("err")){Notify.server_error(_("We couldn't create a link to this album. Please try again."));Modal.hide();return d.refresh()}};if(this.sharing_collection){Forms.add_loading(b);this.attach_collection_to_token(c,a)}else{if(this.alert_if_album_name_invalid()){return}Forms.add_loading(b);this.create_collection_and_attach_to_token(c,a)}return PhotosLogger.log_interaction(PhotosEvents.GET_LINK,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var b,a,c=this;if(FlashDetect.installed){a=Util.copy_to_clipboard_swf(this.current_shmodel_url,"foshmodal-copy-link","Foshmodal.get_link_button_onclick");$(a).up().style.zIndex="1001";clearInterval(this.follow_freshbutton);b=function(){return $j("#"+a).parent().clonePosition($j("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})};return this.follow_freshbutton=setInterval(b,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(a){var b=this;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this);return}if(FacebookOAuth.has_authed){this.do_fb_post()}else{setTimeout(this.unlock.bind(this),750);FacebookOAuth.do_auth((function(){return b.do_fb_post()}))}return PhotosLogger.log_interaction(PhotosEvents.FB_SHARE,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(a){var b=this;if(!this.lock()){return}if(!(this.current_shmodel_url!=null)){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(Twitter.has_authed){this.do_twitter_post()}else{setTimeout(this.unlock.bind(this),750);Twitter.do_auth((function(){return b.do_twitter_post()}))}return PhotosLogger.log_interaction(PhotosEvents.TWITTER_SHARE,PhotosTriggers.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(){var a,b,c=this;b=function(e){var d;FacebookOAuth.custom_show_posting=function(){return Forms.add_loading($("shmodal-fb-post-submit"))};FacebookOAuth.progress_container=$("modal").down(".modal-buttons");d=c.get_current_display_name();FacebookOAuth.custom_show_complete=function(){Modal.hide();Notify.server_success(_("Shared %(album_name)s on Facebook").format({album_name:d}));return c.refresh()};FacebookOAuth.post($F("shmodal-fb-post-input"),c.current_shmodel_url);ViralLogger.log(Constants.uid,"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return AlbumsLogger.log_share("share_facebook",e,c.num_photos_to_share,c.creating_anonymous_collection(),!c.sharing_collection)};a=function(){Notify.server_error(_("We couldn't share this album on Facebook. Please try again."));Modal.hide();return c.refresh()};if(this.sharing_collection){return this.attach_collection_to_token(b,a)}else{return this.create_collection_and_attach_to_token(b,a)}},do_twitter_post:function(){var c,a,b,d=this;c=$F("shmodal-twitter-post-input");if(!c){Notify.server_error(_("Please enter a tweet"));this.unlock();return}if(c.length>140){Notify.server_error(_("Your tweet must be 140 characters or less"));this.unlock();return}b=function(e){Twitter.custom_show_posting=function(){$("twitter-chars").hide();return Forms.add_loading($("shmodal-twitter-post-submit"))};Twitter.custom_post(c,function(){Modal.hide();Notify.server_success(_("Posted your tweet"));return d.refresh()});ViralLogger.log(Constants.uid,"shmodel","send",{src:"photo_twitter",file_type:"collection"});return AlbumsLogger.log_share("share_twitter",e,d.num_photos_to_share,d.creating_anonymous_collection(),!d.sharing_collection)};a=function(){Notify.server_error(_("We couldn't share this album on Twitter. Please try again."));Modal.hide();return d.refresh()};if(this.sharing_collection){return this.attach_collection_to_token(b,a)}else{return this.create_collection_and_attach_to_token(b,a)}},show_get_link_modal:function(b,a,c){var d;Modal.show(_("Link to %(album_name)s").format({album_name:a.escapeHTML()}),$("get-link-modal"));d=$("get-link-modal").down(".link-input");d.setValue(b);d.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(b,"_blank");return Modal.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(c!=null){PhotosCollections.flash_sidebar_album(c)}return Modal.hide()}},update_current_album_name_text:function(a){this.current_album_name=$(FoshmodalPanes.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===FoshmodalPanes.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(e){var b,d,c,a;if(e){if(this.num_photos_to_share===1){b=e}else{b=_("%(album_name_text)s (%(album_desc)s)").format({album_name_text:e,album_desc:PhotosUtil.album_desc(Foshmodal.collection_to_share)})}}else{a=this.sharing_collection?Photos.get_timeline().get_photos():this._selection;if(a.length===1){c=a[0];if(c.preview_type==="photo"){d=_("Photo from %(date_taken)s")}else{d=_("Video from %(date_taken)s")}b=d.format({date_taken:Util.niceDateWithMonthName(new Date(c.time_taken),true,true,true)})}else{b=PhotosUtil.file_desc(a)}}return $(FoshmodalPanes.to_content_str(FoshmodalPanes.FB)).down(".link-name").__date(b)},set_current_album_name_text:function(b,a){$(FoshmodalPanes.to_content_str(b)).down(".album-name-input").value=a;if(b===FoshmodalPanes.FB){return this.set_fb_post_title(a)}},show_content:function(e){var b,d,a,c;if(this.working){return}$("shmodal-title-text").__date(FoshmodalPanes.to_title_str());c=FoshmodalPanes.list;for(d=0,a=c.length;d<a;d++){b=c[d];if(b!==e){$(FoshmodalPanes.to_toggle_str(b)).removeClassName("toggled");$(FoshmodalPanes.to_content_str(b)).hide()}}$(FoshmodalPanes.to_content_str(e)).show();$(FoshmodalPanes.to_toggle_str(e)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(e,this.current_album_name)}switch(e){case FoshmodalPanes.FB:$("shmodal-fb-post-input").focus();break;case FoshmodalPanes.TWITTER:$("shmodal-twitter-post-input").focus();break;case FoshmodalPanes.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=e},_get_foshmodal_title:function(){var a=this;return SharingModel.generate_title_content(FoshmodalPanes.to_title_str(),(function(){return a.show_content(FoshmodalPanes.SEND)}),(function(){return a.show_content(FoshmodalPanes.FB)}),(function(){return a.show_content(FoshmodalPanes.TWITTER)}))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return PhotosUtil.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var a,c,b,e,d;a=this.sharing_collection?Photos.get_timeline().get_photos():this._selection;if(a.length===1){d=PhotosUtil.categorize_files(a),b=d[0],e=d[1];if(b){c=_("Just shared a photo using @Dropbox")}else{if(e){c=_("Just shared a video using @Dropbox")}else{assert(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{c=_("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+c+" "+this.current_short_url)},update_shmodal_image_text:function(){var h,k,j,f,e,i,a,g,d,c,b;if(this.sharing_collection){k=this.collection_to_share.num_items;j=PhotosUtil.album_desc(this.collection_to_share,false,true)}else{k=this._selection.length;j=PhotosUtil.file_desc(this._selection,false,true)}if(k>1){g=$$(".shmodal-image");c=[];for(f=0,i=g.length;f<i;f++){h=g[f];h.down("span").__date(j);c.push(h.down(".share-file-count").show())}return c}else{d=$$(".shmodal-image");b=[];for(e=0,a=d.length;e<a;e++){h=d[e];b.push(h.down(".share-file-count").hide())}return b}},show:function(i,q){var j,n,o,k,p,g,f,d,m,b,a,h,e,c,l=this;this.unlock();Modal.onHide=function(){var s,r;if((s=$("flash_copy_container"))!=null){s.remove()}if((r=l.send_link_autocompleter)!=null){r.hide()}$j("#modal").find(".new-collab-input").val("");clearInterval(l.follow_freshbutton);Photos.disable_selection();delete Modal.onHide;return Modal.hide()};this.sharing_collection=q;p=this.sharing_collection?i.thumbnail_url_256:i[0].thumbnail_url;h=$$(".link_image");for(g=0,m=h.length;g<m;g++){n=h[g];if(p!=null){n.src=p}else{n.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=FoshmodalPanes.SEND;this.have_real_tkey=this.sharing_collection&&(i.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=i;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=i.sort(function(s,r){return s.time_taken-r.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");e=$$(".save-as-album-checkbox");for(f=0,b=e.length;f<b;f++){j=e[f];j.checked=false;k=function(z){var A,w,u,s,r,v,t,y,x;if(z.target.checked){$("shmodal").addClassName("saving-as-album");l.current_album_name=l.previous_album_name||PhotosCollections.get_default_album_name();l.set_current_album_name_text(l.current_foshmodal_pane,l.current_album_name);A=$(FoshmodalPanes.to_content_str(l.current_foshmodal_pane)).down(".album-name-input");A.focus();A.select();v=$$(".save-as-album-checkbox");y=[];for(w=0,s=v.length;w<s;w++){j=v[w];y.push(j.checked=true)}return y}else{$("shmodal").removeClassName("saving-as-album");l.previous_album_name=l.current_album_name;l.current_album_name="";l.set_current_album_name_text(l.current_foshmodal_pane,l.current_album_name);t=$$(".save-as-album-checkbox");x=[];for(u=0,r=t.length;u<r;u++){j=t[u];x.push(j.checked=false)}return x}};j.observe("change",k);if($j.browser.msie&&parseInt($j.browser.version,10)<9){j.observe("click",k)}}c=$$(".album-name-input");for(d=0,a=c.length;d<a;d++){o=c[d];o.observe("keyup",this.update_current_album_name_text.bind(this))}}Photos.enable_selection();Modal.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url((function(){l.initialize_get_link_button();return l.set_twitter_message()}),(function(){Notify.server_error(_("This request could not be completed.  Please try again."));return Modal.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer("foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",Sharing.contacts,Sharing.lcontacts,{tokens:[",",";"],include_fb:true,include_team:true,include_groups:Photos.show_groups})}this.send_link_autocompleter.clearTokens();ActAsBlock.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return Util._track_twitter_chars_left("shmodal-twitter-post-input",140)}};var ContactImporter,Contacts,EmailProvider,init_connected_services,_this=this;EmailProvider={GOOGLE:"-1",YAHOO:"-2",OUTLOOK:"-3",FACEBOOK:"-4",TWITTER:"-5",VARIOUS:"-6",NONE:"-7",services:function(){return[this.GOOGLE,this.YAHOO,this.OUTLOOK,this.FACEBOOK,this.TWITTER]},contact_services:function(){return[this.GOOGLE,this.YAHOO,this.FACEBOOK]},to_img:function(a){switch(a){case this.GOOGLE:return"/static/images/icons/gmail_logo28.png";case this.YAHOO:return"/static/images/icons/yahoo_mail_logo28.png";case this.OUTLOOK:return"/static/images/icons/hotmail_logo28.png";case this.FACEBOOK:return"/static/images/icons/facebook_logo28.png";default:return assert(false,"Should never get EmailProvider.to_img with provider: "+a)}},to_name:function(a){switch(a){case this.GOOGLE:return _("Gmail");case this.YAHOO:return _("Yahoo! Mail");case this.OUTLOOK:return _("Outlook.com");case this.FACEBOOK:return _("Facebook");case this.VARIOUS:return _("Email");default:return assert(false,"Should never get EmailProvider.to_name with provider: "+a)}}};ContactImporter={toggle:null,refresh:null,suggestions_enabled:false,modal_show:function(a){if(a){this.import_done_callback=a}else{assert(this.import_done_callback,"You must set ContactImporter.import_done_callback prior to calling ContactImporter.show()")}return Modal.show("",$("contact-importer"))},modal_import_done:function(){return typeof this.import_done_callback==="function"?this.import_done_callback():void 0}};init_connected_services=function(){var c,a,e,b,d;c={};d=EmailProvider.services();for(e=0,b=d.length;e<b;e++){a=d[e];c[""+a]=true}return c};Contacts={contacts_to_import:EmailProvider.NONE,connected_services:init_connected_services(),ask_to_import:function(){var a,d,b,c;c=EmailProvider.contact_services();for(d=0,b=c.length;d<b;d++){a=c[d];if(!this.connected_services[a]){return true}}return false},set_contacts_to_import:function(){var a,b=this;if(!Constants.shmodal_contact_importer_enabled){return this.contacts_to_import=EmailProvider.VARIOUS}a=function(){var e,c,d;e=/@(.+?)\./g;c=e.exec(Constants.email);if(c&&c.length>1){if(c[1]==="gmail"&&!b.connected_services[EmailProvider.GOOGLE]){return b.contacts_to_import=EmailProvider.GOOGLE}else{if(((d=c[1])==="yahoo"||d==="ymail"||d==="rocketmail")&&!b.connected_services[EmailProvider.YAHOO]){return b.contacts_to_import=EmailProvider.YAHOO}else{return b.contacts_to_import=EmailProvider.VARIOUS}}}};new Ajax.DBRequest("/contacts/connected_services",{onSuccess:function(c){b.connected_services=Util.from_json(c.responseText);return a()},onFailure:function(){var c,f,d,e;b.connected_services={};e=EmailProvider.services();for(f=0,d=e.length;f<d;f++){c=e[f];b.connected_services[""+c]=true}return a()}});return new Ajax.DBRequest("/contacts/get_importer_suggestions_pref",{onSuccess:function(c){return ContactImporter.suggestions_enabled=c.responseText==="True"}})},google_auth_complete:function(f,h){var e,b,g,d,a,c;if(f){Sharing.load_contacts(true,null,true);Notify.server_success(_("Imported Gmail contacts"));e=$("auth_gmail");b=$("deauth_gmail");e&&e.hide();b&&b.show();Contacts.connected_services[EmailProvider.GOOGLE]=true;if(!Contacts.ask_to_import()){c=$$(".import-contacts-link");for(d=0,a=c.length;d<a;d++){g=c[d];g.hide()}}}else{if(h){Notify.server_error(h)}else{Notify.server_error(_("We need your permission to import your Gmail contacts"))}}_this.contacts_to_import=EmailProvider.VARIOUS;ContactImporter.modal_import_done();return typeof ContactImporter.refresh==="function"?ContactImporter.refresh():void 0},facebook_auth_complete:function(e,g){var f,d,b,c,a;if(e){FacebookOAuth.has_authed=1;Sharing.load_contacts(true,null,true);Contacts.connected_services[EmailProvider.FACEBOOK]=true;if(FacebookOAuth.onLoginSuccessCallback!=null){FacebookOAuth.onLoginSuccessCallback();FacebookOAuth.onLoginSuccessCallback=null}if($("modal").visible()){Notify.server_success(_("Successfully connected to Facebook."));if((c=$("contact-import-buttons"))!=null?c.visible():void 0){ContactImporter.modal_import_done();return}if(!Contacts.ask_to_import()){a=$$(".import-contacts-link");for(d=0,b=a.length;d<b;d++){f=a[d];f.hide()}}return typeof ContactImporter.refresh==="function"?ContactImporter.refresh():void 0}else{if(DBHistory.get_url().startsWith("/account")){return new Ajax.DBRequest("/fb/get_fb_profile",{onSuccess:function(h){var i,j;i=Util.from_json(h.responseText);j=i.username?i.username:'"'+i.name+'"';$j("#facebook_username").html("&nbsp;"+j);$j("#auth_facebook").hide();return $j("#deauth_facebook").show()}})}}}else{if(g){return Notify.server_error(g)}else{return Notify.server_error(_("In order to connect your Facebook account, Dropbox needs permission to post on your behalf."))}}},yahoo_auth_complete:function(e,h){var a,g,f,d,b,c;if(e){Sharing.load_contacts(true,null,true);Notify.server_success(_("Imported Yahoo! Mail contacts"));a=$("auth_yahoo_mail");g=$("deauth_yahoo_mail");a&&a.hide();g&&g.show();Contacts.connected_services[EmailProvider.YAHOO]=true;if(!Contacts.ask_to_import()){c=$$(".import-contacts-link");for(d=0,b=c.length;d<b;d++){f=c[d];f.hide()}}}else{if(h){Notify.server_error(h)}else{Notify.server_error(_("We need your permission to import your Yahoo! Mail contacts"))}}_this.contacts_to_import=EmailProvider.VARIOUS;ContactImporter.modal_import_done();return typeof ContactImporter.refresh==="function"?ContactImporter.refresh():void 0},outlook_auth_complete:function(f,h){var c,b,g,e,a,d;if(f){Sharing.load_contacts(true,null,true);Notify.server_success(_("Imported Outlook.com contacts"));c=$("auth_outlook_mail");b=$("deauth_outlook_mail");c&&c.hide();b&&b.show();Contacts.connected_services[EmailProvider.OUTLOOK]=true;if(!Contacts.ask_to_import()){d=$$(".import-contacts-link");for(e=0,a=d.length;e<a;e++){g=d[e];g.hide()}}}else{if(err_msg){Notify.server_error(err_msg)}else{Notify.server_error(_("We need your permission to import your Outlook.com contacts"))}}_this.contacts_to_import=EmailProvider.VARIOUS;ContactImporter.modal_import_done();return typeof ContactImporter.refresh==="function"?ContactImporter.refresh():void 0},auth_import:function(b,a){if(a==null){a="none"}switch(b){case EmailProvider.GOOGLE:window.open("/google/authentry?referrer="+a,"google_auth","width=600,height=450");break;case EmailProvider.YAHOO:window.open("/yahoo/authentry?referrer="+a,"yahoo_auth","width=600,height=450");break;case EmailProvider.OUTLOOK:window.open("/outlook/authentry?referrer="+a,"outlook_auth","width=600,height=450");break;case EmailProvider.FACEBOOK:window.open("/fb/access_token","fb_auth","width=600,height=450");break;default:assert(false,"Should never get here.  Input should be an EmailProvider.")}if(a!=="contact-importer-modal"){return typeof ContactImporter.unshow==="function"?ContactImporter.unshow():void 0}},deauth_import:function(a,b){switch(a){case EmailProvider.GOOGLE:return new Ajax.DBRequest("/google/remove_contacts",{parameters:{source_id:b},onSuccess:function(c){$("auth_gmail").show();$("deauth_gmail").hide();return Notify.server_success(_("Successfully removed Gmail contacts"))},onFailure:function(){return Notify.server_error(_("We were unable to remove your Gmail contacts"))}});case EmailProvider.YAHOO:return new Ajax.DBRequest("/yahoo/remove_contacts",{onSuccess:function(c){$("auth_yahoo_mail").show();$("deauth_yahoo_mail").hide();return Notify.server_success(_("Successfully removed Yahoo! Mail contacts"))},onFailure:function(){return Notify.server_error(_("We were unable to remove your Yahoo! Mail contacts"))}});case EmailProvider.OUTLOOK:return new Ajax.DBRequest("/outlook/remove_contacts",{onSuccess:function(c){$("auth_outlook_mail").show();$("deauth_outlook_mail").hide();return Notify.server_success(_("Successfully removed Outlook.com contacts"))},onFailure:function(){return Notify.server_error(_("We were unable to remove your Outlook.com contacts"))}});default:return assert(false,"Should never get here.  Input should be an EmailProvider.")}}};var DBModal,DBModalLoading,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};DBModal=(function(){a.KEY_SCOPE="dbmodal";a.EVENT={SHOW:"dbmodal:show",HIDE:"dbmodal:hide"};a.prototype.on_show=null;a.prototype.on_hide=null;a.prototype.on_confirm_button_click=function(b){b.preventDefault();return this.hide()};a.prototype.on_cancel_button_click=function(b){b.preventDefault();return this.hide()};function a(b){var c;this.options=b;this.hide=__bind(this.hide,this);this.show=__bind(this.show,this);this.__fix_position=__bind(this.__fix_position,this);this.__keydown_handler=__bind(this.__keydown_handler,this);this.__x_click_handler=__bind(this.__x_click_handler,this);this.on_cancel_button_click=__bind(this.on_cancel_button_click,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.$template=$j("#db-modal-"+this.options.element_id);c=this.$template.find(".db-modal");assert(this.$template.length,"Missing DBModal pyxl element for '"+this.options.element_id+"'");assert(this.$template.length===1,"DBModal pyxl element for '"+this.options.element_id+"' shouldn't be included more than once on a      page");if(this.options.focus){if(this.options.focus==="confirm"){assert(c.find(".confirm-button").length,"DBModal pyxl element is missing a confirm button to focus")}else{if(this.options.focus==="cancel"){assert(c.find(".cancel-button").length,"DBModal pyxl element is missing a cancel button to focus")}else{assert(c.find(this.options.focus).length,"DBModal pyxl element is missing focus element with selector '"+this.options.focus+"'")}}}if(this.on_show===!null){assert(typeof this.on_show==="function","'on_confirm_button_click' must be a function")}if(this.on_hide===!null){assert(typeof this.on_hide==="function","'on_confirm_button_click' must be a function")}if(this.on_confirm_button_click===!null){assert(typeof this.on_confirm_button_click==="function","'on_confirm_button_click' must be a function");assert(c.find(".confirm-button").length,"Couldn't find confirm button element in DBModal pyxl element")}if(this.on_cancel_button_click===!null){assert(typeof this.on_cancel_button_click==="function","'on_cancel_button_click' must be a function");assert(c.find(".cancel-button").length,"Couldn't find cancel button element in DBModal pyxl element")}if(this.options.vars){this.vars=this.options.vars}this.click_out_to_close=true;if(this.options.click_out_to_close===false){this.click_out_to_close=false}this.prev_key_scope=null;this.vertical_offset=90;this}a.prototype.__show_modal=function(){if(!this.$modal_window){this.$modal_window=this.$template.clone().attr("id",this.options.element_id);this.$overlay=this.$modal_window.find(".db-modal-overlay")}$j("body").prepend(this.$modal_window);this.$modal_window.show();return this.__fix_position()};a.prototype.__x_click_handler=function(b){b.preventDefault();return this.hide()};a.prototype.__tabbable_elements=function(){var b,h,f,g,d,k,e,l,c,j;e=this.$modal_window.find(".db-modal").find(":tabbable");assert(e.length,'"dbmodal-x" should be in tabbable_elms');l=(function(){var n,m,i;i=[];for(n=0,m=e.length;n<m;n++){f=e[n];if(parseInt($j(f).attr("tabindex"))>-1){i.push(f)}}return i})();if(l.length){k=function(m,i){var n,o;n=parseInt($j(m).attr("tabindex"),10);o=parseInt($j(i).attr("tabindex"),10);if(n<o){return -1}if(n>o){return 1}return 0};l.sort(k);g=-1;for(c=0,j=l.length;c<j;c++){f=l[c];d=e.index(f);if(g===-1){g=d}e.splice(d,1)}assert(g>-1,"First index should be set");h=e.slice(0,g);b=e.slice(g);e=$j.merge(h,l);e=$j.merge(e,b)}return e};a.prototype.__keydown_handler=function(f){var d,c,b,g;if(f.keyCode===27||(f.keyCode===8&&!Util.focus_in_input())){f.preventDefault();this.hide()}if(f.keyCode===9){f.preventDefault();d=this.__tabbable_elements();c=d.index($j(f.target));if(c<0){if(this.focus_element){return $j(this.focus_element).focus()}if(f.shiftKey){g=d.last()}else{g=d.first()}return g.focus()}if(c>-1){if(f.shiftKey){b=-1}else{b=1}g=(c+b)%d.length;return d.get(g).focus()}}};a.prototype.__fix_position=function(h){var f,c,d,b,g;f=this.$modal_window.find(".db-modal");g=f.width();c=f.height();d=$j(document).scrollTop()+this.vertical_offset;b="absolute";if(c+this.vertical_offset<$j(window).height()){b="fixed"}return f.css({margin:"0 0 0 "+(Math.floor(-g/2).toString())+"px",position:b,top:this.vertical_offset})};a.prototype.__listen=function(){if(this.click_out_to_close!==false){this.$overlay.on("click",this.hide)}this.$db_modal_x=this.$modal_window.find(".db-modal-x");this.$db_modal_x.on("click",this.__x_click_handler);$j(document).on("keydown",this.__keydown_handler);return this.__listen_buttons()};a.prototype.__listen_buttons=function(){if(this.on_confirm_button_click!==null){this.$confirm_button=this.$modal_window.find(".confirm-button");this.$confirm_button.on("click",this.on_confirm_button_click)}if(this.on_cancel_button_click!==null){this.$cancel_button=this.$modal_window.find(".cancel-button");return this.$cancel_button.on("click",this.on_cancel_button_click)}};a.prototype.__unlisten=function(){if(this.click_out_to_close!==false){this.$overlay.off("click")}this.$db_modal_x.off("click");$j(document).off("keydown",this.__keydown_handler);if(this.on_confirm_button_click!==null){this.$confirm_button.off("click")}if(this.on_cancel_button_click!==null){return this.$cancel_button.off("click")}};a.prototype.__focus=function(){var b,c,d;b=this.$modal_window.find(".db-modal");if(this.options.focus==="confirm"){this.focus_element=b.find(".confirm-button").first()}else{if(this.options.focus==="cancel"){this.focus_element=b.find(".cancel-button").first()}else{if(this.options.focus){this.focus_element=b.find(this.options.focus).first()}else{this.focus_element=b.focus();if(!Util.ie){c=b.find("input[type=button]").first();if(c.length){this.focus_element=c}d=b.find("input[type=submit]").first();if(d.length){this.focus_element=d}}}}}return this.focus_element.focus()};a.prototype.show=function(){if(this.visible){return}this.__show_modal();this.__listen();this.visible=true;if(key.getScope()!==this.constructor.KEY_SCOPE){this.prev_key_scope=key.getScope()}key.setScope(this.constructor.KEY_SCOPE);this.__focus();if(this.on_show!==null){this.on_show()}$j(document).trigger($j.Event(this.constructor.EVENT.SHOW,{DBModal:this}));return this};a.prototype.hide=function(){if(!this.visible){return}this.__unlisten();key.setScope(this.prev_key_scope);this.$modal_window.remove();this.visible=false;this.prev_key_scope=null;if(this.on_hide!==null){this.on_hide()}$j(document).trigger($j.Event(this.constructor.EVENT.HIDE,{DBModal:this}));return this};return a})();DBModalLoading=(function(b){__extends(a,b);function a(c){this.options=c;this.__change_title=__bind(this.__change_title,this);assert(this.options.endpoint_url!=null,"DBModalLoading requires an endpoint_url parameter");if(this.options.on_load!=null){assert(typeof this.options.on_load==="function","'on_load' must be a function")}a.__super__.constructor.call(this,this.options)}a.prototype.on_show=function(){var c=this;if(this.options.title!=null){this.__change_title(this.options.title)}return new Ajax.DBRequest(this.options.endpoint_url,{method:this.options.method||"post",parameters:this.options.parameters,onSuccess:function(d){c.$modal_window.find(".loading-spinner").replaceWith(d.responseText);c.__listen_buttons();if(c.on_load!==null){return c.on_load(d)}},onFailure:function(d){return c.hide()}})};a.prototype.on_load=null;a.prototype.__change_title=function(c){return this.$modal_window.find(".db-modal-title-text").text(c)};return a})(DBModal);var Forms,__hasProp={}.hasOwnProperty;Forms={submitOnlyOnce:function(){var a;a=Forms.submitted!==true;Forms.submitted=true;return a},disable:function(a){if(a){return setTimeout((function(){return a.disabled=true}),0)}},enable:function(a){if(a){return setTimeout((function(){return a.disabled=false}),0)}},enable_button:function(a){return $j(a).attr("disabled",false)},disable_button:function(a){return $j(a).attr("disabled",true)},enable_button_on_change:function(a){var b;Forms.disable_button(a);b=$j(a).closest("form");b.change(function(){return Forms.enable_button(a)});b.find("input").filter(":text").on("input",function(){return Forms.enable_button(a)});return b.find("textarea").on("input",function(){return Forms.enable_button(a)})},add_vars:function(c,d){var e,b,a;c=$(c);a=[];for(b in d){if(!__hasProp.call(d,b)){continue}e=new Element("input",{type:"hidden",name:b});e.setValue(d[b]);e.addClassName("added-vars");a.push(c.__sert(e))}return a},clear_added_vars:function(a){return $$("#"+a+" .added-vars").each(Element.remove)},mirror:function(c,b){var a;c=$(c);b=$(b);a=function(e,d){d.setValue($F(e));return d.fire("db:value_change")};if(c&&b){c.observe("keyup",function(){return a(c,b)});c.observe("db:autocompleted",function(){return a(c,b)});b.observe("keyup",function(){return a(b,c)});return b.observe("db:autocompleted",function(){return a(b,c)})}},collect_form_vars:function(d){var g,c,b,f,e,a;d=d||$(document.body);c=d.select("input").concat(d.select("textarea")).concat(d.select("select"));b={};for(e=0,a=c.length;e<a;e++){g=c[e];if(g.name&&g.name!=="t"){f=g.getValue();if(f){if(typeof f!=="string"){f=f.join(",")}if(b[g.name]!=null){if(typeof b[g.name]==="string"){b[g.name]=[b[g.name],f]}else{b[g.name].push(f)}}else{b[g.name]=f}}}}return b},add_loading:function(c,a){var b;if(c){c=$(c);b=new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"});b.addClassName("text-img ajax_submit_loading");if(a==="after"){return c.__sert({after:b})}else{return c.__sert({before:b})}}},remove_loading:function(a){return $$(".ajax_submit_loading").each(function(b){return Util.yank(b)})},ui_form_submit:function(b,a){a=a||b.action;return new UIRequest(b,a,{parameters:Forms.collect_form_vars(b)})},ajax_submit:function(d,b,m,c,k,h,l,e,a,p,f){var n,g,i,o,j;if(a==null){a=false}if(d.ajax_submitted){return false}d.ajax_submitted=true;j=d.select(".suggestion-input");for(i=0,o=j.length;i<o;i++){n=j[i];SuggestionInput.blank(n.identify())()}if(k){Forms.add_loading(k,l)}g=Forms.collect_form_vars(d);if(h){Object.extend(g,h)}new Ajax.DBRequest(b||d.action,{noAutonotify:true,parameters:g,job:e,progress_text:f,evalJSON:false,onSuccess:function(q){Forms.remove_loading();if(m&&typeof m==="function"){return m(q)}},onFailure:function(s){var q,r;if(s){if(s.responseText.indexOf("err:")===0){q=s.responseText.substr(4);if(q.indexOf("{")===0){r=q.evalJSON(true);Forms.fill_errors(d,r)}else{if(a){q=new HTML(q)}Notify.server_error(q)}}else{Notify.server_error()}Forms.remove_loading();if(c&&typeof c==="function"){return c(s)}}},onComplete:function(t){var s,r,q;q=d.select(".suggestion-input");for(s=0,r=q.length;s<r;s++){n=q[s];SuggestionInput.blur_elm(n)}d.ajax_submitted=false;if(p&&typeof p==="function"){return p(t)}}});return false},clear_errors:function(a){a=a||$(document.body);this.hide_errors(a);return a.select(".error-removable").invoke("remove")},fill_errors:function(e,d){var b,g,a,c,f;d=d||{};e=e||$(document.body);Forms.clear_errors(e);for(f in d){if(!__hasProp.call(d,f)){continue}g=e.down("[data-error-field-name='"+f+"']")||e.down("[name='"+f+"']");if(g){b=new Element("br",{"class":"error-removable"});a=new Element("span",{"class":"error-message error-removable"});c=d[f];assert(c.message_html||c.message_text,"Error message must have a message_html or message_text property");if(c.message_html){a.update(c.message_html)}else{a.__date(c.message_text)}g.__sert({before:a});g.__sert({before:b})}}return this.show_errors(e)},value:function(d){var c,b,f,e,a;b=$$('input[name="'+d+'"]');f=null;for(e=0,a=b.length;e<a;e++){c=b[e];f=$(c).getValue()||f}return f},postRequest:function(c,d,a){var b;if(d==null){d={}}if(a==null){a={}}assert(c!=null,"postRequest missing action");d.t=Constants.TOKEN;b=new Element("form",{action:c,method:"POST"});if(a.target){b.target=a.target}document.body.appendChild(b);Forms.add_vars(b,d);return b.submit()},hide_errors:function(c){var f,e,d,b,a;f=this.get_errors(c);a=[];for(d=0,b=f.length;d<b;d++){e=f[d];if(e.down("span.error-message")){a.push(e.hide())}else{a.push(void 0)}}return a},show_errors:function(b){var e,d,c,a;e=this.get_errors(b);for(c=0,a=e.length;c<a;c++){d=e[c];if(d.down("span.error-message")){d.show()}}return $j(".sick-input").find("label").css("top","")},get_errors:function(b){var c,a;a=".error-bubble, .error-plain-text";c=b?b.select(a):$$(a);return c}};Util.smartLoad(function(){return Forms.show_errors()});var ActAsBlock;ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(f,g){var d,b,c,a;if(g==null){g=document.body}c=$(g).getElementsByClassName("act_as_block");a=[];for(d=0,b=c.length;d<b;d++){f=c[d];a.push(this.resize(f))}return a},resize:function(e){var a,c,d,b;e=$(e);c=e.up();a=Util.sumStyles(e,this.elm_list);d=Util.sumStyles(c,this.parent_list);e.style.width="1px";b=c.getWidth()-a-d;if(b>0){return e.style.width=b+"px"}}};var BrowseStyleRows;BrowseStyleRows={register_all:function(){var d,c,a,b;b=$$(".bs-row");for(c=0,a=b.length;c<a;c++){d=b[c];this.register(d)}return Event.observe(document,"click",this.kill_current.bind(this))},register:function(b){var a;b=$(b);b.db_observe("mouseover",this.mouseover.bind(this));b.db_observe("mouseout",this.mouseout.bind(this));a=b.down(".action-button");if(a){return a.db_observe("click",this.click.bind(this))}},mouseover:function(b,a){return a.addClassName("hover")},mouseout:function(b,a){return a.removeClassName("hover")},click:function(d,b){var a,f,c;if(d.target.tagName==="A"){return}f=b.up(".bs-row");Event.stop(d);if(f.hasClassName("selected")){this.kill_current(false);return}this.kill_current(false);c=$(d.target);if(!c.match(".bs-actions-list *")){f.addClassName("selected")}a=(c.hasClassName("bs-row")?c:c.up(".bs-row"));return a.style.zIndex=9},kill_current:function(f){var g,d,b,c,a;c=$$(".bs-row.selected");a=[];for(d=0,b=c.length;d<b;d++){g=c[d];g.removeClassName("selected");a.push(g.style.zIndex="")}return a}};var Bubble;Bubble={make:function(q,D,v,o,j){var g,s,A,f,e,C,x,p,n,h,m,u,z,k,a,i,d,B,y,w;if(D==null){D="left"}j=j!=null?j:{};if(["left","right"].contains(D)){v=v||"middle";assert(["top","middle","bottom"].contains(v),"expected tail position ['top', 'middle', 'bottom'], got "+v)}else{if(["bottom","top"].contains(D)){v=v||"center";assert(["left","center","right"].contains(v),"expected tail position ['left', 'center', 'right'], got "+v)}else{if(!["none"].contains(D)){assert(false,"unexpected tail side, got "+D)}}}u=new Element("table");if(j.style==="titled"){u.addClassName("bluebubble");z="bluebubble"}else{u.addClassName("bubble");z="bubble"}if(o){u.style.width=o+"px"}a=new Element("tbody");B=new Element("tr");i=new Element("td");i.addClassName("tl");m=new Element("td");m.addClassName("t");if(j.style==="titled"){if(o){m.style.width=(o-42)+"px"}}d=new Element("td");d.addClassName("tr");if(D==="top"){k=new Element("img",{src:"/static/images/"+z+"_arrow_top.png"});k.addClassName("tarrow");if(j.style==="titled"){k.addClassName("arrow-"+v);s=new Element("div");s.addClassName("arrow-container");if(o){s.style.width=(o-42)+"px"}s.__sert(k);m.__sert(s)}else{m.style.textAlign=v;m.__sert(k)}}B.__sert(i);B.__sert(m);B.__sert(d);a.__sert(B);y=new Element("tr");p=new Element("td");p.addClassName("l");if(D==="left"){if(j.style==="titled"){g=new Element("img",{src:"/static/images/bluebubble_arrow_left.png"})}else{g=new Element("img",{src:"/static/images/bubble_arrow.png"})}g.addClassName("arrow");p.__sert(g);p.vAlign=v}x=new Element("td");x.addClassName("c");x.update(q);n=new Element("td");n.addClassName("r");if(D==="right"){h=new Element("img",{src:"/static/images/bubble_arrow_right.png"});h.addClassName("rarrow");n.__sert(h);n.vAlign=v}y.__sert(p);y.__sert(x);y.__sert(n);a.__sert(y);w=new Element("tr");e=new Element("td");e.addClassName("bl");A=new Element("td");A.addClassName("b");if(D==="bottom"){f=new Element("img",{src:"/static/images/"+z+"_arrow_bottom.png"});f.addClassName("barrow");if(j.style==="titled"){f.addClassName("arrow-"+v);s=new Element("div");s.addClassName("arrow-container");if(o){s.style.width=(o-42)+"px"}s.__sert(f);A.__sert(s)}else{A.style.textAlign=v;A.__sert(f)}}C=new Element("td");C.addClassName("br");w.__sert(e);w.__sert(A);w.__sert(C);a.__sert(w);u.__sert(a);return u}};var DbBubble;DbBubble={position:function(h,g,k){var l,a,c,d,b,j,e,i,f;h=$j(h).css({top:"auto",right:"auto",bottom:"auto",left:"auto",position:"absolute"});assert(h.find(".db-arrow").length,"db-arrow not found");l=h.find(".db-arrow-border");assert(l.length,"db-arrow-border not found");j=null;f=["top","right","bottom","left"];for(e=0,i=f.length;e<i;e++){b=f[e];if(h.hasClass("db-"+b+"-arrow")){j=b;break}}assert(j,"No db-#{direction}-arrow class set");if(j==="left"||j==="right"){c=l.position().top;a=l.outerWidth();if(j==="left"){d="left+"+a+"px top-"+c+"px"}else{if(j==="right"){d="right-"+a+"px top-"+c+"px"}}}else{if(j==="top"||j==="bottom"){c=l.position().left;a=l.outerHeight();if(j==="top"){d="left-"+c+" top+"+a+"px"}else{if(j==="bottom"){d="left-"+c+" bottom-"+a+"px"}}}}if(!k){k={top:"bottom",left:"right",bottom:"top",right:"left"}[j]}return h.position({my:d,at:k,of:g,collision:"none"})}};var FreshDropdown;FreshDropdown={show:function(c,e,f,h){var a,b,i,d,g=this;if(h==null){h=false}a=$j(e);if(!f){f=a[0].offsetHeight}this.hide_all();b=$j(c).show();d=b[0].offsetWidth;i=a[0].offsetWidth;b.clonePosition(a,{setHeight:false,setWidth:false,offsetLeft:-1*(d-i),offsetTop:f});if(h){b.width(d)}e.addClassName("pressed");return(function(){return document.observe("click",g.hide_all)}).defer()},hide_all:function(a){$$(".freshdropdown-menu").invoke("hide");$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",this.hide_all)}};var JumpWatcher;JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&JumpWatcher.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=Util.url_hash()}},report:function(){clearInterval(JumpWatcher.interval);return assert(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash)}};var LocaleSelectorModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};LocaleSelectorModal=(function(b){__extends(a,b);function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.on_show=function(){var c=this;return this.$modal_window.on("click",".locale-option",function(d){d.preventDefault();c.hide();return c.set_locale($j(d.target).attr("data-locale"))})};a.prototype.on_hide=function(){return this.$modal_window.off("click")};a.prototype.set_locale=function(c,e){var d;if(e==null){e=false}if(c===Constants.USER_LOCALE){return}d=$j("<form />",{action:"https://"+Constants.WEBSERVER+"/set_locale",method:"post"});Forms.add_vars(d[0],{locale:c,locale_cont:e||window.location.href,t:Constants.TOKEN});$j(document.body).append(d);return d.submit()};return a})(DBModal);var LoginDropdown;LoginDropdown={init:function(){var a;a=$("login-hover-link");if(!a){return}this.login_link=a;return this.register()},register:function(a){this.login_link.observe("click",this.click.bind(this));this.login_link.observe("mouseenter",this.over.bind(this));this.login_link.observe("mouseleave",this.out.bind(this));this.login_link.observe("focus",this.click.bind(this));$("login_email_elm").observe("focus",this.click.bind(this));return $(document.body).observe("click",this.unclick.bind(this))},over:function(a){return this.hover()},out:function(a){return this.unhover()},click:function(a){Event.stop(a);this.hover();this.down=true;this.login_link.up().addClassName("down");return $("login_email_elm").focus()},unclick:function(b){var a;a=$(b.target);if(a.match("#top-login-wrapper, #top-login-wrapper *")){return}this.down=false;this.unhover();return this.login_link.up().removeClassName("down")},hover:function(){var a;if(this.is_hover||this.down){return}this.is_hover=true;a=$("login-hover-dropdown-icon");return Sprite.replace(a,"web","big-dropdown-gray","big-dropdown")},unhover:function(){var a;if(!this.is_hover||this.down){return}this.is_hover=false;a=$("login-hover-dropdown-icon");return Sprite.replace(a,"web","big-dropdown","big-dropdown-gray")}};var Modal;Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(n,j,k,o,c,l,g,i){var f,b,m,a,d,e,h;if(k==null){k=false}if(o==null){o=false}if(c==null){c=false}if(l==null){l=false}if(g==null){g=""}if(i==null){i=true}c=c||this.width;$$("#modal-content .error-message, #modal-content .error-removable").invoke("hide");if(FileQueue.uploading&&!l){alertd(_("You can't do this while uploading."));return false}assert(j,"Missing modal content!");d=this.vars._prev_scope;this.vars=k||{};this.vars._prev_scope=d;$("modal").setStyle({width:""+c+"px",margin:"0 0 0 "+(Math.floor(-c/2).toString())+"px"});this.vars.extra_class="";if(g){$("modal").addClassName(g);this.vars.extra_class=g}if(!l){if(FileQueue.num_files()){Upload.reset()}a=Util.childElement($("modal-content"),0);if(a&&a!==j){$("grave-yard").__sert(a)}b=new Element("div");b.update(j);h=this.vars.wit_group;if(!h){f=b.down();h=f&&f.id}if(h){WIT.add_group(b,h)}$("modal-content").__sert(b);if(j.show){j.show()}Element.show("modal")}$j("#modal-overlay").off("click");if(i){$j("#modal-overlay").on("click",function(p){Modal.hide(null,false,true);p.preventDefault();return p.stopPropagation()})}else{$j("#modal-overlay").on("click",function(p){p.preventDefault();return p.stopPropagation()})}this.fix_position();$j("#modal-overlay").css("opacity",0.6);$("modal-overlay").show();$("modal-behind").setStyle({width:""+(c+20)+"px",margin:"0 0 0 "+(Math.floor(-c/2-10).toString())+"px"});$j("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(o){$("modal-content").select("#"+o.id).first().focus()}else{if(!Util.ie){m=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(m){m.focus()}}}if(!this.track_id){this.track_resizes()}if(n){$("modal-title").update(n);$("modal-title").show();e=n.innerText||n.textContent||n;T("Modal.show:",e)}else{$("modal-title").hide();T("Modal.show")}ActAsBlock.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);return false},async_show:function(b,c){var a;a=new Element("img",{src:"/static/images/icons/ajax-loading.gif"});this.show("",a);return new Ajax.DBRequest(b,{parameters:c,onSuccess:this._async_load})},_async_load:function(a){var b;b=Util.from_json(a.responseText);$("modal-content").__date(new HTML(b.content));if(b.title){$("modal-title").update(new HTML(b.title));$("modal-title").show();return T("Modal.show:",b.title)}else{$("modal-title").hide();return T("Modal.show")}},fix_position:function(d){var c,b,a;a=document.viewport.getScrollOffsets().top+this.vertical_offset;b=parseInt($("modal").getStyle("height"),10);c=$("flash-upload-container")&&$("flash-upload-container").descendantOf("modal");if(!c&&b+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(b+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:a+"px"});return $("modal-behind").setStyle({position:"absolute",height:(b+20)+"px",top:(a-10)+"px"})}},keydown:function(d){var f,a,c,b;c=d.keyCode||d.which||d.charCode;if(c===27||(c===8&&!Util.focus_in_input())){d.preventDefault();this.hide(null,false,true)}if(c===9&&!Util.focus_in_input()){a=$("modal").down("input[type=text], input[type=email]");b=$("modal").down(".modal-tabs");f=b;while(f&&f.next()){f=f.next();if(f.visible()){a=f.down("input[type=text], input[type=email]");break}}if(a){d.preventDefault();return a.focus()}}},icon_show:function(h,i,e,f,j,a,g,c,d){var b;if(c==null){c=""}if(d==null){d=true}b=new Element("div");if(h){b.__sert(Sprite.make("web",h,{"class":"modal-h-img"}))}b.__sert(i);return this.show(b,e,f,j,a,g,c,d)},show_loading:function(a,c){var b;b="<p style='margin: 3em 0; text-align: center;'>\n<img src='/static/images/icons/ajax-loading-small.gif' alt=''/></p>";return this.icon_show(a,c,b)},shown:function(){return $("modal").visible()},hide:function(c,a,b){if(c){Event.stop(c)}if(this.onHide){this.onHide(b);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!a&&!FileQueue.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(FileQueue.uploading){InlineUploadStatus.show()}}if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return T("Modal.hide")},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var a;a=$("modal").getHeight();if(this.old_height!==a||$("modal-behind").getHeight()<a){this.old_height=a;return this.fix_position()}},vars:{}};var Notify;Notify={server_error:function(c,b,a){return this._show_div(c,b,a,false,_("There was a problem completing this request."))},server_success:function(e,d,b,a,c){return this._show_div(e,d,b,true,_("Your request completed successfully."),a,c)},_show_div:function(b,d,f,h,k,a,j){var e,c,i,g=this;this.clear_all();b=b||k;d=d||(a?30:10);c=$j("#notify-msg");if(b.toHTML!=null){c.html(b.toHTML())}else{c.text(b)}if(a){UndoAction.set_undo_info(a,j);i=$j("<a/>",{href:"#"}).text(_("Undo"));i.click(function(){UndoAction.perform_undo();return false});c.append("&nbsp;").append(i);this.preserve_last_msg=true}else{this.preserve_last_msg=false}e=$j("#notify");if(h){e.removeClass("server-error").addClass("server-success")}else{e.removeClass("server-success").addClass("server-error")}this.last_fade_effect=e.fadeIn(500);this.last_msg=b;this.last_fade_timeout=setTimeout((function(){return g.last_fade_effect=e.fadeOut(1000)}),d*1000);return this.cancel_on_reload=f},is_shown:function(){return $j("#notify").visible()},clear_all:function(){if(this.last_fade_timeout){clearTimeout(this.last_fade_timeout)}if(this.last_fade_effect){this.last_fade_effect.stop()}return $j("#notify").hide()},clear_if:function(a){if(this.last_msg===a){return this.clear_all()}}};var SickInput;SickInput={init:function(){var e,d,b,c,a;c=$$(".sick-input");a=[];for(d=0,b=c.length;d<b;d++){e=c[d];if(!e.hasClassName("sickified")){a.push(this._create(e))}}return a},_create:function(d){var c,a,b;if(d==null){return}c=d.identify();a=d.down("input")||d.down("textarea")||d.down("select");a.observe("focus",function(){return d.addClassName("focused")});a.observe("blur",function(){return d.removeClassName("focused")});b=function(){if(d.hasClassName("populated")&&a.getValue()===""){d.removeClassName("populated")}else{if(!d.hasClassName("populated")&&a.getValue()!==""){d.addClassName("populated")}}if(c in SickInput._handler_map){return SickInput._handler_map[c]()}};Forms.show_errors();b();return setInterval(b,100)},_handler_map:{},add_interval_handler:function(b,a){var c;c=b.identify();return this._handler_map[c]=a},remove_interval_handler:function(b,a){var c;c=b.identify();if(this._handler_map[c]===a){return delete this._handler_map[c]}}};var Spinner;Spinner={showLoading:function(h,a,g,d){var b,e,f,c;g=true;e=$("spinner-loading");a=$(a);if(!e){e=new Element("div",{id:"spinner-loading"});b=new HTML('<table style="height: 100%; width: 100%; background:#fff;">\n  <tr>\n  <td valign="top">\n    <div id="spinner-loading-text" style="padding-top: 16px;text-align:center;"></div>\n  </td>\n  </tr>\n</table>');e.__date(b);document.body.appendChild(e)}$j(e).clonePosition($j(a));if(e.getWidth()===0){return}if(Util.ie){e.style.left=a.getBoundingClientRect().left+"px"}e.setOpacity(0.9);f=$("spinner-loading-text");if(h){f.__date()}else{c=new Element("img",{src:"/static/images/icons/ajax-loading.gif",style:"vertical-align: bottom;"});f.__date(c);if(!g){f.__sert(_("Loading..."))}}$("spinner-loading").show();if(d){return e.style.zIndex="1001"}},hideLoading:function(){return $("spinner-loading").hide()}};var Sprite;Sprite={SPACER:"/static/images/icons/icon_spacer.gif",CLASS_PREFIX:"s_",_make_class:function(b,a){return this.CLASS_PREFIX+b+"_"+a},src:function(c,b,a){this.clear(c);return $j(c).addClass(this._make_class(b,a))},replace:function(d,b,c,a){return $j(d).removeClass(this._make_class(b,c)).addClass(this._make_class(b,a))},clear:function(c){var a,b=this;a=c.className.split(" ");a=$j.grep(a,(function(d){return d.indexOf(b.CLASS_PREFIX)===0}),true);return c.className=a.join(" ")},make:function(c,b,a){a=this._prep_attrs(c,b,a);return new Element("img",a)},html:function(d,b,a){var e,c;a=this._prep_attrs(d,b,a);e=["<img "];for(c in a){e.push(c,'="',HTML._raw_escape(a[c]),'" ')}e.push("/>");return new HTML(e.join(""))},_prep_attrs:function(d,c,b){var a;if(b==null){b={}}b.src=b.src||this.SPACER;a=this._make_class(d,c);b["class"]=("sprite sprite_"+d+" "+a+" ")+(b["class"]||"");return b},_get:function(a){return a.className},_set:function(b,a){b.className=a;return b.src=this.SPACER}};var SuggestionInput;SuggestionInput={register:function(b){var a;b=$(b);a=b.up("form");if(SuggestionInput.defaulted(b)||b.getValue()===""){b.setValue(b.title)}else{b.addClassName("suggestion-input-unfaded")}b.observe("blur",this.blur.bind(this));b.observe("focus",this.focus.bind(this));b.observe("db:value_change",this.focus.bind(this));if(a){if(!b.id){b.id="r_elm_id_"+(Math.random().toString())}return a.observe("submit",SuggestionInput.blank(b.id).bind(this))}},register_all:function(){var c,e,b,d,a;d=$$(".suggestion-input");a=[];for(e=0,b=d.length;e<b;e++){c=d[e];a.push(this.register(c))}return a},blank:function(a){var b=this;return function(){var c;c=$(a);if(!c){return}if(b.defaulted(c)){return c.setValue("")}}},defaulted:function(a){a=$(a);return a.getValue()===a.title},do_blank:function(a){return this.blank(a)()},clear:function(a){var b;b={target:a};return this.focus(b)},focus:function(a){var b;b=$(a.target);if(!b){return}if(this.defaulted(b)){b.addClassName("suggestion-input-unfaded");return b.setValue("")}},blur_elm:function(a){if(a.getValue()===""){a.removeClassName("suggestion-input-unfaded");a.setValue(a.title)}return a.blur()},blur:function(a){var b;b=$(a.target);if(!b){return}return this.blur_elm(b)},reset:function(b){var a;a=$(b);if(!a){return}a.removeClassName("suggestion-input-unfaded");a.setValue(a.title);a.defaulted=true;return a.blur()},setValue:function(a,b){var c;c=$(a);if(!c){return}c.addClassName("suggestion-input-unfaded");c.setValue(b);return c.defaulted=false}};var Tabs;Tabs={init:function(){var p,k,l,h,q,d,n,r,m,b,f,e,o,c,g,j=this;n=$j.merge($j(".tab"),$j(".subtab"));k="";for(f=0,o=n.length;f<o;f++){q=n[f];p=q.down("a");b=p.href.split("/");if(q.hasClassName("subtab")){p.href="#"+b[b.length-1]}if(q.hasClassName("subtab-default")&&q.id){k=q.id.replace(/-tab$/,"")}r=Sprite.make("web","rounded_tl",{"class":"rounded_tl"});m=Sprite.make("web","rounded_tr",{"class":"rounded_tr"});p.appendChild(r);p.appendChild(m)}h=20;g=$$(".events_bubble");for(e=0,c=g.length;e<c;e++){l=g[e];d=(-1*l.getWidth()/2)+"px";l.style.marginLeft=d;l.style.marginRight=d;l.style.right="6px";l.parentNode.style.zIndex=h--}$j(window).bind("hashchange",function(){return j.check_url(k)});if(!("onhashchange" in document.body)){this.simulate_hashchange_support()}return $j(window).trigger("hashchange")},simulate_hashchange_support:function(){var b,a;clearInterval(this.check_interval);b=window.location.hash;a=function(){var c;c=window.location.hash;if(c!==b){b=c;return $j(window).trigger("hashchange")}};return this.check_interval=setInterval(a,300)},check_url:function(b){var a;a=/#([^#]*)/.exec(window.location.hash);if(a&&this.showTab(null,a[1])){return true}a=/[^\/]+$/.exec(window.location.pathname);if(a&&this.showTab(null,a[0])){return true}if(b&&this.showTab(null,b)){return true}return this.showTab(null,"")},showTab:function(e,a){var j,h,i,d,l,c,g,f,k,b;if(this.last_shown===a){return true}if(a){d=$(a+"-tab");i=$(a+"-content")}else{d=$$(".subtab").first();i=$$(".content-tab").first()}if(!d||!i){return false}setTimeout((function(){return d.fire("db:tabshown")}),0);c=document.getElementsByClassName("subtab selected");for(g=0,k=c.length;g<k;g++){l=c[g];l.removeClassName("selected")}d.addClassName("selected");j=document.getElementsByClassName("content-tab");for(f=0,b=j.length;f<b;f++){l=j[f];l.hide()}i.show();Util.syncHeight();h=i.select("input[type=text]","input[type=email]","textarea");if(h.length>0){Util.focus(h[0])}this.last_shown=a;return true}};var TitleBubble;TitleBubble=(function(){var c,b,g,d,e,a,f;f=0;c=0;a=function(h){return f=h};e=function(l){var q,o,j,n,i,h,m,k,p;n=$j(l.currentTarget);p=n.attr("title");if(p!=null?p.length:void 0){n.attr("data-title",p);n.removeAttr("title")}j=parseInt(n.data("title-delay"));o="title-bubble-"+(c++);n.data("bubble-id",o);q=$j("<div/>",{id:o,"class":"title_bubble_container"});if(!j){q.css({opacity:0});q.addClass("has-transition")}if(n.hasClass("white")){q.addClass("white")}if(n.hasClass("black")){q.addClass("black")}q.text(n.attr("data-title"));k=$j("<div/>",{"class":"tail"});q.append(k);$j(document.body).append(q);h=g(n[0],q[0]);i=b(h,q[0],n[0]);q.clonePosition(n,{setWidth:false,setHeight:false,offsetTop:i.top-f,offsetLeft:i.left});q.addClass("position-"+h);k.css("margin-left",i.tail_offset_left+"px");k.css("margin-top",i.tail_offset_top+"px");m=function(){var r;if(!((q.data("pending-delay"))&&(n.data("bubble-id")===o))){return}r=(parseInt(n.data("title-fade-time")))||400;return q.fadeIn(r)};if(j){q.hide();q.data("pending-delay",true);return setTimeout(m,j)}else{return q.css({opacity:""})}};g=function(l,h){var k,j,i;l=$(l);i=l.getAttribute("data-title-position");k=document.viewport.getDimensions();j=l.viewportOffset();if(!(i==="above"||i==="below"||i==="right"||i==="left")){i="above"}if(i==="left"){if(j.left<h.width){return"right"}}else{if(i==="right"){if(k.width-(j.left+l.getWidth())<h.width){return"left"}}else{if(i==="below"){if(k.height-(j.top+l.getHeight())<h.height){return"above"}}else{if(i==="above"){if(j.top<h.height){return"below"}}}}}return i};b=function(j,q,m){var o,k,r,n,p,l,h,t,s,i;q=$(q);m=$(m);r=document.viewport.getDimensions();o=q.getDimensions();n=m.viewportOffset();k=6;p=0;l=0;s=0;i=0;if(j==="below"||j==="above"){if(j==="below"){l=m.getHeight()+k}else{l=(-1*o.height)-k}h=m.getWidth()/2-o.width/2;if(n.left+h+o.width>r.width){p=r.width-n.left-o.width;s=h-p-4}else{p=h;s=-4}}if(j==="left"||j==="right"){if(j==="right"){p=m.getWidth()+k}else{p=(-1*o.width)-k}t=m.getHeight()/2-o.height/2;if(n.top+t+o.height>r.height){l=r.height-n.top-o.height;i=t-l-4}else{l=t;i=-4}}return{left:p,top:l,tail_offset_left:s,tail_offset_top:i}};d=function(i){var h,j,k;k=$j(i!=null?i.currentTarget:void 0);h=$j("#"+k.data("bubble-id"));if(h.data("pending-delay")){h.removeData("pending-delay");j=(parseInt(k.data("title-fade-time")))||400;return h.fadeOut(j,function(){return h.remove()})}else{return h.remove()}};return{init:function(){$j(document).on("mouseenter",".title_bubble",e);$j(document).on("mouseleave",".title_bubble",d).on("mouseup",".title_bubble",d);$j(document).on("mouseenter",".title_bubble_sticky",e);return $j(document).on("mouseleave",".title_bubble_sticky",d)},set_vertical_space:a,hide_all:function(){return $j(".title_bubble_container").remove()}}})();var Tooltip;Tooltip={attach:function(g,c,a,b){var f,e;if(b==null){b={}}g=$(g);a=(a?$(a):null);f=Bubble.make(c,g.tail_position,b.tail_position,b.width,b);f.setStyle({display:"none",position:"absolute"});$("floaters").__sert(f);if(g.match("#modal-content *")||g.match(".db-modal-content *")){f.style.zIndex="13001"}else{f.style.zIndex=""}if(g.tail_position==="right"){e=(Util.ie?32:12);f.style.marginLeft=-(f.getWidth()+g.getWidth()+e)+"px"}g.tooltip=f;g.out_target=(a?true:false);g.observe("mouseout",this.mouseout("target",g));g.observe("mouseover",this.mouseover("target",g));g.out_trigger=(a?false:true);if(a){a.observe("mouseout",this.mouseout("trigger",g));a.observe("mouseover",this.mouseover("trigger",g))}g.out_tooltip=true;f.observe("mouseout",this.mouseout("tooltip",g));return f.observe("mouseover",this.mouseover("tooltip",g))},update:function(b,a){if(b.tooltip){return $(b.tooltip).update(a)}},mouseover:function(a,b){return function(){return b["out_"+a]=false}},mouseout:function(a,b){return function(){b["out_"+a]=true;return Tooltip.hide_if_out.defer(b)}},show_by:function(b){var c,a;c=$j(b.tooltip);b=$j(b);c.show();a=Math.floor(c[0].offsetHeight/2);return c.clonePosition(b,{setWidth:false,setHeight:false,offsetTop:Math.floor(b[0].offsetHeight/2)-a,offsetLeft:b[0].offsetWidth+1})},hide_if_out:function(a){var b;if(!a.out_target||!a.out_trigger||!a.out_tooltip){return}b=$(a.tooltip);return b.hide()},show:function(e,d,b,a,c){if(a==null){a="left"}e=$(e);if(!e.tail_position){e.tail_position=a}b=(b?$(b):null);if(!e.tooltip){this.attach(e,d,b,c)}return this.show_by(e)}};var TreeView;TreeView={tv:{},loaded:false,set_params:function(a){return this.ajax_params=a},init:function(c,a,d){var b;if(d==null){d="treeview"}this.tv[d]={};b=this.tv[d];b.autohide=(a===null?true:a);b.handler=c;b.viewdiv=$(d);return b.hidefunc=this.hide.bindAsEventListener(this)},schedule_reset:function(){return this.loaded=false},reset:function(a){var b=this;return $j.ajax({url:"/ajax_subtreeview",method:"post",data:this.ajax_params,success:function(d){var e,c;c=[];for(e in b.tv){if(b.tv.hasOwnProperty(e)){b.tv[e].viewdiv.down(".treeview-folders").update(d);if(a&&a.onSuccess){c.push(a.onSuccess(d))}else{c.push(void 0)}}else{c.push(void 0)}}return c}})},toggle:function(c,b){var a;Event.stop(c);a=this.tv[b||"treeview"];if(a.shown){a.shown=false;this.hide(c,b)}else{a.shown=true;this.show(c.target,b)}return false},hide:function(c,b){var a;a=this.tv[b||"treeview"];if(!c||!$(c.target).descendantOf(a.viewdiv)){a.viewdiv.hide();Event.stopObserving(window,"click",a.hidefunc);return a.shown=false}},show:function(c,b){var d,a;a=this.tv[b||"treeview"];c=$(c);c.blur();d=c.cumulativeOffset();a.viewdiv.setStyle({top:(d.top+c.getHeight())+"px",left:(d.left-4)+"px"});a.viewdiv.show();return Event.observe(window,"click",a.hidefunc)},toggleNode:function(b){var a;b=$(b);a=b.down("img");if(a.className.match("bullet_plus")){Sprite.replace(a,"web","bullet_plus","bullet_minus")}else{Sprite.replace(a,"web","bullet_minus","bullet_plus")}b.up().next("div").toggle();b.blur();return false},toggleNodeAjax:function(c,a){var b,d,e=this;if(c.fetched_children){return this.toggleNode(c)}c=$(c);b=c.down("img");d=Sprite._get(b);b.src="/static/images/icons/ajax-loading-small.gif";$j.ajax({url:"/ajax_subtreeview"+a,method:"post",data:this.ajax_params,success:function(f){var g;g=new Element("div",{style:"display: none;"}).update(f);c.up().__sert({after:g});c.fetched_children=true;Sprite._set(b,d);return e.toggleNode(c)},complete:function(){if(/loading/.match(b.src)){return Sprite._set(b,d)}}});return false},handle:function(c,b){var d,a;d=$H(this.tv).keys();a=$(b).ancestors().find(function(e){return d.include(e.id)});if(!a){return}a=this.tv[a.id];$("modal").fire("db:treeview_selected",{path:c});if(a.handler){a.handler(c,b)}if(a.autohide){this.hide(a.id)}return false},move:function(c,d,b){var a,e=this;a=$(c);if(!this.loaded){this.reset({onSuccess:function(){e.loaded=1;return e.move(c,d,b)}})}else{if(b&&b.onSuccess){b.onSuccess()}}assert(a,"Couldn't find tree_id");assert($(d),"Couldn't find location_id");$(d).appendChild(a);return a.show()}};var ULSelectMenu;ULSelectMenu=(function(){var d,h,c,i,j,e,g,a,f,b,k;d=function(l){return l.removeClassName("shown")};k=function(l){return l.toggleClassName("shown")};g=function(){return this.removeClassName("hover")};e=function(){return this.addClassName("hover")};a=function(p,o){var l,q,n,m;m=[];for(q=0,n=o.length;q<n;q++){l=o[q];m.push(p.insert(l))}return m};i=function(n,l,m){a(n,m);if(n.firstChild!==l){return n.__sert({top:l})}};f=function(l,m){l.down(".selected").removeClassName("selected");return m.addClassName("selected")};b=function(n,q){var r,p,m,o,l;o=n.select("li");l=[];for(p=0,m=o.length;p<m;p++){r=o[p];if(r.getAttribute("data-value")===q){l.push(f(n,r))}else{l.push(void 0)}}return l};j=function(l,n,m){return function(o){if(!l.hasClassName("selected")){f(n,l);n.fire("db:change",l.getAttribute("data-value"));return d(n)}else{i(n,l,m);return k(n)}}};h=function(n){var q,t,p,m,s,l,o,r;t=n.select("li");assert(t.length,"Empty list of options "+n.identify());p=void 0;if(t.length===1){n.addClassName("one")}else{for(o=0,r=t.length;o<r;o++){q=t[o];s=q.getAttribute("data-value");assert(s,q.identify()+" missing data value");q.observe("click",j(q,n,t));q.observe("mouseenter",e);q.observe("mouseleave",g);if(q.hasClassName("selected")){p=q}}$(document.body).observe("click",function(u){if($(u.target).up(".ul_select_menu")===n){return}return d(n)})}if(!p){p=t[0]}p.addClassName("selected");l=new Element("span");m=p.getDimensions();l.setStyle({width:m.width+"px",height:m.height+"px",position:"relative",display:"inline-block"});return n.wrap(l)};c=function(){var p,o,m,n,l;n=$$(".ul_select_menu");l=[];for(o=0,m=n.length;o<m;o++){p=n[o];l.push(h(p))}return l};Util.smartLoad(c);return{init:function(l){return h(l)},set_selected_by_value:b}})();var UndoAction;UndoAction={set_undo_info:function(a,b){assert(b,"need to specify a function to start the undo");this.undo_info=a;return this.undo_handler=b},perform_undo:function(){if(this.undo_handler!=null){this.undo_handler(this.undo_info);return this.undo_handler=this.undo_info=null}}};var DBCalendar;DBCalendar=Class.create({initialize:function(b,a){this.options=a||{};this.container=$(b);assert(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=Util.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=Util.start_of_day(this.options.first_day||this.today)}this.view_date=Util.start_of_day(this.options.selected_date||this.today);this.selected_date=Util.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(b,a){Event.stop(b);this.view_date.setMonth(a);return this.render()},is_valid_date:function(d,f,e,c,a){var b;d=parseInt(d,10);f=parseInt(f,10);e=parseInt(e,10);c=parseInt(c,10);a=parseInt(a,10);c=c||1970;a=a||(new Date()).getFullYear()+1;f+=1;if(e<c){return false}if(e>a){return false}if(f<1||f>12){return false}if(d<=0){return false}if(f===2){b=((e%4)===0)&&(((e%100)!==0)||((e%400)===0));if(b){return d<=29}else{return d<=28}}else{if(f===4||f===6||f===9||f===11){return d<=30}else{return d<=31}}},change_date:function(a,d,b){var c;if(!this.is_valid_date(a,d,b)){return}c=b!==this.view_date.getFullYear()||d!==this.view_date.getMonth();this.selected_date.setDate(a);this.selected_date.setMonth(d);this.selected_date.setFullYear(b);if(c){this.view_date.setMonth(d);this.view_date.setFullYear(b);this.render()}else{$j(this.container).find(".selected").removeClass("selected");$j(this.container).find("a#day"+a+"-"+d).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var d,j,h,f,e,b,g,c,i,a;j=this.render_days();f=$j(".current-month",j);g=f.first().data("date");b=f.last().data("date");a=g<=this.options.first_day;i=b>=this.options.last_day;d=new Element("div");d.addClassName("calendar clearfix");if(!i){this._next_month=(function(k){return this._change_month(k,this.view_date.getMonth()+1)}).bind(this);e=new Element("a");e.addClassName("changemonth next");e.update(Sprite.make("web","arrowright",{}));Event.observe(e,"click",this._next_month);d.__sert(e)}if(!a){this._prev_month=(function(k){return this._change_month(k,this.view_date.getMonth()-1)}).bind(this);c=new Element("a");c.addClassName("changemonth prev");c.update(Sprite.make("web","arrowleft",{}));Event.observe(c,"click",this._prev_month);d.__sert(c)}h=new Element("h5");h.update(_("%(month)s %(year)s").format({month:Util.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));d.__sert(h);d.__sert(j);return this.container.__date(d)},render_days:function(){var h,g,a,f,b,e,d,c;g=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);d=g.getDay();h=new Element("div");h.addClassName("days");for(a=c=d;d<=0?c<0:c>0;a=d<=0?++c:--c){e=new Date(g.getFullYear(),g.getMonth(),g.getDate());e.setDate(e.getDate()-a);h.__sert(this.render_day(e,true))}f=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(f.getMonth()===this.view_date.getMonth()){h.__sert(this.render_day(f));f=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),f.getDate()+1)}b=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(b.getDay()!==6){b=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);h.__sert(this.render_day(b,true))}return h},render_day:function(c,e){var b,d;d=!e;if(this.options.last_day){e=e||c>this.options.last_day}if(this.options.first_day){e=e||c<this.options.first_day}b=new Element(e?"span":"a");$j(b).data("date",c);if(d){b.addClassName("current-month")}b.update(c.getDate());b.addClassName("date");b.writeAttribute("id","day"+c.getDate()+"-"+c.getMonth());if(this.selected_date.getDate()===c.getDate()&&this.selected_date.getMonth()===c.getMonth()&&this.selected_date.getFullYear()===c.getFullYear()){b.addClassName("selected")}if(e){b.addClassName("inactive")}else{this._handler=(function(f){var a;a=f.target.identify().substr(3).split("-");return this.change_date(a[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(b,"click",this._handler)}return b}});var DatePickerInput;DatePickerInput=Class.create({initialize:function(a,c){var d,b;this.container=a;this.options={};Object.extend(this.options,c||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");b=(this.input.value?Util.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){d=Util.from_mysql_date(this.container.getAttribute("data-first"))}this.cal_container=this.container.down(".cal-container");this.calendar=new DBCalendar(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:d,disable_future:true,selected_date:b});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(b)},show_cal:function(b){var a;if(b){Event.stop(b)}a=$(b.target);if(a.match(".cal-container")||a.up(".cal-container")){return}$j(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(a){this.input.value=Util.to_mysql_date(a,false);this.display.update(DateUtil.localize(a));return this.hide_cal()}});var TextInputDatePicker;TextInputDatePicker=Class.create({initialize:function(d,c){var f,e,b,a;this.options={include_seconds:true,choose_eod:false};Object.extend(this.options,c||{});this.input=$(d);assert(this.input,"Couldn't find the element "+d.toString());b=new Date();a=(this.input.value?Util.from_mysql_date(this.input.value):false);e=new Date(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate());this.cal_icon=Sprite.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+d,style:"display: none; position: absolute; z-index: 1"});this.calendar=new DBCalendar(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:e,selected_date:a});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));f=$j(this.input);$j(this.cal_container).clonePosition(f,{setWidth:false,setHeight:false,offsetTop:f[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(a){if(a){Event.stop(a)}return this.cal_container.toggle()},hide_cal:function(a){if(a){Event.stop(a)}return this.cal_container.hide()},onDateChange:function(a){if(this.options.choose_eod){a.setTime(Util.start_of_day(a).getTime()+86399999)}this.input.value=Util.to_mysql_date(a,true);return this.hide_cal()}});Util.smart_window_load(ActAsBlock.register.bind(ActAsBlock));Util.smartLoad(SickInput.init.bind(SickInput));Util.smartLoad(SuggestionInput.register_all.bind(SuggestionInput));Event.observe(window,"scroll",function(){return TitleBubble.hide_all()});Util.smartLoad(function(){JumpWatcher.interval=setInterval(JumpWatcher.check.bind(JumpWatcher),500);LocaleSelector.init();LoginDropdown.init();TitleBubble.init();return Tabs.init()});var LocaleSelector;LocaleSelector={init:function(){var a=this;return $j(document).on("click",".modal-locale-link",(function(b){b.preventDefault();return a.show()}))},show:function(){if(!this.modal){this.modal=new LocaleSelectorModal({element_id:"locale-selector-modal"})}return this.modal.show()}};var BulkUpload,CrossDomainUploader,FileQueue,InlineUploadStatus,OverQuotaUploads,Upload,UploadFile;Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",SWFU:false,current_dest:null,init:function(c,d){var b,a;a={};Object.extend(a,Upload.cookies);b=Upload.initSWFU(a);if(!d){Util.smart_window_load(b)}else{b()}Upload.current_dest=c;$$(".swfupload").each(function(e){if(e.observe){Util.freshbutton_overlay(e,$("choose-button"));return Util.freshbutton_overlay(e,$("add-button"))}});return FileQueue.clear()},init_basic:function(){Util.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("basic-choose-button").observe("mousemove",function(c){var b,a,d;b=$("modal").cumulativeOffset();d=c.clientY-b.top-3;a=c.clientX-b.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:d+"px",left:a+"px"})});return $("file-box").observe("change",function(){var d,b,e,c,a;Modal.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();b=$("file-box").getValue().split("\\").pop();c=Sprite.make("web",Util.filename_to_icon(b));$("basic-upload-status").down(".icon").__date(c);d=_("Uploading %(filename)s").format({filename:b.em_snippet(25)});$("basic-upload-status").down(".file-desc").__date(d);$("basic-upload-status").show();$("basic-uploading-message").show();if(window.File&&window.FileList){e=$("file-box").files;if(e){a=e[0].lastModifiedDate;$("mtime").value=Math.round(Date.parse(a)/1000)||0}}return $("basic-upload-form").submit()})},initSWFU:function(a){return function(){var b;b=new SWFUpload({upload_url:"https://"+Constants.BLOCK_CLUSTER+"/upload",file_post_name:"file",file_size_limit:"307200",file_types:"*",file_types_description:_("All files"),file_upload_limit:"0",button_placeholder_id:"flash-upload-button-placeholder",button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_width:1000,button_height:1000,button_cursor:SWFUpload.CURSOR.HAND,swfupload_loaded_handler:Upload.flashLoaded,file_queued_handler:Upload.fileQueued,file_queue_error_handler:Upload.fileQueueError,upload_progress_handler:Upload.uploadProgress,upload_error_handler:Upload.uploadError,upload_success_handler:Upload.uploadSuccess,upload_complete_handler:Upload.uploadComplete,flash_url:"/static/swf/swfupload.swf",custom_settings:{progress_target:"fsUploadProgress",upload_successful:false},post_params:a,debug:Constants.upload_debug||false});return Upload.SWFU=b}},reset:function(){var a;if(FileQueue.uploading&&FileQueue.current_file){if(CrossDomainUploader.is_cross_domain(FileQueue.current_file)){CrossDomainUploader.current_req.transport.abort()}else{Upload.SWFU.cancelUpload()}}a=$$(".swfupload").first();if(a&&a.remove){a.remove()}delete Upload.SWFU;FileQueue.clear();return InlineUploadStatus.hide()},show_upload:function(){var a;$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();a=$$(".swfupload").first();if(a){$j("#flash-upload-container").clonePosition($j("#add-button"));a.width=$("add-button").getWidth();a.height=$("add-button").getHeight()}if(!$("modal-overlay").visible()){return InlineUploadStatus.show()}},updatePostParams:function(c){var b,a;a=Upload.SWFU.getSetting("post_params");for(b in c){if(c.hasOwnProperty(b)){a[b]=c[b]}}return Upload.SWFU.setPostParams(a)},fileQueueError:function(d,b,c){var e,a;a=_("File too large");e=_('The upload limit online is 300MB. You can upload larger files with the <a id="install_link">Dropbox desktop application</a>.');e=e.replace('id="install_link"','href="/install" target="_blank"');switch(b){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:document.fire(Upload.QUEUE_ERROR_EVT,{file:d,message:a,tooltip_text:e});break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:if(d.size!=null){document.fire(Upload.QUEUE_ERROR_EVT,{file:d,message:_("Empty file"),tooltip_text:_("You can't upload an empty file.")})}else{document.fire(Upload.QUEUE_ERROR_EVT,{file:d,message:a,tooltip_text:e})}break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:document.fire(Upload.QUEUE_ERROR_EVT,{file:d,message:_("Invalid file type"),tooltip_text:_("This file does not have an allowed file type.")});break;default:document.fire(Upload.QUEUE_ERROR_EVT,{file:d});this.debug("Error code: "+b+", file name: "+d.name+", file size: "+d.size+", message: "+c)}return Upload.show_upload()},fileQueued:function(a){document.fire(Upload.QUEUE_EVT,{file:a});return Upload.show_upload()},uploadNext:function(){if(CrossDomainUploader.is_cross_domain(FileQueue.next())){CrossDomainUploader.upload_next()}else{Upload.updatePostParams({dest:FileQueue.next_dest(),t:Constants.TOKEN});Upload.SWFU.startUpload()}FileQueue.last_update_time=0;return FileQueue.last_update_size=0},pause:function(){return Upload.SWFU.stopUpload()},uploadProgress:function(c,b,a){if(!FileQueue.cancelled_files[c.id]){return document.fire(Upload.UPDATE_EVT,{file:c,percent_complete:b/a})}},uploadSuccess:function(b,a){if(a.strip()===""){return document.fire(Upload.ERROR_EVT,{file:b})}else{if(a==="quota"){return document.fire(Upload.ERROR_EVT,{file:b,message:_("Quota exceeded"),tooltip_text:_("Your upload failed because you are over quota.")})}else{if(a==="folder_exists"){return document.fire(Upload.ERROR_EVT,{file:b,message:_("Invalid file name"),tooltip_text:_("You can't upload a file with the same name as a folder in this folder.")})}else{return document.fire(Upload.UPDATE_EVT,{file:b,percent_complete:1})}}}},uploadComplete:function(a){if(!FileQueue.cancelled_files[a.id]&&!FileQueue.errored_files[a.id]){return document.fire(Upload.COMPLETE_EVT,{file:a})}},uploadError:function(e,b,d){var c,a;c=e;if(parseInt(b,10)!==-280){a=FlashDetect.major+"."+FlashDetect.revision;Util.report_exception("Uploader error: "+b+" "+d+" "+(Object.toJSON(e))+" FLASH VERSION: "+a,window.location.href)}switch(b){case SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL:this.debug("Error code: No backend file, file name: "+c.name+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:this.debug("Error code: upload limit exceeded, file name: "+c.name+", file size: "+c.size+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:this.debug("Error code: HTTP error, file name: "+c.name+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:this.debug("Error code: upload failed, file name: "+c.name+", file size: "+c.size+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:this.debug("Error code: IO error, file name: "+c.name+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:this.debug("Error code: security error, file name: "+c.name+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:this.debug("Error code: upload cancelled, file name: "+c.name+", message: "+d);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:this.debug("Error code: upload stopped, file name: "+c.name+", message: "+d);break;default:this.debug("Error code: "+b+(", file name: "+c.name+", file size: "+c.size+", message: "+d))}if(FileQueue.files[e.id]){return document.fire(Upload.ERROR_EVT,{file:e,error_code:b})}},grabURL:function(){var a;a=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(a)){$("url").value=a}return true},set_dest:function(a){var b;Upload.current_dest=a;DomUtil.fillVal(a,"dest-folder");b=$("basic-uploader-url");if(b){return b.href=b.href.replace(/(\/upload)(.*)(\?basic=1)/,function(e,d,g,c){return d+Util.urlquote(a)+c})}},treeview_handler:function(b,a){Upload.set_dest(b);return FileQueue.clear()},new_folder:function(){TreeView.hide();Modal.show(_("Create new folder..."),DomUtil.fromElm("create-folder"),{action:Upload.do_new_folder,wit_group:"new-folder-confirm"});if(!Util.ie){return $("first-treeview-link").onclick()}},do_new_folder:function(){var b,a;if(!Modal.vars.selected_path){Notify.server_error(_("Please select a parent folder."));return}a=$F("entered-name");b=Modal.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+Util.urlquote(b)+"?to_path="+Util.urlquote(a),{onSuccess:function(c){Upload.treeview_handler(Util.normalize(b)+"/"+a);return TreeView.schedule_reset()},cleanUp:function(){}})},flashLoaded:function(){var a;if($("upload-start-buttons").visible()){$("upload-loading").hide();$("choose-button").show();a=$$(".swfupload").first();if(a){$j("#flash-upload-container").clonePosition($j("#choose-button"));a.width=$("choose-button").getWidth();return a.height=$("choose-button").getHeight()}}}};FileQueue={files:{},file_ids:[],uploading:false,num_left:0,queue_size:0,completed_size:0,completed_files:{},errors:0,errored_files:{},cancels:0,cancelled_files:{},all_cancelled:false,last_update_time:0,last_update_size:0,average_bps:0,formatted_time:null,init:function(){return FileQueue._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,FileQueue._file_queued);document.observe(Upload.QUEUE_ERROR_EVT,FileQueue._file_queue_errored);document.observe(Upload.UPDATE_EVT,FileQueue._file_updated);document.observe(Upload.COMPLETE_EVT,FileQueue._file_completed);document.observe(Upload.ERROR_EVT,FileQueue._file_errored);return document.observe(Upload.CANCEL_EVT,FileQueue._file_cancelled)},_file_queued:function(b){var a;a=b.memo.file;if(typeof a.size!=="undefined"){FileQueue.queue_size+=a.size}FileQueue.files[a.id]=a;FileQueue.file_ids.push(a.id);FileQueue.num_left++;if(!FileQueue.uploading){FileQueue._start_uploading()}return T("File queued:",a.name)},_file_queue_errored:function(a){FileQueue._file_queued(a);return setTimeout((function(){return FileQueue._file_errored(a)}),250)},_file_updated:function(j){var d,a,b,c,h,g,f,i,k;c=j.memo.file;g=j.memo.percent_complete;h=g*c.size;k=FileQueue.completed_size+h;b=new Date().getTime();if(FileQueue.last_update_time){f=(b-FileQueue.last_update_time)/1000;a=h-FileQueue.last_update_size;d=a/f;FileQueue.average_bps=((k-a)*FileQueue.average_bps+a*d)/k;i=(FileQueue.queue_size-k)/FileQueue.average_bps;FileQueue.formatted_time=Util.formatTime(i+FileQueue.num_left)}FileQueue.current_file=c;FileQueue.last_update_time=new Date().getTime();FileQueue.last_update_size=h;return FileQueue.totalPercentage=k/FileQueue.queue_size},_file_completed:function(b){var a;a=b.memo.file;FileQueue.num_left=Math.max(0,FileQueue.num_left-1);FileQueue.completed_files[a.id]=true;FileQueue.completed_size+=a.size;FileQueue.totalPercentage=FileQueue.completed_size/FileQueue.queue_size;T("File completed:",a.name);return FileQueue._check_if_finished(a)},_file_errored:function(b){var a;a=b.memo.file;FileQueue.errors=FileQueue.errors+1;FileQueue.errored_files[a.id]=true;FileQueue.num_left=Math.max(0,FileQueue.num_left-1);if(typeof a.size!=="undefined"){FileQueue.queue_size-=a.size}FileQueue.totalPercentage=FileQueue.completed_size/FileQueue.queue_size;BulkUpload.update_errors();InlineUploadStatus.update_errors();T("File errored:",a.name);return FileQueue._check_if_finished(a)},_file_cancelled:function(b){var a;a=b.memo.file;delete FileQueue.files[a.id];FileQueue.file_ids.splice(FileQueue.file_ids.indexOf(a.id),1);FileQueue.cancels=FileQueue.cancels+1;FileQueue.cancelled_files[a.id]=true;FileQueue.num_left=Math.max(0,FileQueue.num_left-1);if(typeof a.size!=="undefined"){FileQueue.queue_size-=a.size}FileQueue.totalPercentage=FileQueue.completed_size/FileQueue.queue_size;if(CrossDomainUploader.is_cross_domain(a)){if(FileQueue.current_file===a){CrossDomainUploader.current_req.transport.abort()}}else{Upload.SWFU.cancelUpload(a.id)}T("File cancelled:",a.name);return FileQueue._check_if_finished(a)},_start_uploading:function(){var a;Upload.uploadNext();FileQueue.uploading=true;FileQueue.all_cancelled=false;return window.onbeforeunload=a=function(){return _("Leaving this page will cancel your uploads.")}},_check_if_finished:function(a){if(FileQueue.empty()){if(FileQueue.uploading){return FileQueue._finished_uploading()}}else{if(!FileQueue.all_cancelled&&FileQueue.current_file&&a.id===FileQueue.current_file.id){return Upload.uploadNext()}}},_finished_uploading:function(){var d,b,c,e,a;FileQueue.uploading=false;if(!FileQueue.num_files()){BulkUpload.cancelled()}else{if(FileQueue.errors){BulkUpload.errored();InlineUploadStatus.errored()}else{BulkUpload.completed();InlineUploadStatus.completed()}}a=InlineUploadStatus.upload_box&&InlineUploadStatus.upload_box.visible();Browse.select_fq_paths=[];if(Browse.inside_dir){d=Browse.containing_fq_path();for(e in FileQueue.completed_files){c=FileQueue.files[e];b=Util.normalize(c.dest||Upload.current_dest);Browse.select_fq_paths.push(""+b+"/"+c.name)}}Browse.force_reload();if(a){InlineUploadStatus.show()}Modal.onHide=null;return window.onbeforeunload=null},empty:function(){return !FileQueue.num_left},num_files:function(){return FileQueue.file_ids.length},next:function(){var a;if(FileQueue.num_left!==0){a=FileQueue.num_files()-FileQueue.num_left;return FileQueue.files[FileQueue.file_ids[a]]}},next_dest:function(){var b,a;a=FileQueue.next();b=a&&a.id;if(b&&$(b)){return $(b).readAttribute("data-dest")}else{return a.dest||Upload.current_dest}},clear:function(a){FileQueue.files={};FileQueue.file_ids=[];FileQueue.queue_size=0;FileQueue.cancels=0;FileQueue.cancelled_files={};FileQueue.all_cancelled=false;FileQueue.errors=0;FileQueue.errored_files={};FileQueue.num_left=0;FileQueue.completed_size=0;FileQueue.completed_files={};FileQueue.last_update_time=0;FileQueue.last_update_size=0;FileQueue.average_bps=0;FileQueue.formatted_time=null;FileQueue.uploading=false;window.onbeforeunload=null;return Modal.onHide=null}};UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){UploadFile._tmpl=HTML.tmpl("upload_list_item_tmpl");return UploadFile._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,UploadFile._file_queued);document.observe(Upload.QUEUE_ERROR_EVT,UploadFile._file_queue_errored);document.observe(Upload.UPDATE_EVT,UploadFile._file_updated);document.observe(Upload.COMPLETE_EVT,UploadFile._file_completed);document.observe(Upload.ERROR_EVT,UploadFile._file_errored);return document.observe(Upload.CANCEL_EVT,UploadFile._file_cancelled)},_file_queued:function(f){var i,b,a,h,g,j,c,d;b=f.memo.file;i=b.dest||Upload.current_dest;j=b.size!=null?Util.formatBytes(b.size,2,true):_("Too large");a=UploadFile._tmpl({file:b,icon:Util.filename_to_icon(b.name),filename_snippet:b.name.em_snippet(UploadFile.FILENAME_SNIPPET_LENGTH),size:j,dest:i,dest_snippet:("Dropbox"+i).em_snippet(UploadFile.DEST_SNIPPET_LENGTH,0)});$("upload-files-list").__sert(a);h=$(b.id);g=FileQueue.num_files()+FileQueue.cancels;c=$("upload-files-list");if(g<=6||IE7_OR_LESS){c.removeClassName("scroll")}else{c.addClassName("scroll");c.scrollTop=c.scrollHeight}h.down(".dest").observe("click",function(){Browse.reload_fqpath(h.readAttribute("data-dest"),true);return Modal.hide()});d=h.down(".status-col").down("a.small-x-button");d.stopObserving("click");d.observe("click",function(k){return document.fire(Upload.CANCEL_EVT,{file:b})});return h.down(".upload-progress-bar").setStyle({width:"0"})},_file_queue_errored:function(a){UploadFile._file_queued(a);return UploadFile._file_errored(a)},_file_updated:function(f){var c,g,b,a,d;c=f.memo.file;g=$(c.id);if(FileQueue.num_files()+FileQueue.cancels===1){if(FileQueue.formatted_time){a=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});g.down(".time-col").__date(a)}}else{g.down(".time-col").__date()}b=parseInt(100*f.memo.percent_complete,10)+"%";if(b==="100%"){g.down(".time-col").__date();g.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"}))}else{d=g.down(".status-col").down("a.small-x-button");if(d){d.stopObserving("click");d.observe("click",function(h){return document.fire(Upload.CANCEL_EVT,{file:c})})}}return g.down(".upload-progress-bar").setStyle({width:b})},_file_completed:function(b){var a,c;a=b.memo.file;c=$(a.id);c.addClassName("complete");c.down(".time-col").__date();c.down(".status-col").__date(Sprite.make("web","synced"));return c.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(f){var a,c,b,g,d;b=f.memo.file;g=$(b.id);g.addClassName("error");g.down(".dest-col").hide();g.down(".time-col").__date();g.down(".status-col").__date(Sprite.make("web","nosync"));g.down(".upload-progress-bar").setStyle({width:"100%"});c=f.memo.message||_("Flash error");a=void 0;if(f.memo.tooltip_text){a=f.memo.tooltip_text}else{if(parseFloat(Util.flash_version(),10)<10.32){a=_('Upload failed.  Please try upgrading to the latest version of <a id="adobe_link">Adobe Flash</a> and try again.');a=a.replace('id="adobe_link"','href="http://get.adobe.com/flashplayer/" target="_blank"')}else{a=_('Sorry, it looks like the advanced uploader is incompatible with your system. Please use the <a id="basic_link">basic uploader</a> to upload via the website');a=a.replace('id="basic_link"','onclick="FileOps.show_basic_upload(Browse.containing_fq_path()); return false;"')}}g.down(".error-msg").__date(c);d=g.down(".error-details");d.observe("mouseover",function(){return Tooltip.show(d,a)});return g.down(".error-col").show()},_file_cancelled:function(b){var a,c;a=b.memo.file;c=$(a.id);c.addClassName("cancelled");c.down(".dest-col").__date(_("Canceled"));c.down(".time-col").__date();c.down(".status-col").__date(Sprite.make("web","cancelsync"));return c.down(".upload-progress-bar").setStyle({width:"100%"})}};BulkUpload={init:function(){return BulkUpload._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,BulkUpload._file_queued);return document.observe(Upload.UPDATE_EVT,BulkUpload._file_updated)},_file_queued:function(c){var a,b;a=$("bulk-upload-status");a.removeClassName("error");a.removeClassName("complete");a.removeClassName("cancelled");b=new Element("a",{"class":"small-x-button"});b.observe("click",function(){var f,h,g,e,d;FileQueue.all_cancelled=true;f=FileQueue.file_ids.slice(0);d=[];for(g=0,e=f.length;g<e;g++){h=f[g];if(!FileQueue.completed_files[h]&&!FileQueue.errored_files[h]){d.push(document.fire(Upload.CANCEL_EVT,{file:FileQueue.files[h]}))}else{d.push(void 0)}}return d});return a.down(".status").__date(b)},_file_updated:function(h){var g,d,c,f,b,a;c=FileQueue.num_files();if(c+FileQueue.cancels>1){g=$("bulk-upload-status");f=ungettext("%d file","%d files",c).format(c);g.down(".num-files").__date(f);b=_("- %(size)s").format({size:Util.formatBytes(FileQueue.queue_size,2,true)});g.down(".size").__date(b);if(FileQueue.formatted_time){a=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});g.down(".time-left").__date(a)}g.down(".upload-progress-bar").style.width=(100*FileQueue.totalPercentage||0).toFixed(2)+"%";g.show();d=$$(".swfupload").first();if(d){$j("#flash-upload-container").clonePosition($j("#add-button"));d.width=$("add-button").getWidth();return d.height=$("add-button").getHeight()}}},update_errors:function(){var a;a=ungettext("- %d error","- %d errors",FileQueue.errors).format(FileQueue.errors);return $("bulk-upload-status").down(".num-errors").__date(a)},completed:function(){var d,b,c,a;$("hide-button").hide();$("done-button").show();b=FileQueue.num_files();if(b+FileQueue.cancels>1){d=$("bulk-upload-status");d.addClassName("complete");c=ungettext("Uploaded %d file","Uploaded %d files",b).format(b);d.down(".num-files").__date(c);a=_("- %(size)s").format({size:Util.formatBytes(FileQueue.completed_size,2,true)});d.down(".size").__date(a);d.down(".num-errors").__date();d.down(".time-left").__date();d.down(".status").__date(Sprite.make("web","synced"));return d.down(".upload-progress-bar").style.width="100%"}},errored:function(){var d,e,b,c,a;$("hide-button").hide();$("done-button").show();b=FileQueue.num_files();if(b+FileQueue.cancels>1){d=$("bulk-upload-status");d.addClassName("error");c=ungettext("Uploaded %(num_completed)d of %(num_files)d file","Uploaded %(num_completed)d of %(num_files)d files",b).format({num_completed:b-FileQueue.errors,num_files:b});d.down(".num-files").__date(c);a=_("- %(size)s").format({size:Util.formatBytes(FileQueue.completed_size,2,true)});d.down(".size").__date(a);e=ungettext("- %d error","- %d errors",FileQueue.errors).format(FileQueue.errors);d.down(".num-errors").__date(e);d.down(".time-left").__date();d.down(".status").__date(Sprite.make("web","nosync"));return d.down(".upload-progress-bar").style.width="100%"}},cancelled:function(){var b,a;$("hide-button").hide();$("done-button").show();a=FileQueue.num_files();if(a+FileQueue.cancels>1){b=$("bulk-upload-status");b.addClassName("cancelled");b.down(".num-files").__date(_("All uploads canceled"));b.down(".size").__date();b.down(".num-errors").__date();b.down(".time-left").__date();b.down(".status").__date(Sprite.make("web","cancelsync"));return b.down(".upload-progress-bar").style.width="100%"}}};InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,upload_box:false,init:function(){return InlineUploadStatus._listen()},_listen:function(){document.observe(Upload.QUEUE_EVT,InlineUploadStatus._file_queued);return document.observe(Upload.UPDATE_EVT,InlineUploadStatus._file_updated)},_file_queued:function(c){var b,a;b=$("inline-upload-status");b.removeClassName("error");b.removeClassName("complete");b.down(".icon").__date(Sprite.make("web","syncing"));b.down(".file-desc").__date(_("Starting upload..."));b.down(".num-errors").__date();a=ungettext("%d file","%d files",FileQueue.num_left).format(FileQueue.num_left);b.down(".view-details").__date(a);b.down(".status").__date();return b.down(".inline-upload-progress").style.width="0%"},_file_updated:function(h){var d,f,c,g,b,a;d=h.memo.file;if($$("#right-content #inline-upload-status").length===0){InlineUploadStatus._build()}c=$("inline-upload-status");c.down(".icon").__date(Sprite.make("web","syncing"));f=_("Uploading %(filename)s").format({filename:d.name.em_snippet(InlineUploadStatus.FILENAME_SNIPPET_LENGTH)});c.down(".file-desc").__date(f);if(FileQueue.num_left>1){a=ungettext("%d file left","%d files left",FileQueue.num_left-1).format(FileQueue.num_left-1);c.down(".view-details").__date(a)}else{c.down(".view-details").__date(_("View details"))}if(FileQueue.formatted_time){b=_("%(time_left)s left").format({time_left:FileQueue.formatted_time});c.down(".status").__date(b)}g=(parseInt(100*FileQueue.totalPercentage,10)||0)+"%";return c.down(".inline-upload-progress").style.width=g},update_errors:function(){var a;a=ungettext("- %d error","- %d errors",FileQueue.errors).format(FileQueue.errors);return $("inline-upload-status").down(".num-errors").__date(a)},add_x_button:function(){var a;a=new Element("a",{"class":"small-x-button"});a.observe("click",function(){InlineUploadStatus.hide();return Upload.reset()});return $("inline-upload-status").down(".status").__date(a)},completed:function(){var b,a;a=$("inline-upload-status");a.addClassName("complete");a.removeClassName("error");a.down(".icon").__date(Sprite.make("web","synced"));b=void 0;if(FileQueue.num_files()>1){b=_("Uploaded %(num_files)d files").format({num_files:FileQueue.num_files()})}else{b=_("Uploaded %(filename)s").format({filename:FileQueue.current_file.name.em_snippet(InlineUploadStatus.FILENAME_SNIPPET_LENGTH)})}a.down(".file-desc").__date(b);a.down(".num-errors").__date();a.down(".view-details").__date(_("View details"));InlineUploadStatus.add_x_button();return a.down(".inline-upload-progress").style.width="100%"},errored:function(){var d,c,a,f,b,e;a=$("inline-upload-status");a.addClassName("error");a.removeClassName("complete");a.down(".icon").__date(Sprite.make("web","nosync"));b=FileQueue.num_files();d=void 0;if(b>1){d=_("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:b-FileQueue.errors,num_files:b});a.down(".file-desc").__date(d);f=ungettext("- %d error","- %d errors",FileQueue.errors).format(FileQueue.errors);a.down(".num-errors").__date(f)}else{c=(e=FileQueue.current_file)!=null?e.name.em_snippet(InlineUploadStatus.FILENAME_SNIPPET_LENGTH):void 0;d=c?_("Unable to upload %(filename)s").format({filename:c}):_("Unable to upload file");a.down(".file-desc").__date(d);a.down(".num-errors").__date()}a.down(".view-details").__date(_("View details"));InlineUploadStatus.add_x_button();return a.down(".inline-upload-progress").style.width="100%"},show:function(a){if(!InlineUploadStatus.upload_box){InlineUploadStatus._build(a)}return InlineUploadStatus.upload_box.show()},_build:function(){if(!InlineUploadStatus.upload_box){InlineUploadStatus.upload_box=$("inline-upload-status")}return $("browse").__sert({top:InlineUploadStatus.upload_box})},hide:function(){if(InlineUploadStatus.upload_box){return InlineUploadStatus.upload_box.hide()}}};CrossDomainUploader={CROSS_DOMAIN_PREFIX:"cross-domain-",_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return CrossDomainUploader.supported()&&Browse.inside_dir},browse_indicators_enabled:function(){var d,b,c,a;if(!CrossDomainUploader.enabled()){return false}b=["file-preview-modal","modal-overlay"];for(c=0,a=b.length;c<a;c++){d=b[c];if($(d).visible()){return false}}return true},modal_indicators_enabled:function(){return CrossDomainUploader.enabled()&&$("modal").down("#upload-modal-dropzone")},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(a){return $j(a).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(b){var a;if(!CrossDomainUploader._drop_indicators){if(CrossDomainUploader.modal_indicators_enabled()){a=$("upload-modal-dropzone");$j(a).clonePosition($j("#modal"),{setLeft:false,setTop:false});a.style.lineHeight=(a.getHeight()-$j("#upload-quota-warning-bar").height())+"px";$j(a).fadeIn(500);CrossDomainUploader._show_border_drop_indicators()}else{if(CrossDomainUploader.browse_indicators_enabled()){BrowseDrag._add_drop_indicators(b)}else{return}}$("drag-status").removeClassName("active");return CrossDomainUploader._drop_indicators=true}},hide_drop_indicators:function(){if(CrossDomainUploader._drop_indicators){CrossDomainUploader._hide_border_drop_indicators();BrowseDrag._remove_drop_indicators();if(!CrossDomainUploader._notifications_cleared){Notify.clear_all()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){CrossDomainUploader._drop_indicators=false;CrossDomainUploader._drop_dest_folder=null;return CrossDomainUploader._notifications_cleared=false}),500)}return CrossDomainUploader._notifications_cleared=true},folder_dragover:function(a){var b;if(CrossDomainUploader.browse_indicators_enabled()&&CrossDomainUploader._drop_indicators){if(OverQuotaUploads.disabled){if(CrossDomainUploader._drop_dest_folder==null){b=_("You can't upload files because you're out of space.");Notify.server_error(b,60);CrossDomainUploader._show_border_drop_indicators()}}else{if(a!==CrossDomainUploader._drop_dest_folder){if(a===Browse.containing_fq_path()){b=_("Drop your file to upload to '%(folder_name)s'").format({folder_name:Util.filename(a).em_snippet(20)});Notify.server_success(b,60);CrossDomainUploader._show_border_drop_indicators()}else{Notify.clear_all();CrossDomainUploader._hide_border_drop_indicators()}}}return CrossDomainUploader._drop_dest_folder=a}},is_cross_domain:function(a){return a.id.indexOf(CrossDomainUploader.CROSS_DOMAIN_PREFIX)!==-1},supports_recursive_upload:function(a){var b;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(a!=null?(b=a[0])!=null?b.webkitGetAsEntry:void 0:void 0)},upload:function(b,c,a){var d;if(a==null){a=null}if(OverQuotaUploads.disabled){d=_("You can't upload files because you're out of space.");return Notify.server_error(d)}else{if(CrossDomainUploader.supports_recursive_upload(a)){return CrossDomainUploader._recursive_upload(b,a)}else{return CrossDomainUploader._upload(b,c,a)}}},_recursive_upload:function(i,h){var j,b,c,g,e,k,a,d;d=(function(){var m,l,f;f=[];for(m=0,l=h.length;m<l;m++){e=h[m];f.push(e.webkitGetAsEntry())}return f})();a=[];c=0;k=0;j=3000;g=0;b=function(){var l,m,f;while(d.length){m=d.pop();if(m.isDirectory){l=m.createReader();c+=1;l.readEntries(function(n){var q,p,o;for(p=0,o=n.length;p<o;p++){q=n[p];d.push(q)}return c-=1})}else{k+=1;f=function(n){return function(o){a.push(o);o.dest=i+Util.parentDir(n.fullPath);return k-=1}};m.file(f(m))}}if(a.length>j&&!g){g=1;Notify.server_error(_("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:j}));return}if(c||k){return b.defer()}else{if(a.length){return CrossDomainUploader._upload("",a)}}};return b()},_upload:function(d,f,c){var a,e,g,b;if(c==null){c=null}if(c){a=this._parse_upload_items(c)}Upload.current_dest=d;if(!$("modal").visible()){FileOps.show_upload();Modal.hide(null,true)}for(g=0,b=f.length;g<b;g++){e=f[g];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(a!=null?a[e.name].isDirectory:void 0)){e.is_directory=true}e.id=CrossDomainUploader.CROSS_DOMAIN_PREFIX+CrossDomainUploader.file_counter;e.dest=e.dest||d;CrossDomainUploader.file_counter++;document.fire(Upload.QUEUE_EVT,{file:e})}return Upload.show_upload()},_parse_upload_items:function(b){var c,d,e,a;c={};for(e=0,a=b.length;e<a;e++){d=b[e];if(d.getAsEntry){d=d.getAsEntry()}else{if(d.webkitGetAsEntry){d=d.webkitGetAsEntry()}}c[d.name]=d}return c},upload_next:function(){var c,a,e,b,d;c=FileQueue.next();if((c.is_directory!=null)&&c.is_directory){setTimeout(CrossDomainUploader._onFolderUpload.curry(c),250);return}b="//"+Constants.BLOCK_CLUSTER+"/upload_cross_domain?filename="+encodeURIComponent(c.name||c.fileName)+"&dest="+encodeURIComponent(FileQueue.next_dest())+"&t="+encodeURIComponent(Constants.TOKEN);FileQueue.current_file=c;if(c.size!=null){a=c.size}else{a=c.fileSize}e={"If-Modified-Since":"Mon, 26 Jul 1997 05:00:00 GMT","Cache-Control":"no-cache","X-File-Name":c.name||c.fileName,"X-File-Size":a};if((d=c.type)!=null?d.length:void 0){e["X-File-Type"]=c.type}return CrossDomainUploader.current_req=new Ajax.DBRequest(b,{method:"POST",contentType:c.type||"application/octet-stream",evalJS:false,evalJSON:false,no_watch:true,requestHeaders:e,postBody:c,onCreate:CrossDomainUploader._onCreate.bind(null,c),onSuccess:CrossDomainUploader._onSuccess.bind(null,c),onFailure:CrossDomainUploader._onFailure.bind(null,c)})},_onCreate:function(a,c){var b;b=c.request.transport;b.upload.addEventListener("progress",(function(d){if(!FileQueue.cancelled_files[a.id]){return document.fire(Upload.UPDATE_EVT,{file:a,percent_complete:d.loaded/d.total})}}),false);return b.send=b.send.wrap(function(e,d){this.withCredentials="true";return e(d)})},_onSuccess:function(a,b){return document.fire(Upload.COMPLETE_EVT,{file:a})},_onFailure:function(a,b){if(!FileQueue.cancelled_files[a.id]){if(a.size){return document.fire(Upload.ERROR_EVT,{file:a,message:_("Upload error"),tooltip_text:_("Please try again. If this continues to fail, your browser might not support drag and drop uploads.")})}else{return document.fire(Upload.ERROR_EVT,{file:a,message:_("Invalid type"),tooltip_text:_("You can't upload folders or files of this type.")})}}},_onFolderUpload:function(a){document.fire(Upload.ERROR_EVT,{file:a,message:_("Invalid type"),tooltip_text:_("Drag and drop doesn't support folder uploads.")});if(!FileQueue.empty()){return CrossDomainUploader.upload_next()}}};OverQuotaUploads={disabled:false,init:function(b,a){this.disabled=b;this.variant=a;if(this.disabled){return $j("body").addClass("uploads-disabled")}},log_show_bar:function(){var a;a={variant:OverQuotaUploads.variant};return GrowthWebActivityLogger.log("quota-upload-bar-show",a)}};var AccountExtras;AccountExtras={prices:{},prices_value:{},watch_id:0,watch:function(){if(!AccountExtras.watch_id){return AccountExtras.watch_id=setInterval(AccountExtras.update_prices,200)}},show_detail:function(a,d,b){var c;c=_("What is %(feature_name)s?").format({feature_name:a});Modal.icon_show("alert_32",c,$(d+"-modal"),{},false);return false},register_price:function(e,a,d,c,b){AccountExtras.prices[e]=[a,d];return AccountExtras.prices_value[e]=[c,b]},update_prices:function(){var f,d,a,b,c,e;e=$("yearly").checked;d=(e?1:0);a=(e?_("year"):_("month"));b=0;for(f in AccountExtras.prices){if(AccountExtras.prices.hasOwnProperty(f)){$(f+"-price").__date(AccountExtras.prices[f][d]);$(f+"-priceperiod").__date(a)}if(AccountExtras.prices_value.hasOwnProperty(f)){if($(f).checked){c=AccountExtras.prices_value[f][d];b+=parseFloat(c)}}}return $(document).fire("widget:update_price",{price:b,period:a})}};var BonusTable;BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(){if(BonusTable._inited){return}BonusTable._inited=true;$("bonus-loading").show();BonusTable._tmpl=HTML.tmpl("bonus_row_tmpl");BonusTable.listen();return BonusTable.get_next_page()},_render:function(d){var b,e,c,a;b=[];for(c=0,a=d.length;c<a;c++){e=d[c];b.push(BonusTable._tmpl({row:e}))}return $("bonus-table").__sert(b)},get_next_page:function(){if(BonusTable._fetching_page){return}BonusTable._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+BonusTable._next_page,{onSuccess:function(b){var d,a,c;d=b.responseText.evalJSON();c=d.rows;a=d.has_more;BonusTable._render(c);$("bonus-loading").hide();if(a){BonusTable._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return BonusTable._fetching_page=false}})},_max_referral_over:function(b){var a,d,c;d=$j(b.currentTarget);c=_("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");a=$j(Bubble.make(c,"right","middle"));Element.absolutize(a[0]);d.append(a);a.clonePosition(d,{setWidth:false,setHeight:false});return a.css({width:"200px",left:(parseInt(a.css("left"),10)-210)+"px",top:(parseInt(a.css("top"),10)-55)+"px"})},_max_referral_out:function(h){var a,g,d,f,c;f=$j(".reached-max-referral-bonus .bubble");c=[];for(g=0,d=f.length;g<d;g++){a=f[g];c.push(a.remove())}return c},listen:function(){$j("#bonus-content").on("click","#load-more-bonus",BonusTable.get_next_page);$j(document).on("mouseenter",".reached-max-referral-bonus",BonusTable._max_referral_over);return $j(document).on("mouseleave",".reached-max-referral-bonus",BonusTable._max_referral_out)}};var ChangeEmail,ChangeEmailModal,ChangeEmailWarningModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};ChangeEmailWarningModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.on_confirm_button_click=function(c){c.preventDefault();this.hide();return ChangeEmail.show_form()};return b})(DBModal);ChangeEmailModal=(function(a){__extends(b,a);function b(){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_show=function(){SickInput.init();return this.$modal_window.find("#change-email").addClass("warnings-not-seen")};b.prototype.on_confirm_button_click=function(f){var c,d,g;f.preventDefault();d=this.$modal_window.find(".change-email-form")[0];g=function(){if(window.location.pathname.indexOf("/account")===0){return window.location.reload()}else{return window.location.href="/home?send_verification_email=1"}};c=function(e){if((e!=null?e.status:void 0)===403){Notify.server_error(_("Request failed due to an unknown authentication error.  Please sign out of Dropbox and sign back in to try again."));return location.reload(true)}};return Forms.ajax_submit(d,false,g,c,$(f.target))};return b})(DBModal);ChangeEmail={show_warning:function(){if(!this.warning_modal){this.warning_modal=new ChangeEmailWarningModal({element_id:"change-email-warning"})}return this.warning_modal.show()},show_form:function(){if(!this.modal){this.modal=new ChangeEmailModal({element_id:"change-email",focus:".textinput[name=email]"})}return this.modal.show()},show:function(){if(this.warning===true){return this.show_warning()}return this.show_form()}};var DowngradeReasons;DowngradeReasons={reasons:{},addReason:function(a){return this.reasons[a]=true},addReasons:function(a){var d,e,c,b;b=[];for(e=0,c=a.length;e<c;e++){d=a[e];b.push(this.addReason(d))}return b},change:function(f,c,a){var g,i,h,d,b,e;f=parseInt(f,10);i=$(c);assert(i,"Couldn't find container for DowngradeReason");g=false;e=this.reasons;for(d in e){h=e[d];b=$(a+d);assert(b,"Couldn't find container for ",a+d);if(h&&parseInt(d,10)===f){b.show();g=true}else{b.hide()}}if(g){return i.show()}else{return i.hide()}}};var Downloading;Downloading={registerAll:function(){if(Prototype.Browser.IE){return $$(".downloading-link").each(Downloading.register)}},register:function(a){a=$(a);return a.observe("click",Downloading.clicked)},clicked:function(b){var a,c;Event.stop(b);c=$(b.target);if(c.nodeName==="SPAN"){c=c.up("a")}a=c.href.split("?").last();window.location="/download?"+a;return setTimeout((function(){return window.location="/downloading?"+a}),4000)}};Util.smartLoad(Downloading.registerAll);var EmailVerification;EmailVerification={EMAIL_SENT_EVT:"db:verification_email_sent",polling:false,show_resend:false,send_email:function(a){return new Ajax.DBRequest("/sendverifyemail",{parameters:{reason:a},onSuccess:function(){return $j(document).trigger(EmailVerification.EMAIL_SENT_EVT)}})},poll_until_verified:function(){var a,b=this;a=4000;return new Ajax.DBRequest("/isemailverified",{onSuccess:function(c){if(c.responseText==="ok"){return window.location.reload()}else{return setTimeout(EmailVerification.poll_until_verified,a)}}})},email_sent:function(){var a;this.show_resend=true;this.show();a=_("Verification email sent to %(email)s");a=a.format({email:Constants.email});Notify.server_success(a);if(!this.polling){this.poll_until_verified();return this.polling=true}},show:function(){if(this.show_resend){return this.show_resend_verify_modal()}return this.show_verify_modal()},show_verify_modal:function(){if(!this.verify_modal){this.verify_modal=new VerifyEmailModal({element_id:"verify-email"})}return this.verify_modal.show()},show_resend_verify_modal:function(){if(!this.resend_verify_modal){this.resend_verify_modal=new ResendVerifyEmailModal({element_id:"resend-verify-email"})}return this.resend_verify_modal.show()},verified:function(){assert($j("#db-modal-verify-email").length,"missing verify-email modal content");assert($j("#db-modal-change-email").length,"missing change-email modal content");if(Constants.EMAIL_VERIFIED){return true}else{this.show();return false}},show_sent_modal:function(){if(!this.sent_modal){this.sent_modal=new DBModal({element_id:"verification-email-sent"})}return this.sent_modal.show()},show_verified_modal:function(){if(!this.verified_modal){this.verified_modal=new DBModal({element_id:"email-verified"})}return this.verified_modal.show()},setup:function(a){return Util.smartLoad(function(){$j("#send-email-link").on("click",function(b){b.preventDefault();return EmailVerification.send_email(a)});return $j(document).on(EmailVerification.EMAIL_SENT_EVT,function(){$j("#pre-resend").hide();$j("#post-resend").show();$j("#pre-resend-header").hide();return $j("#post-resend-header").show()})})}};var GetSpace;GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(c,b,d){var a;GetSpace._current_space=c;GetSpace._why_msg=b;GetSpace._twitter_url=d;if($("why_like")&&$("twitter_post")){$("twitter_post").hide()}$("space-actions").on("click",".space-action",GetSpace.perform_action);a=Util.url_hash();if(a){return GetSpace.highlight_offer(a)}},highlight_offer:function(b){var a,c;a=$j("#"+b);c=a.css("background-color");return a.css("background-color",GetSpace.offer_highlight_color).delay(2000).animate({"background-color":c}).queue(function(){return a.css("background-color","")})},perform_action:function(b){var c,a;a={contact_sales:GetSpace._contact_sales,contact_support:GetSpace._contact_support,teams:GetSpace._teams,upgrade:GetSpace._upgrade,plans:GetSpace._plans,refer:GetSpace._refer,get_started:GetSpace._get_started,fb_link:GetSpace._fb_link,twitter_link:GetSpace._twitter_link,twitter_follow:GetSpace._twitter_follow,why_like:GetSpace._why_like,twitter_post:GetSpace._twitter_post,mailbox_link:GetSpace._mailbox_link};c=$(b.target);if(!c.hasClassName("space-action")){c=c.up(".space-action")}return a[c.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return FacebookOAuth.do_auth(function(){GetSpace._refresh_link_bonuses();return GetSpace._completed($("fb_link"))})},_twitter_link:function(){return Twitter.do_auth(function(){GetSpace._refresh_link_bonuses();Twitter.has_authed=1;return GetSpace._completed($("twitter_link"))})},_twitter_follow:function(){if(Twitter.has_authed){return GetSpace.follow_dropbox()}else{return Twitter.do_auth(GetSpace.follow_dropbox)}},_why_like:function(){Modal.icon_show("heart_32",_("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return Util._track_twitter_chars_left("why-i-like-input",90)},_twitter_post:function(){if(Twitter.has_authed){return GetSpace.start_twitter_post()}else{return Twitter.do_auth(GetSpace.start_twitter_post)}},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/download"},follow_dropbox:function(){if(!Twitter.has_authed){GetSpace._refresh_link_bonuses();Twitter.has_authed=1}return Twitter.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(_("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(_("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){GetSpace._completed($("twitter_link"))}return GetSpace._completed($("twitter_follow"))}})},submit_why:function(){GetSpace._why_msg=$F("why-i-like-input");return Forms.ajax_submit($("why-i-like-form"),false,(function(){Modal.hide();GetSpace._completed($("why_like"));if($("twitter_post")){return setTimeout((function(){return $j("#twitter_post").css("opacity",0).slideDown().animate({opacity:1},{queue:false,duration:2500})}),2500)}}),false,$("why-i-like-submit"))},start_twitter_post:function(){Modal.onHide=function(){if(!Twitter.has_authed){GetSpace._refresh_link_bonuses();Twitter.has_authed=1}if($("twitter_link")&&$("twitter_link").visible()){GetSpace._completed($("twitter_link"))}delete Modal.onHide;return Modal.hide()};return Twitter.get_user_info(function(a){Modal.icon_show("tweet_32",_("Tweet about your love of Dropbox"),$("twitter-post-modal"));$("twitter-post-header").down(".profile-pic").__date(new Element("img",{src:a.profile_image_url_https}));$("twitter-post-header").down(".name").__date(a.name);$("twitter-post-header").down(".username").__date("@"+a.screen_name);GetSpace._update_display_twitter_post();$("twitter-post-input").setValue(GetSpace._why_msg);return Util._track_twitter_chars_left("twitter-post-input",90)})},show_edit_twitter_post:function(){$("display-twitter-post").hide();$("display-twitter-post-buttons").hide();$("edit-twitter-post").show();$("edit-twitter-post-buttons").show();$("twitter-post-input").observe("keypress",function(a){if(a.keyCode===13){return GetSpace.hide_edit_twitter_post()}});return $("twitter-post-input").focus()},hide_edit_twitter_post:function(){var a;a=$F("twitter-post-input");if(!a){Notify.server_error(_("Please enter a message"));return}else{if(a.length>90){Notify.server_error(_("Your post must be 90 characters or less"));return}}GetSpace._why_msg=a;GetSpace._update_display_twitter_post();$("edit-twitter-post").hide();$("edit-twitter-post-buttons").hide();$("display-twitter-post").show();return $("display-twitter-post-buttons").show()},do_twitter_post:function(){var a;Twitter.from_getspace=1;a=_("I love Dropbox because %(why_msg)s %(referral_link)s").format({why_msg:GetSpace._why_msg,referral_link:GetSpace._twitter_url});if(a.length>140){GetSpace.show_edit_twitter_post();Notify.server_error(_("Your tweet must be 140 characters or less"));return}Twitter.custom_show_posting=function(){return Forms.add_loading($("twitter-post-submit"))};return Twitter.custom_post(a,function(){Modal.hide();return GetSpace._completed($("twitter_post"))})},_update_display_twitter_post:function(){var a;$("display-twitter-post").__date(_("I love Dropbox because %(why_msg)s ").format({why_msg:GetSpace._why_msg}));a=new Element("a",{href:GetSpace._twitter_url,target:"_blank"});a.__date(GetSpace._twitter_url);return $("display-twitter-post").__sert(a)},_completed:function(b){var a;b.addClassName("completed");b.down(".icon-col").__date(Sprite.make("web","check_36"));$j(b).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return $j(b).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);a=parseInt(b.down(".space").readAttribute("data-space"),10);GetSpace._current_space+=a;$("current-space").__date(Util.formatBytes(GetSpace._current_space,2,true));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var Help;Help={toggle_more_help:false,show_os:function(b,c,a){c=$(c);$$(".os-filter").invoke("removeClassName","selected");c.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+a).invoke("show");return Event.stop(b)},vote:function(a,b){new Ajax.DBRequest("/help/"+a+"/vote/"+b);$j("#help-vote-cont").fadeOut();return Notify.server_success(_("Thanks for your feedback!"))}};var Home;Home={hide_promo:function(a){new Ajax.DBRequest(a);return $$(".house-ad").invoke("remove")},hide:function(b,a){$(b).up("div").hide();return new Ajax.DBRequest("/hide/"+a)}};var Hosts,UnlinkHostModal,show_unlink_host_modal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};Hosts={edit:function(g){var d,c,f,a,b,e;f=$("host"+g);if(f.editing){return false}f.editing=true;c=f.innerHTML.unescapeHTML();f.previous=c;e=c.escapeHTML().gsub('"',"&quot;");b=_("Save");d=_("Cancel");f.innerHTML='<input type="text" class="skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" value="'+e+'">&nbsp;\n<input type="button" onclick="Hosts.doneEditing(\''+g+'\')" class="button" value="'+b+'">&nbsp;\n<input type="button" onclick="Hosts.cancelEditing(\''+g+'\')" class="button grayed" value="'+d+'">';a=f.down("input");Event.observe(a,"keydown",Hosts.checkKey(g));a.select();return false},doneEditing:function(c){var b,a;b=$("host"+c);a=b.down("input").value;return new Ajax.DBRequest("/computer_edit?host_id="+c+"&name="+Util.urlquote(a),{onSuccess:function(d){return Hosts.unedit(b,d.responseText)}})},cancelEditing:function(b){var a;a=$("host"+b);return Hosts.unedit(a,a.previous)},unedit:function(b,a){b.editing=false;return b.__date(a)},dismiss:function(b,a){new $j.ajax("/computer_edit",{type:"POST",data:{host_id:b,dismiss_unlink:"yessir"},success:function(c){return a.remove()}});return false},unlink:function(c,b,a){DomUtil.fillVal(b.escapeHTML(),"unlink-confirm-name");return Modal.icon_show("alert_32",_("Unlink computer?"),DomUtil.fromElm("unlink-confirm"),{host_id:c,plat:a,wit_group:"unlink-confirm"})},doUnlink:function(b,a){return new Ajax.DBRequest("/computer_edit?host_id="+b+"&unlink=yessir",{onSuccess:function(c){Hosts.killRow(b);return Hosts.dec_count(a)}})},dec_count:function(a){var c,b,e,d;b=$(a+"-count");if(!b){return}d=b.innerHTML.split(" ");c=parseInt(d.shift(),10);e=d.join(" ");if(!c){return}c--;if(c===1&&e.charAt(e.length-1)==="s"){e=e.substr(0,e.length-1)}else{if(c!==1&&e.charAt(e.length-1)!=="s"){e=e+"s"}}return b.innerHTML=c.toString()+" "+e},killRow:function(d){var b,a,c;a=$("host"+d).up("table");$("host"+d).up("tr").remove();if(Hosts.rowCount()===0){b=new Element("tr");c=new Element("td",{colspan:4});c.__date(HTML.tmpl("<center><%= text %></center>",{text:_("You no longer have any hosts linked.")}));a.__sert(b);b.__sert(c);return $("my-computers-table").__date(b)}},rowCount:function(){return $$("#my-computers-table .host-row").length},checkKey:function(a){return function(b){b=b||window.event;if(b.keyCode===Event.KEY_RETURN){Hosts.doneEditing(a)}if(b.keyCode===Event.KEY_ESC){return Hosts.cancelEditing(a)}}}};UnlinkHostModal=(function(b){__extends(a,b);function a(){this.on_show=__bind(this.on_show,this);this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_confirm_button_click=function(f){var c,d;f.preventDefault();d=this.$modal_window.find(".unlink_host_form")[0];c=$(this.$modal_window.find(".confirm-button")[0]);return Forms.ajax_submit(d,false,this.success_callback,false,c)};a.prototype.success_callback=function(){this.hide();Hosts.killRow(this.host_id);return Hosts.dec_count(this.plat)};a.prototype.on_show=function(c){this.$modal_window.find(".delete_data").attr("checked",false);if(this.delete_supported==="False"){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}this.$modal_window.find("[type=hidden][name=host_id]").attr("value",this.host_id);return this.$modal_window.find(".host_name").text(this.name)};return a})(DBModal);show_unlink_host_modal=function(c,b,a,f){var e,d;d=new UnlinkHostModal({element_id:"unlink-host-modal"});d.host_id=c;d.name=b;d.plat=a;d.delete_supported=f;d.show();e=d.$modal_window.find(".unlink_host_form")[0];return e.on("submit",d.on_confirm_button_click)};var Install;Install={pingForLinkedHost:function(a){return new Ajax.Request("/host_linked",{method:"get",onSuccess:function(){return location.href="/share"+a},onFailure:function(){return setTimeout(Install.pingForLinkedHost.curry(a),3000)}})}};var LoginAndRegister;LoginAndRegister={init:function(a){$("login-link").observe("click",function(){$("login-and-register-container").removeClassName("show-register");return $("login_email").focus()});$("register-link").observe("click",function(){$("login-and-register-container").addClassName("show-register");return $("fname").focus()});if(a){return $("fname").focus()}else{return $("login_email").focus()}},invite_init:function(b,a){if(!a){return $("invite-register-page").on("click",".switch-form-link",function(){return $("invite-register-page").toggleClassName("show-login-form")})}}};var News;News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(b,c){var a;if(c.hasAttribute("data-div")){b.preventDefault();a=c.readAttribute("data-div");return DBHistory.push_state("/news/"+a)}});return DBHistory.add_callback("/news",News.history_change)},change_tab:function(a){var b;b=$$("#nav a[data-div="+a+"]").first();if($(b)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(b).addClassName("selected");return $(a).addClassName("selected")}},history_change:function(a){a=a||News.DEFAULT_TAB;return News.change_tab(a)}};var PasswordChange;PasswordChange={show_change_password_modal:function(){return Modal.icon_show("alert_32",_("Change password"),$("change-password"),{},false,550)},submit_password_change:function(c){var a,b,d;b=$("change-password-form");d=function(){return window.location.reload()};a=function(e){if((e!=null?e.status:void 0)===403){Notify.server_error(_("Request failed due to an unknown authentication error.  Please sign out of Dropbox and sign back in to try again."));return window.location.reload(true)}};return Forms.ajax_submit(b,false,d,a,$(c.target))}};var PromoHolder;PromoHolder={init:function(b,c,a){if(!b){return new Ajax.DBRequest("/promo",{parameters:{force_campaign:c,force_promo:a},noAutonotify:true,no_watch:true,onSuccess:function(f){var e,d;if(f.responseText.length>0){$j("#promo_holder").html(f.responseText);e=$j("#promo_holder img");d=0;return e.load(function(){d++;if(d===e.length){Event.observe(window,"resize",PromoHolder.check_sizing);return Util.smart_window_load(PromoHolder.check_sizing)}})}}})}},check_sizing:function(){var a,c,e,d,f,b;f=$$("#promo_holder div");if(!f.length){return}e=f[0];a=20;c=$("page-sidebar");b=c.cumulativeOffset().top+c.getLayout().get("height");d=e.cumulativeOffset().top;if(b+a>d||$(document.body).getWidth()<1015){return $j("#promo_holder").css("visibility","hidden")}else{return $j("#promo_holder").css("visibility","visible")}}};var Recover;Recover={init:function(){var a;a=$("recover-form");return a.observe("submit",this.form_submit.bind(this))},form_submit:function(a){this.clear_error();a.preventDefault();return Forms.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(b){var a;a=Util.from_json(b.responseText);if(a.status==="error"){this.show_error(a.msg)}if(a.status==="ok"){this.show_hosts(a)}if(a.status==="redirect"){return window.location.href=a.url}},show_hosts:function(h){var e,c,d,a,g,b,f;Forms.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(h.filename);c=$("trusted-hosts");c.update();f=h.hosts;for(g=0,b=f.length;g<b;g++){e=f[g];a=new Element("li");d="lnx";if(e.platform==="mac"){d="osx"}if(e.platform==="win"){d="win"}a.__sert(Sprite.make("web",d));a.__sert(new HTML(e.display_name.escapeHTML()));c.appendChild(a)}$("login-step").hide();return $("hosts-step").show()},show_error:function(a){$("error-messages").update(a);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var Restore;Restore={next:function(a,d){var c,b;b=$j("ul.selected");c=b.next("ul");c.addClass("selected");b.removeClass("selected");if(c.next("ul").length){$j("#next-page").show()}else{$j("#next-page").hide()}$j("#prev-page").show();return Restore.inc_page(1)},prev:function(a,d){var c,b;b=$j("ul.selected");c=b.prev("ul");c.addClass("selected");b.removeClass("selected");if(c.prev("ul").length){$j("#prev-page").show()}else{$j("#prev-page").hide()}$j("#next-page").show();return Restore.inc_page(-1)},inc_page:function(c){var b,a;b=parseInt($j("#page_num").text(),10);a=b+c;return $j("#page_num").text(a)},init:function(b,c,a){$j("#next-page").on("click",function(d){Restore.next(d);return false});$j("#prev-page").on("click",function(d){Restore.prev(d);return false});if(b){$j("#restore-submit-button").on("click",function(d){FileOps.do_folder_restore(c);return false})}$j("#restore-cancel-button").on("click",function(d){return location.href=a});return $j("#restore-back-button").on("click",function(d){return location.href=a})}};var SecurityTab;SecurityTab={_submit_form:function(b){var a,c;c=function(){return Notify.server_success(_("Settings changed successfully."))};a=function(){return Notify.server_error(_("There was a problem completing this request."))};return Forms.ajax_submit(b,"/account/security_email",c,a)},init:function(){var d,b,c,a,e=this;b=$("show-change-password");if(b){b.on("click",function(f){$("newpass").value="";$("oldpass").value="";PasswordChange.show_change_password_modal();return f.preventDefault()})}c=$("security-email");if(c){d=$("new_api_app_linked");a=$("newhostlinked");if(d){new Form.Element.Observer(d,0.1,function(){return e._submit_form(c)})}if(a){return new Form.Element.Observer(a,0.1,function(){return e._submit_form(c)})}}}};var TabController;TabController=Class.create({initialize:function(c,b){var a;a=$(c);assert(a,c+" is missing.");this.container=a;this.options={killEvent:true};Object.extend(this.options,b);return this.listen()},listen:function(){var f,c,e,b,d,a;c=this;d=this.container.select("a");a=[];for(e=0,b=d.length;e<b;e++){f=d[e];assert(f.id&&f.id.length>0,"Element is missing an id");a.push(f.observe("click",(function(g){return this.click(g)}).bindAsEventListener(c)))}return a},click:function(a){if(this.options.killEvent){Event.stop(a)}return this.toggle($(a.target))},toggle:function(b){var e,a,d,f,c;c=this.container.down("a.selected");if(c){f=$(c.id+"-content");if(f){f.hide()}}this.container.select(".selected").invoke("removeClassName","selected");a=false;if(!b){b=this.container.down("a");a=true}b.addClassName("selected");e=$(b.id+"-content");if(e){e.show()}if(this.options.onTabChange){this.options.onTabChange(b,c)}if(this.options.url_prefix){d=this.options.url_prefix;if(!a){d+="/"+b.id}return DBHistory.push_state(d)}}});var VerifyEmailModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};VerifyEmailModal=(function(b){__extends(a,b);function a(){this._email_sent_callback=__bind(this._email_sent_callback,this);this._open_change_email_modal=__bind(this._open_change_email_modal,this);return a.__super__.constructor.apply(this,arguments)}a.prototype._open_change_email_modal=function(c){c.preventDefault();this.hide();return ChangeEmail.show()};a.prototype._email_sent_callback=function(){this.hide();return EmailVerification.email_sent()};a.prototype._send_email=function(d){var c;d.preventDefault();c=this.$modal_window.find(".verify-email-reason").attr("data-reason");return EmailVerification.send_email(c)};a.prototype.on_show=function(){this.$change_email_link=this.$modal_window.find(".change-email-before-verify");this.$change_email_link.on("click",this._open_change_email_modal);return $j(document).on(EmailVerification.EMAIL_SENT_EVT,this._email_sent_callback)};a.prototype.on_hide=function(){this.$change_email_link.off("click");return $j(document).off(EmailVerification.EMAIL_SENT_EVT)};a.prototype.on_confirm_button_click=function(c){return this._send_email(c)};return a})(DBModal);var ResendVerifyEmailModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};ResendVerifyEmailModal=(function(b){__extends(a,b);function a(){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_confirm_button_click=function(c){c.preventDefault();return this.hide()};a.prototype.on_cancel_button_click=function(c){return this._send_email(c)};return a})(VerifyEmailModal);var HandlePricingTable;HandlePricingTable=Class.create({initialize:function(f,g,h,e,d,c,b,a){this.baseSpace=parseInt(f,10);this.baseUsers=g;this.baseCost=h;this.basePrice=e;this.licensePackQuota=d;this.maxAdditionalLicenses=c;this.prorateAmt=b;this.discountRatio=a;return this.listen()},cash_format:function(a){return a.toFixed(2).replace(/\.00/,"")},handle:function(){var c,b,a,e,d;e=parseInt($("team_num_users").value,10)||0;d=this.baseCost;b=this.baseUsers;c=0;if(this.licensePackQuota){a=Math.max(e-this.baseUsers,0);$("extra_user_licenses_num").__date(a);$("extra_user_licenses_cost").__date(_("$%(num_dollars)s").format({num_dollars:a*this.basePrice}));if(a>0){$("extra_user_licenses_space").__date(Util.formatGB(a*this.licensePackQuota,true,true))}$("total_space").__date(Util.formatGB(a*this.licensePackQuota+this.baseSpace,true,true));$("total_licenses").__date(a+this.baseUsers);d=this.baseCost+a*this.basePrice;b+=this.maxAdditionalLicenses}else{$("total_space").__date(Util.formatGB(this.baseSpace,true,true));$("total_licenses").__date(this.baseUsers)}if(this.discountRatio){c=d*this.discountRatio;d=d-c}d=Math.max(d-this.prorateAmt,0);if(e>b){$("final_price_message").addClassName("hidden_elem");$("pricing_info").addClassName("hidden_elem");$("over_max_warning").removeClassName("hidden_elem")}else{if(e<=0){$("final_price_message").addClassName("hidden_elem");$("pricing_info").addClassName("hidden_elem");$("over_max_warning").addClassName("hidden_elem")}else{$("final_price_message").removeClassName("hidden_elem");$("pricing_info").removeClassName("hidden_elem");$("over_max_warning").addClassName("hidden_elem")}}if(e>0&&e<this.baseUsers){$("low_user_warning").removeClassName("hidden_elem")}else{$("low_user_warning").addClassName("hidden_elem")}$("total_price").__date(_("$%(num_dollars)s").format({num_dollars:this.cash_format(d)}));$("total_price_footer").__date(_("$%(num_dollars)s").format({num_dollars:this.cash_format(d)}));if(this.discountRatio){$("discount_ratio_amt").__date(_("-$%(num_dollars)s").format({num_dollars:this.cash_format(c)}))}if(e>this.baseUsers){$("extra_user_licenses_row").removeClassName("hidden_elem")}else{$("extra_user_licenses_row").addClassName("hidden_elem")}if(e>this.baseUsers||this.prorateAmt){return $("pricing_table_totals_wrapper").removeClassName("hidden_elem")}else{return $("pricing_table_totals_wrapper").addClassName("hidden_elem")}},listen:function(){var a,b=this;a=function(){return b.handle.bind(b).delay(1)};$("team_num_users").observe("keyup",a);$("team_num_users").observe("blur",this.handle.bind(this));return Util.smartLoad(this.handle.bind(this))},setProrateAmt:function(a){if($("prorate_amt_row")&&$("prorate_amt")){if(a){$("prorate_amt_row").show()}else{$("prorate_amt_row").hide()}$("prorate_amt").__date(_("-$%(num_dollars)s").format({num_dollars:this.cash_format(a)}))}this.prorateAmt=a;return this.handle()}});var InviteForm;InviteForm={init:function(){var a=this;return $j(function(){a.add_auto_completer=new Autocompleter.ContactsTokenizer("team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",window.contacts,window.lcontacts,{tokens:[",",";"],include_team:false,hide_import_contacts:true,suggestions_disabled:true});a.tokenAdd=$j.proxy(a._tokenAdd,a);a.tokenRemove=$j.proxy(a._tokenRemove,a);$j("#team-invite-new-collab-input")[0].on("token:add",a.tokenAdd);$j("#team-invite-new-collab-input")[0].on("token:remove",a.tokenRemove);a.reset_licenses();SickInput.init();SuggestionInput.reset("team-invite-message");return a.add_auto_completer.clearTokens()})},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this._update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(){this.available_licenses-=1;this.new_users+=1;this._update_license_count();return $j(window).trigger("token:changed")},_tokenRemove:function(){this.available_licenses+=1;this.new_users-=1;this._update_license_count();return $j(window).trigger("token:changed")},_update_license_count:function(){var a;a=this.available_licenses<0?_("You need more licenses for this invitation."):this.available_licenses===0?_("You have no remaining licenses."):ungettext("You have %d remaining license.","You have %d remaining licenses.",this.available_licenses).format(this.available_licenses);return $j("#license-count-message").text(a)},init_modal_licenses:function(b,a){if(!this.invite_modal){this.invite_modal=new InviteModal()}this.total_licenses=b;this.used_licenses=$j(".team_admin_table_row").length;return this.is_trial=a},init_form_licenses:function(c,a,b){this.total_licenses=c;this.used_licenses=a;return this.is_trial=b}};var InviteModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};InviteModal=(function(b){__extends(a,b);function a(){a.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"})}a.prototype.on_confirm_button_click=function(c){Team.add_users(c);$j(".ajax_submit_loading").hide();return this.hide()};return a})(DBModal);var EnterpriseWarningModal,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};EnterpriseWarningModal=(function(b){__extends(a,b);function a(d,c){var e,f=this;a.__super__.constructor.call(this,{element_id:d,click_out_to_close:false});e=$j("#"+c);e.click(function(){if(e.is(":checked")){return f.show()}})}return a})(DBModal);var Team;Team={invite_modal_show:function(){if(!this.invite_modal_already_initialized){InviteForm.invite_modal.show();InviteForm.init();return this.invite_modal_already_initialized=true}else{return InviteForm.invite_modal.show()}},init_admin:function(){TitleBubble.set_vertical_space(2);return $j("form.activity-report-generator").submit(this.submit_report_form.bind(this))},add_users:function(b){var c,a;Event.stop(b);a=$("team-invite-form");assert(a,"Couldn't find the team invite form.");c=$j(a).find("input[name='emails']");return Forms.ajax_submit(a,"/account/team/add_users",(function(f){var d,e;Modal.hide();e=$$(".team_admin_members_table")[0];if(Constants.use_async_members){d=Util.from_json(f.responseText);TeamMemberTable.add_users(d);if(c.length===1){return Notify.server_success(_("Invited %(user_email)s").format({user_email:c[0].value}))}else{if(c.length>1){return Notify.server_success(ungettext("Invited %(user_count)d user.","Invited %(user_count)d users.",c.length).format({user_count:c.length}))}}}else{return e.update(f.responseText)}}),(function(){return Forms.enable(a.down("input[type='submit']"))}),b.target,{team_id:Constants.team_id},null,null,true)},show_remove_modal:function(d,e,a,b,g,c){var f;if(e){DomUtil.fillVal(e,"remove-user-name");f=_("Remove '%(user_name)s'").format({user_name:e})}else{DomUtil.fillVal(b,"remove-user-name");f=_("Remove '%(user_email)s'").format({user_email:b})}if(!g&&c){$("user-migrated-message").show();$("delete-account").checked=false;$("remove-from-team").checked=true}else{$("user-migrated-message").hide();$("remove-from-team").checked=false;$("delete-account").checked=true}if(!g){return Modal.icon_show("delete_32",f,$("remove-user-modal"),{user_id:a,button:d})}else{return Modal.icon_show("delete_32",f,$("remove-user-modal-simple"),{user_id:a,button:d,disable_if_joined:false})}},remove_user:function(c,f){var b,a,d=this;Event.stop(c);a=Modal.vars.user_id;if(f){b=true}else{b=$j("input[name=disable_if_joined]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:Constants.team_id,user_id:a,disable_if_joined:b},onSuccess:function(e){var g;if(Constants.use_async_members){TeamMemberTable.remove_user(Modal.vars.user_id)}else{g=Modal.vars.button.up(".bs-row");if(!g){g=Modal.vars.button.up(".member-row")}if(!g){g=Modal.vars.button.up(".team_admin_table_row")}if(!g){window.location=window.location.pathname+"?flash=removed-user";return}g.remove()}d.decrement_used_licenses();return Notify.server_success(_("User removed."))},cleanUp:function(){return Modal.hide()}})},show_reinvite_modal:function(c,d,a,b){var e;DomUtil.fillVal(b,"reinvite-user-email");DomUtil.fillVal(d,"reinvite-user-team");e=_("Resend invite to '%(email_address)s'").format({email_address:b.em_snippet(18)});return Modal.icon_show("email_32",e,$("reinvite-user-modal"),{user_id:a,button:c})},reinvite_user:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:Constants.team_id,user_id:a},onSuccess:function(c){var d;Notify.server_success(_("Invite sent."));return(d=$("team-member-info"))!=null?d.update(c.responseText):void 0},cleanUp:function(){return Modal.hide()}})},show_reset_password_modal:function(b,c,a){var d;$j("#reset-password-modal .member-name").text(c);d=_("Reset password for '%(user_name)s'").format({user_name:c});return Modal.icon_show("arrow_refresh_32",d,$("reset-password-modal"),{user_id:a,button:b})},reset_password:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:Constants.team_id,user_id:a},onSuccess:function(c){return Notify.server_success(_("User's password reset."))},cleanUp:function(){return Modal.hide()}})},show_reset_all_passwords_modal:function(){return Modal.icon_show("arrow_refresh_32",_("Reset all passwords"),$("reset-all-passwords-modal"))},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:Constants.team_id},job:Constants.use_async_reset,progress_text:_("Resetting all passwords..."),onSuccess:function(a){return Notify.server_success(_("All passwords reset."))},cleanUp:function(){return Modal.hide()}})},show_admin_status_modal:function(c,i,k,e,j,f){var b,g,a,d,h;a=j.strip()||e;d=void 0;b=void 0;h=void 0;g=void 0;if(f){d=_("Are you sure you want to make <strong>%(person_name)s</strong> an admin?").format({person_name:a.escapeHTML()});b=_("Make admin");h=_("Make '%(person_name)s' an admin").format({person_name:a.escapeHTML()});g="alert_32"}else{d=_("Are you sure you want to remove admin privileges for <strong>%(person_name)s</strong>?").format({person_name:a.escapeHTML()});b=_("Remove admin status");h=_("Remove admin privileges for '%(person_name)s'").format({person_name:a.escapeHTML()});g="alert_32"}DomUtil.fillVal(e,"admin-status-email");DomUtil.fillVal(d,"admin-status-action");DomUtil.fillVal(b,"admin-status-button-action");return Modal.icon_show(g,h,$("admin-status-modal"),{user_id:k,button:c,admin_on:f})},set_admin_status:function(b){var a;Event.stop(b);a=Modal.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:Constants.team_id,user_id:a,on:(Modal.vars.admin_on?"yes":"no")},onSuccess:function(c){var d;if($j(".team_admin_members_table").length){d=(Modal.vars.admin_on?_("User's admin status granted."):_("User's admin status removed."));Notify.server_success(d);return $j(".team_admin_members_table").html(c.responseText)}else{if(Modal.vars.admin_on){return window.location="/team/admin/members?id=%d&msg=granted".format(Modal.vars.user_id)}else{return window.location="/team/admin/members?id=%d&msg=removed".format(Modal.vars.user_id)}}},cleanUp:function(){return Modal.hide()}})},show_disable_2fa_modal:function(c,a,b){$j("#disable-2fa-modal .member-name").text(b);return Modal.icon_show("alert_32",_("Disable two-step verification"),$("disable-2fa-modal"),{user_id:a,elm:c})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(){$j(".tfa_enabled").replaceWith(_("Disabled"));$j(Modal.vars.elm).closest("li").remove();Notify.server_success(_("Two-step verification disabled."));return Modal.hide()}})},show_sso_preview_email:function(a){return Modal.icon_show("email_32",_("Email preview"),$(a))},show_sso_sample_email:function(a){return Modal.icon_show("email_32",_("Sample email"),$(a))},show_user_message_modal:function(c,b,a){var d;DomUtil.fillVal(a,"user-message-email");d=_("Send email to '%(user_name)s'").format({user_name:c});$("user-message").value="";Modal.icon_show("email_32",d,$("user-message-modal"),{user_name:c,user_id:b});return Util.focus.defer("user-message")},send_user_message:function(){var b,a;a=Modal.vars.user_id;b=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:a,team_id:Constants.team_id,message:b},onSuccess:function(){var c;c=Modal.vars.user_name;Notify.server_success(_("Message successfully sent to %(user_name)s.").format({user_name:c}));return Modal.hide()}})},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return $j(".pin_notice").hide()},hide_pin_banner_with_user_id:function(a,b){return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:a},onSuccess:function(c){return $j(b).closest("span").removeClass("on").addClass("off")}})},get_pin_with_user_id:function(a,b){return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:a},onSuccess:function(d){var c;c=Util.from_json(d.responseText);$j(b).closest("span").find(".pin-value").text(c.pin+" -");return $j(b).closest("span").removeClass("off").addClass("on")}})},send_team_message:function(b){var a;Event.stop(b);a=$F("team-message").strip();if(a){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:Constants.team_id,message:a},onSuccess:function(c){Notify.server_success(_("Message successfully sent to team."));return Modal.hide()}})}},show_security_message_modal:function(b,a){var c,d=this;c=ungettext("%(member_count)s member has two-step verification disabled","%(member_count)s members have two-step verification disabled",a).format({member_count:a});$("team-security-message-submit").observe("click",function(f){d.send_team_security_message(f);return false});$("team-security-message-cancel").observe("click",function(){return Modal.hide()});$("team-security-message").value="";Modal.icon_show("email_32",c,$("team-security-message-modal"));return Util.focus.defer("team-security-message")},send_team_security_message:function(c){var b,a;Event.stop(c);a=$F("team-security-message").strip();b=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:b.serialize(true),onSuccess:function(d){Notify.server_success(_("Message successfully sent."));return Modal.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(a,b){this.used_licenses=a;return this.total_licenses=b},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(a,b){$("migration-url").value=b;Modal.icon_show("alert_32",_("Migration link for '%(email)s'").format({email:a.em_snippet(18)}),$("migrate-url-modal"));return $("migration-url").select()},toggle_account_view:function(a){switch(a){case"new":$("account_info_new").removeClassName("hidden_elem");$("account_info_existing").addClassName("hidden_elem");break;case"existing":$("account_info_new").addClassName("hidden_elem");$("account_info_existing").removeClassName("hidden_elem")}$("account_info_type").value=a;return false},show_end_session_modal:function(b,a,c){TitleBubble.hide_all();$j("#end-session-modal .member-name").text($j("#member-name").text());return Modal.icon_show("alert_32",_("Close web session"),$("end-session-modal"),{sess_id:b,user_id:a,elm:c})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_sess_id:Modal.vars.sess_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(_("Web session closed."))}})},unlink_device:function(c,b,a,d){TitleBubble.hide_all();$j(".unlink-device-name").text(b);$j("#unlink-device-modal .member-name").text($j("#member-name").text());return Modal.icon_show("alert_32",_("Unlink device?"),$("unlink-device-modal"),{app_id:c,user_id:a,elm:d})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_device",{parameters:{app_id:Modal.vars.app_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(_("Device unlinked."))}})},unlink_host:function(c,a,b,d){TitleBubble.hide_all();$j(".unlink-host-name").text(a);$j("#unlink-host-modal .member-name").text($j("#member-name").text());return Modal.icon_show("alert_32",_("Unlink device?"),$("unlink-host-modal"),{host_id:c,user_id:b,elm:d})},unlink_host_submit:function(){return new Ajax.DBRequest("/computer_edit",{parameters:{unlink:true,host_id:Modal.vars.host_id,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(_("Device unlinked."))}})},disable_app:function(b,c,a,d){TitleBubble.hide_all();$j("#disable-app-modal .app-name").text(c);$j("#disable-app-modal .member-name").text($j("#member-name").text());return Modal.icon_show("application_delete_32",_("Disable '%(app_name)s'?").format({app_name:c}),$("disable-app-modal"),{app_id:b,user_id:a,elm:d})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:Modal.vars.app_id,keep_sandbox_files:true,team_id:Constants.team_id,user_id:Modal.vars.user_id},onSuccess:function(a){Modal.hide();Team.remove_closest_row(Modal.vars.elm);return Notify.server_success(a.responseText)}})},remove_closest_row:function(c){var b,a;b=$j(c).closest(".team_admin_table_row");a=$j(b).closest(".team_admin_table");if(a.find(".team_admin_table_row").length===1){a.prev(".team_admin_table_title").remove();return a.remove()}else{return b.remove()}},submit_report_form:function(a){$j(a.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};var TeamPayments;TeamPayments={show_update_billing_info_modal:function(){return this.update_billing_info_modal=new UpdateBillingInfoModal().show()}};var TeamsPricingSlider;TeamsPricingSlider=Class.create({initialize:function(a){this.initialValue=5;$j("#"+a+" .slider-track").slider({min:1,max:250,step:1,range:"min",value:this.initialValue,slide:this.sliderChanged.bind(this),change:this.sliderChanged.bind(this)});this.handle=$j("#"+a+" .ui-slider-handle");this.counts=$j(".slider-count");this.prices=$j(".slider-price");return this.sliderChanged(null,{value:this.initialValue})},sliderChanged:function(c,f){var e,a,b,d;d=f.value;a=5;b=795;e=995;if(d>5){a=d;b+=125*(d-5);e+=199*(d-5)}this.handle.text(d);this.counts.text(a);return this.prices.text(_("$%(dollars)s").format({dollars:b}))}});var UpdateBillingInfoModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};UpdateBillingInfoModal=(function(b){__extends(a,b);function a(){this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);a.__super__.constructor.call(this,{element_id:"team-update-billing-info",endpoint_url:"/team/payments/ajax_update_billing",method:"get"})}a.prototype.on_confirm_button_click=function(f){var c,d,g,h=this;f.preventDefault();d=this.$modal_window.find(".billing-info-form")[0];c=this.$modal_window.find(".confirm-button")[0];g=function(e){Notify.server_success(_("We've successfully updated your team's billing information."));return h.hide()};return Forms.ajax_submit(d,"/team/payments/ajax_update_billing",g,false,c)};a.prototype.on_load=function(){return this.cc_highlighter_interval_id=Upgrade.runCardHighlighter()};a.prototype.on_hide=function(){return clearInterval(this.cc_highlighter_interval_id)};return a})(DBModalLoading);var DBGallery,DBPhoto,__slice=[].slice;DBPhoto=function(a){a.preloaded={};a.preload=function(b){if(a.preloaded[b]){return}b=b||"l";assert(b in a,"Photo doesn't have attr "+b);Util.preload_image(a[b]);return a.preloaded[b]=true};a.load_thumb=function(b){return b.src=a.thumbnail};return a};DBGallery={size:"large",index:0,playing:false,preloaded:false,thumb_width:64,thumb_margin:4,low_opacity:0.6,photos:[],set_url_hash:true,container_id:"db_gallery_master_container",add_photos:function(a){return a.each(function(b){return DBGallery.photos.push(DBPhoto(b))})},set_hash:function(){var a;a=1<=arguments.length?__slice.call(arguments,0):[];if(DBGallery.set_url_hash){return HashRouter.set_hash.apply(HashRouter,a)}},observe:function(){Event.observe((document.onresize?document:window),"resize",DBGallery.resize);Event.observe(document.body,"mousewheel",DBGallery.wheel);Event.observe(document.body,"DOMMouseScroll",DBGallery.wheel);return document.observe("keydown",DBGallery.key)},unobserve:function(){Event.stopObserving((document.onresize?document:window),"resize",DBGallery.resize);Event.stopObserving(document.body,"mousewheel",DBGallery.wheel);Event.stopObserving(document.body,"DOMMouseScroll",DBGallery.wheel);return document.stopObserving("keydown",DBGallery.key)},resize:function(){var a,c,b,d;a=$("gallery_main_cont");d=document.viewport.getDimensions();a.style.height=d.height-99+"px";c=$("gallery_main_photo");b=d.height-99-10;c.style.maxHeight=Math.max(b,300)+"px";return c.style.maxWidth=Math.max(d.width,400)+"px"},key:function(b){var a;a=b.keyCode||b.which||b.charCode;switch(a){case 27:return DBGallery.hide();case 32:return DBGallery.playpause();case 37:case 75:return DBGallery.prev();case 39:case 74:return DBGallery.next()}},wheel:function(a){var b;if(DBGallery.block_wheel){return}DBGallery.block_wheel=1;setTimeout((function(){return DBGallery.block_wheel=0}),80);b=0;if(a.wheelDelta){b=a.wheelDelta}else{if(a.detail){b=-a.detail}}if(b>0){return DBGallery.prev()}else{return DBGallery.next()}},playpause:function(){if(DBGallery.playing){return DBGallery.pause()}else{return DBGallery.play()}},play:function(){DBGallery.playing=true;DBGallery.interval=setInterval(function(){return DBGallery.next(true)},5000);return $("gallery_slideshow").__date(Sprite.html("web","white_pause")).__sert(_("Pause slideshow"))},pause:function(){DBGallery.playing=false;clearInterval(DBGallery.interval);return $("gallery_slideshow").__date(Sprite.html("web","white_play")).__sert(_("Play slideshow"))},next:function(a){var b;b=DBGallery.index+1;if(b!==DBGallery.photos.length){return DBGallery.select_photo(b,a)}},prev:function(){var a;if(DBGallery.playing){DBGallery.pause()}a=DBGallery.index-1;if(a!==-1){return DBGallery.select_photo(a)}},select_photo:function(l,n){var e,i,g,k,a,c,b,m,p,f,o,h,d;l=parseInt(l,10);if(!Util.isNumber(l)){return}DBGallery.set_hash("gallery",""+l);if(!n&&DBGallery.playing){DBGallery.pause()}DBGallery.index=l;if(!DBGallery.visible){DBGallery.show(l)}e=$$("#gallery_thumbs_container img.selected");if(e.length){c=e[0];c.setOpacity(DBGallery.low_opacity);c.removeClassName("selected")}i=$$("#gallery_thumbs_container img")[l];assert(i,"Couldn't find img at index");i.setOpacity(1);i.addClassName("selected");DBGallery.render_mainphoto(l);DBGallery.resize();b=$("gallery_thumbs_container");k=-1*l*(DBGallery.thumb_width+DBGallery.thumb_margin)-39;$j(b).stop();if(Math.abs(k-parseInt(b.getStyle("margin-left"),10))>1200){b.style.marginLeft=k+"px"}else{$j(b).animate({marginLeft:k},300)}m=b.select("img");assert(m.length===DBGallery.photos.length,"thumbslength != photoslength");p=Math.ceil(document.viewport.getDimensions().width/DBGallery.thumb_width);p+=p%2;g=Math.max(0,l-p/2);while(g<Math.min(DBGallery.photos.length,l+p/2)){DBGallery.photos[g].load_thumb(m[g]);g+=1}h=DBGallery.photos.slice(l,l+10);d=[];for(f=0,o=h.length;f<o;f++){a=h[f];d.push(a.preload(DBGallery.size))}return d},update_container_top:function(a){a=a||$(DBGallery.container_id);if(a){return a.style.top=document.viewport.getScrollOffsets()[1]+"px"}},show:function(b){var a;assert(!DBGallery.visible,"Tried to show a gallery when it was already up");if(document.viewport.getDimensions().height>768){DBGallery.size="extralarge"}else{DBGallery.size="large"}DBGallery.visible=true;b=b||DBGallery.index;assert(DBGallery.photos.length,"No photos in the photo gallery");a=new Element("div",{id:DBGallery.container_id});DBGallery.update_container_top(a);DBGallery.update_top_interval=setInterval(function(){return DBGallery.update_container_top()},200);document.body.appendChild(a);DBGallery.observe();DBGallery.render_backdrop(a);DBGallery.render_filmstrip(a);DBGallery.render_submenu(a);return DBGallery.render_bottom_menu(b,a)},hide:function(a){if(a){Event.stop(a)}assert(DBGallery.visible,"Tried to hide a gallery when it was already hidden");DBGallery.visible=false;DBGallery.pause();DBGallery.unobserve();DBGallery.hide_backdrop();DBGallery.hide_filmstrip();DBGallery.hide_bottom_menu();DBGallery.hide_mainphoto();$(DBGallery.container_id).remove();DBGallery.set_hash();return clearInterval(DBGallery.update_top_interval)},render_backdrop:function(a){var b,c;c="body";if(Prototype.Browser.IE){c="html, body"}$$(c).invoke("addClassName","full_no_overflow");b=new Element("div",{id:"gallery_backdrop"});b.setOpacity(0.8);return a.__sert(b)},hide_backdrop:function(){$$(".full_no_overflow").invoke("removeClassName","full_no_overflow");return $("gallery_backdrop").remove()},render_filmstrip:function(a){var i,d,h,g,f,e,c,b;d=new Element("div",{id:"gallery_filmstrip"});g=document.createDocumentFragment();g.appendChild(d);h=new Element("div",{id:"gallery_filmstrip_backdrop"});h.setOpacity(0.5);g.appendChild(h);b=new Element("div",{id:"gallery_thumbs_container"});e=0;DBGallery.photos.each(function(k){var j;j=new Element("img",{title:k.filename,src:"/static/images/icons/icon_spacer.gif"});j.setOpacity(DBGallery.low_opacity);j.observe("mouseover",function(l){return $j(j).fadeTo(100,1)});j.observe("mouseout",function(l){if(!j.hasClassName("selected")){return $j(j).fadeTo(100,DBGallery.low_opacity)}});j.observe("click",(function(l){return function(){return DBGallery.select_photo(l)}})(e));b.appendChild(j);return e+=1});c=new Element("div",{id:"gallery_selected_frame"});f=new Element("a",{id:"gallery_close",href:"#",style:"top: 120px; right: 10px;"});i=new Element("img",{src:"/static/images/photos_x.png"});f.__sert(i);f.observe("click",DBGallery.hide);g.appendChild(f);g.appendChild(c);g.appendChild(b);return a.appendChild(g)},render_submenu:function(a){var d,c,e,b;c=new Element("div",{id:"gallery_sub_menu"});e=new Element("div",{id:"gallery_index_text"});d=new Element("div",{id:"gallery_filename_text"});b=new Element("a",{id:"gallery_slideshow"});b.observe("click",DBGallery.playpause);c.__sert(b);c.__sert(e);c.__sert(d);a.appendChild(c);return DBGallery.pause()},render_bottom_menu:function(d,b){var c,a,e;c=new Element("div",{id:"gallery_bottom_menu"});a=new Element("a",{id:"gallery_full_size"});a.__date(Sprite.html("web","arrow_out_black")).__sert(_("Full size"));e=new Element("a",{id:"gallery_save"});e.__date(Sprite.html("web","picture_save")).__sert(_("Save"));c.__sert(a);c.__sert(e);return b.appendChild(c)},update_bottom_menu:function(b){var a;a=DBGallery.photos[b];$("gallery_full_size").href=a.original;return $("gallery_save").href=a.original+"?dl_name="+Util.urlquote(a.filename)},hide_bottom_menu:function(){return $("gallery_bottom_menu").remove()},hide_filmstrip:function(){$("gallery_filmstrip").remove();$("gallery_filmstrip_backdrop").remove();$("gallery_thumbs_container").remove();$("gallery_selected_frame").remove();$("gallery_close").remove();return $("gallery_sub_menu").remove()},render_mainphoto:function(f,b){var a,c,e,d,h,g;b=b||$(DBGallery.container_id);e=DBGallery.photos[f];c=Util.get_preloaded_image(e[DBGallery.size]);c.id="gallery_main_photo";c.title=e.filename;c.stopObserving("click");c.observe("click",function(k){var i,j;Event.stop(k);if(e.video_url){DBGallery.pause();$("gallery_main_photo_td").__date();j=(DBGallery.size==="extralarge"?1024:640);i=Math.floor(j*0.55);return VideoUtil.embed("#gallery_main_photo_td",{src:e.video_url,type:"video/flv",width:j,height:i,controls:true,preload:"auto",autoplay:true})}else{return DBGallery.next()}});if(!$("gallery_main_cont")){a=new Element("table",{id:"gallery_main_cont"});a.observe("click",DBGallery.hide);d=new Element("tbody");a.__sert(d);g=new Element("tr");d.__sert(g);h=new Element("td");h.id="gallery_main_photo_td";g.__sert(h);h.__sert(c);b.appendChild(a)}else{$("gallery_main_cont").down("td").__date(c)}DBGallery.update_sub_menu(f);return DBGallery.update_bottom_menu(f)},update_sub_menu:function(a){$("gallery_index_text").__date(a+1+" of "+DBGallery.photos.length);return $("gallery_filename_text").__date(DBGallery.photos[a].filename)},hide_mainphoto:function(){return $("gallery_main_cont").remove()}};var Notclient,__slice=[].slice,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Notclient=(function(){var G,I,j,l,i,t,q,B,c,n,a,e,m,K,d,M,g,w,r,f,z,k,p,H,N,F,o,E,b,y,D,h,u,L,C,v,s,J,A,x;f=function(){var O;O=1<=arguments.length?__slice.call(arguments,0):[];if(Notclient.DEBUG){return console.log.apply(console,O)}};G=90000;l=8096;t="user";i="list";d=false;I=1000;j=5*60*1000;N=0;u=function(){var O;if(e===0){O=0}else{O=Math.min(I*Math.pow(2,e-1),j)}return Math.max(O,N)};x=[null,null],s=x[0],H=x[1];F={};K={};p=1;M=false;g=false;J=null;B=false;C=[];h=null;a=null;z=null;k={};o=false;e=0;L=0;r=function(O){return $u.isNumber(O)&&O%1===0&&O>0};w=function(O){return $u.isNumber(O)&&O%1===0&&O>=0};v=function(S,Q){var P,O,R;R=[];for(P in Q){O=Q[P];P=parseInt(P,10);assert(r(P),"ns_ids must be positive integers: "+P);assert(w(O),"sjids must be nonnegative integers: "+O);if(S[P]!=null){R.push(S[P]=Math.min(S[P],O))}else{R.push(S[P]=O)}}return R};c=function(){var Q,P,R,O;assert((H!=null)&&!$u.isEmpty(F),"expected nid and ns_map");R={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV};Q=$u.pluck($u.values(K),"type");if(__indexOf.call(Q,t)>=0){assert(s!=null,"nid set, expected user_id to be set too");R.user_id=s;R.nid=H}if(__indexOf.call(Q,i)>=0){R.ns_map=((function(){var S;S=[];for(P in F){O=F[P];S.push(""+P+"_"+O)}return S})()).join(",")}if(Util.add_qstring(Constants.SUBSCRIBE_URL,R).length>l){delete R.ns_map}return R};n=function(){var O;if(!d){return}O=u();if(O>0){return a=window.setTimeout(A,O)}else{return A()}};A=function(){var O;assert(!M&&!g,"connect: invalid state");assert(H>=0||!$u.isEmpty(F),"notclient: called connect with nothing to subscribe to");f("###########################");O=c();if(!(O.nid!=null)&&!O.ns_map){f("nothing to subscribe to. skipping notserver connection.");return}f("connecting to notserver...");M=true;L+=1;return J=$j.ajax(Constants.SUBSCRIBE_URL,{data:O,dataType:"json",noDropboxDefaults:true,error:function(){if(B){B=false;return}e+=1;f("error connecting to notserver. bad rounds="+e+".");M=false;return n()},success:function(P){f("notserver connection closed. response:",P);M=false;if(P.chillout!=null){N=parseInt(P.chillout,10)*1000;f("notserver told us to chill for "+N+"ms")}else{if(N>0){f("setting notserver chillout back to 0ms");N=0}}if(P.ret==="punt"){return n()}else{assert(P.ret==="new","unknown notserver ret: "+P.ret);assert("refresh" in P,"expected notserver ret:new to have refresh keyword");return D(P.refresh)}}})};q=function(){if(J!=null){B=true;J.abort();return J=null}};E=function(){N=0;M=false;g=false;q();C=[];window.clearTimeout(h);window.clearTimeout(a);h=null;a=null;z=null;k={};o=false;e=0;return n()};y=function(){var P,O;d=false;N=0;O=[null,null],s=O[0],H=O[1];F={};K={};P=0;p=1;M=false;g=false;J=null;B=false;C=[];window.clearTimeout(h);window.clearTimeout(a);h=null;a=null;z=null;k={};o=false;e=0;return L=0};D=function(U){var X,S,O,Q,V,R,W,P;assert(!g&&!M,"run_handlers: invalid state");assert(z===null,"run_handlers: new_nid must start at null");assert($u.isEqual(k,{}),"run_handlers: new_ns_map must start at {}");assert(!o,"expected one_or_more_handler_failures=false");g=true;f("running handlers...");Q=$u.filter($u.values(K),function(Z){var Y;return Y=Z.type,__indexOf.call(U,Y)>=0});assert(!$u.isEmpty(Q),"notserver sent a ping for unsubscribed activity");C=$u.pluck(Q,"handler_id");for(R=0,W=Q.length;R<W;R++){P=Q[R],X=P.handler,S=P.handler_id,O=P.name,V=P.type;f("running id="+S+", name="+O+", type="+V);X()}if($u.isEmpty(C)){return f("all handlers already finished running. no need for a slacker timeout.")}else{f("all handlers running. slacker timeout set.");return h=window.setTimeout(b,G)}};b=function(){var Q,R,P,O;assert(g&&!M,"called report_slackers in an invalid state.");assert(!$u.isEmpty(C,"report_slackers called w/ nothing slackin'"));f("found some slackers");o=true;O=[];for(R=0,P=C.length;R<P;R++){Q=C[R];O.push(m(Q))}return O};m=function(O){if(__indexOf.call(C,O)<0){return}f("done handling: "+O);C=$u.without(C,O);if($u.isEmpty(C)){f("all handlers are done running.");g=false;window.clearTimeout(h);if(z!=null){f("new nid: "+z);H=z}if(!$u.isEmpty(k)){f("new ns_map:",k);F=k}if(o){e+=1;f("one or more handler errors. bad_rounds="+e)}else{e=0}z=null;k={};o=false;return n()}};return{get_user_id:function(){return s},get_nid:function(){return H},get_ns_map:function(){return $u.clone(F)},get_consecutive_bad_rounds:function(){return e},get_total_rounds:function(){return L},get_notserver_chillout_ms:function(){return N},get_sleep_ms:u,subscribe_user:function(W){var Q,R,V,U,S,P,O;assert(!g,"adding new handlers from inside handlers is not currently supported");O=["name","handler"];for(S=0,P=O.length;S<P;S++){U=O[S];assert(W[U],"subscribe_user requires this param be non-falsey: "+U)}assert($u.isFunction(W.handler),"handler must be a function");f("adding user handler "+W.name);R=$u.pluck($u.values(K),"type");V=__indexOf.call(R,t)<0;Q=p++;K[Q]={handler_id:Q,handler:W.handler,name:W.name,type:t};if(V){f("first user handler added, reconnecting");E()}return Q},subscribe_sfj:function(W){var Q,R,V,U,S,P,O;assert(!g,"adding new handlers from inside handlers is not currently supported");O=["name","handler"];for(S=0,P=O.length;S<P;S++){U=O[S];assert(W[U],"subscribe_sfj requires this param be non-falsey: "+U)}assert($u.isFunction(W.handler),"handler must be a function");f("adding sfj handler "+W.name);R=$u.pluck($u.values(K),"type");V=__indexOf.call(R,i)<0;Q=p++;K[Q]={handler_id:Q,handler:W.handler,name:W.name,type:i};if(V){f("first sfj handler added, reconnecting");E()}return Q},handler_success:function(O,Q){var P;if(__indexOf.call(C,O)<0){return}P=K[O].type;if(P===i){assert("ns_map" in Q,"ns_map required param is missing");assert(!("nid" in Q),"nid is disallowed from SFJ handlers");v(k,Q.ns_map)}else{assert(P===t,"unknown handler type: "+P);assert("nid" in Q,"nid required param is missing");assert(!("ns_map" in Q),"ns_map is disallowed from user handlers");assert(r(Q.nid),"nid must be a postive int");if(!(z!=null)||Q.nid<z){z=Q.nid}}return m(O)},handler_failure:function(O){f("handler failed. handler_id="+O);if(__indexOf.call(C,O)<0){return}o=true;return m(O)},init:function(Q,P,O){assert(!d,"error: init() has been called twice.");assert(r(Q),"user_id must be a positive integer");assert(w(P),"initial_nid must be a non negative integer");s=Q;H=P;v(F,O);d=true;return n()},reset:y,abort:q,reconnect:E,DEBUG:false}})();var Notserver;Notserver={SUBSCRIBE_CHILLOUT:5,MAX_URL_LENGTH:8096,_subscribe_in_progress:false,subscribe:function(b,a){if(this._subscribe_in_progress){return}this._subscribe_in_progress=true;this._handlers={user:a.onUser,list:a.onList};this._cursors={user:a.cursorForUser,list:a.cursorForList};this._uid=a.uid||Constants.uid;this._subscribe_url=b;return this._make_subscribe_request()},_make_subscribe_request:function(){var c,d,b,a,e=this;b={host_int:0,trace:encodeURIComponent(window.location.pathname),rev:Constants.SVN_REV};if(this._cursors.list){b.ns_map=((function(){var g,f;g=this._cursors.list();f=[];for(c in g){a=g[c];f.push(""+c+"_"+a)}return f}).call(this)).join(",")}if(this._cursors.user!=null){b.user_id=this._uid;b.nid=this._cursors.user}d=Util.add_qstring("",b,false).slice(1);if(this._subscribe_url.length+d.length>this.MAX_URL_LENGTH){return}if((typeof Ajax!=="undefined"&&Ajax!==null?Ajax.DBRequest:void 0)!=null){return new Ajax.DBRequest(this._subscribe_url,{no_watch:true,noAutonotify:true,evalJSON:false,method:"GET",parameters:d,onSuccess:function(g){var f;f=g.responseText||g;return e.subscribe_success(Util.from_json(f))},onFailure:function(){return e.schedule_request(e.SUBSCRIBE_CHILLOUT*1000)}})}else{return $j.ajax(this._subscribe_url,{data:d,dataType:"json",success:function(f){return e.subscribe_success(f)},error:function(){return e.schedule_request(e.SUBSCRIBE_CHILLOUT*1000)}})}},subscribe_success:function(f){var g,e,b,d,a;this._subscribe_in_progress=false;if(f.ret==="new"){try{if("refresh" in f){d=f.refresh;a=[];for(e=0,b=d.length;e<b;e++){g=d[e];if(g in this._handlers){a.push(this._handlers[g]())}else{a.push(void 0)}}return a}else{if(this._handlers.list){return this._handlers.list()}}}catch(c){}}else{assert(f.ret==="punt","Invalid response from subscribe: "+f);return this.schedule_request(0)}},schedule_request:function(a){var b=this;return window.setTimeout((function(){return b._make_subscribe_request()}),a)}};var UpdateEvents;UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var FileTypes;FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5};var BrowseUtil;BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(b){var a;a=Object.clone(b);if(a.is_dir){a.ago="";a.ts=0}else{a.target_ns=false}a.sort_key=Util.decode_sort_key(a.sort_key);return new BrowseFile(a)},filepreview_from_selected:function(d,c){var e,b,k,l,m,h,g,a,f,n,j;if(c&&(c.bytes<0||c.preview_type==="download")){window.open(c.href,"_blank");return}a=DBHistory.get_url();l=a.indexOf("/lightbox")===0;b=a.indexOf("/view")===0;if(d==="callback"&&((l&&Lightbox.shown)||(b&&FileViewer.shown))){return}else{if(d==="callback"&&b&&!c){FileViewer.show();return}else{if(d==="fileclick"&&c&&((j=c.preview_type)!=="photo"&&j!=="video")){FileViewer.show(c);return}}}if(!c){h=BrowseSelection.get_selected_files();c=h&&h.first()}m=this.browsefile_to_filepreview(Browse.files);if(m.length){g=0;if(c){for(k=f=0,n=m.length;f<n;k=++f){e=m[k];if(e.fq_path===c.fq_path){g=k;break}}}Lightbox.init(m,{start_index:g,include_delete:true,keep_url:false})}if(Tutorial.should_handle_event(Tutorial.events.browse_show_lightbox)){return Tutorial.handle_event(Tutorial.events.browse_show_lightbox,{init_file:c})}},browsefile_to_filepreview:function(e){var h,c,a,d,g,b;a=[];for(g=0,b=e.length;g<b;g++){h=e[g];if(h.bytes<0||h.dir){continue}if(h.preview_type==="photo"&&h.large_thumbnail_url_tmpl){c=new PhotoPreview({filename:h.filename,fq_path:h.fq_path,thumbnail_url_tmpl:h.large_thumbnail_url_tmpl,dl_url:h.href+"&dl=1",original_url:h.href,ns_id:h.ns_id,ns_path:h.ns_path});a.push(c)}else{if(h.preview_type==="video"&&h.large_thumbnail_url_tmpl&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){d=new VideoPreview({filename:h.filename,fq_path:h.fq_path,thumbnail_url_tmpl:h.large_thumbnail_url_tmpl,preview_url:h.video_transcode_url(),dl_url:h.href+"&dl=1",ns_id:h.ns_id,ns_path:h.ns_path});a.push(d)}}}return a},profile_files:function(b){var c,d,e,a;d={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0};for(e=0,a=b.length;e<a;e++){c=b[e];if(c.dir){d.folders+=1}else{d.files+=1}if(c.is_sandbox()){d.sandboxes+=1}if(c.is_share()){d.shared_folders+=1}if(c.bytes===-1){d.deleted+=1}if(c.target_ns){d.target_namespaces+=1}if(c.fq_path.toLowerCase()==="/public"&&Browse.public_folder_enabled){d.public_folder=1}if(c.root_coll_item_counter>=0){d.in_root_coll+=1}}return d},profile_summary:function(b){var c,a;c=ungettext("%d file","%d files",b.files).format(b.files);a=ungettext("%d folder","%d folders",b.folders).format(b.folders);if(b.files&&b.folders){return _("%(x_files)s and %(y_folders)s").format({x_files:c,y_folders:a})}else{if(b.files){return c}else{if(b.folders){return a}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var d,c,a,b;b=this.SPECIAL_MODES;for(c=0,a=b.length;c<a;c++){d=b[c];$("browse").removeClassName(d);$("browse-root-actions").removeClassName(d);$("browse-sort").removeClassName(d)}$("browse-sort").removeClassName("cathywu");return $("browse-root-actions").removeClassName("cathywu")},set_special_mode:function(b){var e,d,a,c;assert(this.SPECIAL_MODES.indexOf(b)!==-1,"unknown mode");if($("browse").hasClassName(b)){assert($("browse-root-actions").hasClassName(b),"inconsistent modes");assert($("browse-sort").hasClassName(b),"inconsistent modes");return}c=this.SPECIAL_MODES;for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){$("browse").removeClassName(e);$("browse-root-actions").removeClassName(e);$("browse-sort").removeClassName(e)}}$("browse").addClassName(b);$("browse-root-actions").addClassName(b);$("browse-sort").addClassName(b);if(b===this.SEARCH_MODE){$("browse-sort").addClassName("cathywu");return $("browse-root-actions").addClassName("cathywu")}},get_mode:function(){var e,a,d,b,c;a=this.BROWSE_MODE;c=this.SPECIAL_MODES;for(d=0,b=c.length;d<b;d++){e=c[d];if($("browse").hasClassName(e)){a=e}}return a},load_visible_thumbs:function(){var m,p,d,l,q,r,n,c,h,b,g,f,o,a,k,e;c=this.get_files_in_view();p=c[1]-c[0];n=[Math.max(c[0]-p,0),c[0]];r=[Math.min(c[1],Browse.files.length),Math.min(c[1]+p,Browse.files.length)];m=[];k=[c,r,n];for(g=0,o=k.length;g<o;g++){q=k[g];l=q[0],h=q[1];e=Browse.files.slice(l,h+1||9000000000);for(f=0,a=e.length;f<a;f++){d=e[f];m.push(d.get_div().down("img"))}}b=function(i){if(!i.src.endsWith(Sprite.SPACER)){return i.addClassName("thumbnail")}};return BatchThumbLoader.batch_load_thumbs(m,this.THUMBS_BATCH_SIZE,b)},get_files_in_view:function(){var c,d,b,a,f,e;f=Util.viewport_dimensions().height;e=Util.scroll_offsets().top;c=this._get_top_file_y_offset();d=this._get_elm_height();if(!c||!d){return[0,Browse.files.length]}b=Math.floor((e-c)/d);b=Math.max(b,0);a=b+Math.ceil(f/d);a=Math.min(a,Browse.files.length);return[b,a]},_get_top_file_y_offset:function(){if(Browse.files.length===0){return null}return Browse.files[0].get_div().cumulativeOffset().top},_get_elm_height:function(){var a;if(Browse.files.length<3){return null}a=Browse.files[1].get_div();return a.getLayout().get("margin-box-height")}};var Sort;Sort=(function(){var g,a,d,f,e,c,b;d=function(i){var h;h=i?1:-1;return function(j,k){return h*Util.sort_by_rank_or_key(j,k)}};f=function(i){var h;h=i?1:-1;return function(j,k){if(j.bytes>k.bytes){return h}else{if(j.bytes<k.bytes){return -h}else{return h*Sort.FILES_BY_NAME(j,k)}}}};g=function(i){var h;h=i?1:-1;return function(j,k){return h*(j.fq_path.toLowerCase()>k.fq_path.toLowerCase()?1:-1)}};a=function(i){var h;h=i?1:-1;return function(k,l){var j;j=k.ts===l.ts?0:k.ts>l.ts?1:-1;return h*j}};c=function(h){return function(k){var j,i;i=h(k);j=d(true);return function(l,m){if(l.dir^m.dir){return(l.dir?1:0)-(m.dir?1:0)}else{return i(l,m)||j(l,m)}}}};e=function(h){return function(k){var i,j;if(!Sort.FOLDERS_FIRST){return h(k)}j=h(k);i=k?1:-1;return function(m,n){var l;if(m.dir^n.dir){l=(m.dir?0:1)-(n.dir?0:1);return i*l}else{return j(m,n)}}}};b=function(h){return function(k){var i,j;j=Sort.FILES_BY_NAME(k);i=k?1:-1;return function(m,n){var l;if(m.is_deleted^n.is_deleted){return(m.is_deleted?1:0)-(n.is_deleted?1:0)}l=0;if(h){if(m.get_category()!==n.get_category()){l=m.get_category()<n.get_category()?-1:1}else{if(m.get_extension()!==n.get_extension()){l=m.get_extension()<n.get_extension()?-1:1}}}else{if(m.get_extension()!==n.get_extension()){l=m.get_extension()<n.get_extension()?-1:1}else{if(m.get_category()!==n.get_category()){l=m.get_category()<n.get_category()?-1:1}}}return(i*l)||j(m,n)}}};return{FILES_BY_NAME:e(d),FILES_BY_SIZE:c(f),FILES_BY_LOCATION:c(g),FILES_BY_KIND:c(b(true)),FILES_BY_EXTENSION:c(b(false)),FILES_BY_MODIFIED:c(a),FOLDERS_FIRST:!Util.is_mac(),ALL_BY_MODIFIED:a}})();var FlexColumn;FlexColumn=(function(){var i,c,l,g,d,h,b,a,k,e,j,f;i=[["FILES_BY_KIND",Sort.FILES_BY_KIND,_("Kind"),true],["FILES_BY_EXTENSION",Sort.FILES_BY_EXTENSION,_("Extension"),true],["FILES_BY_SIZE",Sort.FILES_BY_SIZE,_("Size"),false]];c={};l={};d=[];g=[];for(e=0,j=i.length;e<j;e++){f=i[e],k=f[0],b=f[1],h=f[2],a=f[3];d.push(b);c[k]=h;l[k]=a;g.push(k)}return{SORT_FUNCTIONS:d,DISPLAY:c,IS_ASC:l,LABELS:g}})();var FileSearch;FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,init:function(){var a,k,i,c,g,f,l,b,h,e,d,j=this;i=$("browse-search");k=$("browse-search-input");SickInput.add_interval_handler(i,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",function(m){j.search();return Event.stop(m)});$("exit-search-xclose").observe("click",function(){return j.exit_search()});key("/",Browse.KEY_SCOPE,function(){if(BrowseJump.is_active()){return}if(!i.hasClassName("focused")){k.focus();return false}});key("escape",Browse.KEY_SCOPE,function(){if(Browse.in_search_mode()){j.exit_search();return false}if(k.getValue().strip()===""){k.blur();return false}});key("tab",Browse.KEY_SCOPE,function(m){if(document.activeElement===k){m.preventDefault();k.blur();if(Browse.files.length){BrowseSelection.set_selected_files(Browse.files[0])}else{if(Browse.in_search_mode()){j.toggle_advanced()}}return false}});c="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",c,this.toggle_advanced.bind(this));document.observe(FileEvents.RENAME,function(){return j.clear_cache()});h=[FileEvents.DELETE,FileEvents.COPY,FileEvents.MOVE,FileEvents.PURGE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE];for(g=0,l=h.length;g<l;g++){a=h[g];document.observe(a,function(m){if(!Browse.inside_dir){return j.force_reload()}})}e=[UpdateEvents.ADD,UpdateEvents.MOVE,UpdateEvents.REMOVE];d=[];for(f=0,b=e.length;f<b;f++){a=e[f];d.push(document.observe(a,function(m){return j._update_number_results(Browse.files.length)}))}return d},get_state:function(){var c,f,b,e,a,d;f={is_advanced:!$("browse-search").visible()};if(f.is_advanced){d=["all_terms","any_terms","excluded_terms","exact"];for(e=0,a=d.length;e<a;e++){c=d[e];b=$(c).getValue();if(b){f[c]=b}}f.include_files=$("include_files").checked;f.include_folders=$("include_folders").checked;f.include_deleted=!Constants.can_see_trash&&$("include_deleted").checked}else{f.query_unnormalized=this.get_basic_query();f.query=f.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ")}return f},set_state:function(e){var b,d,a,c;if(e.is_advanced){c=["all_terms","any_terms","excluded_terms","exact"];for(d=0,a=c.length;d<a;d++){b=c[d];if(e[b]){$(b).setValue(e[b])}}$("include_files").checked=e.include_files;$("include_folders").checked=e.include_folders;if(!Constants.can_see_trash){$("include_deleted").checked=e.include_deleted}this.show_advanced();return this.search()}else{this.set_basic_query(e.query_unnormalized);this.show_basic();return this.search()}},state_changed:function(){var b,a;b=this.get_state();a=this.last_state;if(a===false){return !!b.query}return(b.is_advanced!==a.is_advanced)||(b.query!==a.query)},get_basic_query:function(){var a;a=$("browse-search-input");return a.getValue()},set_basic_query:function(a){if(a===this.get_basic_query()){return}$("browse-search-input").setValue(a);$("browse-search").show();return $("advanced-search-link").__date(_("Advanced search"))},set_title:function(){var a,b;a=this.get_state();b=_("Search - Dropbox");if(a.query_unnormalized){b=""+a.query_unnormalized+" - "+b}return document.title=b},_pending_search_q:"",search_with_delay:function(){var b,a;a=this.get_state();if(a.is_advanced){return}b=a.query;if(b.length===0&&Browse.in_search_mode()){this.search();return}if(b.length<=this.SHORT_PREFIX_LEN){if(b!==this._pending_search_q){this._pending_search_q=b;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(this.search.bind(this),this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return this.search()}}},search:function(){var b,a;a=this.get_state();b=""===this.get_basic_query();if(!a.is_advanced&&b){if(Browse.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=a;this._clear_on_reload=true;if(!Browse.in_search_mode()){BrowseSelection.deselect_all();Browse.clear();BrowseUtil.set_special_mode("search");if(Browse.inside_dir){this.last_fq_path=Browse.containing_fq_path()}else{this.last_fq_path=""}DBHistory.push_state("/search")}this._prune_cache();this.set_title();if(a.is_advanced){this.ask_server_advanced()}else{if(a.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server()}}}return T("search")},_prune_cache:function(){var c,d,f,e,b,a;c=new Date();d=[];for(f in this._cache_ts){if(c-this._cache_ts[f]>this.CACHE_TIME){d.push(f)}}a=[];for(e=0,b=d.length;e<b;e++){f=d[e];delete this._cache[f];a.push(delete this._cache_ts[f])}return a},show_empty:function(){$("search-empty").show();return $(document.documentElement).removeClassName("earthrise")},hide_empty:function(){$("search-empty").hide();return $(document.documentElement).addClassName("earthrise")},exit_search:function(){var b,d,a,c;c=$$("#advanced-search-box .sick-input input");for(d=0,a=c.length;d<a;d++){b=c[d];b.setValue("");b.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();Browse.first_load=true;return Browse.reload_fqpath(this.last_fq_path,true)},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},ask_server:function(){var b,a,c=this;b=this.get_state();assert(!b.is_advanced,"expected to be in basic search mode");$("web-search-results").__date(_("Searching..."));$("browse").addClassName("pending-search");a="/ajax_search";return new Ajax.DBRequest(a,{no_watch:true,evalJSON:false,parameters:{query:b.query},log_timing:true,onSuccess:function(d){var e;if(!Browse.in_search_mode()){return}e=Util.from_json(d.responseText);c._cache[b.query]=e;c._cache_ts[b.query]=new Date();if(!c.last_state.is_advanced&&(c.last_state.query===b.query)){return c.update_results()}},cleanUp:function(){return $("browse").removeClassName("pending-search")}})},ask_server_advanced:function(){var a,b=this;a=this.get_state();assert(a.is_advanced,"expected to be in advanced search mode");assert(!a.query,"expected advanced search params only");delete a.is_advanced;$("web-search-results").__date(_("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:a,log_timing:true,onSuccess:function(c){if(!Browse.in_search_mode()){return}b.advanced_results=Util.from_json(c.responseText);return b.update_results()},cleanUp:function(c){return $("browse").removeClassName("pending-search")}})},attempt_cache_filter:function(){var a,d,b,h,c,g,f,e;g=this.get_state().query;h=this._query_to_regex(g);b=function(i){return h.match(Util.filename(i.ns_path).toLowerCase())};if(g.length<=1){return false}for(c=f=e=g.length-1;e<=1?f<=1:f>=1;c=e<=1?++f:--f){d=g.substr(0,c).strip();if(d in this._cache){if(this._cache[d].file_info.length<this.MAX_RESULTS){a=Object.clone(this._cache[d]);a.file_info=a.file_info.findAll(b);this.update_results(a);return true}else{return false}}}return false},_query_to_regex:function(a){return new RegExp(RegExp.escape(a).split(new RegExp(" +")).join(".*"))},update_results:function(a){var d,c,b;Browse.reset_state();Browse.reset_sort();b=this.get_state();if(!a&&b.is_advanced){a=this.advanced_results}if(!a){c="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";assert(this.last_state&&!this.last_state.is_advanced,c);assert(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(a=this._cache[this.last_state.query]))}Browse.update(a);Browse.set_selection_from_fq_paths_or_index(FileSearch);this._update_number_results(a.file_info.length);d=b.is_advanced?_("Basic search"):_("Advanced search");$("advanced-search-link").__date(d);if(Browse.files.length){return this.hide_empty()}else{return this.show_empty()}},_update_number_results:function(b){var d,a,c;c=b===0?_("No results"):(d=ungettext("Search - %s result","Search - %s results",b),a=b+(b>=this.MAX_RESULTS?"+":""),d=d.format(a));return $("web-search-results").__date(c)},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(_("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(a){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(_("Advanced search"));$("browse-search").show();if(!a){return $("browse-search-input").focus()}},toggle_advanced:function(){var a,b;b=$("advanced-search-link");b.toggleClassName("selected");if(b.hasClassName("selected")){$("all_terms").setValue(this.get_basic_query());return this.show_advanced()}else{a=$("all_terms").getValue();if(a){this.set_basic_query(a);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(){var a;if(!this.last_state){BrowseURL.set_path_url(Constants.root_ns,"");return}if(this.state_changed()){this.set_state(this.last_state)}key.setScope(Browse.KEY_SCOPE);if(BrowseSelection.get_selected_files().length){a=BrowseSelection.get_selected_files()[0].get_div();return Browse.scrollToWithPadding(a,a.getHeight()*2)}},clear_searchbox:function(){return $("browse-search-input").setValue("")}};var BrowseKeys;BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var c,a,b,d=this;b=this.advanced_dict;for(a in b){c=b[a];key(c.key,Browse.KEY_SCOPE,c.onPress)}this.customize_chart();if(Util.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",function(f){if(f.charCode===63&&!Util.focus_in_input()){return d.advanced_dict.help.onPress()}})}},customize_chart:function(){var d,b,c,a;d=(Util.is_mac()?".key-windows":".key-macos");c=0;b=void 0;a=[];while(true){b=$("keys-chart").down(d,c++);if(!b){break}a.push(b.hide())}return a},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var a,b;a=$("keys-chart");a.style.position="fixed";b=$("browse-sort");if(b.getStyle("display")==="none"){b=$("browse-root-actions")}$j(a).clonePosition($j(b),{setHeight:false});a.style.top=b.cumulativeOffset()[1]+b.getHeight()+"px";a.setOpacity(0.85);return a.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:_("Rename selected files"),key:"f2",onPress:function(b,c){var a;a=BrowseSelection.get_selected_files();if(a.length){return a.first().edit()}}},"delete":{title:_("Delete selected files"),key:"delete, command+backspace, backspace",onPress:function(d,f){var a,c,b;Event.stop(d);b=BrowseSelection.get_selected_files();if(b.length===1){a=b.first();if(a.is_deleted){return FileOps.show_purge(a.fq_path,a.dir)}else{return FileOps.show_delete(a.fq_path,a.dir)}}else{if(b.length>1){c=BrowseUtil.profile_files(b);if(c.deleted===b.length){return FileOps.show_bulk_purge(b)}else{if(c.deleted===0){return FileOps.show_bulk_delete(b)}}}}}},help:{title:_("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return BrowseKeys.toggle_chart()}},close_help:{title:_("Hide keyboard shorcuts"),key:"escape",onPress:function(){return BrowseKeys.hide_chart()}},up_dir:{title:_("Up a folder"),key:"left",onPress:function(){var a,b;Browse.keyboard_nav=true;if(!Browse.reloading){if(Browse.inside_dir){if(!Browse.containing_ns_path()&&Browse.containing_ns_id()!==Constants.root_ns){b=Constants.root_ns;a=Util.normalize(Util.parentDir(Browse.containing_fq_path()))}else{b=Browse.containing_ns_id();a=Util.normalize(Util.parentDir(Browse.containing_ns_path()))}if(Browse.containing_ns_path()!==a||Browse.containing_ns_id()!==b){Browse.select_fq_paths=[Browse.containing_fq_path()];return BrowseURL.set_path_url(b,a)}else{return BrowseSelection.flicker_selected()}}else{return BrowseSelection.flicker_selected()}}}},open_file:{title:_("Open highlighted file"),key:"enter",onPress:function(){var a,b;b=BrowseSelection.get_selected_files();if(b.length===1){a=b[0];Browse.open_file(a,false)}return false}},open_dir:{title:_("Open highlighted folder"),key:"right",onPress:function(){var a,b;Browse.keyboard_nav=true;b=BrowseSelection.get_selected_files();if(b.length===1){a=b[0];if(a.dir){Browse.select_index=0;Browse.open_folder(a)}else{BrowseSelection.flicker_selected()}}return false}},undo:{title:_("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){UndoAction.perform_undo();return false}}}};var BrowseURL;BrowseURL={_DEFAULTS:{d:false,select:false},_get_helper:function(a){var b;b=DBHistory.deconstruct_url().qargs;if(a in b){return !!b[a]}else{assert(a in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[a]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(a,c){var b;if(a!==Constants.root_ns&&(!(a in Browse.ns_id_to_mount_point))){a=Constants.root_ns}if(a===Constants.root_ns){return c}else{b=Browse.ns_id_to_mount_point[a];return b+c}},_make_url:function(a,h,g){var f,e,b,d,c;if(g==null){g={}}if(!a){a=Constants.root_ns}assert(typeof a==="number","expected ns_id as a number");assert(typeof h==="string","expected explicit ns_path string");f=this.ns_to_fq_path(a,h);d="/home"+Util.urlquote(f);b=DBHistory.deconstruct_url().qargs;for(e in g){c=g[e];if(e in this._DEFAULTS&&!!c!==this._DEFAULTS[e]){b[e]=c}}for(e in b){if(!(e in this._DEFAULTS)){delete b[e]}}return DBHistory.construct_url(d,b)},set_path_url:function(a,f,d){var e,c,b;if(!a){a=Constants.root_ns}else{c=parseInt(a,10);a=!isNaN(c)?c:Constants.root_ns}f=Util.normalize(f);b=d!=null?this._make_url(a,f,{d:d?1:0}):this._make_url(a,f);e=DBHistory.deconstruct_url(b);return DBHistory.push_state(e.path,e.qargs)},set_del_url:function(a){var c,d,b;b=DBHistory.deconstruct_url();c=b.path;d=b.qargs;if(a){d.d="1"}else{delete d.d}return DBHistory.push_state(c,d)},_first_load:true,_last_path:null,_last_qargs:null,history_change_handler:function(h,g){var f,a,b,i,d,c,e;key.setScope(Browse.KEY_SCOPE);h=Util.normalize(h);d=g.ns;i=this._last_path;b=(e=this._last_qargs)!=null?e.ns:void 0;c=false;if(!this._first_load){c=(!Browse.inside_dir)||(h!==i)||(d!==b)}f=false;if((g.d==="1")!==(Browse.deleted_shown===true)){f=true;Browse.deleted_shown=g.d==="1"}if(this._first_load||c||f){Browse.reload(d,h,true)}FileSearch.show_basic(true);this._first_load=false;this._last_path=h;this._last_qargs=g;if(BrowseSelection.get_selected_files().length){a=BrowseSelection.get_selected_files()[0].get_div();if(a){return Browse.scrollToWithPadding(a,a.getHeight()*2)}}},parse_b2_hash:function(e){var c,b,d,a,f;a=e.split(":");if(a.length!==4){return false}d=a[0];c=a[2]==="1";b=a[3];f=!b||Util.isNumber(b);if(!f){return false}b=parseInt(b,10)||Constants.root_ns;return{ns_id:b,ns_path:d,deleted:c}}};var BrowseFile;BrowseFile=Class.create({initialize:function(b){var c,e,a;c=Browse.inside_dir?BROWSE_SNIPPET_LEN:SEARCH_SNIPPET_LEN;a=Util.filename(b.fq_path);this.icon=b.icon;this.filename=a;this.caption=a.em_snippet(c);this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.fq_path=b.fq_path;this.hash=b.hash;this.href=b.href;this.size=b.size!=="None"?b.size:"";this.bytes=b.bytes;this.is_deleted=this.bytes===-1;this.ago=b.ago;if(Browse.use_local_cache&&b.ts){if(this.is_deleted){this.ago=null}else{e=DateUtil.fromSecondsSinceEpochUTC(b.ts);this.ago=DateUtil.contextualFormat(e)}}this.ts=b.ts;this.dir=b.is_dir?1:0;this.tkey=b.tkey;this.target_ns=b.target_ns;this.sort_rank=b.sort_rank||0;this.sort_key=b.sort_key||[""];this.sjid=b.sjid;this.thumbnail_url_tmpl=b.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=b.large_thumbnail_url_tmpl;this.type=b.type;this.preview_type=b.preview_type;if(b.last_modified_fname){this.last_modified_fname=b.last_modified_fname.em_snippet(LAST_MODIFIED_FNAME_SNIPPET)}this.code_class=b.code_class;this.htmlified_link=b.htmlified_link;this.has_pdf_preview=b.has_pdf_preview;this.root_coll_item_counter=b.root_coll_item_counter;if(!(this.to_key() in BrowseFile._file_index)){Browse.add_file(this);return BrowseFile._file_index[this.to_key()]=this}},is_share:function(){return this.type===FileTypes.SHARED_FOLDER},is_sandbox:function(){return this.type===FileTypes.SANDBOX},video_transcode_url:function(){assert(this.fq_path,"video_transcode_url: expected a non-root fq_path");return"https://"+Constants.LIVE_TRANSCODE_SERVER+"/transcode_video/w/"+(this.hash+Util.urlquote(this.fq_path))},get_div:function(){return $("f_"+(this.to_key()))},rename:function(f,h,d,e,g,i){var b,j,a,c;b=Browse.inside_dir?BROWSE_SNIPPET_LEN:SEARCH_SNIPPET_LEN;a=this.fq_path;Browse.pre_action_selection=[a];j=Browse.find_file(f);if(j){Browse.remove_file(j)}this.filename=Util.filename(f);this.caption=this.filename.em_snippet(b);this.fq_path=f;this.ns_path=h;this.htmlified_link=i;this.hash=d;this.sort_key=e;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){c=this.href.split("/");c[c.length-1]=Util.urlquote(this.filename)+("?w="+d);this.href=c.join("/");this.icon=g}else{this.href="/home"+Util.urlquote(f);if(this.target_ns){Browse.ns_id_to_mount_point[this.target_ns]=f}}BrowseFile._file_index[this.to_key()]=this;Browse.update_file_pos(this);return document.fire(FileEvents.RENAME,{old_fq_path:a,file:this})},edit:function(){var c,a,b,d,e=this;this.editing=true;Browse.selectable();d=function(m){var g,f,j,o,l,i,p,n,k,h;h=m.responseText.evalJSON(true);assert(h.new_browse_files.length===1,"No new file data returned.");j=h.new_browse_files.first();o=j.fq_path;l=j.hash;k=Util.decode_sort_key(j.sort_key);p=j.icon;n=j.ns_path;i=j.htmlified_link;g=h.changesets;f=_("Rename complete.");Notify.server_success(f,null,null,g,FileOps.do_rollback);e.rename(o,n,l,k,p,i);BrowseSelection.set_selected_files([e]);e.get_div().smoothScrollIntoView();return BrowseUtil.load_visible_thumbs()};a="/cmd/rename"+(Util.urlquote(this.fq_path));c=new Ajax.InPlaceEditor(this.get_div().down(".filename-col a"),a,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:function(){return e.editing=false},onFailure:function(){},savingText:_("Saving..."),ajaxOptions:{job:true,html_in_error_msg:true,progress_text:_("Renaming..."),method:"POST",onCreate:Notify.clear_all,onSuccess:d,onUninitialized:Browse.unselectable},callback:function(f,g){return{to_path:g||"",folder:(e.dir?"yes":"")}}});c.enterEditMode();b=this.get_div().down(".editor_field");if("selectionEnd" in b&&this.filename.lastIndexOf(".")>-1){return b.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var b,a;if(this.dir){if(Browse.inside_dir&&Browse.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&Browse.public_folder_enabled){b="PUBLIC_FOLDER"}}if(b==null){if(this.type===FileTypes.FOLDER){b="FOLDER"}else{if(this.type===FileTypes.PACKAGE){b="FOLDER"}else{if(this.type===FileTypes.SHARED_FOLDER){b="SHARED_FOLDER"}else{if(this.type===FileTypes.SANDBOX){b="SANDBOX"}else{if(this.target_ns){b="SHARED_FOLDER"}else{b="FOLDER"}}}}}}}if(b==null){b=BrowseFile.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}a=this.is_deleted?BrowseFile.CATEGORY_TO_DELETED_TRANSLATION[b]:BrowseFile.CATEGORY_TO_TRANSLATION[b];assert(a,"CATEGORY MISSING FOR "+b);return a},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return Util.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&Browse.is_shmodelable_path(this.fq_path)}});BrowseFile._CATEGORIES={IMAGE:"ai bmp cr2 eps gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"cdr csv doc docx fla indd keynote numbers otf pages pdf ppt pptx pps ppsx ps rtf swf txt wpd xls xlsx",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};BrowseFile.EXTENSION_TO_CATEGORY={};BrowseFile.CATEGORY_TO_TRANSLATION={FILE:_("file"),FOLDER:_("folder"),SHARED_FOLDER:_("shared folder"),PUBLIC_FOLDER:_("folder"),IMAGE:_("image"),VIDEO:_("video"),AUDIO:_("audio"),DOCUMENT:_("document"),COMPRESSED_FILE:_("archive"),CODE:_("code"),DISK_IMAGE:_("disk image"),EXECUTABLE:_("executable"),SHORTCUT:_("shortcut"),LINK:_("link"),FONT:_("font"),SANDBOX:_("app folder")};BrowseFile.CATEGORY_TO_DELETED_TRANSLATION={FILE:_("deleted file"),FOLDER:_("deleted folder"),SHARED_FOLDER:_("deleted shared folder"),PUBLIC_FOLDER:_("deleted folder"),IMAGE:_("deleted image"),VIDEO:_("deleted video"),AUDIO:_("deleted audio"),DOCUMENT:_("deleted document"),COMPRESSED_FILE:_("deleted archive"),CODE:_("deleted code"),DISK_IMAGE:_("deleted disk image"),EXECUTABLE:_("deleted executable"),SHORTCUT:_("deleted shortcut"),LINK:_("deleted link"),FONT:_("deleted font"),SANDBOX:_("deleted app folder")};(function(){var c,e,b,d,a;d=BrowseFile._CATEGORIES;a=[];for(c in d){b=d[c];a.push((function(){var i,g,f,h;f=b.trim().split(" ");h=[];for(i=0,g=f.length;i<g;i++){e=f[i];h.push(BrowseFile.EXTENSION_TO_CATEGORY[e]=c)}return h})())}return a})();BrowseFile._file_index={};BrowseFile.from_key=function(a){return BrowseFile._file_index[a]};BrowseFile.from_elem=function(b){var a;if(!b){return}a=b.readAttribute("data-identity");if(a){return BrowseFile.from_key(a)}else{return BrowseFile.from_elem(b.up("[data-identity]"))}};var BrowseActions,BrowseActionsBasic,BrowseActionsContext,GlobalActions,GlobalActionsBasic,GlobalActionsContext;BrowseActions=Class.create({initialize:function(a){return this._set_files(a)},unlisten:function(){},get_actions:function(){var a;a=this.get_files();if(a.length<2){return this._get_actions_single(a.first())}else{return this._get_actions_multi(a)}},get_icon:function(a){return BrowseActions.option_dict[a].icon},get_text:function(a){var b;b=BrowseActions.option_dict[a];if(typeof b.text==="function"){return b.text.call(this)}else{return b.text}},get_href:function(a){var b;b=BrowseActions.option_dict[a];if(b.href){return b.href.call(this)}else{return""}},get_files:function(){return this._files},_set_files:function(a){return this._files=$A(a)},_get_actions_single:function(c){var d,a,e,g,b,i,f,j,h;d=[];if(!c){return[]}e=Browse.public_folder_enabled&&c.fq_path.toLowerCase().startsWith("/public/");f=Browse.public_folder_enabled&&c.fq_path.toLowerCase()==="/public";b=c.target_ns;a=c.ns_id!==Constants.root_ns;h=c.type===FileTypes.SHARED_FOLDER;j=c.type===FileTypes.SANDBOX;i=c.type===FileTypes.PACKAGE;g=c.root_coll_item_counter>=0;if(c.is_deleted){d=d.concat(["restore"]);d.push("purge");if(!c.dir){d.push("revisions")}}else{if(c.dir){if(j){d.push("app_info")}else{if(h){d.push("sharing_options")}else{if(!(a||b||e||f)){d.push("share")}}}if(c.is_shmodelable()){d.push("token_share")}d.push("download");if(!f){if(Browse.can_open_with){d.push("open_with")}d=d.concat(["delete","rename","move"]);if(!(i||b)){d.push("copy")}}if(Browse.can_create_album_from_folder){d.push("album_from_folder")}}else{if(c.is_shmodelable()){d.push("token_share")}if(e||Browse.public_app_token){d.push("copy_url")}d.push("download");if(Browse.can_open_with){d.push("open_with")}d=d.concat(["delete","rename","move","copy","revisions"]);if(g){d.push("view_in_photos")}}}return d},_get_actions_multi:function(c){var a,b;a=["download"];if(Browse.can_open_with){a.push("open_with")}a=a.concat(["delete","move","copy","restore","purge","view_in_photos"]);b=BrowseUtil.profile_files(c);if(b.deleted>0||b.public_folder>0){a.removeItem("move");a.removeItem("copy");a.removeItem("delete")}if(b.shared_folders>0){a.removeItem("copy")}if(b.deleted>0){a.removeItem("delete");a.removeItem("download")}if(!Browse.inside_dir){a.removeItem("download")}if(b.deleted!==c.length){if(b.rejoinables!==c.length){a.removeItem("restore")}a.removeItem("purge")}if(b.in_root_coll!==c.length){a.removeItem("view_in_photos")}return a}});Object.extend(BrowseActions,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(a){var b;Modal.icon_show("alert_32",_("Copy public link"),DomUtil.fromElm("copy-public-url"),{wit_group:"copy_public_link"});Modal.onHide=function(){$("flash_copy_container").remove();delete Modal.onHide;return Modal.hide()};BrowseActions.addCopyUrlFlash(a);b=$("modal-content").down("#public_url");assert(b,"Text element not found for copy pulic link");b.setValue(a);return b.select()},clipboard_copy_done:function(){Notify.server_success(_("Link copied to clipboard!"));return Modal.hide()},shortenPublicLink:function(){var a;Util.shorten_url($F("public_url"),BrowseActions.updatePublicLink);a=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small.gif",className:"right"});return $("modal-content").down("a").__date(a)},updatePublicLink:function(a){$("public_url").setValue(a);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();return BrowseActions.addCopyUrlFlash(a)},addCopyUrlFlash:function(b,c){var a;if(c==null){c="real_copy"}a=Util.copy_to_clipboard_swf(b,c,"BrowseActions.clipboard_copy_done");return $(a).up().style.zIndex="1001"},option_dict:{new_folder:{icon:"folder_add",text:_("New folder"),click_handler:function(a){return Browse.new_folder()}},global_restore:{icon:"restore",text:function(){assert(Browse.inside_deleted_dir,"Global restore from not a deleted dir");if(Browse.inside_deleted_shared_folder){return _("Rejoin shared folder")}else{if(Browse.inside_deleted_sandbox){return _("Restore app folder")}else{return _("Restore folder")}}},click_handler:function(){var c,b,a;c=Browse.containing_fq_path();if(Browse.inside_deleted_sandbox){assert(Browse.old_path_to_ns_id[c],"Deleted sandbox missing nsid");return Apps.restore_sandbox(c,Browse.old_path_to_ns_id[c])}else{if(Browse.inside_deleted_shared_folder){assert(Browse.old_path_to_ns_id[c],"Deleted shared folder missing nsid");return Sharing.rejoin(c,Browse.old_path_to_ns_id[c])}else{a=Util.urlquote(c);b=encodeURIComponent(location.href);return window.location.href="/restore"+a+"?prev="+b}}}},restore:{icon:"restore",text:function(){var b,a;b=this.get_files();a=BrowseUtil.profile_files(b);if(a.shared_folders===b.length){return ungettext("Rejoin shared folder","Rejoin shared folders",b.length)}else{return _("Restore")}},click_handler:function(){var b,e,a,f,d,c;e=this.get_files();if(e.length===0){}else{if(e.length===1){b=e.first();if(!b.is_deleted){return}f=b.fq_path;a=f.toLowerCase();if(b.type===FileTypes.SANDBOX){assert(Browse.old_path_to_ns_id[a],"Restore missing ns");Apps.restore_sandbox(f,Browse.old_path_to_ns_id[a])}else{if(b.type===FileTypes.SHARED_FOLDER){assert(Browse.old_path_to_ns_id[a],"Rejoin missing ns");Sharing.rejoin(f,Browse.old_path_to_ns_id[a])}else{if(b.dir){c=Util.urlquote(b.fq_path);d=encodeURIComponent(Util.add_qstring(location.href,{select:b.filename}));window.location="/restore"+c+"?prev="+d}else{FileOps.show_undelete(b)}}}}else{return FileOps.show_bulk_restore(e)}}}},global_share:{icon:"rainbow_16",text:function(){if(Browse.inside_shared_folder){return _("Shared folder options")}else{if(Browse.containing_fq_path()===""){return _("Share a folder")}else{return _("Share this folder")}}},click_handler:function(a){if(Browse.containing_fq_path()===""){return Sharing.start_wizard(a)}else{if(Browse.inside_shared_folder){return Sharing.get_sharing_options(Browse.containing_mount_point())}else{return Sharing.show_share_existing_modal(Browse.containing_fq_path())}}}},sharing_options:{icon:"rainbow_16",text:_("Shared folder options"),click_handler:function(a){return Sharing.get_sharing_options(this.get_files().first().fq_path)}},view_token:{icon:"link",text:_("Share link"),click_handler:function(){var b,a;b=this.get_files().first();a="/s/"+b.tkey;if(!b.dir){a+="/"+Util.urlquote(Util.filename(b.fq_path))}return window.location.href=a}},remove_share:{icon:"link_delete",text:_("Disable link"),click_handler:function(){var a;a=this.get_files().first();return SharingModel.confirm_remove(Util.filename(a.fq_path),a.tkey,a.dir)}},share_new:{icon:"rainbow_16",text:_("Share a folder"),click_handler:function(a){return Sharing.start_wizard(a)}},share:{icon:"rainbow_16",text:_("Invite to folder"),click_handler:function(a){return Sharing.show_share_existing_modal(this.get_files().first().fq_path)}},share_invite_more:{icon:"group",text:_("Invite more people"),click_handler:function(a){return Sharing.show_invite_more_modal(this.get_files().first().fq_path)}},share_leave:{icon:"folder_user_delete",text:_("Leave shared folder"),click_handler:function(a){var b;b=this.fq_path;return Sharing.show_leave_modal(this.get_files().first().fq_path)}},share_unshare:{icon:"link_break",text:_("Unshare this folder"),click_handler:function(a){var b;b=this.get_files().first().fq_path;return Sharing.show_unshare_modal(b)}},revisions:{icon:"previousversions",click_handler:function(){return window.location.href="/revisions"+Util.urlquote(this.get_files().first().fq_path)},text:_("Previous versions")},token_share:{icon:"link",text:_("Share link"),click_handler:function(b){var a;a=this.get_files().first().fq_path;assert(a,"token_share: expected non-root fq_path");return Sharing.shmodel(a)}},global_token_share:{icon:"link",text:_("Share link"),click_handler:function(a){return Sharing.shmodel(Browse.containing_fq_path())}},copy_url:{icon:"world_link",text:_("Copy public link"),click_handler:function(c){var a,b;AMC.log("site_action",{action:"publink_create",webserver:Constants.WEBSERVER});a=this.get_files().first();b=Browse.public_app_token?"/spa/"+Browse.public_app_token+Util.urlquote(a.ns_path):"/u/"+Constants.uid+Util.urlquote(a.fq_path.substring(BrowseActions.PUBLIC_FOLDER_PATH_LENGTH));return BrowseActions.showCopyPublicUrlModal("https://"+Constants.PUBSERVER+b)}},download:{icon:"download",text:function(){return _("Download")},click_handler:function(){var h,b,c,f,e,g,a,d;c=this.get_files();AMC.log("file_action",{action:"download",num_files:c.length,webserver:Constants.WEBSERVER});if(c.length===1&&!c[0].dir){b=c.first();d=[Constants.protocol,Constants.block,Util.urlquote(b.fq_path),b.hash],g=d[0],h=d[1],e=d[2],f=d[3];a=""+g+"://"+h+"/get"+e+"?w="+f+"&dl=1";return window.location=a}else{return FileOps.do_bulk_download(c)}}},view:{href:function(){var f,a,d,c,e,b;a=this.get_files().first();b=[Constants.protocol,Constants.block,Util.urlquote(a.fq_path),a.hash],e=b[0],f=b[1],c=b[2],d=b[3];return""+e+"://"+f+"/get"+c+"?w="+d},icon:"page_white_magnify",text:_("View file")},a_photo:{href:function(){return"/photoshow"+Util.urlquote(this.get_files().first().fq_path.substring(7))},icon:"pictures",text:_("Gallery view")},ignore:{click_handler:function(){return Sharing.ignore(this.get_files().first().fq_path)},icon:"folder_user_delete",text:_("Permanently remove")},show_del:{click_handler:function(a){return Browse.toggle_deleted()},icon:"show-deleted",text:_("Show deleted files")},hide_del:{click_handler:function(a){return Browse.toggle_deleted()},icon:"hide-deleted",text:_("Hide deleted files")},copy:{icon:"copy",text:_("Copy"),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_copy(a.fq_path,a.dir)}else{if(b.length>1){return FileOps.show_copy_bulk(b)}}}},move:{icon:"move_16",text:_("Move"),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_move(a.fq_path,a.dir)}else{if(b.length>1){return FileOps.show_move_bulk(b)}}}},rename:{icon:"rename",text:_("Rename"),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:_("Delete"),click_handler:function(c){var a,b;b=this.get_files();if(b.length>1){return FileOps.show_bulk_delete(b)}else{if(b.length===1){a=b.first();return FileOps.show_delete(a.fq_path,a.dir)}}}},global_purge:{icon:"permdelete",text:_("Permanently delete folder"),click_handler:function(){return FileOps.show_purge(Browse.containing_fq_path(),true)}},purge:{icon:"permdelete",text:_("Permanently delete"),click_handler:function(c){var a,b;b=this.get_files();if(b.length===1){a=b.first();return FileOps.show_purge(a.fq_path,a.dir)}else{return FileOps.show_bulk_purge(b)}}},upload:{icon:"upload_16",text:_("Upload"),click_handler:function(a){return FileOps.show_upload()}},app_info:{icon:"application_double",text:_("Application info"),click_handler:function(a){return window.location.href="/account/applications"}},more_actions:{icon:"big-dropdown",text:function(){return _("More")},click_handler:Prototype.emptyFunction},preview_folder:{icon:"magnifier2",text:function(){return _("Preview folder")},click_handler:function(){return BrowseUtil.filepreview_from_selected("fileclick",this)}},more_global_actions:{icon:"arrow_down_grey_small",text:_("More actions"),click_handler:function(){GlobalActionsBasic.show_secondary();return document.body.observe("click",GlobalActionsBasic.hide_secondary)}},open_with:{icon:"move_16",text:_("Open with..."),click_handler:function(){return FileOps.show_open_with(this.get_files(),Util.do_open_with)}},view_in_photos:{icon:"photos_16",text:function(){return _("View in Photos")},click_handler:function(){var a;a=this.get_files();return FileOps.do_bulk_photo_view(a)}},album_from_folder:{icon:"pictures",text:function(){return _("Create album")},click_handler:function(){var b,a;b=this.get_files();a=b.first();return FileOps.create_album_from_folder(a.fq_path,a.filename)}}}});BrowseActionsContext=Class.create(BrowseActions,{initialize:function($super,a){$super(a);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(d,b){var c,a;c=b.readAttribute("data-value");a=BrowseActions.option_dict[c];d.stop();ContextMenu.hide();return a.click_handler.call(this)}});BrowseActionsBasic=Class.create(BrowseActions,{initialize:function($super){var a;a=BrowseSelection.get_selected_files();$super(a);this._render();return this._listen()},_listen:function(){var a;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(BrowseSelection.UPDATED_EVT,this.bound_update);document.observe(ContextMenu.SHOW_EVT,this.bound_disable);document.observe(ContextMenu.HIDE_EVT,this.bound_enable);a=$("browse-root-actions");a.stopObserving("click");return a.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(BrowseSelection.UPDATED_EVT,this.bound_update);document.stopObserving(ContextMenu.SHOW_EVT,this.bound_disable);document.stopObserving(ContextMenu.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(BrowseSelection.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var t,o,h,r,u,v,n,p,j,e,f,g,q,d,l,b,i,k,m,c,a,s;e=this.get_files();h=this.get_actions();t=14;p="";f="";if(e.length===1){p=e[0].filename.em_snippet(t);if(!e[0].dir&&e[0].bytes>=0){f=e[0].size}}else{if(1<e.length){b=BrowseUtil.profile_files(e);q=[];if(b.files){d=ungettext("%d file","%d files",b.files).format(b.files);q.push(d)}if(b.folders){d=ungettext("%d folder","%d folders",b.folders).format(b.folders);q.push(d)}p=Util.nice_list(q)}}u=$("browse-root-actions");r=u.getLayout().get("width");g=u.getStyle("font-size");assert(g.endsWith("px"),"Invalid font size "+g);g=parseInt(g,10);j=new Emstring(p).length*g;k=new Emstring(f).length*g;r-=j+k;m=[];i=[];r-=10;for(a=0,s=h.length;a<s;a++){o=h[a];c=new Emstring(this.get_text(o)).length*g;v=c+16+8+10+9;if(r>v){m.push(o)}else{if(i.length===0){l=m.pop();i.push(l)}i.push(o)}r-=v}n=HTML.tmpl("actions_bar_tmpl",{context:this,description:p,filesize:f,has_actions:!!h.length,standard_actions:m,secondary_actions:i});return $("browse-root-actions").__date(n)},_click:function(d,b){var c,a;c=b.readAttribute("data-value");assert(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);d.preventDefault();return a.click_handler.call(this)}});Object.extend(BrowseActionsBasic,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos"]});GlobalActions=Class.create(BrowseActions,{initialize:function($super){return $super()},get_actions:function(){var b,a;if(!Browse.inside_dir){return[]}b=[];if(!Browse.inside_deleted_dir){b=b.concat(["upload","new_folder"]);a=Browse.inside_shared_folder&&Browse.containing_ns_path();if(!(Browse.inside_sandbox||a)){b.push("global_share")}if(Browse.containing_fq_path()&&Browse.is_shmodelable_path(Browse.containing_fq_path())){b.push("global_token_share")}if(!Constants.can_see_trash){b.push((Browse.deleted_shown?"hide_del":"show_del"))}}else{b=b.concat(["global_restore"])}return b}});GlobalActionsBasic=Class.create(GlobalActions,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(ContextMenu.SHOW_EVT,this._disable.bind(this));return document.observe(ContextMenu.HIDE_EVT,this._enable.bind(this))},_render:function(){var d,b,c,a;d=this.get_actions();a=d.intersect(GlobalActionsBasic.STANDARD_ACTIONS);c=d.without.apply(d,GlobalActionsBasic.STANDARD_ACTIONS);if(c.length===1){a=d;c=[]}if(c.length){a.push("more_global_actions")}b=HTML.tmpl("global_actions_tmpl",{context:this,standard_actions:a,secondary_actions:c});return $("global-actions").__date(b)},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_enable:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");return $$("#global-actions .action a").invoke("addClassName","title_bubble")},_click:function(d,b){var c,a;c=b.readAttribute("data-value");assert(c);a=BrowseActions.option_dict[c];assert(a,"Action info is missing for "+c);d.stop();GlobalActionsBasic.hide_secondary();BrowseSelection.deselect_all();return a.click_handler.call(this)}});Object.extend(GlobalActionsBasic,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var a,b;b=$("secondary-actions");a=$("more_global_actions_button");b.show();return a.addClassName("down")},hide_secondary:function(){var a,b;b=$("secondary-actions");if(!b){return}a=$("more_global_actions_button");b.hide();return a.removeClassName("down")}});GlobalActionsContext=Class.create(GlobalActions,{initialize:function($super,a){$super(a);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(d,b){var c,a;c=b.readAttribute("data-value");a=BrowseActions.option_dict[c];d.stop();BrowseSelection.deselect_all();ContextMenu.hide();return a.click_handler.call(this)}});var BrowseClipboard;BrowseClipboard=(function(){var i,f,c,g,e,k,m,h,b,a,j,d,l;i=0;f=1;e=[];c=null;l=function(){var p,r,o,s,q,n;if(Util.focus_in_input()){return}o=BrowseSelection.get_selected_files();if(o&&o.length){for(q=0,n=o.length;q<n;q++){r=o[q];if(r.bytes<0){Notify.server_error(_("Deleted files cannot be added to the clipboard"));return false}else{if(r.target_ns){s=_("'%(filename)s' cannot be added to the clipboard");s=s.format({filename:r.filename});Notify.server_error(s);return false}}}e=o;p=o.length;s=ungettext("Added %d item to clipboard","Added %d items to clipboard",p).format(p);Notify.server_success(s);return true}};k=function(){if(l()){c=i;return false}};m=function(){if(l()){c=f;return false}};h=function(n){var o;assert(typeof n!=="undefined","BrowseClipboard _paste got an undefined path");if(e.length){o=c===i?FileOps.do_bulk_copy:FileOps.do_bulk_move;o(e,n);return true}};d=function(n){var o;if(Util.focus_in_input()||Browse.in_search_mode()||Browse.inside_deleted_dir){return}o=h(Browse.containing_fq_path());if(o){return false}};g=function(){return e=[]};a=function(u){var t,p,r,s,q,o,n;r=u.memo.files;for(s=0,o=r.length;s<o;s++){p=r[s];for(q=0,n=e.length;q<n;q++){t=e[q];if(t.fq_path===p.fq_path||t.fq_path.startsWith(p.fq_path+"/")){g();return}}}};b=function(n){assert((n.memo.file!=null)&&!(n.memo.files!=null));n.memo.files=[n.memo.file];return a(n)};j=function(){var r,n,q,o,p;document.observe(FileEvents.RENAME,b);p=[FileEvents.DELETE,FileEvents.MOVE];for(q=0,o=p.length;q<o;q++){r=p[q];document.observe(r,a)}n=key.main_modifier();key(""+n+"+c",Browse.KEY_SCOPE,k);key(""+n+"+x",Browse.KEY_SCOPE,m);return key(""+n+"+v",Browse.KEY_SCOPE,d)};return{init:function(){return j()}}})();var BrowseSelection;BrowseSelection=(function(){var y,D,B,x,g,f,u,z,m,e,C,r,q,a,b,n,s,E,l,j,o,i,w,d,h,v,t,c,A,k,p;h=[];x=null;e=null;z=null;f=[];A=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select");return BrowseSelection.get_selected_files().invoke("get_div").findAll(function(F){return F}).invoke("addClassName","file-select")};k=function(){if(z){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);return BrowseSelection.get_selected_files().filter(function(F){return !F.editing}).invoke("get_div").findAll(function(F){return F}).invoke("writeAttribute","draggable","true")};p=function(F){F.apply(null,$A(arguments).slice(1));return document.fire(BrowseSelection.UPDATED_EVT)};v=function(H,G){var I,F;F=h.length;h=(H instanceof BrowseFile?[H]:$A(H));if(h.length!==F){T("Selected",h.length,"files")}I=G||h.last();assert(!I||I instanceof BrowseFile,"Invalid anchor type"+I);return x=I};v=v.wrap(p);y=function(G,F){if(G){h.push(G)}return x=F||G};y=y.wrap(p);j=function(F){var G;G=h.indexOf(F);if(G===-1){return}return h.splice(G,1)};j=j.wrap(p);o=function(){return h=[]};o=o.wrap(p);t=function(F){f=F;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return F.invoke("get_div").findAll(function(G){return G}).invoke("addClassName","context-select")};a=function(O){var L,J,I,K,R,H,Q,S,F,N,P,M,G;M=$(O.target);S=M.match("li.browse-file")?M:M.up("li.browse-file");L=M.match("a")?M:M.up("a");I=BrowseFile.from_elem(S);if(O.isRightClick()||!S||L){return}Browse.keyboard_nav=false;if(f.length){return}H=Util.is_mac();if((H&&O.metaKey)||(!H&&O.ctrlKey)){if(h.indexOf(I)===-1){return y(I)}else{return j(I)}}else{if(O.shiftKey){J=Browse.files.indexOf(x);G=Browse.files.indexOf(I);Q=Browse.files.indexOf(h.last());N=h.slice(0);R=Q<J?-1:1;K=J;while(K!==Q){K+=R;P=N.indexOf(Browse.files[K]);if(P!==-1){N.splice(P,1)}}R=G<J?-1:1;K=J;while(K!==G){K+=R;F=N.indexOf(Browse.files[K]);if(F!==-1){N.splice(F,1)}N.push(Browse.files[K])}return v(N,x)}else{return v(I)}}};b=function(K){var O,H,N,L,G,F,J,I,M;if(K.isRightClick()||f.length||Util.in_scrollbar(K.pointerX())){return}L=$(K.target);if(Element.match(L,"object")){L=L.parentNode}J=["browse-box","context-menu-container","modal","modal-overlay"];G=false;for(I=0,M=J.length;I<M;I++){F=J[I];if(L.descendantOf(F)||L.match("#"+F)){G=true;break}}if(!G){v();return}N=L.match("li.browse-file")?L:L.up("li.browse-file");H=BrowseFile.from_elem(N);O=L.match("[draggable]")||L.up("[draggable]");if(H&&!O){e=x;if(!K.shiftKey){if(H){e=H}else{if(L.match("#browse-files")){e=Browse.files.last()}}}z=[];if(K.metaKey||K.ctrlKey){return z=BrowseSelection.get_selected_files()}}};c=function(I){var G,F,H;H=$(I.target);F=H.match("li.browse-file")?H:H.up("li.browse-file");G=BrowseFile.from_elem(F);I.preventDefault();if(G){return Sharing.shmodel(G.fq_path)}};g=function(I){var G,F,H;H=$(I.target);F=H.match("li.browse-file")?H:H.up("li.browse-file");G=BrowseFile.from_elem(F);if(G){return a(I)}};q=null;C=function(){var F;clearInterval(q);F=function(){Browse.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return q=setTimeout(F,100)};u=function(){if(!Browse.keyboard_nav){Browse.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};n=function(L){var I,H,G,K,N,F,J,M;C();if(!BrowseSelection.is_selecting()){return}I=Browse.files.indexOf(e);F=Browse.files.indexOf(BrowseFile.from_elem(L.target));assert(I<Browse.files.length&&I>=0,"anchor_index: "+I+" "+e);assert(F<Browse.files.length&&F>=0,"target_index: "+F);H=Browse.files.slice(Math.min(I,F),Math.max(I,F)+1);G=z.slice(0);for(J=0,M=H.length;J<M;J++){N=H[J];K=G.indexOf(N);if(K===-1){G.push(N)}else{G.splice(K,1)}}return v(G)};m=function(F){e=null;return z=null};l=function(H){var F,G;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(H){Event.extend(H).preventDefault()}G=h.length?h.last()===Browse.files.first()?Browse.files.first():(F=Browse.files.indexOf(h.last())-1,Browse.files[F]):Browse.files.last();v(G);if(G){return Browse.scrollTo(G.get_div())}};s=function(H){var F,G;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(H){Event.extend(H).preventDefault()}G=h.length?h.last()===Browse.files.last()?Browse.files.last():(F=Browse.files.indexOf(h.last())+1,Browse.files[F]):Browse.files.first();v(G);if(G){return Browse.scrollTo(G.get_div())}};B=function(N){var F,G,L,M,I,J,K,H;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(N){Event.extend(N).preventDefault()}if(h.length>0){M=Browse.files.indexOf(h.last());F=Browse.files.indexOf(x);if(x===h.last()||F>M){if(M>0){H=[];for(L=J=K=M-1;K<=0?J<=0:J>=0;L=K<=0?++J:--J){G=Browse.files[L];I=h.indexOf(G);y(G,x);if(I!==-1){H.push(h.splice(I,1))}else{Browse.scrollTo(G.get_div());break}}return H}}else{j(h.last());return Browse.scrollTo(h.last().get_div())}}else{return l()}};D=function(O){var F,G,M,N,J,K,L,I,H;if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}u();if(O){Event.extend(O).preventDefault()}if(h.length>0){N=Browse.files.indexOf(h.last());F=Browse.files.indexOf(x);if(x===h.last()||F<N){H=[];for(M=K=L=N+1,I=Browse.files.length;L<=I?K<I:K>I;M=L<=I?++K:--K){G=Browse.files[M];J=h.indexOf(G);y(G,x);if(J!==-1){H.push(h.splice(J,1))}else{Browse.scrollTo(G.get_div());break}}return H}else{j(h.last());return Browse.scrollTo(h.last().get_div())}}else{return s()}};i=function(){if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}v(Browse.files);return false};d=function(){if(typeof BrowseJump!=="undefined"&&BrowseJump!==null){BrowseJump.reset()}return v(null,null,null)};w=function(F){return v(Browse.find_file(F.memo.fq_path))};r=function(){$$(".file-select").invoke("removeClassName","file-select");return setTimeout(A,100)};E=function(F){return F.memo.files.each(function(G){var H;H=h.indexOf(G[0]);if(H!==-1){h.splice(H,1);return y(G[1])}})};document.observe(UpdateEvents.REMOVE,function(F){return F.memo.files.each(j)});document.observe(UpdateEvents.MOVE,E);return{UPDATED_EVT:"db:select:updated",LIGHTBOX_EXIT_SELECT_EVT:"db:filepreview:exitselect",init:function(){var F;document.observe("click",g);document.observe("mousedown",b);document.observe("mouseup",m);document.observe("dragend",m);document.observe("mouseup",k);$("browse-files").on("mouseover","li.browse-file",n);$("browse-files").on("click",".shmodel-file",c);document.observe(BrowseSelection.UPDATED_EVT,A);document.observe(BrowseSelection.UPDATED_EVT,k);document.observe(Browse.RENDER_EVT,A);document.observe(Browse.RENDER_EVT,k);document.observe(Browse.UPDATE_EVT,v.bind(null,null,null));document.observe(BrowseSelection.LIGHTBOX_EXIT_SELECT_EVT,w);F=key.main_modifier();key("up",Browse.KEY_SCOPE,l);key("down",Browse.KEY_SCOPE,s);key(F+"+a",Browse.KEY_SCOPE,i);key("escape",Browse.KEY_SCOPE,d);key("shift+up",Browse.KEY_SCOPE,B);return key("shift+down",Browse.KEY_SCOPE,D)},set_selected_files:function(F){return v(F)},get_selected_files:function(){return h.slice(0)},get_selected_fq_paths:function(){return h.map(function(F){return F.fq_path})},is_selected:function(F){return h.indexOf(F)!==-1},is_selecting:function(){return !!e},deselect_all:o,set_context_selected:function(F){return t(F)},flicker_selected:r}})();var DragScroll;DragScroll={_timer:null,_mouse_y:0,_scroll_amount:40,_scroll_window:50,_exclude_move_event:null,init:function(a,b){this._exclude_move_event=a;if(b!=null){return this._scroll_window=b}},start:function(){this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(b){var a;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(b):void 0){return this._mouse_y=0}else{a=b.pointerY();return this._mouse_y=a-Util.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var a;a=0;if(this._mouse_y<this._scroll_window){a=-1*this._scroll_amount}else{if(this._mouse_y>Util.viewport_dimensions().height-this._scroll_window){a=this._scroll_amount}}if(a){return Util.scroll_to(Util.scroll_offsets().left,Util.scroll_offsets().top+a)}}};var BrowseDrag;BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var a;if(!Modernizr.draganddrop){return}this.listen();a=function(c){var b;b=$j(c.target);return b.closest("#browse-location").length||b.attr("id")==="browse-location"};return DragScroll.init(a,$j("#browse-header").height())},listen:function(){var a;a=$(document.body);document.observe(Browse.UPDATE_EVT,this._update_body_data.bind(this));a.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));a.on("dragend",this._body_dragend.bind(this));a.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){a.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));a.on("mousedown",this._ie_start_drags.bind(this));a.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}a.observe("dragover",this._body_dragover.bind(this));a.observe("dragleave",this._body_dragleave.bind(this));a.observe("dragstart",this._body_dragstart.bind(this));a.observe("mousemove",this._body_mousemove.bind(this));a.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(BrowseSelection.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(Browse.RENDER_EVT,this._build_selected_drag_icon.bind(this));a.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return a.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(b){var a;if(!window.event||window.event.button!==1){return}a=b.findElement("[draggable]");if(a&&a!==document&&a.dragDrop){a.dragDrop();return BrowseDrag._ie_end_drags()}},_ie_start_drags:function(a,b){if(b.tagName!=="OBJECT"&&$(b).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var b,a;b=Browse.inside_dir?"copy move":false;a=Browse.inside_dir?Browse.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",b);return $(document.documentElement).writeAttribute("data-fq_path",a)},_body_dragover:function(d){var b,c,a;b=this._get_event_browse_files();if(b.length){return this._update_status_position(d,b)}else{if(!this._drag_from_window&&((c=d.dataTransfer)!=null?(a=c.types)!=null?a.contains("Files"):void 0:void 0)){return CrossDomainUploader.show_drop_indicators(d)}}},_body_dragleave:function(c){var b,a,d;a=c.x||c.clientX;d=c.y||c.clientY;b=Util.viewport_dimensions();if(!((0<a&&a<b.width)&&(0<d&&d<b.height))){return CrossDomainUploader.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();CrossDomainUploader.hide_drop_indicators();DragScroll.end();return this._drag_from_window=false},_body_mousemove:function(){return CrossDomainUploader.hide_drop_indicators()},_ie_mouseover:function(b,a){if(!Util.focus_in_input()){return a.focus()}},_dropzone_dragover:function(f,a){var b,c,d;c=this._get_event_browse_files();d=this._target_fq_path(a);if(!c.pluck("fq_path").indexOf(d===-1)){return}if(!this._can_drop(f,a)){a.addClassName("drag_nodrop");return}if(Util.is_mac()){f.dataTransfer.dropEffect="copyMove"}else{f.dataTransfer.dropEffect="move"}f.preventDefault();b=$$(".dragover");b.removeItem(a);b.invoke("removeClassName","dragover");if(!OverQuotaUploads.disabled){a.addClassName("dragover")}return CrossDomainUploader.folder_dragover(d)},_dropzone_dragleave:function(b,a){return this._clear_hover_state(a)},_file_dragstart:function(h,k){var l,b,m,g,d,f,i,c;Util.clear_selected();if(BrowseSelection.is_selecting()){return h.preventDefault()}h.dataTransfer.effectAllowed="copyMove";h.dataTransfer.setData("URL","about:blank");g=BrowseFile.from_elem(k);this._set_event_browse_files(g);d=this._get_event_browse_files();if(d.length<=1&&!g.dir){c=g.href;f=(g.filename||_("file")).replace(/:/g,"-");i="application/octet-stream";try{h.dataTransfer.setData("DownloadURL",[i,f,c].join(":"))}catch(j){}}m=new Element("img",{src:"/static/images/icons/icon_spacer.gif",width:1,height:1});l=true;try{h.dataTransfer.setDragImage(m,150,150)}catch(a){l=Util.ie8}this._add_drop_indicators(h);DragScroll.start();if(l){this._update_status_position(h,d);b=$("drag-status");b.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(d.length>1){b.addClassName("rotatein")}if(this._is_dragging_selection()){b.addClassName("selection")}return b.addClassName("fadein")}},_add_drop_indicators:function(f){var g,d,b,c,a;$(document.body).addClassName(this._STATUS_CLASS);if(!OverQuotaUploads.disabled){c=$$('[dropzone="copy move"]');a=[];for(d=0,b=c.length;d<b;d++){g=c[d];if(this._can_drop(f,g)){a.push(g.addClassName("can_drop"))}else{a.push(void 0)}}return a}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var a,d,j,c,g,k,h,b,e,l,f;b=BrowseSelection.get_selected_files();j=new Element("div",{id:"drag-selection-status"});f=b.slice(0,4);for(g=e=0,l=f.length;e<l;g=++e){d=f[g];a=d.get_div();if(!a){continue}h=a.down(".icon");h.stopObserving("load");h.observe.bind(h).defer("load",BrowseDrag._build_selected_drag_icon);k=h.cloneNode(false);Element.addClassName(k,"icon icon"+g);j.__sert(k)}c=new Element("span",{className:"badge"});c.__date(b.length);j.appendChild(c);return $("drag-selection-status").replace(j)},_build_file_drag_icon:function(f,a){var b,g,d,c;b=BrowseFile.from_elem(a);c=b.get_div().down(".icon").cloneNode(false);Element.addClassName(c,"icon icon0");d=new Element("span",{className:"badge"});d.__date("1");g=new Element("div",{id:"drag-file-status"});g.__date(c).__sert(d);return $("drag-file-status").replace(g)},_drop:function(i,d){var a,c,f,g,b,h;i.preventDefault();c=this._get_event_browse_files();b=i.dataTransfer.files;h=i.dataTransfer.items;f=null;g=BrowseFile.from_elem(d);a=d.readAttribute("data-fq_path");if(g){f=g.fq_path}else{if(a||a===""){f=a}}if(b&&b.length){if(!CrossDomainUploader.supported()){Notify.server_error(_("Drag and drop not supported. Please try the simple uploader."))}else{if(!CrossDomainUploader.browse_indicators_enabled()&&!CrossDomainUploader.modal_indicators_enabled()){Notify.server_error(_("You can't drag and drop upload right now."))}else{CrossDomainUploader.upload(f,b,h)}}}else{if(c.length){if((i.dataTransfer.dropEffect==="copy")||(i.dataTransfer.effectAllowed==="copy")){FileOps.do_bulk_copy(c,f)}else{if(!Browse.inside_dir||Browse.containing_fq_path()!==f){FileOps.do_bulk_move(c,f)}}}}this._remove_drop_indicators();return CrossDomainUploader.hide_drop_indicators()},_set_event_browse_files:function(a){var b;b=BrowseSelection.is_selected(a);return this._current_item_key=b?this._SELECTION_CONST:a.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var c,b;try{b=this._current_item_key;if(this._is_dragging_selection()){return BrowseSelection.get_selected_files()}else{if(b){c=BrowseFile.from_key(b);return(c?[c]:[])}}}catch(a){console.log(a)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_can_drop:function(d,b){var a,c;a=this._target_fq_path(b);c=this._get_event_browse_files();if(c.length){return !FileOps.bulk_move_error(c,a)}else{if($A(d.dataTransfer.types).indexOf("Files")!==-1){return CrossDomainUploader.supported()}else{return false}}},_target_fq_path:function(a){var b;b=BrowseFile.from_elem(a);if(b){return b.fq_path}else{return a.readAttribute("data-fq_path")}},_clear_hover_state:function(b){var e,d,a,c;c=$$("#browse .dragover");for(d=0,a=c.length;d<a;d++){e=c[d];if(e!==b){e.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(a){a=Event.extend(a);return Util.scry("drag-status").setStyle({left:(a.pointerX()-Util.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(a.pointerY()-Util.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var BrowseJump;BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(a){return a.charCodeAt(0)}),update:function(){var c,f,b,e,a,d;if(!BrowseJump._listening){BrowseJump.listen();BrowseJump._listening=true}c=[];d=Browse.files;for(e=0,a=d.length;e<a;e++){b=d[e];f=BrowseJump.to_codepoint_list(b.filename);c.push([f,b])}c.sort(function(h,g){return BrowseJump.cmp_codepoints(h[0],g[0])});return BrowseJump._CODEPOINTS=c},reset:function(){return BrowseJump._active=""},is_active:function(){return BrowseJump._active},jump:function(a){if(a){BrowseSelection.set_selected_files([a]);return Browse.scrollTo(a.get_div())}},listen:function(){var e,d,b,c,a;document.observe("keypress",function(g){var f;if(key.getScope()!==Browse.KEY_SCOPE){return}if(Util.focus_in_input()||g.metaKey||g.altKey||g.altGraphKey||g.ctrlKey){return}f=g.charCode||g.keyCode;if(f<32){return}if((33<=f&&f<=40)){return}if(f===32){if(BrowseJump._active){g.preventDefault()}else{return}}if(BrowseJump._BLACKLIST.indexOf(f)!==-1){return}clearTimeout(BrowseJump._RESET_TIMER_ID);BrowseJump._active+=String.fromCharCode(f).toLowerCase();BrowseJump.jump(BrowseJump.nearest_file(BrowseJump._active));return BrowseJump._RESET_TIMER_ID=setTimeout(BrowseJump.reset,BrowseJump._RESET_WAIT)});c=[FileEvents.DELETE,FileEvents.COPY,FileEvents.MOVE,FileEvents.RENAME,FileEvents.PURGE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE,UpdateEvents.ADD,UpdateEvents.REMOVE,UpdateEvents.MOVE];a=[];for(d=0,b=c.length;d<b;d++){e=c[d];a.push(document.observe(e,function(f){return BrowseJump.update()}))}return a},nearest_file:function(i){var f,b,a,e,h,g,d,c;if((g=BrowseJump._CODEPOINTS)!=null?g.length:void 0){f=BrowseJump.to_codepoint_list(i);d=BrowseJump._CODEPOINTS;for(e=0,h=d.length;e<h;e++){c=d[e],a=c[0],b=c[1];if(BrowseJump.cmp_codepoints(f,a)<1){return b}}BrowseJump._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(e,d){var a,c,b;assert(e.length>0&&d.length>0,"bad input to cmp_codepoints");for(a=c=0,b=e.length;0<=b?c<b:c>b;a=0<=b?++c:--c){if(!(d[a]!=null)){return 1}if(e[a]!==d[a]){return(e[a]<d[a]?-1:1)}}if(d.length>e.length){return -1}else{return 0}},to_codepoint_list:function(b){var c,a,e,d;b=b.toLowerCase();a=[];for(c=e=0,d=b.length;0<=d?e<d:e>d;c=0<=d?++e:--e){a.push(b.charCodeAt(c))}return a}};var ContextMenu;ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){var a=this;document.observe("click",this.hide_on_click);document.observe(Browse.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,function(b){return ContextMenu.hide()})},unlisten:function(){return document.stopObserving("click",this.hide_on_click)},hide_on_click:function(a){if(!a.isRightClick()){return ContextMenu.hide()}},show_for_file:function(a,d,c){var f,b;Browse.keyboard_nav=false;this.hide();f=BrowseFile.from_elem(c);b=BrowseSelection.is_selected(f)?BrowseSelection.get_selected_files():[f];BrowseSelection.set_context_selected(b);return this._show(d,new a(b))},show_global:function(a,b){this.hide();return this._show(b,new a())},show_shmodel:function(f){var d,a,b,c;d=["get_original"];this.hide();b=f.findElement("img");c={get_original:{icon:"download",text:_("Download Original"),href:b.readAttribute("data-original-href")}};a=Class.create({get_actions:function(){return d},get_icon:function(e){return c[e].icon},get_text:function(e){return c[e].text},get_href:function(e){return c[e].href}});return this._show(f,new a())},show_for_lightbox:function(f){var d,a,b,c;d=["download","view_original"];this.hide();b=f.findElement("img");c={download:{icon:"download",text:_("Download"),href:""+(b.readAttribute("data-original-href"))+"&dl=1"},view_original:{icon:"view_original",text:_("View Original"),href:b.readAttribute("data-original-href"),target:"_blank"}};a=Class.create({initialize:function(){return this._listen()},_listen:function(){var e;e=$("context-menu-container");e.stopObserving("click");e.stopObserving("contextmenu");e.on("click",".action button",this._click.bind(this));return e.on("contextmenu",".action button",this._click.bind(this))},_click:function(k,h){var j,g,i;j=h.readAttribute("data-value");g=c[j];k.stop();ContextMenu.hide();return(i=g.click_handler)!=null?i.call(this,k):void 0},get_actions:function(){return d},get_type:function(e){return c[e].type},get_icon:function(e){return c[e].icon},get_icon_href:function(e){return c[e].icon_href},get_text:function(e){return c[e].text},get_target:function(e){return c[e].target},get_href:function(e){return c[e].href}});return this._show(f,new a())},show_photos:function(j,n){var m,b,g,d,l,k,a,c,h,i,f;this.hide();d={divider:{type:"divider"},choose_album:{icon:"album_new_16",text:_("Add %(num_photos)s to album...").format({num_photos:n.length}),click_handler:function(o){PhotosCollections.show_add_to_album_modal(o,n);return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.PCM,{num_photos:n.length})}},remove:{icon:"album_delete_16",text:_("Remove %(num_photos)s from album").format({num_photos:n.length}),click_handler:function(){PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),n);return PhotosLogger.log_interaction(PhotosEvents.REMOVE,PhotosTriggers.PCM,{num_photos:n.length})}},set_cover:{icon:"album_16",text:_("Set as cover"),click_handler:function(){Photos.get_current_collection().set_cover(n[0]);return PhotosLogger.log_interaction(PhotosEvents.SET_AS_COVER,PhotosTriggers.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return Photos.show_timestamps_modal(n)}}};if(Photos.in_single_collection_view()){m=["share","choose_album","remove"];if(n.length===1){m.unshift("divider");m.unshift("set_cover")}}else{m=["share","choose_album"];m.push("divider");m.push("delete");if(Photos.timestamp_edit_enabled){l=(function(){var p,o,e;e=[];for(p=0,o=n.length;p<o;p++){c=n[p];if(!(c.time_taken!=null)){e.push(c)}}return e})();if(l.length===0){m.push("edit_timestamp")}else{if(l.length===n.length){d.edit_timestamp.text="Set timestamp";m.push("edit_timestamp")}}}}if(n.length===1){i=PhotosUtil.categorize_files(n),k=i[0],a=i[1];if(k){h=_("Share photo")}else{h=_("Share video")}Object.extend(d,{share:{icon:"link",text:h,click_handler:function(o){Foshmodal.show(n,false);return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.PCM,{num_photos:1})}},"delete":{text:_("Delete"),click_handler:function(){Photos.show_delete_photos_modal(n);return PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.PCM,{num_photos:1})}},show_in_folder:{text:_("Show in folder"),click_handler:function(){Photos.show_in_folder(n[0]);return PhotosLogger.log_interaction(PhotosEvents.SHOW_IN_FOLDER,PhotosTriggers.PCM,{num_photos:1})}}});if(Photos.in_single_collection_view()){m.push("divider")}m.push("show_in_folder")}else{f=PhotosUtil.categorize_files(n),k=f[0],a=f[1];if(k&&a){h=ungettext("Share %(file_count)s item","Share %(file_count)s items",n.length);g=ungettext("Delete %(file_count)s item","Delete %(file_count)s items",n.length)}else{if(k){h=ungettext("Share %(file_count)s photo","Share %(file_count)s photos",n.length);g=ungettext("Delete %(file_count)s photo","Delete %(file_count)s photos",n.length)}else{h=ungettext("Share %(file_count)s video","Share %(file_count)s videos",n.length);g=ungettext("Delete %(file_count)s video","Delete %(file_count)s videos",n.length)}}h=h.format({file_count:n.length});g=g.format({file_count:n.length});Object.extend(d,{share:{icon:"link",text:h,click_handler:function(o){Photos._share_selected();return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.PCM,{num_photos:n.length})}},"delete":{text:g,click_handler:function(o){Photos.show_delete_photos_modal(n);return PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.PCM,{num_photos:n.length})}}})}b=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(r,p){var q,o,s;q=p.readAttribute("data-value");o=d[q];r.stop();if(r.clientX===0&&r.clientY===0){return}ContextMenu.hide();return(s=o.click_handler)!=null?s.call(this,r):void 0},get_actions:function(){return m},get_type:function(e){return d[e].type},get_icon:function(e){return d[e].icon},get_icon_href:function(e){return d[e].icon_href},get_text:function(e){return d[e].text},get_href:function(e){return d[e].href}});return this._show(j,new b())},show_photo_collection:function(d,f,g){var c,a,b;this.hide();if(f.is_anonymous){c=["go_to_link","unshare"]}else{if(f.is_creator){c=["share","rename"];if(f.share_tkey!=null){c.push("unshare")}c.push("delete")}else{c=["share"]}}b={share:{icon:"link",text:_("Share album"),click_handler:function(h){if(f.num_items===0){Notify.server_error(_("This album is empty. Add some photos before you share it!"));return}Foshmodal.show(f,true);return PhotosLogger.log_interaction(PhotosEvents.SHARE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},unshare:{icon:"lock",text:f.is_anonymous?_("Unshare"):_("Unshare album"),click_handler:function(h){PhotosCollections.show_unshare_modal(f);return PhotosLogger.log_interaction(PhotosEvents.UNSHARE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},rename:{icon:"album_rename_16",text:_("Rename album"),click_handler:function(h){f.rename(g.down(".collection-name"));return PhotosLogger.log_interaction(PhotosEvents.RENAME_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},"delete":{icon:"album_delete_16",text:_("Delete album"),click_handler:function(h){PhotosCollections.show_delete_modal(f);return PhotosLogger.log_interaction(PhotosEvents.DELETE_ALBUM,PhotosTriggers.CCM,{num_photos:f.num_photos})}},go_to_link:{icon:"link",text:_("Go to link"),click_handler:function(h){PhotosCollections.go_to_link(f);return PhotosLogger.log_interaction(PhotosEvents.GO_TO_ALBUM_LINK,PhotosTriggers.CCM,{num_photos:f.num_photos})}}};a=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(l,i){var k,h,j;k=i.readAttribute("data-value");h=b[k];l.stop();ContextMenu.hide();return(j=h.click_handler)!=null?j.call(this):void 0},get_actions:function(){return c},get_icon:function(e){return b[e].icon},get_text:function(e){return b[e].text},get_href:function(e){return b[e].href}});return this._show(d,new a())},_show:function(s,k,r){var p,q,h,t,a,o,l,i,n,x,w,m,b,d,c,u,v,j,g,f;if(r==null){r=false}m=((s!=null?(j=s.target)!=null?j.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((s!=null?(g=s.target)!=null?g.type.toUpperCase():void 0:void 0)==="TEXT")||((s!=null?(f=s.target)!=null?f.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");o=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer",".db-modal-wrapper"];w=$(s.target);if($j(w).parents("#context-menu").length){return}p=$j("#file-preview-modal");if(!p.find(w)||!$j(w).is("img")){for(d=0,u=o.length;d<u;d++){a=o[d];t=$$(a);if(t){for(c=0,v=t.length;c<v;c++){h=t[c];if(w.descendantOf(h)||w.match(a)){return}}}}}if((s!=null?s.shiftKey:void 0)||m){return}else{Event.stop(s)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=HTML.tmpl("context_menu_tmpl")}q=Event.pointer(s);if(!k.get_actions().length){return}FreshDropdown.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:k,actions:k.get_actions(),big:r}));b=Util.viewport_dimensions();x=Util.scroll_offsets();i=parseInt($("context-menu").getStyle("width"),10);l=parseInt($("context-menu").getStyle("height"),10);n=15;if(q.x+i>b.width+x.left-n){$("context-menu").setStyle({left:(q.x-x.left-i)+"px"})}else{$("context-menu").setStyle({left:(q.x-x.left)+"px"})}if(q.y+l>b.height+x.top-n){$("context-menu").setStyle({top:(b.height-l-n)+"px"})}else{$("context-menu").setStyle({top:(q.y-x.top)+"px"})}$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();BrowseSelection.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var BROWSE_SNIPPET_LEN,Browse,BrowseUpdate,FILE_PPREVIEW_MODAL_FOR_DOCS,LAST_MODIFIED_FNAME_SNIPPET,SEARCH_SNIPPET_LEN;BROWSE_SNIPPET_LEN=25;SEARCH_SNIPPET_LEN=20;LAST_MODIFIED_FNAME_SNIPPET=4;FILE_PPREVIEW_MODAL_FOR_DOCS=false;Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",UPDATE_EVT:"db:browse:update",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:[Sort.FILES_BY_NAME,true],folder_loading_notification:null,keyboard_nav:false,init:function(b,e,c,d,a){this.browse_actions_ctor=e;this.global_actions_ctor=c;this.browse_actions_context_ctor=d;this.global_actions_context_ctor=a;this.unselectable();this.listen();Util.viewport_dimensions();if($j.browser.chrome){return this.previews_enabled=b&&Util.pdf_plugins().length}else{return this.previews_enabled=b}},setup:function(b){var f,e,d,a,c;this.ns_id_to_mount_point=b.ns_id_to_mount_point;this.old_path_to_ns_id=b.old_path_to_ns_id;this.compiled_tmpl=HTML.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_dir=b.inside_dir;this.inside_deleted_dir=b.inside_deleted_dir;this.inside_shared_folder=b.inside_shared_folder;this.inside_sandbox=b.inside_sandbox;this.public_app_token=b.public_app_token;this.public_folder_enabled=b.public_folder_enabled;this.inside_deleted_sandbox=b.inside_deleted_sandbox;this.inside_deleted_shared_folder=b.inside_deleted_shared_folder;this.ns_map=b.ns_map;this.contents_cache_key=b.contents_cache_key;e="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(e)}else{$("browse").removeClassName(e)}this.block_hash=b.block_hash;this.block_hash_param=b.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=b.containing_ns_id;this._containing_ns_path=b.containing_ns_path;this._containing_fq_path=b.containing_fq_path;this._containing_mount_point=b.containing_mount_point;BrowseURL.set_path_url(this._containing_ns_id,this._containing_ns_path);this.breadcrumb();c=[this.browse_actions,this.global_actions];for(d=0,a=c.length;d<a;d++){f=c[d];if(f!=null){f.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!b.file_info){this.show_message(_('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}return this._push_files(b.file_info)},_push_files:function(b){var c,d,a;for(d=0,a=b.length;d<a;d++){c=b[d];BrowseUtil.make_browsefile(c)}return BrowseJump.update()},_get_helper:function(a){assert(this.inside_dir,"accessed "+a+", but not inside a directory");return Browse[a]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_fq_path:function(){return this._get_helper("_containing_fq_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},listen:function(){var b,f,n,i,h,e,l,c,a,m,j,g,d,k=this;$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",ContextMenu.show_for_file.bind(ContextMenu,this.browse_actions_context_ctor));this.enable_sorting();f="#browse-sort a.sortable-column-header";Util.add_sort_arrow_mouseover($("name-sorter"),true,f,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",ContextMenu.show_global.bind(ContextMenu,this.global_actions_context_ctor));document.observe(BrowseSelection.UPDATED_EVT,this.selection_handler.bind(this));document.observe(FileEvents.COPY,function(o){if(k.inside_dir&&o.memo.to_fq_path===k.containing_fq_path()){return k.force_reload()}});j=[FileEvents.MOVE,FileEvents.RESTORE,FileEvents.UPLOAD,FileEvents.SF_NEW,FileEvents.SF_REJOIN,FileEvents.SF_IGNORE,FileEvents.LINKS_REMOVE];for(i=0,l=j.length;i<l;i++){b=j[i];document.observe(b,function(o){if(k.inside_dir){return k.force_reload()}})}g=[FileEvents.SF_LEAVE,FileEvents.SF_UNSHARE];for(h=0,c=g.length;h<c;h++){b=g[h];document.observe(b,function(o){if(k.inside_dir){if(o.memo.target_ns_id===k.containing_ns_id()){if(o.memo.folder_deleted){return k.reload_fqpath("")}else{return k.reload_fqpath(k.containing_fq_path())}}else{return k.force_reload()}}})}d=[FileEvents.DELETE,FileEvents.PURGE];for(e=0,a=d.length;e<a;e++){b=d[e];document.observe(b,function(w){var t,v,p,u,o,r,s,q;if(k.inside_dir){if(w.eventName===FileEvents.PURGE||(w.eventName===FileEvents.DELETE&&!BrowseURL.get_del())){for(v=u=s=k.files.length-1;s<=0?u<=0:u>=0;v=s<=0?++u:--u){if(w.memo.files.indexOf(k.files[v])===-1){p=k.files[v]}else{break}}BrowseSelection.deselect_all();q=w.memo.files;for(r=0,o=q.length;r<o;r++){t=q[r];t.get_div().remove();k.files.removeItem(t)}if(k.files.length){if(p!=null){return BrowseSelection.set_selected_files(p)}else{return BrowseSelection.set_selected_files(k.files.last())}}else{return k.show_empty()}}else{if(k.keyboard_nav){k.select_fq_paths=[k.containing_fq_path()+"/"+w.memo.files.last().filename]}if(Lightbox.shown){return Lightbox.reload=true}else{return k.force_reload()}}}})}document.observe(ContextMenu.SHOW_EVT,this.disable_sorting.bind(this));document.observe(ContextMenu.HIDE_EVT,this.enable_sorting.bind(this));m=function(){var p,o;p=$("browse-header");o=p.cumulativeOffset().top+p.getHeight();return Util.viewport_dimensions().height-o};key("pagedown",this.KEY_SCOPE,function(o){Event.extend(o).preventDefault();return window.scrollBy(0,m())});key("pageup",this.KEY_SCOPE,function(o){Event.extend(o).preventDefault();return window.scrollBy(0,-1*m())});n=function(){var o;o=Browse.in_search_mode()?FileSearch:Browse;if(Browse.files.length===0){return o.show_empty()}else{return o.hide_empty()}};document.observe(UpdateEvents.ADD,function(q){var p,o,s,r;r=q.memo.files;for(o=0,s=r.length;o<s;o++){p=r[o];k.insert_file(p,true)}return n()});document.observe(UpdateEvents.REMOVE,function(q){var p,o,s,r;r=q.memo.files;for(o=0,s=r.length;o<s;o++){p=r[o];k.remove_file(p)}return n()});return document.observe(UpdateEvents.MOVE,function(r){var v,u,p,t,s,q,o;s=r.memo.files;o=[];for(p=0,t=s.length;p<t;p++){q=s[p],v=q[0],u=q[1];k.remove_file(v);o.push(k.insert_file(u))}return o})},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(b,c){var a;a=$(b.target);if(a.match("a.filename-link")||a.match("img.icon")){return this._click(b,c)}},dblclick:function(a,b){if($(a.target).match("a")){return}return this._click(a,b)},dropbox_open_file:function(c,a){var b,d;b={mode:"get",file_ext:Util.file_extension_for_logging(c.filename),file_bytes:c.bytes};if(c.dir){if(a){return this.open_folder_in_new_window(c)}else{return this.open_folder(c)}}else{if(!a&&!((c.preview_type==="video")&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX)){if(this.previews_enabled||((d=c.preview_type)==="photo"||d==="video")){return BrowseUtil.filepreview_from_selected("fileclick",c)}else{UserActivityLogger.log("web","file_view",Object.toJSON(b));return window.open(c.href,"_blank")}}else{UserActivityLogger.log("web","file_view",Object.toJSON(b));return window.open(c.href,"_blank")}}},open_file:function(b,a){if(!b.dir&&Browse.can_open_with&&b.get_extension() in Browse.app_prefs){return window.open(Util.open_with_url(Browse.app_prefs[b.get_extension()],[b]),"_blank")}else{return this.dropbox_open_file(b,a)}},open_preview:function(a){var b,c=this;b=function(){var e,d,g,f;e=c.find_file(a);g=e.preview_type==="video"&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX;d=c.previews_enabled||((f=e.preview_type)==="photo"||f==="video");if(!g&&d){BrowseUtil.filepreview_from_selected("fileclick",e)}return document.stopObserving(c.UPDATE_EVT,b)};return document.observe(this.UPDATE_EVT,b)},_click:function(c,d){var b,a;this.keyboard_nav=false;b=BrowseFile.from_elem(d);if(b.editing){return}a=(c.which===2)||(Util.is_mac()&&c.metaKey);Browse.open_file(b,a);c.preventDefault()},crumb_click:function(d,a){var c,b;this.keyboard_nav=false;d.preventDefault();b=a.readAttribute("data-fq_path");c=this.details_from_fq_path(b);return BrowseURL.set_path_url(c.ns_id,c.ns_path)},parent_click:function(d,c){var a,b;this.keyboard_nav=false;d.preventDefault();b=c.readAttribute("data-parent_ns_path");a=parseInt(c.readAttribute("data-parent_ns_id"),10);return BrowseURL.set_path_url(a,b)},selection_handler:function(){if(BrowseSelection.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(BrowseUtil.load_visible_thumbs.bind(BrowseUtil),this.POST_SCROLL_WAIT)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var b,a;this.last_sort=[Sort.FILES_BY_NAME,true];a="#browse-sort a.sortable-column-header";b=$$(a)[0];Util.add_sort_arrow_mouseover(b,true,a,false);$("kind-sorter-label").__date(FlexColumn.DISPLAY.FILES_BY_KIND);return Sprite.src(b.down("img"),"web","sort-uptick-off")},sort_handler:function(h,i,d){var f,a,g,b,j,c;i=$(i);i.blur();f=i.readAttribute("data-sort");if(!(d!=null)){d=this.last_sort[0]===Sort[f]?i.readAttribute("data-ascending")==="false":true}if(FlexColumn.LABELS.indexOf(f)!==-1){j=FlexColumn.SORT_FUNCTIONS.indexOf(this.last_sort[0])!==-1;if(j){g=(FlexColumn.LABELS.indexOf(f)+1)%FlexColumn.LABELS.length;f=FlexColumn.LABELS[g];a=FlexColumn.DISPLAY[f];$("kind-sorter-label").__date(a)}i.writeAttribute("data-sort",f);d=FlexColumn.IS_ASC[f]}else{i.writeAttribute("data-ascending",(d?"true":"false"))}c="#browse-sort a.sortable-column-header";Util.add_sort_arrow_mouseover(i,d,c,true);b=Sort[f];this.sort(b,d);if(h){return h.stop()}},toggle_deleted:function(){var a;a=!BrowseURL.get_del();return BrowseURL.set_del_url(a)},new_folder:function(){var f,r,h,b,g,o,k,d,j,n,c,p,l,i,a,q,e,m=this;if(this.reloading||this.creating_folder){return}this.hide_empty();this.selectable();r=_("New folder");g=[];e=this.files;for(a=0,q=e.length;a<q;a++){o=e[a];if(o.dir&&o.filename.indexOf(r)!==-1){g.push(o.filename)}}d=r;f=1;while(true){if(g.indexOf(d)===-1){break}d=r+" ("+f+")";f++}i=HTML.tmpl("new_folder_tmpl",{name:d});k=-1;if(this.files.length){l=Util.scroll_offsets();if(l.top>0){p=this.files[0].get_div().getLayout().get("margin-box-height");k=Math.floor(l.top/p)}}if(k>0){this.files[k].get_div().__sert({after:i})}else{$("browse-files").__sert({top:i})}j=$$("#browse-files .browse-new-folder .name").first();assert(j!=null,"expected new_folder_name to be defined");h=this.containing_fq_path();c=function(u){var t,s,v;v=u.responseText.evalJSON(true);assert(v.new_browse_files.length===1,"No new file data returned.");t=Util.filename(v.new_browse_files.first().fq_path);s=_("Created folder '%(folder_name)s'");s=s.format({folder_name:t.snippet()});Notify.server_success(s);m.select_fq_paths=[v.new_browse_files.first().fq_path];return m.force_reload()};n=function(t){var s;s=$$("#browse-files li.browse-new-folder").first();if(s){s.remove()}return m.creating_folder=false};b=new Ajax.InPlaceEditor(j,"/cmd/new"+(Util.urlquote(h)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:n,savingText:_("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:c},callback:function(s,t){m.creating_folder=true;return{to_path:t||"",folder:"yes"}}});return b.enterEditMode()},open_folder:function(c){var b,a,d,e=this;assert(c.dir,"Only open directories, not files");if(!(BrowseSelection.get_selected_files().length===1&&BrowseSelection.get_selected_files().indexOf(c)===0)){BrowseSelection.deselect_all();c.get_div().addClassName("file-select")}clearTimeout(this.folder_loading_notification);b=function(){var f;f=_("Loading %(filename)s...");f=f.format({filename:c.filename.em_snippet(50)});return Notify.server_success(f,60,true)};this.folder_loading_notification=setTimeout(b,1000);if(c.target_ns){a=c.target_ns;d=""}else{a=c.ns_id;d=c.ns_path}if(c.is_deleted){return BrowseURL.set_path_url(a,d,true)}else{return BrowseURL.set_path_url(a,d)}},open_folder_in_new_window:function(a){return window.open(BrowseURL._make_url(a.ns_id,a.ns_path),"_blank")},show_message:function(c){var b,a;if((typeof c)!==(typeof"string")){a=$("browse-files").down(".browse-message");if(a){a.show()}return}this.msg=c;b=new Element("div",{"class":"browse-message"});b.__date(c);return $("browse-files").__sert(b)},sort:function(a,d,c){var b;if(!c&&a===this.last_sort[0]&&d===this.last_sort[1]){return}this.last_sort=[a,d];b=a(d);this.files.sort(b);this.smartfill();return BrowseUtil.load_visible_thumbs()},resort:function(){var c,a,b;a=this.last_sort;b=a[0];c=a[1];return this.sort(b,c,true)},in_search_mode:function(){return $("browse").hasClassName("search")},flex_column:function(){return $("kind-sorter").readAttribute("data-sort")},smartfill:function(){var b,e,c,f,d,h,a,g;b=$("browse-files");d=[];f=this.in_search_mode();c=this.flex_column();g=this.files;for(h=0,a=g.length;h<a;h++){e=g[h];d.push(this.compiled_tmpl({file:e,in_search_mode:f,flex_column:c}))}b.__date(d);return document.fire(this.RENDER_EVT)},add_file:function(a){this.files.push(a);if(a.target_ns){Browse.ns_id_to_mount_point[a.target_ns]=a.fq_path}if(a.bytes<0){return this.deleted_shown=true}},insert_file:function(c,b){var a;if(!c){return}b=b||0;a=this.find_file(c.fq_path);if(a&&a!==c){this.remove_file(a);BrowseFile._file_index[c.to_key()]=c}this.update_file_pos(c);if(b){c.get_div().setStyle({display:"none"})}return document.fire(this.RENDER_EVT)},add_files:function(a){return Browse._push_files(a.file_info)},get_file_pos:function(a){var b;b=this.files.indexOf(a);assert(b!==-1,"file not present in @files");assert(a.to_key() in BrowseFile._file_index,"file not present in BrowseFile._file_index");return b},remove_file:function(a){var b;if(!a){return}b=this.files.indexOf(a);if(b!==-1){this.files.splice(b,1);delete BrowseFile._file_index[a.to_key()];return a.get_div().remove()}},update_file_pos:function(f){var a,i,d,e,g,c,b,h;h=this.files.indexOf(f);if(h!==-1){this.files.splice(h,1)}delete f.sort_rank;c=this.last_sort[0];g=this.last_sort[1];e=Util.bsearch(this.files,f,c(g),true);this.files.splice(e,0,f);d=f.get_div();a=$("browse-files");if(d){d.remove()}b=this.compiled_tmpl({file:f,in_search_mode:this.in_search_mode(),flex_column:this.flex_column()});i=a.childElements();if(e<i.length){return a.childElements()[e].__sert({before:b})}else{return a.__sert(b)}},find_file:function(a){return this.files.find(function(b){return b.fq_path.toLowerCase()===a.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];BrowseFile._file_index={};return BrowseDrag._body_dragend()},clear:function(){$("browse-files").__date();return this.hide_empty()},show_empty:function(){$("browse-empty").show();return $(document.documentElement).removeClassName("earthrise")},hide_empty:function(){$("browse-empty").hide();return $(document.documentElement).addClassName("earthrise")},update:function(a){$("browse-box").show();$("browse-files").__date();if(typeof a==="string"){this.setup(Util.from_json(a))}else{this.setup(a)}this.resort();return document.fire(this.UPDATE_EVT)},reload_fqpath:function(b,a){return this.reload(null,Util.urlquote(b),a)},force_reload:function(){return this.reload(this.containing_ns_id(),Util.urlquote(this.containing_ns_path()),true)},set_title:function(){var a;a=this.containing_fq_path();return document.title=a?Util.filename(a)+" - Dropbox":_("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(i){var c,b,g,f,a,d,e,h;a=i.select_fq_paths;d=i.select_index;if(a||d>-1){b=[];if(a){for(e=0,h=a.length;e<h;e++){g=a[e];f=this.find_file(g);if(f){b.push(f)}}}if(!b.length&&d>-1){c=this.files[d];if(c){b.push(c)}}if(b.length){BrowseSelection.set_selected_files(b);this.scrollToWithPadding(b.first().get_div(),100)}i.select_fq_paths=false;return i.select_index=-1}else{return window.scrollTo(0,0)}},reload:function(d,n,b){var q,f,k,e,i,o,p,c,j,g,m,a,h=this;c="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+n+")";assert(n.search(DBHistory.URL_ESCAPE_REGEX)===-1,c);if(d==null){d=Constants.root_ns}n=Util.normalize(n);if(BrowseUtil.get_mode()!==BrowseUtil.BROWSE_MODE){this.clear();BrowseUtil.set_browse_mode()}if(FileSearch._clear_on_reload){FileSearch.clear_searchbox()}if(!FileQueue.uploading){InlineUploadStatus.hide()}if(this.reloading){return}if(this.inside_dir&&n===this.containing_ns_path()&&d===this.containing_ns_id()&&!b){return}m=this.first_load?Constants.referrer:"";o=this.deleted_shown?"?show_deleted=yes":"";g={ns_id:d,referrer:m};g=Object.extend(g,this.extra_reload_args);T("Browse.reload:",n);this.reloading=true;a="/browse"+n+o;q=2;f=["browse",d,n,o,Constants.uid,q];j=function(r){h.reset_state();h.update(r);(h.files.length?h.hide_empty.bind(h):h.show_empty.bind(h))();clearTimeout(h.folder_loading_notification);if(Notify.cancel_on_reload){Notify.clear_all();Notify.cancel_on_reload=false}Util.force_delete_cached_scroll_offsets();h.set_selection_from_fq_paths_or_index(Browse);h.set_title();if(Tutorial.should_handle_event(Tutorial.events.browse_reload)){return Tutorial.handle_event(Tutorial.events.browse_reload)}};k=false;if(this.use_local_cache){e=DBLocalStorage.getItem(f);try{p=Util.from_json(e)}catch(l){p={}}g.contents_cache_key=p.contents_cache_key;if(e){i=function(){try{j(p);h.reloading=false;return k=true}catch(r){return DBLocalStorage.removeItem(f)}};i.defer()}}new Ajax.DBRequest(a,{allow_retries:true,parameters:g,log_timing:true,on304:function(r){},onSuccess:function(v){var y,s,x,t,u,w,r;if(h.in_search_mode()){return}p=Util.from_json(v.responseText);t=null;x=null;if(h.use_local_cache){u=function(){return DBLocalStorage.setItem(f,v.responseText)};u.defer();if(e&&k){if(!(h.containing_fq_path()===p.containing_fq_path)){return}t=BrowseSelection.get_selected_files();x=Util.scroll_offsets()}}j(p);if(t){s=[];for(w=0,r=t.length;w<r;w++){y=t[w];s.push(Browse.find_file(y.fq_path))}BrowseSelection.set_selected_files(s);return window.scrollTo(x[0],x[1])}},onFailure:function(){if(h.first_load){h.reload.bind(h).defer(Constants.root_ns,"")}return clearTimeout(h.folder_loading_notification)},cleanUp:function(){h.first_load=false;return h.reloading=false},no_feed_reload:true,evalJSON:false});return true},unload:function(){var a;this.reset_state();a=$("dropdown");if(a){return Util.yank(a)}},is_shmodelable_path:function(a){var b;if(Browse.public_app_token){return false}if(Browse.public_folder_enabled){b=a.toLowerCase();if(b.startsWith("/public/")){return false}}return true},can_get_details_from_fq_path:function(c){var b,a;b=this.containing_fq_path();a=this.containing_mount_point();return(a&&c.startsWith(a))||b.startsWith(c)},details_from_fq_path:function(d){var e,b,a,c;assert(this.can_get_details_from_fq_path(d));b=this.containing_mount_point();if(b&&d.startsWith(b)){a=this.containing_ns_id();c=d.slice(b.length);e=Util.filename(d)}else{a=Constants.root_ns;c=d;e=Util.filename(d)}return{ns_id:a,ns_path:c,fq_path:d,folder_name:e||"Dropbox",url:"/home"+d,icon:(d.length?"folder_32":"dropbox_32")}},_make_breadcrumbs_data:function(){var f,g,b,e,a,d,c;g=this.containing_fq_path();f=[];a=g.split("/");for(b=d=0,c=a.length;0<=c?d<c:d>c;b=0<=c?++d:--d){e=Util.normalize(a.slice(0,b+1).join("/"));f.push(this.details_from_fq_path(e))}return f},_MAX_BREADCRUMB_WIDTH:16.5,_CONNECT_WIDTH:1.64,breadcrumb:function(){var k,b,d,l,g,j,a,h,c,e,f;b=this._make_breadcrumbs_data();c=b.collect(function(i){return new Emstring(i.fq_path?i.folder_name:"").length});h=0;d=0;assert(b.length>0,"expected at least one breadcrumb");for(g=e=f=b.length-1;f<=0?e<=0:e>=0;g=f<=0?++e:--e){h+=c[g];if(h>this._MAX_BREADCRUMB_WIDTH){break}d+=1;h+=this._CONNECT_WIDTH}l=b.slice(0,b.length-Math.max(1,d));b=b.slice(l.length,b.length);if(!l.length&&b.length>1){b.shift()}j=b.pop();k=HTML.tmpl("breadcrumb_tmpl",{breadcrumbs:b,dropdown:l,containing_fq_path:this.containing_fq_path()});a=j.folder_name.em_snippet(this._MAX_BREADCRUMB_WIDTH);$("browse-location").__date(k);$("browse-location").__sert(" "+a);if(l.length>1){return this._render_breadcrumbs_dropdown(l)}},_render_breadcrumbs_dropdown:function(f){var a,c,b,e,d=this;a=$("breadcrumbs-box");f.reverse();b=HTML.tmpl("breadcrumb_li_tmpl",{breadcrumbs:f});$("browse-location").__sert(b);c=$("breadcrumb-dropdown");e=function(h){var g;h.stopPropagation();c.show();g=$j(a);return $j(c).clonePosition(g,{setWidth:0,setHeight:0,offsetTop:g[0].offsetHeight,offsetLeft:parseInt(g.css("padding-left"),10)})};a.observe("click",e);a.observe("dragover",e);return document.observe("click",function(){a.removeClassName("down");return c.hide()})},viewportOffset:function(){var a,c,b;if(!this.files.length){return}if(!this.div_parent){c=this.files[0].get_div().offsetParent;if(!c){return}this._viewportOffset={};this.div_parent=$(c);this._cumulativeOffset=this.div_parent.cumulativeOffset()}a=Util.scrollLeft(this.div_parent);b=Util.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==b||this.scrollLeft!==a){this._viewportOffset.top=this._cumulativeOffset.top-b;this._viewportOffset.left=this._cumulativeOffset.left-a;this.scrollLeft=a;this.scrollTop=b}return this._viewportOffset},selectable:function(){return Util.enableSelection($("browse-files"))},unselectable:function(){return Util.disableSelection($("browse-files"))},_header_offset:(function(){var a;a=$("browse-header");return a.getHeight()+a.cumulativeOffset().top}).cached(1000),scrollTo:function(a){return this.scrollToWithPadding(a,3)},scrollToWithPadding:function(d,f){var c,g,b,e,a;if(!d){return}e=Util.viewport_dimensions();a=Util.scroll_offsets();g=d.cumulativeOffset().top-a.top;c=d.getHeight();b=this._header_offset();if(g<b){Util.scroll_to(0,a.top+g-b-f)}else{if(g+c>e.height){Util.scroll_to(0,a.top+g+c-e.height+f)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return Modal.fix_position()}}};BrowseUpdate=(function(){var a,h,g,d,f,e,c,b;c=function(j){var k,l,i;if(!Browse.inside_dir){return}l=j.parent_changes;if(l.change_to_fq_path!=null){if(l.change_type==="moved"){if(l.is_changing_view){k=_("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");k=k.format(l.old_fq_path.escapeHTML(),Util.urlquote(l.new_fq_path))}else{k=_("This folder has been moved")}}else{if(l.change_type==="renamed"){if(l.is_changing_view){k=_("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");k=k.format(l.old_fq_path.escapeHTML(),Util.urlquote(l.new_fq_path))}else{k=_("This folder has been renamed to '%s'.");i=l.change_to_fq_path.split("/");k=k.format(i[i.length-1].escapeHTML())}}else{k=_("The folder '%s' has been deleted.");k=k.format(l.old_fq_path.escapeHTML())}}if(l.is_changing_view){Notify.server_error(new HTML(k))}else{if(l.old_fq_path===Browse.containing_fq_path()){Notify.server_success(new HTML(k))}}Browse.reload_fqpath(l.change_to_fq_path);return}return e(j)};b=function(n){var j,q,p,i,s,o,l,r,m,k;q=[];o=[];if(!Browse.in_search_mode()){return}FileSearch.clear_cache();for(i in Browse.ns_id_to_mount_point){if(!(i in n.mount_points)){n.mount_points[i]=null}}m=n.mount_points;for(i in m){p=m[i];i=parseInt(i,10);s=Browse.ns_id_to_mount_point[i];if(p===s){continue}if(p){Browse.ns_id_to_mount_point[i]=p}else{delete Browse.ns_id_to_mount_point[i]}k=Browse.files;for(l=0,r=k.length;l<r;l++){j=k[l];if(j.fq_path.indexOf(s)===0&&j.target_ns!==i){if(p){j.fq_path=p+j.fq_path.slice(s.length);j.href="/home"+p+j.href.slice(5+s.length);q.push([j,j])}else{o.push(j)}}}}return e(n,[],o,q)};e=function(B,q,w,p){var o,x,t,v,u,z,r,l,j,i,y,C,A,s,n,m,k;if(q==null){q=[]}if(w==null){w=[]}if(p==null){p=[]}s=B.added;for(l=0,y=s.length;l<y;l++){x=s[l];o=Util.normalize(Util.parentDir(x.ns_path));if(Browse.in_search_mode()||(x.ns_id===Browse.containing_ns_id()&&o===Browse.containing_ns_path())){q.push(BrowseUtil.make_browsefile(x))}}n=B.removed;for(j=0,C=n.length;j<C;j++){t=n[j];w.push(Browse.find_file(t))}m=B.moved;for(i=0,A=m.length;i<A;i++){k=m[i],v=k[0],r=k[1];z=Util.normalize(Util.parentDir(r.ns_path));u=null;if(Browse.in_search_mode()||(r.ns_id===Browse.containing_ns_id()&&z===Browse.containing_ns_path())){u=BrowseUtil.make_browsefile(r)}p.push([Browse.find_file(v),u])}document.fire(UpdateEvents.ADD,{files:q});document.fire(UpdateEvents.MOVE,{files:p});BrowseUtil.load_visible_thumbs();if(Tutorial.should_handle_event(Tutorial.events.browse_folder_update_start)){Tutorial.handle_event(Tutorial.events.browse_folder_update_start,{added:q,moved:p,removed:w})}return f(q,w,p)};a=function(l,j,k,i){l.css("background","");document.fire(UpdateEvents.REMOVE,{files:k});if(Tutorial.should_handle_event(Tutorial.events.browse_folder_update_done)){return Tutorial.handle_event(Tutorial.events.browse_folder_update_done,{added:j,moved:i,removed:k})}};f=function(s,r,t){var k,v,p,w,o,n,l,u,j,i,q,m;p=!IE7_OR_LESS&&(s.length+r.length)<=10;for(o=0,u=s.length;o<u;o++){k=s[o];if(!(k&&k.get_div())){continue}h(k,p,s,r,t)}for(n=0,j=r.length;n<j;n++){k=r[n];if(!(k&&k.get_div())){continue}d(k,p,s,r,t)}m=[];for(l=0,i=t.length;l<i;l++){q=t[l],v=q[0],w=q[1];if(v){d(v,p,s,r,t)}if(w){m.push(h(w,p,s,r,t))}else{m.push(void 0)}}return m};g=function(i){var j;j=BrowseSelection.is_selected(i)?"#83B8DC":"#CCEAFF";return $j(i.get_div()).css("background-color",j)};d=function(i,l,k,m,j){var n;g(i);n=$j(i.get_div());if(l){return n.show().slideUp("normal",function(){return a(n,k,m,j)})}else{n.hide();return a(n,k,m,j)}};h=function(i,l,k,m,j){var n;g(i);n=$j(i.get_div());if(l){return n.hide().slideDown("normal",function(){return a(n,k,m,j)})}else{n.show();return a(n,k,m,j)}};return{init:function(){var i;return i=Notclient.subscribe_sfj({name:"BrowseUpdater",handler:function(){var q,m,o,l,j,n,k,p=this;l=Browse.in_search_mode();q=l?b:c;k=l?"/update/list_search":"/update/list_dir";if(!(Browse.inside_dir||l)){Notclient.handler_failure(i)}if(l){n=FileSearch.get_state();if(n.is_advanced){o=n}else{o={all_terms:n.query}}}else{o={fq_dir:Browse.containing_fq_path(),show_deleted:Browse.deleted_shown}}o.ns_map=((function(){var s,r;s=Notclient.get_ns_map();r=[];for(m in s){j=s[m];r.push(""+m+"_"+j)}return r})()).join(",");return new $j.ajax(k,{data:o,dataType:"json",type:"POST",success:function(r){q(r);return Notclient.handler_success(i,{ns_map:r.ns_map})},error:function(){return Notclient.handler_failure(i)}})}})}}})();var FileEvents;FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove"};var FileOps,_this=this;FileOps={OPEN_WITH_ITEM_SELECTED:"#open-with-app-list .selected",NOTIFICATION_SNIPPET_LEN:40,open_with_select:function(a){$$(FileOps.OPEN_WITH_ITEM_SELECTED).invoke("removeClassName","selected");this.addClassName("selected");return $("open-button").addClassName("freshbutton-blue")},_find_app_by_id:function(b){var e,d,a,c;c=Modal.vars.apps;for(d=0,a=c.length;d<a;d++){e=c[d];if(e.app_id!==b){continue}return e}return null},close_open_with:function(a){return function(h,f){var g,b,i,c,e,d;$("open-button").removeClassName("freshbutton-blue");if(!h){return Modal.hide(f)}e=$$(FileOps.OPEN_WITH_ITEM_SELECTED);if(e.length!==1){return false}e=e[0];b=parseInt(e.readAttribute("name",10));if(b!==-1){g=FileOps._find_app_by_id(b);if(g==null){return Modal.hide(f)}}else{b=null;g=null}i=Modal.vars.extensions[0];d=$("make-default").checked;if(d){if(g!=null){Browse.app_prefs[i]=g.landing}else{delete Browse.app_prefs[i]}new Ajax.DBRequest("/set_open_with_pref",{parameters:{app_id:b,ext:i},onSuccess:function(j){},onFailure:function(j){}})}if(g!=null){new Ajax.DBRequest("/edit_flow_add_files",{parameters:{app_id:b,fq_paths:Util.to_json((function(){var m,k,l,j;l=Modal.vars.files;j=[];for(m=0,k=l.length;m<k;m++){c=l[m];j.push(c.fq_path)}return j})())},onSuccess:function(j){return a(g,j.responseText)},onFailure:function(j){var k;k=ungettext("Error opening file","Error opening files",Modal.vars.files.length);return Notify.server_error(k)}})}else{assert(Modal.vars.files.length===1,"App should not be null if there are more than one file, Dropbox handler can only handle one");Browse.dropbox_open_file(Modal.vars.files[0],true)}return Modal.hide(f)}},render_open_with_dialog:function(f,c,m,a){var h,b,o,g,p,j,i,n,d,k;try{b=Util.from_json(f).apps}catch(l){b=[]}if(c.length===1){o={app_id:-1,name:"Dropbox",description:"",landing:"",icon_url:"/static/images/favicon.ico"};b.unshift(o)}if(!b.length){g=ungettext("No apps available for this file!","No apps available for these files",c.length);Notify.server_error(g);return}$("open-with-app-list").__date();for(j=0,n=b.length;j<n;j++){h=b[j];$("open-with-app-list").__sert(HTML.tmpl("open_with_app_tmpl",{app:h}))}k=$$(".open-with-app-list-li");for(i=0,d=k.length;i<d;i++){p=k[i];p.observe("click",FileOps.open_with_select)}return Modal.icon_show("page_white_go_32",_("Open With..."),$("open-with"),{apps:b,action:FileOps.close_open_with(a),files:c,extensions:m})},create_album_from_folder:function(b,a){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:b,album_name:a},job:true,dont_hide_progress_on_complete:true,progress_text:_("Creating album..."),onSuccess:function(c){var d;d=JSON.parse(c.responseText);return window.location.href=d.url}})},dir_handler:function(d,c){var b,a;if(typeof c==="string"){c=$(c)}b=$$(".treeview .highlight")[0];if(b){b.removeClassName("highlight")}a=c.up("div");a.addClassName("highlight");Modal.selected_div=a;if(Modal.shown()){c.blur()}document.fire("db:dir_click",{path:d});return Modal.vars.selected_path=d},show_folder_pick:function(h,f,e,g,a){var b,d,c;DomUtil.fillVal(Util.filename(f).escapeHTML(),"folder-pick-file");TreeView.move("copy-move-treeview","folder-pick-treeview");c=(a?"page_white_go_32":"page_white_copy_32");b=(a?_("Move"):_("Copy"));DomUtil.fillVal(b,"folder-pick-action-text");Modal.icon_show(c,h,$("folder-pick"),{fq_path:f,action:e,folder:g});d=$("first-treeview-link");return d.onclick()},show_bulk_folder_pick:function(h,e,a,f){var b,i,c,g,d;d=BrowseUtil.profile_files(a);i=BrowseUtil.profile_summary(d);DomUtil.fillVal(i,"bulk-folder-pick-file");TreeView.move("copy-move-treeview","bulk-folder-pick-treeview");g=(e==="move"?"page_white_go_32":"page_white_copy_32");if(e==="move"){b=_("Move")}else{if(e==="copy"){b=_("Copy")}else{b=_("Restore")}}DomUtil.fillVal(b,"bulk-folder-pick-action-text");Modal.icon_show(g,h,$("bulk-folder-pick"),{files:a,action:f});c=$("first-treeview-link");return c.onclick()},show_copy:function(a,b){var c;c=(b?_("Copy folder to..."):_("Copy file to..."));return FileOps.show_folder_pick(c,a,FileOps.do_copy,b,false)},show_copy_bulk:function(a){var b;b=ungettext("Copy %(item_count)s item to...","Copy %(item_count)s items to...",a.length).format({item_count:a.length});return FileOps.show_bulk_folder_pick(b,"copy",a,FileOps.do_bulk_copy)},show_move_bulk:function(a){var b;b=ungettext("Move %(item_count)s item to...","Move %(item_count)s items to...",a.length).format({item_count:a.length});return FileOps.show_bulk_folder_pick(b,"move",a,FileOps.do_bulk_move)},show_move:function(a,b){var c;c=(b?_("Move folder to..."):_("Move file to..."));return FileOps.show_folder_pick(c,a,FileOps.do_move,b,true)},show_delete:function(b,c,a){var d,e;DomUtil.fillVal("'"+Util.filename(b).escapeHTML()+"'","delete_filename");d=void 0;if(a){d=function(){return FileOps.do_nonbrowse_delete([b])}}else{d=FileOps.do_delete}e=(c?_("Delete folder?"):_("Delete file?"));return Modal.icon_show("delete_32",e,DomUtil.fromElm("delete-file"),{fq_path:b,action:d,folder:c,wit_group:"delete-confirm"})},show_bulk_delete:function(b){var c,a;c=ungettext("%(item_count)s item","%(item_count)s items",b.length).format({item_count:b.length});DomUtil.fillVal(c,"delete_filename");a=ungettext("Delete %(item_count)s item?","Delete %(item_count)s items?",b.length).format({item_count:b.length});return Modal.icon_show("delete_32",a,DomUtil.fromElm("delete-file"),{files:b,action:FileOps.do_bulk_delete,wit_group:"delete-bulk-confirm"})},show_purge:function(a,b){var c;DomUtil.fillVal("'"+Util.filename(a).escapeHTML()+"'","purge-filename");c=(b?_("Permanently delete folder?"):_("Permanently delete file?"));return Modal.icon_show("alert_32",c,DomUtil.fromElm("purge-file"),{fq_path:a,action:FileOps.do_purge,folder:b,wit_group:"purge-file-confirm"})},show_bulk_purge:function(b){var c,a;c=ungettext("%(item_count)s item","%(item_count)s items",b.length).format({item_count:b.length});DomUtil.fillVal(c,"purge-filename");a=ungettext("Permanently delete %d item?","Permanently delete %d items?",b.length).format(b.length);return Modal.icon_show("alert_32",a,DomUtil.fromElm("purge-file"),{files:b,action:FileOps.do_bulk_purge,wit_group:"purge-bulk-confirm"})},show_bulk_restore:function(b){var c,a;c=ungettext("%(item_count)s item","%(item_count)s items",b.length).format({item_count:b.length});DomUtil.fillVal(c,"restore-filename");a=ungettext("Restore %d item...","Restore %d items...",b.length).format(b.length);return Modal.icon_show("alert_32",a,DomUtil.fromElm("restore-file"),{files:b,action:FileOps.do_bulk_restore,wit_group:"restore-bulk-confirm"})},show_upload:function(b,f){var h,c,g,e,a,d;h=Util.filename(b);if(OverQuotaUploads.disabled){DomUtil.fillVal("'"+h.escapeHTML()+"'","disabled-upload-foldername");g=_("Upload to '%(folder_name)s'").format({folder_name:h.em_snippet(20)});Modal.icon_show("upload_32",g,$("disabled-upload-modal"),{},false);OverQuotaUploads.log_show_bar();return}b=b||Browse.containing_fq_path();if(!FlashDetect.versionAtLeast(9)){FileOps.show_basic_upload(b);$("enhanced-upload-toggle").hide();return}DomUtil.fillVal("'"+h.escapeHTML()+"'","upload-foldername");DomUtil.fillVal("'"+h.em_snippet(14).escapeHTML()+"'","dnd-upload-foldername");if($("upload-desc").visible()&&CrossDomainUploader.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}g=_("Upload to '%(folder_name)s'").format({folder_name:h.em_snippet(20)});Modal.icon_show("upload_32",g,DomUtil.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,FileQueue.num_files()&&!f);d=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(e=0,a=d.length;e<a;e++){c=d[e];c.observe("click",function(){FileOps.show_basic_upload(Browse.containing_fq_path());return false})}if(!FileQueue.num_files()||f){Upload.init(Util.normalize(b),true)}else{Upload.set_dest(Util.normalize(b))}return InlineUploadStatus.hide()},show_basic_upload:function(a){var c,b;c=Util.filename(a);DomUtil.fillVal("'"+c.escapeHTML()+"'","basic-upload-foldername");b=_("Upload to '%(folder_name)s'").format({folder_name:c.em_snippet(20)});Modal.icon_show("upload_32",b,$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){FileOps.show_upload(Browse.containing_fq_path(),1);return false});Upload.set_dest(Util.normalize(a));return Upload.init_basic()},show_undelete:function(a){var b,c,d;DomUtil.fillVal(a.filename.escapeHTML(),"undelete_filename");b=Sprite.make("web",a.icon,{});b.addClassName("link-img");b.style.backgroundColor="transparent";c="/revisions"+Util.urlquote(a.fq_path)+"?undelete=1";$$(".undelete-icon").invoke("update",b);$$(".undelete-other-versions")[0].href=c;$$(".undelete-link")[0].href=c;$("undelete-form").action="/revisions"+Util.urlquote(a.fq_path);d=_("Restore file?");return Modal.icon_show("alert_32",d,$("undelete-modal"),{file:a})},show_open_with:function(b,a){var c,g,i,k,d,h,f,e,j;i={};h=false;for(e=0,j=b.length;e<j;e++){d=b[e];if(d.dir){c="/";h=true}else{c=d.get_extension()}i[c]=(i[c]||0)+1}k=[];f=[];for(c in i){k.push(c);f.push(_(c))}g='"'+f.join('", "')+'"';DomUtil.fillVal(g,"open_with_ext");if(k.length!==1||h){$("open-with-prefs").setStyle("display: none")}else{$("open-with-prefs").setStyle("display: inline");$("make-default").checked=false}return new Ajax.DBRequest("/openwithlist",{parameters:{extensions:Util.to_json(k)},onSuccess:function(l){return FileOps.render_open_with_dialog(l.responseText,b,k,a)}})},do_undelete:function(f){var c,b,d,a;b=Modal.vars.file;d=$("undelete-form");a=_("Restored '%(file_name)s'").format({file_name:b.filename});c=_("Error, unable to restore '%(file_name)s'").format({file_name:b.filename});Forms.ajax_submit(d,false,(function(){Modal.hide();Notify.server_success(a);return document.fire(FileEvents.RESTORE,{files:[b]})}),(function(){return Notify.server_error(c)}),f.target);return false},do_copy:function(c,b){var a;c=c||Modal.vars.fq_path;b=b||Modal.vars.selected_path;a=Browse.find_file(c);assert(a,"Trying to copy a file we couldn't find.");return FileOps.do_bulk_copy([a],b)},do_bulk_copy:function(f,b){var d,e,c,g,a;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();f=f||Modal.vars.files;assert(f.length>0,"Tried to copy 0 files");if(typeof b==="undefined"){if(typeof Modal.vars.selected_path==="undefined"){Notify.server_error(_("You need to select a destination for the file."));return}else{b=Modal.vars.selected_path}}b=Util.normalize(b);c=0;for(g=0,a=f.length;g<a;g++){d=f[g];if(d.dir){if((b+"/").indexOf(d.fq_path+"/")===0){Notify.server_error(_("You cannot copy a folder into itself."));return}}}e=f.pluck("fq_path");Notify.clear_all();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:e,to_path:b},job:true,html_in_error_msg:true,progress_text:_("Copying..."),onSuccess:function(o){var k,n,h,p,j,l,i,m;k=o.responseText.evalJSON().changesets;n=e.length;p=Util.filename(b).em_snippet(FileOps.NOTIFICATION_SNIPPET_LEN).escapeHTML();j=ungettext("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",n);j=j.format({count:n,location:p});Notify.server_success(new HTML(j),null,null,k,FileOps.do_rollback);h=[];m=o.responseText.evalJSON().new_browse_files;for(l=0,i=m.length;l<i;l++){d=m[l];h.push(d.fq_path)}Browse.select_fq_paths=h;$("reload-link").observe("click",function(){return Browse.reload_fqpath(b)});TreeView.schedule_reset();return document.fire(FileEvents.COPY,{files:f,to_fq_path:b})}})},bulk_move_error:function(a,i){var g,d,j,e,k,f,b,c,h;j=Browse.find_file(i);e=BrowseUtil.profile_files(a);c=void 0;f=void 0;h=void 0;if(j){f=j.dir;c=j.fq_path;h=j.target_ns||j.ns_id}else{if(Browse.inside_dir&&Browse.can_get_details_from_fq_path(i)){d=Browse.details_from_fq_path(i);f=true;c=d.fq_path;h=d.ns_id}else{f=true;c=i;h=void 0}}k=a.pluck("fq_path").collect(Util.normalize);if(-1!==k.indexOf(Util.normalize(c))){return _("You cannot copy a folder into itself.")}g=b=function(l){var m;m=Util.parentDir(l.fq_path);return m===(c||"/")};if(a.all(g)){return ungettext("That file already exists in that folder.","Those files already exist in that folder.",a.length)}if(!f){return _("You cannot put files inside one another.")}if(e.target_namespaces>0&&h&&h!==Constants.root_ns){if(e.sandboxes>0){return _("You're not allowed to put an application folder inside a special folder.")}else{if(e.shared_folders>0){return _("You're not allowed to put a shared folder inside a special folder.")}else{return _("You're not allowed to nest special folders.")}}}if(Browse.public_folder_enabled){if(c==="/Public"&&e.target_namespaces>0){return _("You're not allowed to move shared folders to your Public folder.")}}if(e.public_folder>0){return _("You're not allowed to move your Public folder.")}if(e.deleted>0){return _("Moving deleted folders or files is not allowed.")}},do_move:function(c,b){var a;c=c||Modal.vars.fq_path;b=b||Modal.vars.selected_path;a=Browse.find_file(c);assert(a,"Trying to move a file we couldn't find.");return FileOps.do_bulk_move([a],b)},do_bulk_move:function(e,f){var c,d,a,b;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();e=e||Modal.vars.files;if(!e){return}assert(e.length>0,"Tried to move 0 files");a=f||Modal.vars.selected_path||"";a=Util.normalize(a);c=FileOps.bulk_move_error(e,a);if(c){Notify.server_error(c);return}d=e.pluck("fq_path");Notify.clear_all();b="/cmd/move";return new Ajax.DBRequest(b,{parameters:{files:d,to_path:a},job:true,html_in_error_msg:true,progress_text:_("Moving..."),onSuccess:function(j){var i,h,g,k;i=j.responseText.evalJSON().changesets;h=d.length;g=Util.filename(a).em_snippet(FileOps.NOTIFICATION_SNIPPET_LEN).escapeHTML();k=ungettext("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",h);k=k.format({count:h,location:g});Notify.server_success(new HTML(k),null,null,i,FileOps.do_rollback);$("reload-link").observe("click",function(){return Browse.reload_fqpath(a)});TreeView.schedule_reset();return document.fire(FileEvents.MOVE,{files:e,to_fq_path:a})}})},do_rollback:function(a){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:Util.to_json(a)},job:true,html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(b){var c;c=_("Undo complete.");Notify.server_success(c);assert(Browse.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(Browse.in_search_mode()){FileSearch.select_fq_paths=Browse.pre_action_selection;FileSearch.force_reload()}else{if(Lightbox.shown){Browse.select_fq_paths=Browse.pre_action_selection}else{Browse.select_fq_paths=Browse.pre_action_selection;Browse.force_reload()}}return Browse.pre_action_selection=false}})},do_bulk_delete:function(c){var a,b;Browse.pre_action_selection=BrowseSelection.get_selected_fq_paths();c=c||Modal.vars.files;assert(c.length>0,"Tried to delete 0 files");b=(function(){var f,e,d;d=[];for(f=0,e=c.length;f<e;f++){a=c[f];d.push(a.fq_path)}return d})();Notify.clear_all();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:b},job:true,html_in_error_msg:true,progress_text:_("Deleting..."),onSuccess:function(d){var f,e;e=d.responseText.evalJSON();f=ungettext("Deleted %d item.","Deleted %d items.",b.length).format(b.length);Notify.server_success(f,null,null,e.changesets,FileOps.do_rollback);TreeView.schedule_reset();return document.fire(FileEvents.DELETE,{files:c})}})},do_delete:function(b){var a;a=Browse.find_file(b||Modal.vars.fq_path);assert(a,"Trying to delete a file we couldn't find.");return FileOps.do_bulk_delete([a])},do_nonbrowse_delete:function(a){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:a},html_in_error_msg:true,onSuccess:function(b){var c;c=ungettext("Deleted %(file_count)s item","Deleted %(file_count)s items",a.length);c=c.format({file_count:a.length});Notify.server_success(c);return document.fire(FileEvents.DELETE,{fq_paths:a})}})},do_purge:function(){var a;a=Browse.find_file(Modal.vars.fq_path);assert(a,"Trying to purge a file we couldn't find.");return FileOps.do_bulk_purge([a])},do_bulk_purge:function(b){var a,c;b=b||Modal.vars.files;assert(b.length>0,"Tried to purge 0 files");a=b.collect(function(d){return d.fq_path});c=ungettext("Permanently deleted %d item","Permanently deleted %d items",a.length).format(a.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:a},job:true,html_in_error_msg:true,progress_text:_("Deleting..."),onSuccess:function(d){Notify.server_success(c);TreeView.schedule_reset();return document.fire(FileEvents.PURGE,{files:b})}})},do_bulk_restore:function(b){var a,c;b=b||Modal.vars.files;assert(b.length>0,"Tried to restore 0 files");a=b.collect(function(d){return d.fq_path});c=ungettext("Restored %d item","Restored %d items",a.length).format(a.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:a},job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:function(d){Notify.server_success(c);TreeView.schedule_reset();return document.fire(FileEvents.RESTORE,{files:b})}})},do_folder_restore:function(a){var b;b=function(c){var e,d;e=_("Restoring '%(folder_name)s'").format({folder_name:Util.filename(a)});d=c.responseText;if(d.startsWith("err:")){d=d.substring(4);$j("#async-result").html(d);Notify.server_error(new HTML(d),60)}else{e=_("Restored '%(folder_name)s'").format({folder_name:Util.filename(a)});$j("#status-of-files").text(_("Restored files"));Notify.server_success(e,60)}$j("#restore-done-heading").text(e);$j(".pre-restore").hide();return $j(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[a]},job:true,html_in_error_msg:true,progress_text:_("Restoring..."),onSuccess:b,onFailure:b})},do_bulk_download:function(c){var e,b,d,a;e=new Element("form",{action:"https://"+Constants.BLOCK_CLUSTER+"/zip_batch",method:"post"});for(d=0,a=c.length;d<a;d++){b=c[d];Forms.add_vars(e,{files:b.fq_path})}Forms.add_vars(e,{parent_path:Browse.block_hash_param||"/",w:Browse.block_hash});$(document.body).__sert(e);return e.submit()},do_bulk_photo_view:function(c){var e,b,d,a;e=new Element("form",{action:"https://"+Constants.WEBSERVER+"/photos",method:"post"});Forms.add_vars(e,{t:Constants.TOKEN});for(d=0,a=c.length;d<a;d++){b=c[d];Forms.add_vars(e,{selected_items:b.root_coll_item_counter})}$(document.body).__sert(e);return e.submit()}};var Job,ModalProgress,ProgressBar,ProgressWatcher;ProgressBar={MAGIC:42,make:function(a,b,c){var j,h,i,e,g,d,f;if(b==null){b=300}f=b.toString()+"px";c=(typeof c!=="undefined"?c:"0%");i=new Element("div",{"class":"outer-progress-bar",style:"width: "+f});j=new Element("div",{"class":"inner-progress-bar",id:"pb_"+a,style:"width: "+f});g=new Element("div",{"class":"under-pb progress-bar",style:"width: "+f});e=new Element("div",{style:"display: none","class":"over-pb progress-bar",id:"pb_"+a+"_over"});d=new Element("div",{"class":"pb-percentage",id:"pb_"+a+"_upct",style:"width: "+f});d.update(c);h=new Element("div",{"class":"pb-percentage",id:"pb_"+a+"_opct",style:"width: "+f});h.update(c);g.__sert(d);e.__sert(h);j.__sert(g);j.__sert(e);i.__sert(j);e.progress_width=b;return i},reset:function(a){return ProgressBar.set(a,0)},set:function(e,a,d){var c,b;a=Math.min(a,1);d=(typeof d!=="undefined"&&d!==false?d:Math.floor(a*100).toString()+"%");c=$("pb_"+e+"_over");if(!c){return}b=c.progress_width*a;c.show();c.makeClipping().setStyle({width:b.toString()+"px",backgroundColor:"#348DD3"});$("pb_"+e+"_upct").innerHTML=d;return $("pb_"+e+"_opct").innerHTML=d}};ModalProgress={show:function(c,a){var b;if(!c){return}a=$(a)||$("browse-box")||$("gallery-view-media");b=$("modal-progress-overlay");if(!(a!=null)){b.setStyle({position:"fixed",width:"100%",height:"100%"})}else{$j(b).clonePosition($j(a))}if(!b.getWidth()){return}$("modal-progress-text").__date(c);$("modal-progress-bar").setOpacity(1);$("modal-progress-bar").__date(ProgressBar.make("modal-progress",150,""));$j(b).fadeTo(250,0.7);return $j("#modal-progress-content").fadeIn(250)},update:function(a){var b;if(a.indexOf("/")>0){b=a.split("/");a=Number(b[0])/Number(b[1])}if(a){return ProgressBar.set("modal-progress",a,"")}},hide:function(){$j("#modal-progress-overlay").fadeOut(250);return $j("#modal-progress-content").fadeOut(250)}};Job={complete:{},handled:function(a){var b;if(!a){return false}b=!!Job.complete[a];Job.complete[a]=true;return b},peek:function(a){if(!a){return false}return !!Job.complete[a]}};ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(a,d){var c,b;if(a.async_task_id){if(!a.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}b=a.async_task_id}else{b=a.job_id}ProgressWatcher.job_info[b]={};c=ProgressWatcher.job_info[b];c.req=a;c.is_async_task=!!a.async_task_id;c.poll_int=ProgressWatcher.INIT_POLL_INT;c.poll_count=0;c.int_id=setInterval(ProgressWatcher.update_for(b),c.poll_int);c.failures=0;c.start_time=Util.time();return c.dont_hide=d},update_for:function(a){return function(){return ProgressWatcher.update(a)}},backoff:function(b){var a;a=ProgressWatcher.job_info[b];clearInterval(a.int_id);a.poll_int=Math.min(Math.floor(a.poll_int*1.5),30000);return a.int_id=setInterval(ProgressWatcher.update_for(b),a.poll_int)},update:function(c){var a,b;b=ProgressWatcher.job_info[c];if(Job.peek(c)){return ProgressWatcher.done(c)}b.poll_count++;if(b.poll_count%10===0){ProgressWatcher.backoff(c)}if(!b.modaled&&Util.time()-b.start_time>ProgressWatcher.MODAL_WAIT_MS){a=b.req.options;ModalProgress.show(a.progress_text,a.cover_this);a.onProgress=ModalProgress.update;if(a.on_modal_shown!=null){a.on_modal_shown()}b.modaled=true}if(b.is_async_task){return ProgressWatcher.get_async_task_status(c)}else{return ProgressWatcher.get_job_status(c)}},get_job_status:function(a){return new Ajax.Request("/job_status/"+a,{method:"post",parameters:{t:Constants.TOKEN},onSuccess:function(c){var d,b;d=ProgressWatcher.job_info[a];b=c.responseText;if(b.indexOf("err")===0){ProgressWatcher.done(a);if(d.req.options.onFailure&&!Job.handled(a)){d.req.options.onFailure(c)}return}if(b.indexOf("done")===0){d.req.options.job=false;if(!Job.peek(a)){new Ajax.Request("/job_results/"+a,{method:"post",parameters:{t:Constants.TOKEN},onSuccess:function(f){if(Job.handled(a)){return}Notify.clear_if(RequestWatcher.working_msg);if(d.req.options.onSuccess){return d.req.options.onSuccess(f)}},onFailure:function(f){if(Job.handled(a)){return}Notify.clear_if(RequestWatcher.working_msg);if(d.req.options.onFailure){return d.req.options.onFailure(f)}}})}return ProgressWatcher.done(a)}else{try{if(d.req.options.onProgress){return d.req.options.onProgress(c.responseText)}}catch(e){}}},onFailure:function(b){var c;c=ProgressWatcher.job_info[a];c.failures++;if(c.failures>=ProgressWatcher.FAILS_MEAN_FAIL){if(c.req.options.onFailure){c.req.options.onFailure(b,true)}RequestWatcher.remove(c.req);return ProgressWatcher.done(a)}}})},get_async_task_status:function(a){return new Ajax.Request("/async_task_status/"+a,{method:"post",parameters:{t:Constants.TOKEN},onSuccess:function(c){var d,b;d=ProgressWatcher.job_info[a];b=c.responseText;if(!(b.indexOf("done:")&&b.indexOf("err:"))){Job.handled(a);Notify.clear_if(RequestWatcher.working_msg);if(b.indexOf("done:")===0){c.responseText=b.substr(5)}if(d.req.options.onSuccess){d.req.options.onSuccess(c)}if(d.req.options.onComplete){d.req.options.onComplete(c)}return ProgressWatcher.done(a)}else{try{if(d.req.options.onProgress){return d.req.options.onProgress(c.responseText)}}catch(e){}}},onFailure:function(b){var c;c=ProgressWatcher.job_info[a];c.failures++;if(c.failures>=ProgressWatcher.FAILS_MEAN_FAIL){if(c.req.options.onFailure){c.req.options.onFailure(b,true)}RequestWatcher.remove(c.req);return ProgressWatcher.done(a)}}})},done:function(b){var a;a=ProgressWatcher.job_info[b];clearInterval(a.int_id);if(!a.dont_hide){delete ProgressWatcher.job_info[b];if(!(a.req.async_task_id&&a.req.async_task_id!==b)){return ModalProgress.hide(b)}}else{return ModalProgress.update("1/1")}}};var EventBubble,EventDatePicker,EventsFull,Feed;EventBubble={make:function(b){var a;a='<table class="ebubble">\n  <tr>\n    <td class="tl"></td>\n    <td class="t"></td>\n    <td class="tr"></td>\n  </tr>\n  <tr>\n    <td class="l"></td>\n    <td class="c">\n      <%= content %>\n    </td>\n    <td class="r"></td>\n  </tr>\n  <tr>\n    <td class="bl"></td>\n    <td class="b">\n      <img src="/static/images/events_bubble_tail.gif" alt="" class="events_bubble_tail" />\n    </td>\n    <td class="br"></td>\n  </tr>\n</table>';return HTML.tmpl(a,{content:b})}};Feed={firstTime:true,_displayed_restore:false,_more:false,page_num:0,ns_id:null,_fetching_feed:false,changeDate:function(a,b){Feed.date=a;Feed.nice_date=Util.niceDate(a);if(!b){return Feed.getPage(0)}},getPage:function(a){var b,c,d=this;if(Feed._fetching_feed){return this._more}Feed._fetching_feed=true;a=a||0;if(a===0){this._displayed_restore=false}if(a===0){this._more=true}Feed.page_num=parseInt(a,10);b=a===0?"140px":"20px";$j("#more-loading").css("marginTop",b).show();c=Feed.ns_id!=null?"&ns_id="+(Feed.ns_id.toString()):"";new Ajax.DBRequest("/next_events?cur_page="+a+c,{parameters:{date:Feed.nice_date?Feed.nice_date:"",displayed_restore:this._displayed_restore},log_timing:true,dataType:"json",onSuccess:function(e){var f;f=Util.from_json(e.responseText);if(a===0){$j("#old-event-table").empty()}$j(f.events).appendTo($j("#old-event-table"));d._displayed_restore=f.displayed_restore;d._more=f.more;if(f.rss_url){return d.rss_url=f.rss_url}},onComplete:function(){$j("#more-loading").hide();Feed._fetching_feed=false;EventsFull.load_more_if_needed();return EventsFull.update_rss_button_title()}});return this._more},url_check:function(b,c,a){var d;c=c||0;b=b||null;d=(Feed.ns_id!==b)||(Feed.page_num!==c)||(Feed.nice_date!==a);Feed.ns_id=b||Feed.ns_id;Feed.page_num=parseInt((c!=null?c:Feed.page_num),10);if(a){Feed.changeDate(new Date(a.gsub("-","/")),true)}if(d){ULSelectMenu.set_selected_by_value($("namespace-list"),Feed.ns_id);if(a){EventDatePicker.change_date(Feed.date)}return Feed.getPage(Feed.page_num)}},set_url:function(c){var b,a,d,e;a=(c.ns_id!=null?c.ns_id:Feed.ns_id);d=(c.page_num!=null?c.page_num:Feed.page_num);b=(c.date!=null?c.date:Feed.nice_date);e={n:d,d:b};if(a){e.ns=a}return DBHistory.push_state("/events",e)},get_key:function(a){return""+Feed.ns_id+"_"+Feed.date+"_"+a+"_"+Feed.nice_date},show_rss_modal:function(){var a,b;a=Feed.ns_id||Constants.root_ns;b=Feed.rss_url;Modal.icon_show("feed_32",_("Subscribe to this RSS feed"),$("rss-modal"));$("rss_url").setValue(b);BrowseActions.addCopyUrlFlash(b);$("copy_success").__date();$("reset-rss-link").writeAttribute("href","/reset_rss/"+a);return $("rss_url").select()}};EventDatePicker={show_calendar:function(c){var a,b,d;Event.extend(c).preventDefault();if(EventDatePicker.shown){$("cal_container").hide();EventDatePicker.shown=false;return}if(!EventDatePicker.calendar){d=new Element("div",{id:"cal_container"});d.observe("click",function(f){return f.preventDefault()});$(document.body).__sert(d);EventDatePicker.calendar=new DBCalendar("cal_container",{onDateChange:function(e){return EventDatePicker.change_date(e,0)},disable_future:true,first_day:EventDatePicker.first_event});d.absolutize();b=$j("#cal_date");a=$j("#cal_container");a.clonePosition(b,{setWidth:false,setHeight:false,offsetTop:b.height(),offsetLeft:b.width()-a.children().first()[0].offsetWidth})}$("cal_container").show();$(document.body).observe("click",EventDatePicker.hide_calendar);return EventDatePicker.shown=true},hide_calendar:function(a){if($(a.target).up("#cal_date")){return}Event.stop(a);$("cal_container").hide();$(document.body).stopObserving("click",EventDatePicker.hide_calendar);return EventDatePicker.shown=false},change_date:function(a,b){var c;if(b!=null){Feed.page_num=0}c=$("cur_date_text");c.update(DateUtil.localize(a));return Feed.set_url({date:Util.niceDate(a)})}};EventsFull={_first_event:null,init:function(a){this._first_event=a;if(this._first_event){EventDatePicker.first_event=new Date(this._first_event)}on_script_loaded(function(){EventsFull._listen();return EventsFull._get_more(0)});this.more=true;Event.observe(window,"scroll",this._window_scroll);return this.SCROLL_OFFSET=50},has_more:function(a){return this.more=a},_window_scroll:function(){var c,b,a;if(!EventsFull.more){return}a=Util.scroll_offsets().top;b=Util.viewport_dimensions().height;c=document.body.getHeight();if(a+b+Scroll.SCROLL_OFFSET>=c){return EventsFull._get_more()}},_get_more:function(b){var a;a=b!=null?b:(parseInt(Feed.page_num,10)||0)+1;return this.more=Feed.getPage(a)},load_more_if_needed:function(){if(Util.viewport_dimensions().height>=document.body.getHeight()&&EventsFull.more){return EventsFull._get_more()}},history_change:function(e,f){var b,a,d,c;a=f.ns;c=f.s;d=f.n;b=f.d;return Feed.url_check(a,d,b)},_listen:function(){DBHistory.add_callback("/events",EventsFull.history_change);return $("namespace-list-container").observe("db:change",this._set_feed_url.bind(this))},_set_feed_url:function(a){return Feed.set_url({ns_id:a.memo,page_num:0})},update_rss_button_title:function(){var b,a;b=$j("#namespace-list-container").find("li.selected").text();a=_("Subscribe to %(folder_name)s changes feed").format({folder_name:b});return $j("#rss-feed a").attr("data-title",a)}};var DateUtil;DateUtil={fromSecondsSinceEpochUTC:function(a){var b;b=new Date(1970,0,1);b.setSeconds(a);return b},utcnow:function(){var a;a=new Date();return new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds())},applyTimezoneOffset:function(b,d){var a,c;a=parseInt(d,10);c=60*(d-a);b.setHours(b.getHours()+a);return b.setMinutes(b.getMinutes()+c)},contextualFormat:function(b){var d,f,a,c,e;a=this.utcnow();c=(a.getTime()-b.getTime())/1000;d=0;if(c<8*3600){return this.ago(b)}this.applyTimezoneOffset(a,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(b,Constants.TIMEZONE_OFFSET);e=this.utcnow();this.applyTimezoneOffset(e,Constants.TIMEZONE_OFFSET);e.setDate(e.getDate()-1);if(b.getYear()===a.getYear()&&b.getMonth()===a.getMonth()&&b.getDate()===a.getDate()){f=_("Today %(time)s");return f.format({time:DateUtil.format(b,Constants.time_format)})}else{if(b.getYear()===e.getYear()&&b.getMonth()===e.getMonth()&&b.getDate()===e.getDate()){f=_("Yesterday %(time)s");return f.format({time:DateUtil.format(b,Constants.time_format)})}else{return DateUtil.format(b,Constants.datetime_format)}}},toUTCDate:function(a){return new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds())},differenceStr:function(d,g){var i,h,b,c,e,a,f;e=(d.getTime()-g.getTime())/1000;if(e<60){return ungettext("%d sec","%d secs",e).format(e)}else{if(e<3600){b=parseInt(e/60,10);return ungettext("%d min","%d mins",b).format(b)}else{if(e<86400){h=parseInt(e/3600,10);return ungettext("%d hour","%d hours",h).format(h)}else{if(e<2592000){i=parseInt(e/(60*60*24),10);return ungettext("%d day","%d days",i).format(i)}else{if(e<4838400){a=parseInt(e/(60*60*24*7),10);return ungettext("%d week","%d weeks",a).format(a)}else{if(e<31536000){c=parseInt(e/(60*60*24*30),10);return ungettext("%d month","%d months",c).format(c)}else{f=parseInt(e/(60*60*24*365),10);return ungettext("%d year","%d years",f).format(f)}}}}}}},ago:function(e){var i,h,c,d,f,b,a,g;b=this.utcnow();f=(b.getTime()-e.getTime())/1000;if(f<60){return ungettext("%d sec ago","%d secs ago",f).format(f)}else{if(f<3600){c=parseInt(f/60,10);return ungettext("%d min ago","%d mins ago",c).format(c)}else{if(f<86400){h=parseInt(f/3600,10);return ungettext("%d hour ago","%d hours ago",h).format(h)}else{if(f<2592000){i=parseInt(f/(60*60*24),10);return ungettext("%d day ago","%d days ago",i).format(i)}else{if(f<4838400){a=parseInt(f/(60*60*24*7),10);return ungettext("%d week ago","%d weeks ago",a).format(a)}else{if(f<31536000){d=parseInt(f/(60*60*24*30),10);return ungettext("%d month ago","%d months ago",d).format(d)}else{g=parseInt(f/(60*60*24*365),10);return ungettext("%d year ago","%d years ago",g).format(g)}}}}}}},localize:function(a){assert(Constants.date_format!=null,"Date format missing.");return DateUtil.format(a,Constants.date_format)},format:function(a,b){var c,d=this;assert(typeof b==="string","Date format requires a format string");c={yy:function(){return a.getFullYear().toString().substring(2)},yyyy:function(){return a.getFullYear().toString()},M:function(){return(a.getMonth()+1).toString()},MM:function(){return(a.getMonth()+1).toString().lpad(2)},d:function(){return a.getDate().toString()},dd:function(){return a.getDate().toString().lpad(2)},h:function(){return(a.getHours()%12||12).toString()},H:function(){return a.getHours().toString()},HH:function(){return a.getHours().toString().lpad(2)},m:function(){return a.getMinutes().toString()},mm:function(){return a.getMinutes().toString().lpad(2)},a:function(){if(a.getHours()>11){return _("PM")}else{return _("AM")}}};return b.replace(/([a-zA-Z]+)/g,function(e){if(c[e]!=null){return c[e]()}else{return e}})}};var Timezone;Timezone={check_timezone:function(){var a;if(!Constants.uid){return}a=Timezone.get_current_timezone();if(!(Constants.auto_timezone_offset!=null)||Constants.auto_timezone_offset!==a){return Timezone.update(a)}},get_current_timezone:function(){var d,c,a,b;c=new Date();c.setSeconds(0);c.setMilliseconds(0);b=c.toGMTString();d=new Date(b.substring(0,b.lastIndexOf(" ")));a=(c-d)/(1000*60*60);return a},update:function(a){assert(typeof a==="number","Timezone offset was not a number: "+a);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:a},noAutonotify:true})},on_change:function(){var a,b;a=[];b=[$("timezone_area"),$("timezone_location"),$("timezone_city")];b.each(function(c){if(c){return a.push($F(c))}});return Timezone.update_form(a)},update_form:function(m){var h,a,n,c,e,j,d,l,b,g,f,k;m=m||["America"];assert(Timezone.tree,"Timezone tree missing...");$("tz").__date();a=["timezone_area","timezone_location","timezone_city"];e=Timezone.tree;b=Math.max(m.length+1,2);for(h=g=0;0<=b?g<b:g>b;h=0<=b?++g:--g){d=m[h];n=Object.keys(e);if(!n.length){break}l=new Element("select",{id:a[h],name:a[h]});l.observe("change",Timezone.on_change);for(f=0,k=n.length;f<k;f++){c=n[f];j=new Element("option");j.value=c;j.update(c);if(c===d){j.selected=true}l.appendChild(j)}$("tz").appendChild(l);e=e[d]}return Util.syncHeight()},auto:function(){var a;a=$F("timezone_auto");if(a){return $("tz").__date()}else{return Timezone.update_form()}},build_tree:function(b){var a;a={};b.each(function(e){var d,c;c=e.split("/");d=a;return c.each(function(f){if(!d[f]){d[f]={}}return d=d[f]})});return Timezone.tree=a}};var Apps;Apps={init_create_app:function(){var a;if(!EmailVerification.verified()){EmailVerification.show_verify_modal()}a=$j("#create-app-form");a.find("input[type=radio]").change(function(b){var c;c=b.target.name;$j("input[name="+c+"]").each(function(){$j(this).parents("label").removeClass("active");return a.removeClass($j(this).data("next"))});$j(b.target).parents("label").addClass("active");a.addClass($j(this).data("next"))});a.find("input:checked").trigger("change");return a.submit(function(b){if(EmailVerification.verified()){a=$j(b.target);Forms.ajax_submit(a[0],false,(function(c){return window.location.href=c.responseText}))}return false})},init_apps:function(){return $j("#show-disabled-apps").click(function(){$j(this).parent().hide();$j("#disabled-apps").show();return false})},init_app_info:function(a){this._hoverable_tmpl=HTML.tmpl("hoverable_tmpl");$j("#domain-list").on("click",".img-container",function(b){Apps.remove_domain(b.currentTarget.parentNode,a)});$j("#oauth-uri-list").on("click",".img-container",function(b){Apps.remove_oauth_uri(b.currentTarget.parentNode,a)});return this.init_app_info_add_redirect_uri()},init_app_info_add_redirect_uri:function(){var a,b,c,d;b=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!b){return}d=window.decodeURIComponent(b[1]);a=$j("#oauth-add-uri-form");$j("input[name=oauth_uri]",a).val(d);c=$j("#add-redirect-uri-modal")[0];$j("#add-redirect-uri-modal-uri").text(d);Modal.icon_show("alert_32",_("Add OAuth redirect URI"),c,{doit:function(){var e;if(window.history&&window.history.replaceState){e=window.location.href;e=e.substring(0,e.indexOf("#"));window.history.replaceState({},document.title,e)}else{window.location.hash=""}Modal.hide();return Apps.submit_new_oauth_uri($j("#oauth-add-uri-form")[0])}})},confirm_disable:function(d,c,b){var e,a;e=(b?_("Are you sure you want to disable '%(app_name)s'?"):_("Are you sure you want to delete '%(app_name)s'?"));DomUtil.fillVal(e.format({app_name:d.escapeHTML()}),"app-disable-text");Modal.icon_show("application_delete_32",(b?_("Confirm disable"):_("Confirm delete")),$("app-disable-modal"));a="/developers/disable_app/"+c;$("app-disable-modal").down("form").action=a;return $("disable-app-button").setValue((b?_("Disable"):_("Delete")))},enable_app:function(b){var a;a="/developers/enable_app/"+b;return window.location.href=a},show_uninstall:function(f,d,b,a,c){var g;if(f){Event.stop(f)}Modal.vars={app_id:b,delete_row_type:"inst-app",action:"uninstall_app"};g=$("delete-"+a+"-app-confirm");if(a==="sandbox"){if(!c){return Apps.do_action()}g.select(".app_folder")[0].__date(c)}g.select(".app_name")[0].__date(d);Modal.icon_show("application_delete_32",_("Remove %(app_name)s?").format({app_name:d.em_snippet(22)}),g,Modal.vars);return null},do_uninstall:function(){new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:Modal.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(a){Notify.server_success(a.responseText);$("inst-app-"+Modal.vars.app_id+"-row").hide().removeClassName("active_app");if($$(".active_app").length===0){$("applications-table-container").__date(_("You're not using any Dropbox API apps."));return $("applications-explanation").remove()}}});return Modal.hide()},do_action:function(){return new Ajax.DBRequest("/api/"+Modal.vars.action,{parameters:{app_id:Modal.vars.app_id},onSuccess:function(a){Notify.server_success(a.responseText);if(Modal.vars.delete_row_type){return $(Modal.vars.delete_row_type+"-"+Modal.vars.app_id.toString()+"-row").hide()}else{return window.location.reload()}}})},enable_users_in_dev:function(a,b){new Ajax.DBRequest("/developers/enable_users_in_dev/"+a,{onSuccess:function(c){Modal.icon_show("alert_32",_("Limit raised to %d users").format(b),$("increased-dev-user-limit-modal"));$j("#users-in-dev-none, #users-in-dev-some").hide();return $j("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(a){Modal.icon_show("alert_32",_("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+a,{onSuccess:function(b){$j("#current-app-users-1, #current-app-users-2").text("0");return Modal.hide()}})}});return false},restore_sandbox:function(b,a){var d,c;d=$("restore-sandbox");Modal.icon_show("folder_app_32",_("Restore app folder '%(filename)s'").format({filename:Util.filename(b).em_snippet(17)}),d);c=$("restore-sandbox-form");return Forms.add_vars(c,{ns_id:a})},submit_restore_sandbox:function(b){var a;a=$("restore-sandbox-form");Forms.ajax_submit(a,false,(function(c){Modal.hide();Notify.server_success(_("Restored app folder"));if(c.responseText.length){return Browse.reload_fqpath(c.responseText)}else{return Browse.reload("","",true)}}),false,b.target);return false},developer_support:function(){var a;a=$("dev-support-modal");return Modal.icon_show("alert_32",_("Dropbox developer support"),a)},submit_developer_support:function(b){var a;a=$("dev-support-form");assert(a,"Form is missing in submit_developer_support");return Forms.ajax_submit(a,false,(function(){Modal.hide();return Notify.server_success(_("Thanks for your help request.  We'll get back to you soon."))}),false,b&&b.target)},submit_app_info:function(a){var b;b=$j(a).find("input[name=name]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("App info updated.");if(b){return $j("#app-info h1").text(b)}}))},submit_folder_name:function(a){var b;b=$j(a).find("input[name=folder]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("App folder name updated.");$j("#folder-name .text").text(b);return Apps.hide_folder_input()}))},submit_new_oauth_uri:function(b){var a;a=$j(b).find("input[name=oauth_uri]").val();Forms.clear_errors(b);return Forms.ajax_submit(b,false,(function(){Notify.server_success("OAuth URI added.");Apps.add_oauth_uri(a);return $j(b).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(b){var a;a=$j("#oauth-uri-list");a.append(this._hoverable_tmpl({value:b}).toHTML());return a.show()},remove_oauth_uri:function(b,a){var d,c;d=$j(b).find(".value").text();c=function(f){var e;Notify.server_success("OAuth URI removed.");e=b.parentNode;e.removeChild(b);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:a,oauth_uri:d},dataType:"json",success:c,error:function(){return Notify.server_error("Unable to complete your request.")}})},submit_new_domain:function(a){var b;b=$j(a).find("input[name=domain_name]").val();Forms.clear_errors(a);return Forms.ajax_submit(a,false,(function(){Notify.server_success("Domain added.");Apps.add_domain(b);return $j(a).find("input[name=domain_name]").val("")}))},add_domain:function(b){var a;a=$j("#domain-list");a.append(this._hoverable_tmpl({value:b}).toHTML());return a.show()},remove_domain:function(b,a){var d,c;d=$j(b).find(".value").text();c=function(f){var e;Notify.server_success("Domain removed.");e=b.parentNode;e.removeChild(b);if(e.getElementsByTagName("div").length===0){return e.hide()}};return $j.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:a,domain_name:d},dataType:"json",success:c,error:function(){return Notify.server_error("Unable to complete your request.")}})},show_need_users_modal:function(a){Modal.icon_show("alert_32",_("Please test this app"),$("app-need-users-modal"));return false},show_name_branding_modal:function(a){Modal.icon_show("alert_32",_("Please rename this app"),$("app-name-branding-modal"));return false},hide_folder_input:function(){$j("#folder-name").show();return $j("#folder-input").hide()},show_folder_input:function(){$j("#folder-name").hide();$j("#folder-input").show();return $j("#folder-input input[name=folder]").focus()}};var Twitter;window.twitter_auth_complete=function(){if(Twitter.onLoginSuccessCallback){Twitter.onLoginSuccessCallback()}else{window.location.reload()}return false};Twitter={get_progress_container:function(){var a;assert(Twitter.progress_container,"Twitter is missing progress_container");a=$(Twitter.progress_container);assert(a,"Missing progress_container elm");return a},follow_dropbox:function(a){var b;if(a.showWorking){a.showWorking()}b=function(){if(a.onFailure){return a.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(c){if(!c.responseText.startsWith("ok")){return b()}else{if(a.onSuccess){return a.onSuccess()}}},onFailure:function(){return b()}})},do_auth:function(a){window.open("/twitter/request_token","twitter_auth","width=800,height=400");if(a){return Twitter.onLoginSuccessCallback=a}},show_auth:function(a){if(a){Twitter.onLoginSuccessCallback=a}return DomUtil.updateFromElm(Twitter.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(Twitter.should_hide_modal()){Modal.hide()}return Twitter.get_progress_container().update(DomUtil.fromElm("sharing-progress"))},show_complete:function(b){var a;a=Twitter.get_progress_container();a.update(DomUtil.fromElm("sharing-posted"));return Twitter.show_complete_into(b,a)},show_complete_into:function(g,a){var d,e,c,f,b;d="twitter";f=_("View tweet");b=void 0;if(g.startsWith("ok")){b="http://www.twitter.com/"}else{b=g}e=a.down("#view-post");e.href=b;e.update(f);c=Sprite.make("web",d);return e.__sert({top:c})},post:function(c,e,b){var d,a;assert(c,"Twitter message is empty");d={message:c,from_referrals:Twitter.from_referrals,from_getspace:Twitter.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:d,onSuccess:function(f){var g,h;if(f.responseText==="login"){Twitter.onLoginSuccessCallback=function(){return Twitter.post(c)};g=Twitter.custom_show_auth||Twitter.show_auth;return g()}else{if(Twitter.should_hide_modal()){Modal.hide()}h=Twitter.onPostSuccessCallback||Twitter.show_complete;return h(f.responseText)}}});a=Twitter.custom_show_posting||Twitter.show_posting;return a()},custom_post:function(a,b){if(b){Twitter.onPostSuccessCallback=b}if(!a){return}assert(a,"Twitter message doesn't exist");if(!Constants.uid){return window.open("http://www.twitter.com/home?status="+encodeURI(a))}else{return Twitter.post(a)}},get_user_info:function(a){return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(b){return a(Util.from_json(b.responseText))}})},should_hide_modal:function(){if(typeof Twitter.hide_modal==="undefined"){return true}else{return Twitter.hide_modal}}};var FacebookOAuth;FacebookOAuth={get_progress_container:function(){var a;assert(FacebookOAuth.progress_container,"Facebook is missing progress_container");a=$(FacebookOAuth.progress_container);assert(a,"Missing progress_container elm");return a},do_auth:function(a){window.open("/fb/access_token","fb_auth","width=600,height=450");if(a){return FacebookOAuth.onLoginSuccessCallback=a}},show_posting:function(){Modal.hide();return FacebookOAuth.get_progress_container().update(DomUtil.fromElm("sharing-progress"))},show_auth:function(a){if(a){FacebookOAuth.onLoginSuccessCallback=a}return DomUtil.updateFromElm(FacebookOAuth.get_progress_container(),"inline-facebook-auth")},show_complete:function(){var a,d,e,c,f,b;a=FacebookOAuth.get_progress_container();a.update(DomUtil.fromElm("sharing-posted"));d="facebook";f="View Post";b="http://www.facebook.com/profile.php?v=wall";e=a.down("#view-post");e.href=b;e.update(f);c=Sprite.make("web",d);return e.__sert({top:c})},post:function(e,d,c,b,f){var a;if(!Constants.uid){window.open("http://www.facebook.com/sharer.php?u="+encodeURI(d)+"&t="+encodeURI(c));return}a=FacebookOAuth.custom_show_posting||FacebookOAuth.show_posting;a();return new Ajax.DBRequest("/fb/post",{parameters:{message:e,link:d,link_name:c,description:b,from_referrals:FacebookOAuth.from_referrals,from_getspace:FacebookOAuth.from_getspace,picture:(f?f:"")},onSuccess:function(g){var h;if(g.responseText.startsWith("ok")){h=FacebookOAuth.custom_show_complete||FacebookOAuth.show_complete;return h()}else{if(g.responseText.startsWith("auth")){return do_auth(function(){return FacebookOAuth.post(e,d,c,b)})}}}})}};var Scroll;Scroll={SCROLL_OFFSET:100,_get_cursor:null,_getting_more:false,_more_endpoint:null,_get_more_params:null,_render_more:null,_paused:true,_more:true,_scroller:null,init:function(b,c,d,f,e,a){this.SCROLL_OFFSET=b;this._more_endpoint=c;this._get_more_params=d;this._render_more=f;this._get_cursor=e;this._paused=false;this._more=true;return this._scroller=a},listen:function(){var a;return Event.observe((a=this._scroller)!=null?a:window,"scroll",this._window_scroll)},pause:function(){return this._paused=true},_window_scroll:function(){var c,b,a;if(Scroll._more){a=Util.scroll_offsets().top;b=Util.viewport_dimensions().height;c=document.body.getHeight();if(Scroll._scroller){if(Scroll._scroller.scrollTop+Scroll._scroller.offsetHeight+Scroll.SCROLL_OFFSET>=Scroll._scroller.scrollHeight){return Scroll._get_more()}}else{if(a+b+Scroll.SCROLL_OFFSET>=c){return Scroll._get_more()}}}},_get_more:function(){var a,b;if(Scroll._getting_more||Scroll._paused){return}Scroll._getting_more=true;if((b=$("more-loading"))!=null){b.show()}a={cursor:Scroll._get_cursor()};Object.extend(a,Scroll._get_more_params);return new Ajax.DBRequest(Scroll._more_endpoint,{method:"POST",parameters:a,onSuccess:function(d){var e,c;if((c=$("more-loading"))!=null){c.hide()}e=Util.from_json(d.responseText);Scroll._more=e.more;Scroll._render_more(e);return Scroll._getting_more=false}})}};var AllPhotosPhotoPreview,AllPhotosVideoPreview,LightboxPreviewBase,PhotoPreview,SingleCollectionPhotoPreview,SingleCollectionVideoPreview,VideoPreview,get_timeline_preview_classes,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d},__bind=function(a,b){return function(){return a.apply(b,arguments)}};LightboxPreviewBase=(function(){function a(b){this.link_hash=b.link_hash;this.filename=b.filename;this.fq_path=b.fq_path;this.thumbnail_url_tmpl=b.thumbnail_url_tmpl;this.dl_url=b.dl_url;this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.display_time=b.display_time||null;this.more_actions_item_tmpl=HTML.tmpl("lightbox_more_actions_item_tmpl")}a.prototype.preload=function(){};a.prototype.render=function(){};a.prototype.image_size=function(){var b;b=document.viewport.getDimensions();return Util.dimensions_to_imagesize(b.width,b.height)};a.prototype.get_more_actions_above_divider=function(c){var d,b;b=[];d=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,sprite_name:"lightbox_download",item_text:_("Download"),more_classes:"more-actions-item"});b.push(d);return b};a.prototype.get_more_actions_below_divider=function(b){return[]};a.prototype.is_a_timeline_preview=function(){return this instanceof SingleCollectionPhotoPreview||this instanceof AllPhotosPhotoPreview||this instanceof SingleCollectionVideoPreview||this instanceof AllPhotosVideoPreview};a.prototype.is_an_album_preview=function(){return this instanceof SingleCollectionPhotoPreview||this instanceof SingleCollectionVideoPreview};a.prototype.is_a_photo_preview=function(){return this instanceof PhotoPreview};a.prototype.is_a_video_preview=function(){return this instanceof VideoPreview};a.prototype.get_actions=function(f){var c,e,d,b,g=this;e=[];if(!this.is_a_timeline_preview()){d=$j("<a />",{id:"lightbox_shmodel_link","class":"title_bubble black"});if(this.is_a_photo_preview()){d.attr("title",_("Share link to photo"))}else{if(this.is_a_video_preview()){d.attr("title",_("Share link to video"))}else{assert(false,"preview needs to be a photo or video")}}d.html(Sprite.make("web","link_white"));if(this.shmodel_link){d.attr("href",this.shmodel_link+"?m");d.attr("target","_blank")}else{d.attr("href","#");b=(function(h){h.preventDefault();return Forms.postRequest("/sm/create"+Util.urlquote(g.fq_path),{},{target:"_blank"})});d.on("click",b)}e.push(d[0])}if(f.include_delete){c=$j("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:Photos.in_single_collection_view()?_("Remove"):_("Delete")});c.html(Sprite.make("web","lightbox_delete_16"));c.on("click",(function(h){h.preventDefault();return Lightbox.toggle_delete()}));e.push(c[0])}assert(Lightbox.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");e.push(Lightbox.more_actions_button);return e};a.prototype.delete_pressed=function(){var b;b=_("Deleting...");if(this.is_a_timeline_preview()){if(Photos.in_single_collection_view()){b=_("Removing...");Photos.get_current_collection().remove_photos([this.photo])}else{Photos._delete_photos([this.photo])}}else{document.fire(Lightbox.PHOTO_DELETE_EVT,this)}return Notify.server_success(b)};a.prototype.set_more_actions_event_handlers=function(b){};return a})();PhotoPreview=(function(b){__extends(a,b);function a(c){a.__super__.constructor.call(this,c);this.original_url=c.original_url;this.shmodel_link=c.shmodel_link;this.fail_image_src="/static/images/preview_fail.png";if(this.is_gif()){this.thumbnail_url_tmpl=c.original_url}this.loaded=false}a.prototype.show_fail=function(d){var c;c=new Element("div").__sert(_("Unable to preview this item."));return d.__sert(c)};a.prototype.fallback=function(d){var c,f;c=$(d.target);c.writeAttribute({src:this.fail_image_src,width:128,height:128});f=c.up("div.content-item");if(f){return this.show_fail(f)}};a.prototype.is_gif=function(){return"gif"===Util.file_extension(this.filename).toLowerCase()};a.prototype.preload=function(e){var d,f,c,g=this;c=Util.add_qstring(this.thumbnail_url_tmpl,{size:this.image_size()});if(this.is_gif()){c=this.thumbnail_url_tmpl}f=function(){if(typeof e==="function"){e()}return g.loaded=true};Util.preload_image(c,this.fallback.bind(this),f);d=$(Util.preloaded_images[c]);d.writeAttribute("data-original-href",this.original_url);d.writeAttribute("class","thumbnail");return d};a.prototype.render=function(e){var d,f,c,g;if(this.loaded){e()}d=this.preload(e);g=new Element("div").__sert(d);f=d.getAttribute("src").length;c=d.getAttribute("src").substring(f-this.fail_image_src.length,f);if(c===this.fail_image_src){this.show_fail(g)}return g};a.prototype.advance_on_click=true;a.prototype.get_more_actions_above_divider=function(e){var d,c;c=a.__super__.get_more_actions_above_divider.call(this,e);d=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:_("View original"),more_classes:"more-actions-item"});c.push(d);return c};return a})(LightboxPreviewBase);VideoPreview=(function(a){__extends(b,a);function b(c){this._player_error=__bind(this._player_error,this);this._player_ready=__bind(this._player_ready,this);b.__super__.constructor.call(this,c);this.preview_url=c.preview_url;this.shmodel_link=c.shmodel_link;this.thumbnail_div=null}b.prototype.render_error=function(){var d,c,e;d=new Element("div");c=new Element("img",{src:"/static/images/preview_fail.png","class":"video-preview-fail"});e=new Element("div",{"class":"video-preview-fail"});e.__sert(_("Unable to preview this item."));d.__sert(c);d.__sert(e);return d};b.prototype._player_ready=function(){var c;c=function(){return $j(".vjs-big-play-button").focus()};return c.defer()};b.prototype._player_error=function(c){this.div=this.render_error();return $j("#file-preview-modal .content-item").html(this.div)};b.prototype.preload=function(){};b.prototype.render=function(){this.div=this.render_video();return this.div};b.prototype.render_video=function(e){var g,d,c,h,f;if(!FlashDetect.installed){return this.render_error()}f=new Element("div",{"class":"video-player"});h=this.image_size().split("x")[0]*0.8;c=parseInt(h*0.55,10);g=false;d=Util.add_qstring(this.thumbnail_url_tmpl,{size:this.image_size()});VideoUtil.embed(f,{src:this.preview_url,type:"video/flv",width:h,height:c,controls:true,preload:"auto",poster:d,onError:this._player_error,onReady:this._player_ready});f.down(".video-js").setStyle({margin:"0 auto"});return f};return b})(LightboxPreviewBase);get_timeline_preview_classes=function(c){var a,b;a=(function(e){__extends(d,e);function d(f){f.ns_id=f.photo.ns_id;f.ns_path=f.photo.ns_path;d.__super__.constructor.call(this,f);this.photo=f.photo;TitleBubble.set_vertical_space(3);if(Photos.in_single_collection_view()){$j("#lightbox-delete-photo").val(_("Remove"))}else{$j("#lightbox-delete-photo").val(_("Delete"))}}d.prototype.get_more_actions_above_divider=function(h){var g,f;f=d.__super__.get_more_actions_above_divider.call(this,h);g=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:_("Add to album"),more_classes:"more-actions-item"});f.push(g);return f};d.prototype.toggle_select_button_off=function(f){if(this.is_a_photo_preview()){f.attr("title",_("Select photo"))}else{if(this.is_a_video_preview()){f.attr("title",_("Select video"))}}f.html(Sprite.make("web","lightbox_unselected"));f.removeClass("selected");f.addClass("elbboggiw");return setTimeout((function(){return f.removeClass("elbboggiw")}),540)};d.prototype.toggle_select_button_on=function(f){if(this.is_a_photo_preview()){f.attr("title",_("Un-select photo"))}else{if(this.is_a_video_preview()){f.attr("title",_("Un-select video"))}}f.html(Sprite.make("web","lightbox_selected"));f.addClass("selected");f.addClass("wiggobble");return setTimeout((function(){return f.removeClass("wiggobble")}),540)};d.prototype.toggle_select=function(g){var f;g.preventDefault();f=$j("#lightbox-select-button");TitleBubble.hide_all();if(PhotosSelection.contains(this.photo)){PhotosSelection._remove(this.photo);return this.toggle_select_button_off(f)}else{PhotosSelection._add(this.photo);return this.toggle_select_button_on(f)}};d.prototype.get_actions=function(h){var g,f,j,i=this;g=[];j=$j("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});Lightbox.update_share_button_text(null,$j(j));j.on("click",(function(l){var k;l.preventDefault();k=PhotosSelection.get();if(k.length===0){return Foshmodal.show([i.photo],false)}else{return Foshmodal.show(PhotosSelection.get(),false)}}));f=$j("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:_("Select this photo")});if(PhotosSelection.contains(this.photo)){f.html(Sprite.make("web","lightbox_selected"))}else{f.html(Sprite.make("web","lightbox_unselected"))}f.on("click",this.toggle_select.bind(this));g.push(j[0]);g.push(f[0]);return g.concat(d.__super__.get_actions.call(this,h))};d.prototype.set_more_actions_event_handlers=function(f){var g=this;$("lightbox_add_to_album").observe("click",(function(h){h.preventDefault();return PhotosCollections.show_add_to_album_modal(h,[g.photo])}));$("lightbox_show_in_folder").observe("click",(function(h){h.preventDefault();return Photos.show_in_folder(g.photo)}));return d.__super__.set_more_actions_event_handlers.call(this,f)};d.prototype.get_more_actions_below_divider=function(h){var g,f;g=[];f=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:_("Show in folder"),more_classes:"more-actions-item"});g.push(f);g=g.concat(d.__super__.get_more_actions_below_divider.call(this,h));return g};return d})(c);b=(function(e){__extends(d,e);function d(){return d.__super__.constructor.apply(this,arguments)}d.prototype.get_more_actions_below_divider=function(h){var f,g;g=[];f=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:_("Remove from album"),more_classes:"more-actions-item"});g.push(f);g=g.concat(d.__super__.get_more_actions_below_divider.call(this,h));return g};d.prototype.set_more_actions_event_handlers=function(f){var g=this;$("lightbox_remove_from_album").observe("click",(function(h){h.preventDefault();return PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),[g.photo])}));return d.__super__.set_more_actions_event_handlers.call(this,f)};return d})(a);return[a,b]};_ref=get_timeline_preview_classes(PhotoPreview),AllPhotosPhotoPreview=_ref[0],SingleCollectionPhotoPreview=_ref[1];_ref1=get_timeline_preview_classes(VideoPreview),AllPhotosVideoPreview=_ref1[0],SingleCollectionVideoPreview=_ref1[1];var Lightbox;Lightbox=(function(){var q,o,U,S,H,g,f,a,v,D,Y,R,C,M,m,L,A,I,X,l,O,N,e,t,Q,B,h,w,x,F,c,p,E,P,W,K,n,s,d,r,G,b,i,J,y,z,k,u,j,V;S=[];q=0;H=false;U=true;y=void 0;f="lightbox";a=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;g=false;Q=void 0;M=void 0;G=-1;b=null;I=null;l=function(Z){return Z.complete!==false};d=function(){var Z;if($$("#file-preview-modal .loading-image").length){return}Z=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black.gif"});return $$("#file-preview-modal .preview-content").first().__sert(Z)};A=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};x=function(){var af,ae,ab,Z,ad,ac,aa;ae=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!ae||!l(ae)){return}Z=$$("#file-preview-modal .preview").first().getDimensions();af=void 0;if(!ae.naturalHeight){af=ae.getDimensions();ae.naturalHeight=af.height;ae.naturalWidth=af.width}else{af={width:ae.naturalWidth,height:ae.naturalHeight}}ab=af.width/Z.width;aa=af.height/Z.height;ac=Math.max(ab,aa);ae.style.visibility="";if(ac<1){ae.style.width="";ae.style.height=""}else{ae.style.width=Math.floor(af.width/ac)+"px";ae.style.height=Math.floor(af.height/ac)+"px"}ad=$j("#file-preview-modal .paging-block").position().left-16;return $j("#file-preview-modal .filename").css("max-width",ad)};C=void 0;N=function(){var ag,ab,af,ae,ad,aa,ac,Z;ab=$("file-preview-modal");ae=ab.down(".menu");af=ab.down(".header");ac=$$(".lightbox-not-important");Z=[];for(ad=0,aa=ac.length;ad<aa;ad++){ag=ac[ad];Z.push(ag.addClassName("opacity-zero"))}return Z};r=function(){var ad,ac,aa,ab,Z;if(C){clearTimeout(C)}ab=$$(".lightbox-not-important");Z=[];for(ac=0,aa=ab.length;ac<aa;ac++){ad=ab[ac];Z.push(ad.removeClassName("opacity-zero"))}return Z};F=function(aa){var Z;r();Z=aa&&$(aa.target).descendantOf("file-preview-menu");if(C!=null){clearTimeout(C)}if(U){if(!g&&!Z){return C=setTimeout(N,3112)}}};J=function(){if(C!=null){clearTimeout(C)}return U=false};i=function(){U=true;return F()};X=function(aa){var Z;Z=S.length;return(Z+(q+aa)%Z)%Z};B=function(aa){var Z,ab;if(Q.no_preload){return}Z=n.bind(null,aa);return typeof(ab=S[aa]).preload==="function"?ab.preload(Z):void 0};h=function(){var ab,ad,aa,ac,Z;ac=[1,2,3,4,5,6,-1,-2];Z=[];for(ad=0,aa=ac.length;ad<aa;ad++){ab=ac[ad];if(Math.abs(ab)<S.length){Z.push(B(X(ab)))}else{Z.push(void 0)}}return Z};p=function(Z){if(!Q.filename_in_url){return}if(Z!=null){return HashRouter.replace_hash("lh",Z)}else{return HashRouter.replace_hash("")}};E=function(ac,at){var ai,aj,ak,ao,ae,Z,an,ar,aq,am,ag,aa,af,al,ap,ab,au,ah,ad;window.scrollTo(0,0);G=Util.time();Lightbox.vid_player=null;assert(q<S.length,"Invalid index "+q);al=S[q];if(typeof al!=="object"){if(b){clearTimeout(b)}b=setTimeout((function(){if((Lightbox.shown!=null)&&Lightbox.shown){return E(ac,at)}}),100);return}$j("#file-preview-modal").trigger("lightbox-preview",{preview:al});an={mode:"lightbox"};UserActivityLogger.log("web","file_view",Object.toJSON(an));af=ac?K:n;ae=al.render(af);ae.addClassName("content-item");aq=$("file-preview-modal");ap=aq.down(".preview-content");ap.__date(ae);if(!I){I=aq.on("contextmenu","img.thumbnail",ContextMenu.show_for_lightbox.bind(ContextMenu))}p(al.link_hash);aa=Q.num_previews||S.length;aq.down(".lightbox-index-text-container").__date(_("%(cur_file_num)s of %(num_total_files)s").format({cur_file_num:q+1,num_total_files:aa}));if(al.display_time){if(al.filename.match(a)){aq.down(".filename").__date(al.display_time)}else{aq.down(".filename").__date(al.display_time+" - "+al.filename)}}else{aq.down(".filename").__date(al.filename)}aq.down(".filename").writeAttribute("title",al.filename);if(Photos.in_single_collection_view()&&((ah=Photos.get_current_collection().member_fnames)!=null?ah.length:void 0)>1&&(((ad=al.photo)!=null?ad.item_owner_fname:void 0)!=null)){ao="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";ao+=_("Added by %(fname)s").format({fname:al.photo.item_owner_fname.snippet(15)});aq.down(".added-by").__date(new HTML(ao));aq.down(".added-by").show()}else{aq.down(".added-by").hide()}if(S.length===1){aq.down(".prev").addClassName("opacity-zero");aq.down(".next").addClassName("opacity-zero")}else{if(q===0&&Q.no_wrap){aq.down(".prev").addClassName("opacity-zero");aq.down(".next").removeClassName("opacity-zero")}else{if(q===S.length-1&&Q.no_wrap){aq.down(".prev").removeClassName("opacity-zero");aq.down(".next").addClassName("opacity-zero")}else{aq.down(".prev").removeClassName("opacity-zero");aq.down(".next").removeClassName("opacity-zero")}}}ag=HTML.tmpl("lightbox_more_actions_item_tmpl");am=al.get_more_actions_above_divider(Q);ak=al.get_more_actions_below_divider(Q);if(ak.length){am.push(ag({divider:true}));am=am.concat(ak)}$("lightbox-more-actions-list").__date(am);al.set_more_actions_event_handlers(Q);aj=al.get_actions(Q);Z=document.createDocumentFragment();for(ab=0,au=aj.length;ab<au;ab++){ai=aj[ab];Z.appendChild(ai)}aq.down(".actions").__date();aq.down(".actions").appendChild(Z);document.fire(Lightbox.ACTIONS_ADDED);if(Photos.in_single_collection_view()){aq.down(".album-name").show().__date(Photos.get_current_collection().name.em_snippet(15,1));aq.down(".filename").addClassName("faded")}else{aq.down(".album-name").hide();aq.down(".filename").removeClassName("faded")}ae=ae.down("img.thumbnail");if(ae){if(!l(ae)){ae.hide();d();ae.observe("load",function(){A();ae.style.visibility="hidden";ae.show();return x()})}else{ae.show();x()}}ar={preview_obj:al,index:q,direction:at};return document.fire(Lightbox.PHOTO_CHANGE_EVT,ar)};W=function(ab){var Z,aa;if(G===-1){return}aa=Util.time()-G;if(typeof PhotosLogger!=="undefined"&&PhotosLogger!==null){Z=PhotosLogger.get_current_view()}else{if(typeof SharingModel!=="undefined"&&SharingModel!==null?SharingModel.is_album:void 0){Z="album_shmodel"}else{Z="not_photos"}}WebTimingLogger.log_ajax_transition(aa,ab,{current_view:Z});G=-1;return h()};K=function(){return W("file-preview-lightbox-load-initial")};n=function(Z){var aa;if(typeof Z==="number"){if((aa=S[Z])!=null){aa.loaded=true}if(Z===q){return W("file-preview-lightbox-load")}}else{return W("file-preview-lightbox-load")}};P=function(Z){var aa;aa=$j("#lightbox-click-catcher");if(!aa.length){aa=$j("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});aa.appendTo("#file-preview-modal .modal-preview-content");if(($j.browser.msie!=null)&&$j.browser.msie){aa.css("background","black");aa.fadeTo(0,0)}}aa.off("click");aa.on("click",(function(ab){ab.preventDefault();return Z()}));return aa.show()};m=function(){return $j("#lightbox-click-catcher").hide()};Y=function(){var Z;Z=$("lightbox_more_actions_button");if(Z.hasClassName("toggled")){m();Z.removeClassName("toggled");$("lightbox-more-actions-menu").hide();i();return true}return false};t=function(){var Z;Z=$j("#lightbox_more_actions_button");if(!Z.hasClass("toggled")){Z.addClass("toggled");TitleBubble.hide_all();$j("#lightbox-more-actions-menu").show();J();return P(Lightbox.close_more_actions_menu)}};k=function(){if($j("#lightbox_more_actions_button").hasClass("toggled")){return Y()}else{return t()}};e=function(Z){Y();if(Z){Z.preventDefault()}if(q===S.length-1&&Q.no_wrap){return}q=X(1);if(q===0){F()}return E(null,Lightbox.NEXT)};w=function(Z){Y();if(Z){Z.preventDefault()}if(q===0&&Q.no_wrap){return}q=X(-1);return E(null,Lightbox.PREV)};D=function(Z){if(Z){Z.preventDefault()}if(S[q].advance_on_click){if(Z.clientX<document.width/10){return w()}else{return e()}}};R=function(af){var ac,ab,ae,ag,ad,aa,Z;ac=S.dict_by("fq_path");ag=void 0;if(af.memo.files){ag=af.memo.files.collect(function(ah){return ah.fq_path})}else{ag=af.memo.fq_paths}Z=[];for(ad=0,aa=ag.length;ad<aa;ad++){ae=ag[ad];if(ac[ae]){ab=S.indexOf(ac[ae]);S.splice(ab,1);if(Q.num_previews){Q.num_previews--}if(!Q.num_previews&&!S.length){Z.push(M())}else{if(ab===S.length){Z.push(w())}else{Z.push(E())}}}else{Z.push(void 0)}}return Z};c=function(Z){if(S[q].is_a_timeline_preview()){return S[q].toggle_select(Z)}};u=function(){Event.stopObserving(document,"mousemove",F);Event.stopObserving(document,"click",F);document.stopObserving(FileEvents.DELETE,R);document.stopObserving(PhotosSelection.CHANGE_EVT,j);return clearInterval(y)};M=function(ac){var aa,ab,Z;if(ac){ac.preventDefault()}if(!Lightbox.shown){return}aa=$("file-preview-modal");aa.hide();if(Lightbox.vid_player&&Lightbox.vid_player.sendEvent){Lightbox.vid_player.sendEvent("stop")}aa.down(".preview-content").__date();document.body.removeClassName("full_no_overflow");$j(document.documentElement).removeClass("full_no_overflow");u();p();Lightbox.shown=0;aa.stopObserving("click",Lightbox.back);if((ab=$$(".preview-content"))!=null){if((Z=ab.first())!=null){Z.stopObserving("click")}}if(Lightbox.reload){Browse.force_reload()}if(Tutorial.should_handle_event(Tutorial.events.browse_hide_lightbox)){return Tutorial.handle_event(Tutorial.events.browse_hide_lightbox)}};o="db:filepreview:exitselect";v=function(Z){if(Q.keep_url){M()}else{window.history.go(-1)}if(Z!=null){if(Z.originalEvent){Z=Z.originalEvent}Event.extend(Z).stop()}return document.fire(o,S[q])};O=function(){var Z,aa=this;if(!H){Z=$j("#file-preview-modal");Z.on("click",".close",v);key("esc",f,(function(ab){if($j("#lightbox_more_actions_button").hasClass("toggled")){return Y()}else{if(g){return L()}else{return v(ab)}}}));Z.on("click",".next",e);Z.on("click",".prev",w);Z.on("click",".preview-container",D);key("left, k",f,function(ab){return w()});key("right, j",f,function(ab){e();return false});key("up, down",f,function(ab){return false});key("x, s, space",f,function(ab){c(ab);return false});if(Q.include_delete){key("delete, command+backspace, backspace",f,function(ab){Event.extend(ab).preventDefault();return Lightbox.toggle_delete()});$j("#lightbox-delete-photo").on("click",(function(ab){z();return S[q].delete_pressed()}));$j("#lightbox-delete-cancel").on("click",L)}DBHistory.add_exit_callback("/lightbox",function(){return M()});Util.disableSelection(Z.find(".preview-container")[0]);Util.disableSelection(Z.find(".header")[0]);H=true}Event.observe(document,"mousemove",F);Event.observe(document,"click",F);document.observe(FileEvents.DELETE,R);document.observe(Lightbox.PHOTO_DELETE_EVT,function(ab){return FileOps.do_delete(ab.memo.fq_path)});document.observe(PhotosSelection.CHANGE_EVT,j);key.setScope(f);return y=setInterval(x,500)};V=function(){return on_script_loaded(function(){HashRouter.watch("lh",function(ac){var ad,Z,af,ae,ab,aa;Z=decodeURIComponent(ac);aa=[];for(ad=ae=0,ab=S.length;ae<ab;ad=++ae){af=S[ad];if(af.link_hash&&af.link_hash.toLowerCase()===Z.toLowerCase()){q=ad;if(!Lightbox.shown){aa.push(Lightbox.show())}else{aa.push(E())}}else{aa.push(void 0)}}return aa});return HashRouter.watch("f",function(Z){var ac,ad,af,ae,ab,aa;ac=decodeURIComponent(Z);aa=[];for(ad=ae=0,ab=S.length;ae<ab;ad=++ae){af=S[ad];if(af.filename.toLowerCase()===ac.toLowerCase()){q=ad;if(!Lightbox.shown){aa.push(Lightbox.show())}else{aa.push(E())}}else{aa.push(void 0)}}return aa})})};j=function(ad,af){var ab,ae,aa,ac,Z;if(af==null){af=$j("#lightbox_share")}aa=PhotosSelection.get();ac=PhotosUtil.categorize_files(aa),ab=ac[0],ae=ac[1];if(aa.length===0){af.text(_("Share"));return(Z=S[q])!=null?Z.toggle_select_button_off($j("#lightbox-select-button")):void 0}else{if(aa.length===1){if(ab){return af.text(_("Share 1 photo"))}else{return af.text(_("Share 1 video"))}}else{if(ab&&ae){return af.text(_("Share %(num_files)s items").format({num_files:aa.length}))}else{if(ab){return af.text(_("Share %(num_photos)s photos").format({num_photos:aa.length}))}else{return af.text(_("Share %(num_videos)s videos").format({num_videos:aa.length}))}}}}};s=function(){TitleBubble.hide_all();$j("#file-preview-modal .delete-file-prompt").show();r();g=true;P(Lightbox.toggle_delete);return $j("#lightbox-delete-photo").focus()};L=function(){var aa,Z;if(g){aa=$j("#file-preview-modal .delete-file-prompt");aa.hide();if((Z=aa.find(":focus")[0])!=null){Z.blur()}F();g=false;return m()}};z=function(){if(g){return L()}else{return s()}};return{init:function(Z,ab){var aa=this;if(Lightbox.shown){return}Lightbox.more_actions_button=new Element("a",{id:"lightbox_more_actions_button",href:"#","class":"lightbox_more_actions_button title_bubble black",title:_("More actions")});Lightbox.more_actions_button.observe("click",(function(ac){ac.preventDefault();return Lightbox.toggle_more_actions_menu()}));Lightbox.more_actions_button.__date(Sprite.make("web","lightbox_more"));ab=ab||{};Q={include_delete:ab.include_delete||false,keep_url:ab.keep_url||false,num_previews:ab.num_previews||null,filename_in_url:ab.filename_in_url||false,no_wrap:(ab.no_wrap||false)||true,no_preload:ab.no_preload||false};assert(!Q.filename_in_url||Q.keep_url,"filename_in_url cannot be used with keep_url off");S=Z;if(ab.start_index!=null){Lightbox.show(ab.start_index)}if(Q.filename_in_url){V()}return $(document.body).on("click",".more-actions-item",function(ac,ad){if(ad.down("a").getAttribute("href").length<2){ac.preventDefault()}return Lightbox.close_more_actions_menu()})},update_previews:function(Z){return S=Z},show:function(Z){var aa;if(Lightbox.shown){return}assert(S&&S.length,"Lightbox.show() requires file preview objects to show");O();if(Z!=null){q=Z}$j("#file-preview-modal").trigger("lightbox-init-show",{preview:S[q]});assert(!Lightbox.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();$(document.body).addClassName("full_no_overflow");$j(document.documentElement).addClass("full_no_overflow");E(true);Lightbox.shown=1;if(!Q.keep_url){aa=DBHistory.deconstruct_url(DBHistory.get_url());if(aa.path.indexOf("/lightbox/")!==0){DBHistory.push_state("/lightbox"+aa.path,aa.qargs)}}return F()},jump_to:function(Z){assert(Lightbox.shown,"Lightbox should be showing");q=Z;E();return F()},set_no_wrap:function(Z){return Q.no_wrap=Z},num_previews:function(){return Q.num_previews||S.length},current_index:function(){return q},close_more_actions_menu:Y,toggle_more_actions_menu:k,update_share_button_text:j,toggle_delete:z,back:v,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:o,reload:false,NEXT:1,PREV:-1,vid_player:null,vid_player_loading:null,vid_player_error:null,vid_thumbnail_hidden:null}})();var Tour;Tour=(function(){var d,c,f,g,k,i,j,h,e,l,b,a;c=6;d=0;b=function(m){var v,u,t,o,n,p,r,s,q;$$(".page-end").each(Element.remove);n=m;r=c-m-1;v=document.createDocumentFragment();for(u=s=0;0<=n?s<n:s>n;u=0<=n?++s:--s){o=new Element("img",{src:"/static/images/page-left.png","class":"page-end-left page-end"});o.style.left=(28-u*5)+"px";o.style.zIndex=c-u;v.appendChild(o)}for(t=q=0;0<=r?q<r:q>r;t=0<=r?++q:--q){p=new Element("img",{src:"/static/images/page-right.png","class":"page-end-right page-end"});p.style.right=(31-t*5)+"px";p.style.zIndex=c-t;v.appendChild(p)}return $("book").appendChild(v)};a=function(m){(m>0?Element.show:Element.hide)("tour-page-back");return(m+1<c?Element.show:Element.hide)("tour-page-forward")};e=function(m){$$(".pages").invoke("hide");return $("page-"+m).show()};f=function(m){a(m);b(m);e(m);return d=m};h=function(n){var m;Event.extend(n).preventDefault();m=d-1;if(m<0){return}f(m);return DBHistory.push_state("/tour/"+m)};i=function(n){var m;Event.extend(n).preventDefault();m=d+1;if(m>=c){return}f(m);return DBHistory.push_state("/tour/"+m)};l=function(n,o){var m;n.preventDefault();m=parseInt(o.href.split("/").last(),10);f(m);return DBHistory.push_state("/tour/"+m)};k=function(){$("tour-page-back").observe("click",h);$("tour-page-forward").observe("click",i);key("right",i);key("left",h);return $("toc").on("click","a",l)};g=function(n,o){var m;m=parseInt(n,10)||0;return f(m)};j=function(){var q,p,n,o,m;o=$$(".page-right img");m=[];for(p=0,n=o.length;p<n;p++){q=o[p];m.push(Util.preload_image(q.src))}return m};return{setup:function(){return Util.smartLoad(function(){DBHistory.add_callback("/tour",g);k();return j()})}}})();var CashUtil,PciInputBase,Upgrade,UpgradeDesign1,_this=this,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PciInputBase={set_data_encrypted_names:function(){return $j.each($j(".pci_encrypted_field input, .pci_encrypted_field select"),function(a,b){return $j(b).attr("data-encrypted-name",b.id)})}};Upgrade={card_toggle:function(a){return function(c){var b;b=$(c);if(c===a||!a){return b.removeClassName("cc-icon-off")}else{return b.addClassName("cc-icon-off")}}},highlightCardtype:function(){var c,e,b,a,d;e=$("ccn");if(Upgrade.last_val===e.value){return}Upgrade.last_val=e.value;b=e.value;d=b.substr(0,2);c=$A(["visa","mastercard","amex"]);a=null;if(b.charAt(0)==="4"){a="visa"}else{if(d==="34"||d==="37"){a="amex"}else{if(parseInt(d,10)>=51&&parseInt(d,10)<=55){a="mastercard"}}}return c.each(Upgrade.card_toggle(a))},runCardHighlighter:function(){return setInterval(Upgrade.highlightCardtype,200)},submitPaypal:function(){var a;if(!Forms.submitOnlyOnce()){return}a={plan:Forms.value("plan"),period:Forms.value("period")};if(Forms.value("packrat")==="yes"){a.packrat="yes"}return location.href=Util.add_qstring("/paypal_upgrade",a)},upgradeViaLogin:function(){var a,b;if(!Forms.submitOnlyOnce()){return}a={plan:Forms.value("plan"),period:Forms.value("period")};if(Forms.value("packrat")){a.packrat="yes"}b=Util.add_qstring("/upgrade",a);return location.href=Util.add_qstring("/login",{cont:b})},setFormToObserveLogin:function(){return $("upgrade-login-button").observe("click",Upgrade.upgradeViaLogin)},setFormPaypalSubmitState:function(a){var b;b=$("upgrade-button");if(!b){return}if(a){return b.observe("click",Upgrade.submitPaypal)}else{return b.stopObserving("click")}},watchPaymentOptions:function(){var k,h,g,d,j,b,a,i,f,c,e;i=$$("a.toggle_paypal_link");for(h=0,j=i.length;h<j;h++){k=i[h];k.observe("click",function(){$("credit-card-info").addClassName("hidden_elem");$("submitted_cc").writeAttribute("value","false");$("paypal-info").removeClassName("hidden_elem");$("toggle_paypal_link_container").addClassName("hidden_elem");$("toggle_credit_card_link_container").removeClassName("hidden_elem");return Upgrade.setFormPaypalSubmitState(true)})}f=$$("a.toggle_credit_card_link");for(g=0,b=f.length;g<b;g++){k=f[g];k.observe("click",function(){var l;$("credit-card-info").removeClassName("hidden_elem");$("submitted_cc").setValue("true");l=$("paypal-info");if(l){$("paypal-info").addClassName("hidden_elem")}$("toggle_paypal_link_container").removeClassName("hidden_elem");$("toggle_credit_card_link_container").addClassName("hidden_elem");Upgrade.setFormPaypalSubmitState(false);return $("ccn").focus()})}c=$$("a.change_billing_information");e=[];for(d=0,a=c.length;d<a;d++){k=c[d];e.push(k.observe("click",function(){var m,l,o,n;$("toggle_paypal_link_container").removeClassName("hidden_elem");$("change_billing_information_container").addClassName("hidden_elem");$("upgrade-form").action="/upgrade";n=$$(".sick-input input");for(l=0,o=n.length;l<o;l++){m=n[l];m.writeAttribute("readOnly",false);m.removeClassName("gray")}$("country-list").removeClassName("hidden_elem");$("expyr").writeAttribute("disabled",false);$("expmo").writeAttribute("disabled",false);$("ccn").writeAttribute("value","");$("address").writeAttribute("value","");return $("ccode").writeAttribute("value","")}))}return e},plan_to_prices:{},plan_to_display_name:{},monthly_packrat_cost:0,yearly_packrat_cost:0,monthly_packrat_display_price:0,yearly_packrat_display_price:0,prorate_amount:0,has_packrat_already:false,plan_box_holder_ids:[],user_current_plan_size:0,user_current_billing_period:"",user_has_downgraded:false,initializeUpgradeForm:function(e,g,f,h,j,c,i,b,a,d){Upgrade.user_current_plan_size=e;Upgrade.user_current_billing_period=g;Upgrade.user_has_downgraded=f;Upgrade.monthly_packrat_cost=h;Upgrade.yearly_packrat_cost=j;Upgrade.monthly_packrat_display_price=c;Upgrade.yearly_packrat_display_price=i;Upgrade.prorate_amount=a;Upgrade.has_packrat_already=b;return Upgrade.setFormPaypalSubmitState(d)},registerPrice:function(c,a,b){return Upgrade.plan_to_prices[c]=[a,b]},registerPlanDisplayName:function(b,a){return Upgrade.plan_to_display_name[b]=[a]},registerPlanBoxHolderId:function(b,a){Upgrade.plan_box_holder_ids.push(b);return $(a).observe("click",function(){return Upgrade.updateSelectedPlanBoxHolder(b)})},updateSelectedPlanBoxHolder:function(d){var c,f,b,e,a;$(d).addClassName("selected-plan");e=Upgrade.plan_box_holder_ids;a=[];for(f=0,b=e.length;f<b;f++){c=e[f];if(c!==d){a.push($(c).removeClassName("selected-plan"))}else{a.push(void 0)}}return a},updateBillingForm:function(V){var B,R,z,C,b,r,v,e,a,F,Q,E,t,c,N,D,k,A,u,H,d,y,x,U,S,P,O,w,l,j,i,h,g,f,M,L,K,G,s,q,p,o,n,m,J,I;H=0;D=100;E=$("packrat");e=Upgrade.has_packrat_already||(E&&E.type==="checkbox"&&E.checked);F=_("month");Q="$39.00";G=$$("[name='plan']");for(U=0,w=G.length;U<w;U++){r=G[U];if(r.checked){D=r.getValue();Upgrade.updateSelectedPlanBoxHolder("plan-"+D+"-holder")}}if(D===Upgrade.user_current_plan_size&&!Upgrade.user_has_downgraded){$("current-plan-desc").removeClassName("hidden_elem");$("billing-information").addClassName("hidden_elem")}else{$("current-plan-desc").addClassName("hidden_elem");$("billing-information").removeClassName("hidden_elem")}if($("period-month").checked){H=Upgrade.plan_to_prices[D][0];if(e){H+=Upgrade.monthly_packrat_cost}Q=Upgrade.monthly_packrat_display_price;F=_("month");u="month"}if($("period-year").checked){H=Upgrade.plan_to_prices[D][1];if(e){H+=Upgrade.yearly_packrat_cost}Q=Upgrade.yearly_packrat_display_price;F=_("year");u="year"}t=$("packrat-price");c=$("packrat-priceperiod");if(t&&c){t.__date(Q);c.__date(F)}x=Upgrade.plan_to_prices[D][0]*12;if(e){x+=Upgrade.monthly_packrat_cost*12}v=Upgrade.plan_to_prices[D][1];if(e){v+=Upgrade.yearly_packrat_cost}A=x-v;N=A/x*100;N=Math.round(N);B=0;R=0;if(Upgrade.prorate_amount>=H){B=0;R=H}else{B=H-Upgrade.prorate_amount;R=Upgrade.prorate_amount}b=B;if(Upgrade.user_has_downgraded&&D===Upgrade.user_current_plan_size&&u===Upgrade.user_current_billing_period){b=0;R=0}b=b.toFixed(2);k=$("plan-name");if(k){k.__date(Upgrade.plan_to_display_name[D])}$("big-price").__date("$"+b);s=$$(".summary_price");for(S=0,l=s.length;S<l;S++){d=s[S];d.__date("$"+b)}q=$$(".monthly-price");for(P=0,j=q.length;P<j;P++){a=q[P];a.__date("$"+Upgrade.plan_to_prices[D][0].toFixed(2))}p=$$(".yearly-price");for(O=0,i=p.length;O<i;O++){y=p[O];y.__date("$"+Upgrade.plan_to_prices[D][1].toFixed(2))}$("savings-percentage").__date(N+"%");if(R){o=$$(".credit-holder");for(M=0,h=o.length;M<h;M++){C=o[M];C.removeClassName("hidden_elem")}n=$$(".credit-amount");J=[];for(L=0,g=n.length;L<g;L++){z=n[L];J.push(z.__date(R.toFixed(2)))}return J}else{m=$$(".credit-holder");I=[];for(K=0,f=m.length;K<f;K++){C=m[K];I.push(C.addClassName("hidden_elem"))}return I}},runPlanWatcher:function(){var d,e,h,f,c,b,g,a;g=$$("[name='plan']");for(h=0,c=g.length;h<c;h++){d=g[h];d.observe("click",Upgrade.updateBillingForm)}a=$$("[name='period']");for(f=0,b=a.length;f<b;f++){d=a[f];d.observe("click",Upgrade.updateBillingForm)}e=$("packrat");if(e){return e.observe("click",Upgrade.updateBillingForm)}},updateBillingInfoForPaypal:function(){if(!Forms.submitOnlyOnce()){return}return location.href="/paypal_billing_info"}};UpgradeDesign1={submitPaypal:function(){var a;if(!Forms.submitOnlyOnce()){return}a={plan:Forms.value("plan"),period:Forms.value("period")||$j('select[name="period"]').val()};if(Forms.value("packrat")==="yes"){a.packrat="yes"}return location.href=Util.add_qstring("/paypal_upgrade",a)},upgradeViaLogin:function(){var a,b;if(!Forms.submitOnlyOnce()){return}a={plan:Forms.value("plan"),period:Forms.value("period")||$j('select[name="period"]').val()};if(Forms.value("packrat")){a.packrat=Forms.value("packrat")}else{a.packrat="no"}if(location.href.indexOf("all_plans=1")>-1||Forms.value("all_plans")){a.all_plans="1"}b=Util.add_qstring("/upgrade",a);return location.href=Util.add_qstring("/login",{cont:b})},setFormToObserveLogin:function(){return $("upgrade-login-button").observe("click",UpgradeDesign1.upgradeViaLogin)},setFormPaypalSubmitState:function(a){var b;b=$("upgrade-button");if(!b){return}if(a){return b.observe("click",UpgradeDesign1.submitPaypal)}else{return b.stopObserving("click")}},setCountryCodesWithoutPostalCodes:function(a){this.countryCodesWithoutPostalCodes=a},watchPaymentOptions:function(){var k,h,g,d,j,b,a,i,f,c,e;i=$$("a.toggle_paypal_link");for(h=0,j=i.length;h<j;h++){k=i[h];k.observe("click",function(){$("credit-card-info").addClassName("hidden_elem");$("submitted_cc").writeAttribute("value","false");$("paypal-info").removeClassName("hidden_elem");$("toggle_paypal_link_container").addClassName("hidden_elem");$("toggle_credit_card_link_container").removeClassName("hidden_elem");$j(".section_header .payment-information-title h2").text(_("Pay with PayPal"));return UpgradeDesign1.setFormPaypalSubmitState(true)})}f=$$("a.toggle_credit_card_link");for(g=0,b=f.length;g<b;g++){k=f[g];k.observe("click",function(){var l;$("credit-card-info").removeClassName("hidden_elem");$("submitted_cc").setValue("true");l=$("paypal-info");if(l){l.addClassName("hidden_elem")}$("toggle_paypal_link_container").removeClassName("hidden_elem");$("toggle_credit_card_link_container").addClassName("hidden_elem");$j(".section_header .payment-information-title h2").text(_("Pay with credit card"));UpgradeDesign1.setFormPaypalSubmitState(false);return $("ccn").focus()})}c=$$("a.change_billing_information");e=[];for(d=0,a=c.length;d<a;d++){k=c[d];e.push(k.observe("click",function(){var m,l,o,n;if($("toggle_paypal_link_container")){$("toggle_paypal_link_container").removeClassName("hidden_elem")}if($("change_billing_information_container")){$("change_billing_information_container").addClassName("hidden_elem")}$("upgrade-form").action="/upgrade";n=$$(".sick-input input");for(l=0,o=n.length;l<o;l++){m=n[l];m.writeAttribute("readOnly",false);m.removeClassName("gray")}if($("country-list")){$("country-list").removeClassName("hidden_elem")}$("expyr").writeAttribute("disabled",false);$("expmo").writeAttribute("disabled",false);$("ccn").writeAttribute("value","");$("zip").writeAttribute("value","");$("ccode").writeAttribute("value","");return $j("div.change_billing_information_container").remove()}))}return e},plan_to_prices:{},plan_to_display_name:{},monthly_packrat_cost:0,yearly_packrat_cost:0,monthly_packrat_display_price:0,yearly_packrat_display_price:0,prorate_amount:0,has_packrat_already:false,plan_box_holder_ids:[],user_current_plan_size:0,user_current_billing_period:"",user_has_downgraded:false,express_yearly_pricing_as_monthly:false,expressYearlyPricingAsMonthly:function(a){return UpgradeDesign1.express_yearly_pricing_as_monthly=a},initializeUpgradeForm:function(e,g,f,h,j,c,i,b,a,d){UpgradeDesign1.user_current_plan_size=e;UpgradeDesign1.user_current_billing_period=g;UpgradeDesign1.user_has_downgraded=f;UpgradeDesign1.monthly_packrat_cost=h;UpgradeDesign1.yearly_packrat_cost=j;UpgradeDesign1.monthly_packrat_display_price=c;UpgradeDesign1.yearly_packrat_display_price=i;UpgradeDesign1.prorate_amount=a;UpgradeDesign1.has_packrat_already=b;return UpgradeDesign1.setFormPaypalSubmitState(d)},registerPrice:function(c,a,b){return UpgradeDesign1.plan_to_prices[c]=[a,b]},registerPlanDisplayName:function(b,a){return UpgradeDesign1.plan_to_display_name[b]=[a]},registerPlanBoxHolderId:function(b,a){UpgradeDesign1.plan_box_holder_ids.push(b);return $(a).observe("click",function(){return UpgradeDesign1.updateSelectedPlanBoxHolder(b)})},updateSelectedPlanBoxHolder:function(d){var c,f,b,e,a;if(!$(d)){return}$(d).addClassName("selected-plan");e=UpgradeDesign1.plan_box_holder_ids;a=[];for(f=0,b=e.length;f<b;f++){c=e[f];if(c!==d){a.push($(c).removeClassName("selected-plan"))}else{a.push(void 0)}}return a},togglePostalCodeBasedOnCountry:function(){var a,b;a=(b=$j("#country-list").val(),__indexOf.call(this.countryCodesWithoutPostalCodes,b)>=0);$j("#zip").prop("disabled",a).closest(".zip-field-with-label").toggleClass("hide-zip",a);if(a){return $j("#zip").val("")}},updateBillingForm:function(w){var E,d,n,m,h,u,l,p,t,y,b,o,x,g,v,r,z,j,C,A,f,c,a,B,F,D,q,k,i,e;C=0;g=100;y=$("packrat");l=UpgradeDesign1.has_packrat_already||((y!=null)&&y.type==="checkbox"&&y.checked);p=_("month");t=UpgradeDesign1.yearly_packrat_display_price;x=$("period-month")?$("period-month").checked:false;r=$j("div.period-selector select");if(r.length){x=r.find(":selected").val()==="month"}UpgradeDesign1.togglePostalCodeBasedOnCountry();if(l){$j(".packrat-holder").addClass("packrat-selected")}else{$j(".packrat-holder").removeClass("packrat-selected")}q=$$("[name='plan']");for(f=0,B=q.length;f<B;f++){h=q[f];if(x){$j(h).parent().parent().find(".plan-pricing.monthly-pricing").removeClass("hidden_elem");$j(h).parent().parent().find(".plan-pricing.yearly-pricing").addClass("hidden_elem");$j(h).parent().parent().find(".plan-pricing.yearly-as-monthly-pricing").addClass("hidden_elem");$j(".yearly-as-monthly-footnote").html("&nbsp;");$j("#billing-footer").addClass("hidden_elem")}else{if(UpgradeDesign1.express_yearly_pricing_as_monthly){$j(h).parent().parent().find(".plan-pricing.monthly-pricing").addClass("hidden_elem");$j(h).parent().parent().find(".plan-pricing.yearly-as-monthly-pricing").removeClass("hidden_elem");$j("#billing-footer").removeClass("hidden_elem");$j(".yearly-as-monthly-footnote").removeClass("hidden_elem").html(_("Billed annually")+"*")}else{$j(h).parent().parent().find(".plan-pricing.monthly-pricing").addClass("hidden_elem");$j(h).parent().parent().find(".plan-pricing.yearly-pricing").removeClass("hidden_elem")}}if(h.checked){g=h.getValue();UpgradeDesign1.updateSelectedPlanBoxHolder("plan-"+g+"-holder")}}if(g===UpgradeDesign1.user_current_plan_size&&!UpgradeDesign1.user_has_downgraded){$j("#current-plan-desc").removeClass("hidden_elem");if((UpgradeDesign1.user_current_billing_period===(x?"month":"year"))&&(UpgradeDesign1.has_packrat_already===l)){$j("#billing-information").addClass("hidden_elem");$j(".charge-and-credit-amount").addClass("hidden_elem");$j(".account-summary").addClass("account-summary-no-charge")}else{$j("#billing-information").removeClass("hidden_elem");$j(".charge-and-credit-amount").removeClass("hidden_elem");$j(".account-summary").removeClass("account-summary-no-charge")}}else{$j("#current-plan-desc").addClass("hidden_elem");$j("#billing-information").removeClass("hidden_elem");$j(".charge-and-credit-amount").removeClass("hidden_elem");$j(".account-summary").removeClass("account-summary-no-charge")}if(x){$j(".billing-periods .monthly .sub-right").addClass("selected-billing-period");$j(".billing-periods .yearly .sub-right").removeClass("selected-billing-period");C=UpgradeDesign1.plan_to_prices[g][0];if(l){C+=UpgradeDesign1.monthly_packrat_cost}t=UpgradeDesign1.monthly_packrat_display_price;p=_("month");j="month"}else{$j(".billing-periods .monthly .sub-right").removeClass("selected-billing-period");$j(".billing-periods .yearly .sub-right").addClass("selected-billing-period");C=UpgradeDesign1.plan_to_prices[g][1];if(l){C+=UpgradeDesign1.yearly_packrat_cost}t=UpgradeDesign1.yearly_packrat_display_price;p=_("year");j="year"}b=$j("#packrat-price").text(CashUtil.formatCurrency(t)+(j==="year"?_("/yr"):_("/mo")));$j(".receipt-summary h2").text(_("Dropbox ")+UpgradeDesign1.plan_to_display_name[g]);A=UpgradeDesign1.plan_to_prices[g][0]*12;if(l){A+=UpgradeDesign1.monthly_packrat_cost*12}u=UpgradeDesign1.plan_to_prices[g][1];if(l){u+=UpgradeDesign1.yearly_packrat_cost}z=A-u;o=z/A*100;o=Math.round(o);E=0;d=0;if(UpgradeDesign1.prorate_amount>=C){E=0;d=C}else{E=C-UpgradeDesign1.prorate_amount;d=UpgradeDesign1.prorate_amount}m=E;if(UpgradeDesign1.user_has_downgraded&&g===UpgradeDesign1.user_current_plan_size&&j===UpgradeDesign1.user_current_billing_period){m=0;d=0}v=$("plan-name");if(v){v.__date(UpgradeDesign1.plan_to_display_name[g])}$j(".summary_price").text(CashUtil.formatCurrency(m));$j(".monthly-price").text(CashUtil.formatCurrency(UpgradeDesign1.plan_to_prices[g][0]+(l?UpgradeDesign1.monthly_packrat_cost:0)));$j(".yearly-price").text(CashUtil.formatCurrency(UpgradeDesign1.plan_to_prices[g][1]+(l?UpgradeDesign1.yearly_packrat_cost:0)));$j(".billing-period-total").text(" "+CashUtil.formatNumber(o,{precision:0})+"% ("+CashUtil.formatCurrency(z)+")");if(d>0){$j(".credit").removeClass("hidden_elem").find(".line-item-amount").text(CashUtil.formatCurrency(-1*d))}else{$j(".credit").addClass("hidden_elem")}if(d){k=$$(".credit-holder");for(c=0,F=k.length;c<F;c++){n=k[c];n.removeClassName("hidden_elem")}return $j(".credit-amount").text(CashUtil.formatCurrency(d))}else{i=$$(".credit-holder");e=[];for(a=0,D=i.length;a<D;a++){n=i[a];e.push(n.addClassName("hidden_elem"))}return e}},runPlanWatcher:function(){var l,d,b,i,j,h,f,m,c,a,k,g,e;k=$$("[name='plan']");for(j=0,m=k.length;j<m;j++){l=k[j];l.observe("click",UpgradeDesign1.updateBillingForm)}g=[100,200,500];i=function(n){return $j("#plan-"+n+"-holder").on("click",function(){$j("[name='plan']").prop("checked",false);$j("#plan-"+n).prop("checked",true);return UpgradeDesign1.updateBillingForm()})};for(h=0,c=g.length;h<c;h++){d=g[h];i(d)}$j("label").on("click",function(n){switch($j(this).attr("for")){case"period-month":case"period-year":$j("#"+$j(this).attr("for")).prop("checked",true);return UpgradeDesign1.updateBillingForm(n);case"plan-100":case"plan-200":case"plan-500":$j("[name='plan']").prop("checked",false);$j("#"+$j(this).attr("for")).prop("checked",true);return UpgradeDesign1.updateBillingForm(n)}});e=$$("[name='period']");for(f=0,a=e.length;f<a;f++){l=e[f];l.observe("click",UpgradeDesign1.updateBillingForm)}b=$("packrat");if(b){b.observe("click",UpgradeDesign1.updateBillingForm)}return $j("#country-list").change(UpgradeDesign1.updateBillingForm)},validateUpgradeFormInputs:function(){return $j(document).ready(function(){$j("div.period-selector select").on("change",function(a){if($j(a.target).find(":selected").val()==="month"){$j(a.target).parent().addClass("monthly");$j(".yearly-discount").addClass("hidden_elem");$j(".upgrade-terms-period").text(_("monthly"))}else{$j(a.target).parent().removeClass("monthly");$j(".yearly-discount").removeClass("hidden_elem");$j(".upgrade-terms-period").text(_("yearly"))}return UpgradeDesign1.updateBillingForm(a)});$j("input:radio[name=payment_method]").on("click",function(a){if($j(a.target).val()==="cc-checked"){$("credit-card-info").removeClassName("hidden_elem");$("paypal-info").addClassName("hidden_elem");return UpgradeDesign1.setFormPaypalSubmitState(false)}else{$("credit-card-info").addClassName("hidden_elem");$("paypal-info").removeClassName("hidden_elem");return UpgradeDesign1.setFormPaypalSubmitState(true)}});if($j("div.period-selector select").find(":selected").val()==="month"){$j("div.period-selector select").parent().addClass("monthly");$j(".yearly-discount").addClass("hidden_elem");$j(".upgrade-terms-period").text(_("monthly"))}else{$j("div.period-selector select").parent().removeClass("monthly");$j(".yearly-discount").removeClass("hidden_elem");$j(".upgrade-terms-period").text(_("yearly"))}UpgradeDesign1.updateBillingForm(null);$j("#ccn").payment("formatCardNumber");$j("#ccode").payment("formatCardCVC");$j("#ccn").focus(function(){return $j("#ccn").removeClass("invalid-input")});$j("#ccode").focus(function(){return $j("#ccode").removeClass("invalid-input")});$j("#expmo").focus(function(){$j("#expmo").removeClass("invalid-input");return $j("#expyr").removeClass("invalid-input")});$j("#expyr").focus(function(){$j("#expyr").removeClass("invalid-input");return $j("#expmo").removeClass("invalid-input")});$j("#zip").focus(function(){return $j("#zip").removeClass("invalid-input")});return $j("#upgrade-button").click(function(h){var d,n,c,m,g,o,k,b,j,a,f,l;n=k=b=j=a=false;$j("#ccn").removeClass("invalid-input");$j("#ccode").removeClass("invalid-input");$j("#expmo").removeClass("invalid-input");$j("#expyr").removeClass("invalid-input");$j("#zip").removeClass("invalid-input");$j("#credit-card-info .ccn-client-side-error").empty();$j("#credit-card-info .card-type-error").empty();$j("#credit-card-info .other-billing-client-side-error").empty();$j("span.error-message").remove();$j("div.upgrade-error-message").remove();try{d=$j.payment.cardType($j("#ccn").val());switch(d){case"visa":n=true;break;case"mastercard":n=true;break;case"amex":n=true;break;default:n=$j("#ccn").val().indexOf("*")===0}k=($j.payment.validateCardNumber($j("#ccn").val()))||($j("#ccn").val().indexOf("*")===0);if(!k){$j("#ccn").addClass("invalid-input");$j("#credit-card-info .ccn-client-side-error").empty().html(_("Please enter a valid credit card number."))}if(k&&!n){$j("#credit-card-info .card-type-error").empty().html(_("Please use a Visa, MasterCard or American Express card."))}if(n){$j("#card_type").val(d)}b=$j.payment.validateCardCVC($j("#ccode").val(),d);b=($j("#ccode").val().indexOf("*")===0)||(d==="amex"?$j("#ccode").val().length===4:b);if(!b){$j("#ccode").addClass("invalid-input")}j=$j.payment.validateCardExpiry($j("#expmo").val(),$j("#expyr").val().substring(2));if(!j){$j("#expmo").addClass("invalid-input");$j("#expyr").addClass("invalid-input")}a=$j("#zip").val()||$u.contains(UpgradeDesign1.countryCodesWithoutPostalCodes,$j("#country-list").val());if(!a){$j("#zip").addClass("invalid-input")}if(!$u.every([b,j,a])){c="Please enter a valid ";m=[];if(!a){m.push("billing ZIP")}if(!b){m.push("security code")}if(!j){m.push("expiration date")}for(g=f=0,l=m.length;f<l;g=++f){o=m[g];c+=o;if(g<m.length-2){c+=", "}else{if(g===m.length-2){c+=" and "}}}c+=".";$j("#credit-card-info .other-billing-client-side-error").empty().html(c)}}catch(h){return false}if($u.every([n,k,b,j,a])){return true}return false})})}};CashUtil={_groupSymbol:",",_decimalSymbol:".",_minusSignSymbol:"-",_currencyFormat:"$%v",set_locale_number_format:function(a,b,c){this._groupSymbol=a!=null?a:",";this._decimalSymbol=b!=null?b:".";this._minusSignSymbol=c!=null?c:"-"},set_currency_format:function(a){this._currencyFormat=a!=null?a:"$%v"},_formatAmountThousandsHelper:function(a){var b;b=Math.abs(parseInt(a)).toFixed(0)+"";if(b.length<=3){return b}return CashUtil._formatAmountThousandsHelper(b.substr(0,b.length-3))+this._groupSymbol+b.substr(b.length-3)},formatCurrency:function(b,a){if(a==null){a=2}return this._currencyFormat.replace("%v",CashUtil.formatNumber(b,a))},formatNumber:function(b,a){if(a==null){a=2}return(b<0?this._minusSignSymbol:"")+CashUtil._formatAmountThousandsHelper(b)+(a>0?this._decimalSymbol+b.toFixed(a).split(".")[1]:"")}};var Photos,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:51,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(h,c,e,l,i,d,a,j,n,b){var g,k,m,f;this.event_metadata_cache=a;this.show_groups=b!=null?b:false;this.initialized=true;this.disable_selection();Util.disable_ie_image_dragging();this._tmpl=HTML.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=HTML.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=i!=null?i.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=j.include_shared_folders;this.show_hidden=j.show_hidden;this.timestamp_edit_enabled=n.timestamp_edit_enabled;this.undo_enabled=n.undo_enabled;this.local_storage_enabled=n.local_storage_enabled;k=DBHistory.deconstruct_url();f="share" in k.qargs;for(m in l){if(l.hasOwnProperty(m)){PhotosSelection.inc_num_loading_events_before_select(f)}}this._init_timeline(h,c,e,l);this._init_lightbox();g=[];if(i!=null){g.push(new PhotoCollection(i,false))}PhotosCollections.init(g,d);PhotosSelection.drag_select_enabled=n.drag_select_enabled;if(j.show_photos_tour){PhotosTour.next()}delete k.qargs.selr;delete k.qargs.share;delete k.qargs.m;if("uuid" in k.qargs){delete k.qargs.uuid;delete k.qargs.id}if(HTML5_HISTORY){DBHistory.replace_state(k.path,k.qargs)}else{if(!Util.url_hash()){DBHistory.push_state("/photos",k.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(Lightbox.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(Lightbox.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(Lightbox.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(Lightbox.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(ContextMenu.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));DBHistory.add_callback("/photos",this._history_change_handler.bind(this));document.observe(PhotoEvent.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(PhotoEvent.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(PhotoTimeline.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(PhotoTimeline.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));$j("#photos-nav-item").on("click",this.show_all_photos.bind(this));$j("#back-to-photos").on("click",this._back_to_photos.bind(this));$j("#back-to-albums").on("click",this._back_to_albums.bind(this));$j("#share-selected").on("click",this._share_selected.bind(this));$j("#clear-selected").on("click",this._clear_selected.bind(this));$j("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){$j("#do-include-shared-folders").prop("checked",true)}else{$j("#dont-include-shared-folders").prop("checked",true)}$j("input[name=shared-folder-pref]").on(($j.browser.msie?"click":"change"),this._change_memory_lane_settings.bind(this));PhotosCollections.listen();PhotosSelection.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));return $(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this))},_select_event:function(i){var d,h,c,g,b,f,a;h=$(i.target).up(".cu-month-header").identify().slice(2);d=this.get_timeline().events.valueFromKey(h);f=d.photos;a=[];for(g=0,b=f.length;g<b;g++){c=f[g];a.push(PhotosSelection._add(c))}return a},_share_event:function(h){var c,g,b,f,a,d;g=$(h.target).up(".cu-month-header").identify().slice(2);c=this.get_timeline().events.valueFromKey(g);d=c.photos;for(f=0,a=d.length;f<a;f++){b=d[f];PhotosSelection._add(b)}return this._share_selected()},_add_event_to_album:function(h){var c,g,b,f,a,d;g=$(h.target).up(".cu-month-header").identify().slice(2);c=this.get_timeline().events.valueFromKey(g);d=c.photos;for(f=0,a=d.length;f<a;f++){b=d[f];PhotosSelection._add(b)}return PhotosCollections.show_add_to_album_modal(h,PhotosSelection.get())},_init_timeline:function(h,c,d,j){var b,k,i,a,l,g,f,e;if(!h.length){this.show_empty_state();return}b=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");g=$("cu-view").cumulativeOffset().top+b.getLayout().get("margin-top")+b.getLayout().get("padding-top");i=$("cu-view").cumulativeOffset().left+b.getLayout().get("margin-left")+b.getLayout().get("padding-left");k={top_offset:g,left_offset:i,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};a={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};l=new PhotoTimeline(b,null,h,c,d,j,this._tmpl,k,a);if(this.in_single_collection_view()){if((f=this._single_collection_timeline)!=null){f.unlisten()}this._single_collection_timeline=l}else{if((e=this._all_photos_timeline)!=null){e.unlisten()}this._all_photos_timeline=l}return this.get_timeline().render()},_init_lightbox:function(){var b,a;if(this.get_timeline()==null){return}if(Lightbox.shown){a=this.get_timeline().get_preview_objs();if(a.length){Lightbox.update_previews(a);b=Math.min(Lightbox.current_index(),a.length-1);return Lightbox.jump_to(b)}else{return Lightbox.back()}}else{return Lightbox.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(b){var a;if((a=this.get_timeline())!=null){a.unlisten()}PhotosSelection.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(b);return window.scrollTo(0,0)},_refresh_photo_events:function(b){var a=this;this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:function(c){var d;d=Util.from_json(c.responseText);if(d==="deleted_collection"){a._current_collection_gid=null;PhotosCollections.reload();a.show_all_collections();Notify.server_error(_("This album has been deleted!"));return}a._init_timeline(d.header_ids,d.header_id_to_name,d.header_id_to_num_photos,{});a._init_lightbox();return typeof b==="function"?b():void 0}})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(a){if(a.duplicates_info!=null){return this._show_duplicates_modal(a,false)}else{return window.open(this._get_browse_link(a),"_blank")}},_get_browse_link:function(a){return"/home"+(Util.urlquote(Util.normalize(Util.parentDir(a.fq_path))))+"?select="+(Util.urlquote(a.filename))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return PhotosCollections.get(this._current_collection_gid)}else{return null}},enable_selection:function(){return Util.enableSelection($(document.body))},disable_selection:function(){return Util.disableSelection($(document.body))},show_collection:function(c){var b,a;PhotosLogger.log_transition_to(PhotosViews.SINGLE_COLLECTION_VIEW);a=DBHistory.deconstruct_url();b="/lightbox";if(a.path.indexOf(b)===0){a.path=a.path.slice(b.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(__indexOf.call(a.path,"/c/")<0){if(a.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(c!=null){a.path=PhotosCollections.get(c).url}return DBHistory.push_state(a.path,a.qargs)},show_all_collections:function(){PhotosLogger.log_transition_to(PhotosViews.ALBUMS_VIEW);return DBHistory.push_state("/photos/all_albums")},show_all_photos:function(b){var a;b.preventDefault();PhotosLogger.log_transition_to(PhotosViews.PHOTOS_VIEW);a=DBHistory.deconstruct_url();if(a.path==="/photos"){return this._refresh_view()}else{PhotosSelection.clear();return DBHistory.push_state("/photos")}},_back_to_photos:function(a){PhotosSelection.clear();return this.show_all_photos(a)},_back_to_albums:function(a){PhotosSelection.clear();return this.show_all_collections()},get_thumb_click_event_data:function(c,a){var b;b=c.event;return{timeline_photo_index:a,event_photo_index:b.photos.indexOf(c),num_photos_in_event:b.photos.length,event_index:this.get_timeline().events.list.indexOf(b.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(b){var a;a=this.get_timeline().get_photo_for_thumb_elm($(b.target));if(PhotosSelection._drag_drop.ignore_next_click){return PhotosSelection._drag_drop.ignore_next_click=false}else{return PhotosSelection.photo_click(b,a)}},_thumb_double_click:function(d){var c,b,a;b=this.get_timeline().get_photo_for_thumb_elm($(d.target));a=this.get_timeline().index_of_photo(b);this._preview(a);c=this.get_thumb_click_event_data(b,a);return PhotosLogger.log_interaction(PhotosEvents.OPEN_LIGHTBOX,PhotosTriggers.DBL_CLICK,c)},_thumb_context_menu:function(g){var c,h,f,b,d,a;c=this.get_timeline().get_photo_for_thumb_elm($(g.target));if(g.shiftKey){PhotosSelection.photo_click(g,c);return}if(PhotosSelection.contains(c)){h=PhotosSelection.get()}else{h=[c]}ContextMenu.show_photos(g,h);a=[];for(f=0,b=h.length;f<b;f++){c=h[f];a.push((d=this.get_timeline().get_thumb_elm_for_photo(c))!=null?d.addClassName("context-selected"):void 0)}return a},_context_menu_hide:function(a){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(b){var a;a=PhotosSelection.get();if(!a.length){return}Foshmodal.show(a,false);return PhotosLogger.log_interaction(PhotosEvents.SHARE,PhotosTriggers.SAH,{num_photos:a.length})},_clear_selected:function(b){var a;a=PhotosSelection.get().length;PhotosSelection.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.SAH,{num_photos:a})},_share_collection:function(b){var a;assert(this.in_single_collection_view(),"_share_collection can only happen in single collection view");a=this.get_current_collection();if(a.num_items===0){Notify.server_error(_("This album is empty. Add some photos before you share it!"));return}Foshmodal.show(this.get_current_collection(),true);return PhotosLogger.log_interaction(PhotosEvents.SHARE_ALBUM,PhotosTriggers.SCA)},toggle_mem_lane_settings:function(a){var c,b;if(a){Event.extend(a).preventDefault()}if(!$j("#memory-lane-settings-menu").visible()){b=$j("#memory-lane-settings-menu");FreshDropdown.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));c=function(d){return d.stopPropagation()};b.off("mousedown");b.off("click");b.on("mousedown",c);return b.on("click",c)}},_change_memory_lane_settings:function(){var a=this;FreshDropdown.hide_all();this.include_shared_folders=$j("#do-include-shared-folders").is(":checked");return new Ajax.DBRequest("/toggle_shared_folder_pref",{parameters:{value:this.include_shared_folders},onSuccess:function(e){var d,h,i,c,g,b,f;if(a.include_shared_folders){Notify.server_success(_("All photos and videos in your Dropbox are now shown."))}else{Notify.server_success(_("Photos and videos from shared folders you joined are no                                    longer shown."))}h=null;c=Util.get_viewport();i=c.top+a.get_timeline().top_offset;f=a.get_timeline().events.getValues();for(g=0,b=f.length;g<b;g++){d=f[g];h=d.unique_id;if((d.top_offset>=i)||(d.top_offset+d.get_height()>=c.bottom)){break}}return a._refresh_photo_events(function(){var l,m,k,j;if(__indexOf.call(a.get_timeline().events.list,h)<0){l=h;j=a.get_timeline().events.list;for(m=0,k=j.length;m<k;m++){h=j[m];if(h<l){break}}}d=a.get_timeline().events.valueFromKey(h);return Util.scroll_to(0,d.top_offset-a.get_timeline().top_offset)})}})},show_delete_photos_modal:function(i){var j,f,c,g,a,b,d,h,e;if(i.length===1){b=i[0];if(b.duplicates_info!=null){this._show_duplicates_modal(b,true);return}}else{j=[];for(d=0,h=i.length;d<h;d++){b=i[d];if(b.duplicates_info!=null){f=b.duplicates_info.slice(0);f.push(b);f.sort(function(l,k){return k.mtime-l.mtime});j=j.concat(f)}}if(j.length){this._show_delete_multiple_duplicates_modal(i,j);return}}e=PhotosUtil.categorize_files(i),g=e[0],a=e[1];if(g&&a){c=ungettext("Delete %(file_count)s file?","Delete %(file_count)s files?",i.length)}else{if(g){c=ungettext("Delete %(file_count)s photo?","Delete %(file_count)s photos?",i.length)}else{c=ungettext("Delete %(file_count)s video?","Delete %(file_count)s videos?",i.length)}}c=c.format({file_count:i.length});DomUtil.fillVal(PhotosUtil.file_desc(i),"delete_filename");return Modal.icon_show("delete_32",c,DomUtil.fromElm("delete-file"),{action:this._delete_photos.curry(i),wit_group:"delete-confirm"})},_delete_photos:function(q){var m,j,d,n,a,b,p,i,g,f,o,c,h,e,k,l=this;q=q.slice(0);p=[];for(g=0,o=q.length;g<o;g++){b=q[g];p.push(b.fq_path);if(b.duplicates_info!=null){h=b.duplicates_info;for(f=0,c=h.length;f<c;f++){d=h[f];p.push(d.fq_path)}}}e=PhotosUtil.categorize_files(q),n=e[0],a=e[1];if(n&&a){j=ungettext("Deleting file","Deleting files",p.length);m=ungettext("Deleted file.","Deleted files.",p.length)}else{if(n){j=ungettext("Deleting photo","Deleting photos",p.length);m=ungettext("Deleted photo.","Deleted photos.",p.length)}else{j=ungettext("Deleting video","Deleting videos",p.length);m=ungettext("Deleted video.","Deleted videos.",p.length)}}k=function(r){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:Util.to_json(r)},html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(s){var t;t=_("Undo complete");Notify.server_success(t);return Photos._all_photos_timeline.restore_removed_photos()}})};i=function(r){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:p},job:p.length>Photos.NUM_PHOTOS_LONG_RUNNING_DELETES,progress_text:j,onSuccess:function(u){var s,v,t;v=u.responseText.evalJSON();t=Photos.undo_enabled&&(Photos._all_photos_timeline!=null);s=t?v.changesets:null;Notify.server_success(m,null,null,s,k);Photos.get_timeline().remove_photos(q);if(r.length>0){return PhotosCollections.refresh_album_views(r)}}})};return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:Util.to_json(p)},onSuccess:function(t){var s,r,u,v;r=Util.from_json(t.responseText);u=[];for(v in r){s=r[v];u=u.concat(s)}return i(u)}})},_preview:function(a){return Lightbox.show(a)},_lightbox_delete:function(a){var b;b=a.memo.photo;PhotosLogger.log_interaction(PhotosEvents.DELETE,PhotosTriggers.LIGHTBOX);return this.show_delete_photos_modal([b])},_lightbox_remove:function(b){var a;a=b.memo.photo;this.get_current_collection().remove_photos([a]);return PhotosLogger.log_interaction(PhotosEvents.REMOVE,PhotosTriggers.LIGHTBOX)},_show_duplicates_modal:function(b,q){var i,p,g,k,j,d,m,c,h,l,a,o,e,n,f;j=b.duplicates_info.slice(0);j.push(b);j.sort(function(s,r){return r.mtime-s.mtime});k=$("cu-duplicate-files");d=[];for(e=0,n=j.length;e<n;e++){g=j[e];p="Dropbox"+Util.normalize(Util.parentDir(g.fq_path));d.push(this._cu_duplicate_tmpl({thumbnail_url:g.thumbnail_url,filename_snippet:g.filename.em_snippet(this.DUPLICATES_SNIPPET_LENGTH),path_snippet:p.em_snippet(this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(g)}))}k.__date(d);if(j.length>=5){k.addClassName("scroll")}else{k.removeClassName("scroll")}f=PhotosUtil.categorize_files([b]),l=f[0],a=f[1];if(l){c=_("There are multiple copies of this photo.");h=_("Delete all copies of this photo?")}else{c=_("There are multiple copies of this video.");h=_("Delete all copies of this video?")}if(q){m="delete_32";o=h;i=c+" "+_("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{m="folder_32";o=_("Show in folder");i=c+" "+_("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}DomUtil.fillVal(i,"cu-duplicates-desc");return Modal.icon_show(m,o,$("cu-duplicates-modal"),{action:this._delete_photos.curry([b])})},_show_delete_multiple_duplicates_modal:function(n,i){var m,g,j,c,b,h,f,k,a,d,l,e;j=$("cu-multiple-duplicate-files");c=[];for(d=0,l=i.length;d<l;d++){g=i[d];m="Dropbox"+Util.normalize(Util.parentDir(g.fq_path));c.push(this._cu_duplicate_tmpl({thumbnail_url:g.thumbnail_url,filename_snippet:g.filename.em_snippet(this.DUPLICATES_SNIPPET_LENGTH),path_snippet:m.em_snippet(this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(g)}))}j.__date(c);if(i.length>=5){j.addClassName("scroll")}else{j.removeClassName("scroll")}e=PhotosUtil.categorize_files(n),k=e[0],a=e[1];if(k&&a){b=_("Delete %(num_files)s files and all copies?").format({num_files:n.length});h=_("There are multiple copies of these files in your Dropbox.");f=_("Show files with multiple copies")}else{if(k){b=_("Delete %(num_photos)s photos and all copies?").format({num_photos:n.length});h=_("There are multiple copies of these photos in your Dropbox.");f=_("Show photos with multiple copies")}else{b=_("Delete %(num_videos)s videos and all copies?").format({num_videos:n.length});h=_("There are multiple copies of these videos in your Dropbox.");f=_("Show videos with multiple copies")}}DomUtil.fillVal(h,"cu-multiple-duplicates-desc");DomUtil.fillVal(f,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return Modal.icon_show("delete_32",b,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(n)})},show_timestamps_modal:function(f){var b,c,d,a,e;f.sort_by_key((function(g){return g.time_taken}),true);a=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){d=f[i];g.push(d.time_taken)}return g})();b=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){d=f[i];g.push(d.item_counter)}return g})();c=(function(){var i,h,g;g=[];for(i=0,h=a.length;i<h;i++){e=a[i];if(!(e!=null)){g.push(e)}}return g})();if(c.length===a.length){return this._show_add_timestamps_modal(f,a,b)}else{if(c.length===0){return this._show_edit_timestamps_modal(f,a,b)}else{return assert(false,"Timestamp modal should only open when all selected photos either have or don't        have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(a,b){var c=this;return this._refresh_photo_events(function(){var d,e;e=("m_"+(b.getFullYear()))+(""+(b.getMonth()+1)).lpad(2);d=c.get_timeline().events.valueFromKey(e);assert(d!=null,"Event is missing after a timestamp edit!");ModalProgress.update("2/3");d.on_load_all_metadata=function(){c.get_timeline().scroll_to_photo_with_key(a.uniqueness_key);ModalProgress.hide();return Notify.server_success("New timestamps have been saved!")};if(d.has_loaded_metadata()){d.on_load_all_metadata();return d.on_load_all_metadata=null}else{return d.load_metadata()}})},_show_add_timestamps_modal:function(f,b,a){var d,c,e=this;c=$j("#add-timestamp-modal");d=new DBCalendar("date_picker",{disable_future:true});return Modal.show("Set Timestamps",c[0],{action:function(){var k,o,m,n,h,j,l,g;m=Util.to_iso8601_date(d.selected_date,false,true);n=(function(){var q,p,i;i=[];for(j=q=0,p=f.length;0<=p?q<p:q>p;j=0<=p?++q:--q){i.push(m)}return i})();h={};for(k=l=0,g=a.length;l<g;k=++l){o=a[k];h[o]=n[k]}ModalProgress.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:Util.to_json(h)},onSuccess:function(i){ModalProgress.update("1/3");return e._scroll_to_photo_after_timestamp_edit(f[0],d.selected_date)}})}})},_show_edit_timestamps_modal:function(j,i,e){var a,h,c,f,g,b,d=this;h=$j("#edit-timestamp-modal");a=(function(){var m,l,k;k=[];for(m=0,l=i.length;m<l;m++){f=i[m];k.push(DateUtil.toUTCDate(new Date(f)))}return k})();c={year:0,month:0,day:0,hour:0};g=function(k){return _("%(date)s at %(time)s").format({date:DateUtil.localize(k),time:DateUtil.format(k,Constants.time_format)})};b=function(k,o,p,n){var m,l;if(k==null){k=0}if(o==null){o=0}if(p==null){p=0}if(n==null){n=0}c.year+=k;c.month+=o;c.day+=p;c.hour+=n;l=Util.incrementDate(new Date(a[0]),c.year,c.month,c.day,c.hour,0);m=Util.incrementDate(new Date(a[a.length-1]),c.year,c.month,c.day,c.hour,0);if(j.length===1){return h.find("#timestamp-new").text(g(l))}else{h.find("#timestamp-new-start").text(g(l));return h.find("#timestamp-new-end").text(g(m))}};if(j.length===1){h.find("#edit-timestamp-single").show();h.find("#edit-timestamp-multi").hide();h.find("#timestamp-current").text(g(a[0]))}else{h.find("#edit-timestamp-single").hide();h.find("#edit-timestamp-multi").show();h.find("#timestamp-current-start").text(g(a[0]));h.find("#timestamp-current-end").text(g(a[a.length-1]))}b();$j("#timestamp-year-plus").on("click",b.curry(1,0,0,0));$j("#timestamp-year-minus").on("click",b.curry(-1,0,0,0));$j("#timestamp-month-plus").on("click",b.curry(0,1,0,0));$j("#timestamp-month-minus").on("click",b.curry(0,-1,0,0));$j("#timestamp-day-plus").on("click",b.curry(0,0,1,0));$j("#timestamp-day-minus").on("click",b.curry(0,0,-1,0));$j("#timestamp-hour-plus").on("click",b.curry(0,0,0,1));$j("#timestamp-hour-minus").on("click",b.curry(0,0,0,-1));Modal.onHide=function(){var k,n,l,m;m=["year","month","day","hour"];for(n=0,l=m.length;n<l;n++){k=m[n];$j("#timestamp-"+k+"-plus").off("click");$j("#timestamp-"+k+"-minus").off("click")}Modal.onHide=null;return Modal.hide()};return Modal.show("Edit Timestamps",h[0],{action:function(){var u,q,k,l,r,w,s,o,v,p,n,m;if((((c.year===(m=c.month)&&m===(n=c.day))&&n===(p=c.hour))&&p===0)){return}PhotosLogger.log_interaction(PhotosEvents.EDIT_TIMESTAMP,PhotosTriggers.PCM,{num_photos:j.length});l=(function(){var y,x,t;t=[];for(y=0,x=a.length;y<x;y++){u=a[y];t.push(Util.incrementDate(u,c.year,c.month,c.day,c.hour,0))}return t})();r=(function(){var y,x,t;t=[];for(y=0,x=l.length;y<x;y++){w=l[y];t.push(Util.to_iso8601_date(w,false,true))}return t})();s={};for(q=o=0,v=e.length;o<v;q=++o){k=e[q];s[k]=r[q]}ModalProgress.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:Util.to_json(s)},job:j.length>d.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,onSuccess:function(t){ModalProgress.update("1/3");return d._scroll_to_photo_after_timestamp_edit(j[0],l[0])}})}})},_preload_file_previews:function(d){var h,c,a,m,j,k,g,f,l,b,e;k=this.get_timeline().get_photos();if(d[0]<=d[d.length-1]){j=null;for(g=0,l=d.length;g<l;g++){h=d[g];a=k[h];if(a.status!==Photo.PLACEHOLDER){continue}m=a.event;if(!(j!=null)){j=m}if(m===j){continue}if(j.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}j.load_metadata();j=m}if((j!=null)&&!j.has_loaded_metadata()){c=j.photos.indexOf(a);if(j.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return j.load_metadata(c)}}else{e=[];for(f=0,b=d.length;f<b;f++){h=d[f];a=k[h];if(a.status!==Photo.PLACEHOLDER){continue}m=a.event;c=m.photos.indexOf(a);e.push(m.load_metadata(c))}return e}},_lightbox_photo_change:function(j){var a,l,g,k,h,f,i,d,c,b;this._last_lightbox_photo=j.memo.preview_obj.photo;a=j.memo.index;g=Lightbox.num_previews();if(a===0||a===g-1){return}if(j.memo.direction===Lightbox.NEXT||!(j.memo.direction!=null)){l=Math.min(a+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,g-1);return this._preload_file_previews((function(){c=[];for(var e=i=a+1;i<=l?e<=l:e>=l;i<=l?e++:e--){c.push(e)}return c}).apply(this))}else{if(j.memo.direction===Lightbox.PREV){k=Math.max(a-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){b=[];for(var e=d=a-1;d<=k?e<=k:e>=k;d<=k?e++:e--){b.push(e)}return b}).apply(this))}}},_lightbox_exit:function(a){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var c,b,d,a;b=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");c=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((d=this._all_photos_timeline)!=null){d.update_offsets(b,c)}return(a=this._single_collection_timeline)!=null?a.update_offsets(b,c):void 0},_history_change_handler:function(n,m){var i,j,k,f,d,g,l,h,e,c,b,a;if(this._init_finished){if(Modal.shown()){Modal.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((h=this.get_timeline())!=null){h.unlisten()}if(n==="all_albums"){this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((e=$("all-albums-sidebar"))!=null){e.addClassName("selected")}PhotosSelection.clear();document.title=_("Albums")+" - Dropbox";PhotosCollections.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(n.startsWith("c/")){i=PhotosCollections.get_from_url("/photos/"+n);c=$$(".sidebar-album");for(g=0,l=c.length;g<l;g++){k=c[g];if(k.readAttribute("data-gid")===i.gid){k.addClassName("selected");break}}$("single-collection-title").__date(i.name.em_snippet(PhotosCollections.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(i.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",i.shmodel_url);if(((b=i.member_fnames)!=null?b.length:void 0)>1){j=_("%(photo_video_desc)s from %(album_members)s").format({photo_video_desc:PhotosUtil.album_desc(i),album_members:Util.nice_list(i.member_fnames)});$("single-collection-share-status").__date(j)}else{$("single-collection-share-status").__date(_("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!i.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+i.name+" - Dropbox";AlbumsLogger.log_event("show_collection",i.gid,i.num_photos,i.is_anonymous)}else{i=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=_("Photos")+" - Dropbox"}f=false;if(i!=null){if(i.gid!==this._current_collection_gid){f=true}}else{if(!(this._all_photos_timeline!=null)){f=true}}this._current_collection_gid=i!=null?i.gid:null;if(f){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){d=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(d);if((a=$(d))!=null){a.addClassName("wiggobble")}setTimeout((function(){return $(d).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var PhotosTour;PhotosTour={_frame:0,next:function(){var a,b=this;Modal.show("",$j("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);a=this._frame;PhotosLogger.log_interaction(PhotosTourEvents.SHOW_MODAL,"",{frame:a});$j("#modal-x").off("click");$j("#modal-x").on("click",(function(){return PhotosLogger.log_interaction(PhotosTourEvents.EXIT_MODAL,"",{frame:a})}));return this._frame=(this._frame+1)%4},hide:function(a){PhotosLogger.log_interaction(a,"");return Modal.hide()}};var PhotosUtil;PhotosUtil={categorize_files:function(b){var c,a;c=b.filter(function(d){return d.preview_type==="photo"});a=b.filter(function(d){return d.preview_type==="video"});return[c.length,a.length]},file_desc:function(f,c,a){var b,e,d;if(c==null){c=false}if(a==null){a=false}d=this.categorize_files(f),b=d[0],e=d[1];return this._photo_video_desc(b,e,c,a)},album_desc:function(c,b,a){if(b==null){b=false}if(a==null){a=false}return this._photo_video_desc(c.num_photos,c.num_videos,b,a)},_photo_video_desc:function(b,g,c,a){var d,f,e;f=ungettext("%d photo","%d photos",b).format(b);e=ungettext("%d video","%d videos",g).format(g);if(b&&g){if(c){d=b+g;return ungettext("%d item","%d items",d).format(d)}else{if(a){return new HTML(""+f+"<br/>"+e)}else{return _("%(num_photos)s and %(num_videos)s").format({num_photos:f,num_videos:e})}}}else{if(b){return f}else{if(g){return e}else{return""}}}}};var PhotosSelection,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){var a=this;$(document.body).on("keydown",function(b){if(b.keyCode===a.SHIFT_KEY_CODE&&a._last_mouseover&&!Util.focus_in_input()){return a._highlight_range(a._last_selected,a._last_mouseover)}});$(document.body).on("keyup",function(b){if(b.keyCode===a.SHIFT_KEY_CODE&&!a._marquee.active){return a.clear_highlighted()}});key("delete, command+backspace, backspace",Photos.KEY_SCOPE,function(b){b.preventDefault();if(Photos.in_single_collection_view()){if(a._selected.length){return PhotosCollections.show_remove_photos_modal(Photos.get_current_collection(),a._selected)}}else{if(a._selected.length){return Photos.show_delete_photos_modal(a._selected)}}});key("esc",Photos.KEY_SCOPE,function(c){var b;if(typeof c.preventDefault==="function"){c.preventDefault()}if(a._drag_drop.active){a._drag_drop.active=false;if((b=$("albums-sidebar-list"))!=null){b.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{a.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.ESC)}});$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document.body).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return DragScroll.init(null,$j("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(b){var a,d,c;d=(function(){var h,f,g,e;g=this._selected;e=[];for(h=0,f=g.length;h<f;h++){a=g[h];e.push(a.uniqueness_key)}return e}).call(this);return c=b.uniqueness_key,__indexOf.call(d,c)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");FreshDropdown.hide_all();return document.fire(PhotosSelection.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(b,a){if(b.isRightClick()&&!b.shiftKey){return}if(b.shiftKey){return this._select_highlighted()}else{if(this.contains(a)){return this._remove(a)}else{return this._add(a)}}},num_selected:function(){return this._selected.length},refresh:function(d){var f,g,c,h,e,b,a;h=(function(){var l,j,k,i;k=this._selected;i=[];for(l=0,j=k.length;l<j;l++){c=k[l];i.push(c.uniqueness_key)}return i}).call(this);a=[];for(e=0,b=d.length;e<b;e++){g=d[e];f=h.indexOf(g.uniqueness_key);if(f>=0){a.push(this._selected[f]=g)}else{a.push(void 0)}}return a},inc_num_loading_events_before_select:function(a){if(!this._show_share_after_loading_selected){ModalProgress.show(_("Loading photos..."))}this._show_share_after_loading_selected=a;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;ModalProgress.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){ModalProgress.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return Photos._share_selected()}}}},_photo_mouseover:function(a){this._last_mouseover=Photos.get_timeline().get_photo_for_thumb_elm($(a.target));if(a.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(a){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(d){var a,b,c;if(Photos.in_all_collections_view()||d.isRightClick()||this._invalid_mouse_target($(d.target))){return}ContextMenu.hide();FreshDropdown.hide_all();a=(c=Photos.get_timeline())!=null?c.get_photo_for_thumb_elm($(d.target)):void 0;if(a!=null){if(this.contains(a)||!PhotosSelection.drag_select_enabled){b=Util.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=d.clientX+b.left;this._drag_drop.start_y=d.clientY+b.top;this._drag_drop.anchor=$(d.target);this._drag_drop.single_photo=this.contains(a)?null:a;this._build_drag_status(a);this._update_drag_status_position(d)}else{this._drag_select.active=true;this._drag_select.anchor=a}}else{b=Util.scroll_offsets();if((d.clientX+b.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=d.clientX+b.left;this._marquee.start_y=d.clientY+b.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return DragScroll.start()},_body_mousemove:function(d){var b,a,f,c;b=Util.scroll_offsets();a=d.clientX+b.left;f=d.clientY+b.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(a-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(f-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=a;this._marquee.end_y=f;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(a-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(f-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(d);$$(".sidebar-album").invoke("removeClassName","album-flash");if((c=$("albums-sidebar-list"))!=null){c.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(c){var b,a;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();b=this._highlighted.length;this._select_highlighted();if(b){PhotosLogger.log_interaction(PhotosEvents.MARQUEE_SELECT,PhotosTriggers.DRAG,{num_selected:b})}}if(this._drag_drop.active){if($(c.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((a=$("albums-sidebar-list"))!=null){a.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return DragScroll.end()},_body_double_click:function(a){if(Photos.get_timeline().get_photo_for_thumb_elm($(a.target))||this._invalid_mouse_target($(a.target))){return}this.clear();return PhotosLogger.log_interaction(PhotosEvents.CLEAR_SELECTED,PhotosTriggers.DBL_CLICK)},_draw_marquee:function(){var a,e,d,c,b;b=Math.abs(this._marquee.start_x-this._marquee.end_x);a=Math.abs(this._marquee.start_y-this._marquee.end_y);d=Math.min(this._marquee.start_y,this._marquee.end_y);e=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:b+"px",height:a+"px",top:d+"px",left:e+"px"});$("marquee").show();c=false;if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);c=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);c=true}if(c){return this._update_marquee_highlight(d,e,b,a)}},_update_marquee_highlight:function(m,c,a,o){var k,l,h,b,g,f,n,j,e,d;this.clear_highlighted();b=[];l=Photos.get_timeline().grid.photo_col_offsets.length;j=Photos.get_timeline().grid.photo_col_offsets.slice(0,l-1);for(k=g=0,n=j.length;g<n;k=++g){h=j[k];if(h<=c+a&&Photos.get_timeline().grid.photo_col_offsets[k+1]>=c){b.push(k)}}d=[];for(k=f=0,e=Photos.get_timeline().events.length();0<=e?f<e:f>e;k=0<=e?++f:--f){d.push(Photos.get_timeline().events.valueAtIndex(k).marquee_highlight(m,m+o,b))}return d},_update_marquee_x_bounds:function(a){var d,g,h,f,c,e,b;g=$(document.body).getWidth();if(a<Photos.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=Photos.get_timeline().grid.photo_col_offsets.first()}else{if(a>Photos.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=Photos.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=g}else{e=Photos.get_timeline().grid.photo_col_offsets;b=[];for(d=f=0,c=e.length;f<c;d=++f){h=e[d];if(h>a){this._marquee.x_min_boundary=Photos.get_timeline().grid.photo_col_offsets[d-1];this._marquee.x_max_boundary=h;break}else{b.push(void 0)}}return b}}},_update_marquee_y_bounds:function(h){var a,e,d,g,c,f,b;d=$(document.body).getHeight();if(h<Photos.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=Photos.get_timeline().grid.photo_row_offsets.first()}else{if(h>Photos.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=Photos.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=d}else{f=Photos.get_timeline().grid.photo_row_offsets;b=[];for(e=g=0,c=f.length;g<c;e=++g){a=f[e];if(a>h){this._marquee.y_min_boundary=Photos.get_timeline().grid.photo_row_offsets[e-1];this._marquee.y_max_boundary=a;break}else{b.push(void 0)}}return b}}},_build_drag_status:function(d){var c,a,b;a=Photos.get_timeline().get_thumb_elm_for_photo(d);b=a.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(b);c=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(PhotosUtil.file_desc(c,false,true))},_update_drag_status_position:function(a){return $("photos-drag-status").setStyle({left:(a.pointerX()-Util.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(a.pointerY()-Util.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(n,m,c){var l,a,d,h,k,j,b,f,g,e;if(c==null){c=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=n;this._last_highlight_to_photo=m;d=Photos.get_timeline().index_of_photo(n);b=Photos.get_timeline().index_of_photo(m);l=!c&&this.contains(m)&&!this.contains(n);e=[];for(h=f=d;d<=b?f<=b:f>=b;h=d<=b?++f:--f){j=Photos.get_timeline().photo_at_index(h);if(j.status===Photo.PLACEHOLDER){if(j.event!==k){a=j.event;if(!a.has_loaded_metadata()){a.on_load_all_metadata=this._highlight_range_incremental.bind(this);a.load_metadata();if(g=a.unique_id,__indexOf.call(this._events_highlighting,g)<0){this._events_highlighting.push(a.unique_id)}e.push(k=a)}else{e.push(void 0)}}else{e.push(void 0)}}else{if(this.contains(j)){if(l){e.push(this._dehighlight(j))}else{e.push(void 0)}}else{if(!l){e.push(this._highlight(j))}else{e.push(void 0)}}}}return e},_highlight_range_incremental:function(a){var h,c,j,e,f,b,g,d;j=this._last_highlight_from_photo;g=this._last_highlight_to_photo;if(!((j!=null)&&(g!=null))){return}c=Photos.get_timeline().index_of_photo(j);b=Photos.get_timeline().index_of_photo(g);for(e=d=c;c<=b?d<=b:d>=b;e=c<=b?++d:--d){f=Photos.get_timeline().photo_at_index(e);if(f.status!==Photo.PLACEHOLDER&&!this.contains(f)&&this._highlighted.indexOf(f)===-1){this._highlight(f)}}h=this._events_highlighting.indexOf(a.unique_id);if(h>=0){this._events_highlighting.splice(h,1)}if(this._select_highlighted_waiting){ModalProgress.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(d){var c,e,b,a;this.clear_highlighted();a=[];for(e=0,b=d.length;e<b;e++){c=d[e];if(!this.contains(c)){a.push(this._highlight(c))}else{a.push(void 0)}}return a},_select_highlighted:function(){var d,g,e,c,b,f,a;if(this._events_highlighting.length>0){ModalProgress.show(_("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}f=this._highlighted;for(g=0,c=f.length;g<c;g++){d=f[g];this._add(d)}a=this._dehighlighted;for(e=0,b=a.length;e<b;e++){d=a[e];this._remove(d)}if(this._select_highlighted_waiting){ModalProgress.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(b){var a;this._highlighted.push(b);a=Photos.get_timeline().get_thumb_elm_for_photo(b);return a!=null?a.addClassName("highlighted"):void 0},_dehighlight:function(b){var a;this._dehighlighted.push(b);a=Photos.get_timeline().get_thumb_elm_for_photo(b);return a!=null?a.addClassName("dehighlighted"):void 0},_add:function(b){var a;assert(b.status!==Photo.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);a=Photos.get_timeline().get_thumb_elm_for_photo(b);if(a!=null){a.addClassName("selected")}this._selected.push(b);this._last_selected=b;DomUtil.fillVal(PhotosUtil.file_desc(this._selected,true),"selected-desc");DomUtil.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(PhotosSelection.CHANGE_EVT)},_remove:function(c){var b,a;a=Photos.get_timeline().get_thumb_elm_for_photo(c);if(a!=null){a.removeClassName("selected")}b=this._selected.indexOf(c);if(b!==-1){this._selected.splice(b,1);this._last_selected=c;if(this._selected.length){DomUtil.fillVal(PhotosUtil.file_desc(this._selected,true),"selected-desc");DomUtil.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(PhotosSelection.CHANGE_EVT)},_invalid_mouse_target:function(c){var a,b;a=c.classNames().toArray().concat(c.up().classNames().toArray());return(__indexOf.call(a,"freshbutton")>=0)||(__indexOf.call(a,"freshbutton-blue")>=0)||(__indexOf.call(a,"freshbutton-lightblue")>=0)||(__indexOf.call(a,"freshbutton-blue-on-gray")>=0)||(__indexOf.call(a,"timeline-elm")>=0)||(c.up(".no-marquee")!=null)||(c.up("#context-menu")!=null)||(c.up(".freshdropdown-menu")!=null)||c.nodeName==="A"||((b=c.tagName.toUpperCase())==="INPUT"||b==="TEXTAREA"||b==="SELECT")||Modal.shown()||$("modal-progress-content").visible()||Lightbox.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var PhotosCollections,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new HTML('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,init:function(b,a){this._collections=b;this._gid_to_collection=b.dict_by("gid");this._url_to_collection=b.dict_by("url");this._collection_list_item_tmpl=HTML.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=HTML.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var a=this;if(!this._all_collections_loaded){return new Ajax.DBRequest("/collections",{allow_retries:true,onSuccess:function(d){var h,g,f,c,e,b;e=Util.from_json(d.responseText);for(f=0,c=e.length;f<c;f++){g=e[f];if(!(g.gid in a._gid_to_collection)&&!(b=g.gid,__indexOf.call(a._removed_pre_load,b)>=0)){h=new PhotoCollection(g,false);a._collections.push(h);a._gid_to_collection[h.gid]=h;a._url_to_collection[h.url]=h}}a._all_collections_loaded=true;return a.refresh_album_views()}})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){var a=this;$("single-collection-title").observe("click",function(b){if(!Photos.get_current_collection().is_creator){return}a.header_rename();return PhotosLogger.log_interaction(PhotosEvents.RENAME_ALBUM,PhotosTriggers.CLICK_TITLE)});$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(ContextMenu.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(PhotoCollection.CREATE_EVT,this._collection_created.bind(this));document.observe(PhotoCollection.ADD_EVT,this._collection_photos_added.bind(this));document.observe(PhotoCollection.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(PhotoCollection.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(PhotoCollection.RENAME_EVT,this._collection_renamed.bind(this));document.observe(PhotoCollection.DELETE_EVT,this._collection_deleted.bind(this));document.observe(PhotoCollection.SHARE_EVT,this._collection_shared.bind(this));document.observe(PhotoCollection.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(PhotoCollection.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var e,b,d,a,c;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}b=[];c=this._collections;for(d=0,a=c.length;d<a;d++){e=c[d];b.push(this._collection_list_item_tmpl({collection:e,additional_class:"albums-list-item show-collection-target"}))}$("albums-list").__date(b);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var f,b,c,e,a,d;b=[];c={name:_("Create new album"),thumbnail_url_256:"/static/images/new_album_big.png"};b.push(this._collection_list_item_tmpl({collection:c,additional_class:"create-album-target",hide_icons:true}));d=this._collections;for(e=0,a=d.length;e<a;e++){f=d[e];b.push(this._collection_list_item_tmpl({collection:f,additional_class:"add-to-album-target"}))}$("add-to-album-modal-list").__date(b);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var h,j,e,i,f,d,b,a,c,g=this;if(!this._all_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();j=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5)});if((f=$("albums-sidebar"))!=null){f.__date(j)}if((d=$("all-albums-sidebar"))!=null){d.observe("click",Photos.show_all_collections)}if((b=$("all-albums-sidebar"))!=null){b.observe("mouseup",function(k){var l;if(!PhotosSelection._drag_drop.active){return}if(PhotosSelection._drag_drop.single_photo!=null){l=[PhotosSelection._drag_drop.single_photo]}else{l=PhotosSelection.get()}g.show_add_to_album_modal(k,l);return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})})}if(Photos.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(Photos.in_single_collection_view()){a=$$(".sidebar-album");c=[];for(e=0,i=a.length;e<i;e++){h=a[e];if(h.readAttribute("data-gid")===Photos.get_current_collection().gid){h.addClassName("selected");break}else{c.push(void 0)}}return c}}},refresh_album_views:function(b){var a,c=this;if(b==null){b=null}a=function(){c.render_all_albums_view();c.render_albums_sidebar();return c.render_add_to_album_modal()};if(b!=null?b.length:void 0){return new Ajax.DBRequest("/collections",{allow_retries:true,parameters:{collection_gids:Util.to_json(b.unique())},onSuccess:function(n){var m,l,e,k,h,g,o,d,j,f;j=Util.from_json(n.responseText);for(h=0,o=j.length;h<o;h++){e=j[h];l=new PhotoCollection(e,false);c._gid_to_collection[l.gid]=l;c._url_to_collection[l.url]=l;f=c._collections;for(k=g=0,d=f.length;g<d;k=++g){m=f[k];if(m.gid===l.gid){c._collections[k]=l;break}}}return a()}})}else{return a()}},show_add_to_album_modal:function(a,b){if(b!==PhotosSelection.get()&&!(PhotosSelection._drag_drop.single_photo!=null)){PhotosSelection._context_selected=b}Modal.onHide=function(){PhotosSelection._context_selected=null;delete Modal.onHide;return Modal.hide()};return Modal.show(_("Choose an album"),$("add-to-album-modal"),false,false,893)},add_photos:function(c,e,b){var a,d;if(b==null){b=true}d=null;if(Photos.in_single_collection_view()){d=Photos.get_current_collection().gid}a=e.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;Notify.server_success(_("Adding to album..."));return c.add_photos(e,d,a,b)},show_remove_photos_modal:function(d,g){var c,a,f,b,e=this;b=PhotosUtil.categorize_files(g),a=b[0],f=b[1];if(a&&f){c=ungettext("Remove %(file_count)s item?","Remove %(file_count)s items?",g.length)}else{if(a){c=ungettext("Remove %(file_count)s photo?","Remove %(file_count)s photos?",g.length)}else{c=ungettext("Remove %(file_count)s video?","Remove %(file_count)s videos?",g.length)}}c=c.format({file_count:g.length});DomUtil.fillVal(PhotosUtil.file_desc(g),"collection-remove-files");DomUtil.fillVal(d.name.escapeHTML(),"collection-remove-name");return Modal.icon_show("delete_32",c,DomUtil.fromElm("collection-remove-modal"),{action:function(){var h;g=g.slice(0);h=g.length>e.NUM_PHOTOS_LONG_RUNNING_REMOVES;return d.remove_photos(g,h)}})},header_rename:function(){if($j("#single-collection-title-container").hasClass("editing")){return}$j("#single-collection-title-container").addClass("editing");return Photos.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(b){var a;DomUtil.fillVal(b.name.escapeHTML(),"collection-delete-name");a=_("Delete album?");return Modal.icon_show("delete_32",a,DomUtil.fromElm("collection-delete-modal"),{action:function(){if(b.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){Notify.server_success(_("Deleting '%(collection_name)s'...").format({collection_name:b.name}),100)}return b["delete"]()}})},show_unshare_modal:function(b){var a;DomUtil.fillVal(b.name.escapeHTML(),"collection-unshare-name");a=_("Unshare album?");return Modal.icon_show("alert_32",a,DomUtil.fromElm("collection-unshare-modal"),{action:function(){return b.unshare()}})},create:function(k,j,o,b){var d,g,c,h,m,n,l,a,i,f=this;if(b==null){b=false}if(k){Event.extend(k).preventDefault();i=$(k.target);if(i.hasClassName("inplaceeditor-form")||(i.up(".inplaceeditor-form")!=null)){return}if(i.up("#context-menu")){d=true}else{if(i.up(".freshdropdown-menu")){c=true}}}Photos.enable_selection();if(!o){o=PhotosSelection.get()}h=(function(){var q,p,e;e=[];for(q=0,p=o.length;q<p;q++){a=o[q];e.push(a.item_counter)}return e})();o.sort_by_key(function(e){return e.time_taken});m=o.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;l=function(p){var s,q,e,r;q=Util.from_json(p.responseText);s=new PhotoCollection(q);PhotosSelection.clear();FreshDropdown.hide_all();ContextMenu.hide();Modal.hide();Photos.disable_selection();r=_("Created '%(collection_name)s'");e=s.name.escapeHTML();r=r.format({collection_name:"<a data-gid='"+s.gid+"' class='show-collection-target'>"+e+"</a>"});Notify.server_success(new HTML(r));return f.flash_sidebar_album(s.gid)};n=function(){if(!c){FreshDropdown.hide_all()}if(!d){ContextMenu.hide()}PhotosCollections.render_albums_sidebar();return Photos.disable_selection()};g=new Ajax.InPlaceEditor(j,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:b,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:n,onFailure:function(){},savingText:_("Creating..."),onLeaveEditMode:Photos.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:l,job:m,progress_text:_("Creating album...")},callback:function(e,q){var p;Notify.server_success(_("Creating album..."));p={collection_name:q,item_counters:Util.to_json(h)};if(Photos.in_single_collection_view()){p.source_collection_gid=Photos.get_current_collection().gid}return p}});g.enterEditMode();if(!b){return g._controls.editor.observe("blur",n)}},toggle_more_selected_actions:function(a){if(a){Event.extend(a).preventDefault()}if(!$("more-selected-actions-menu").visible()){return FreshDropdown.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(a){var b;if(a){Event.extend(a).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(Photos.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(($j.browser.msie!=null)&&$j.browser.msie){b=$j("#more-collection-actions-menu");if(!b.parent().is("body")){$j(document.body).append(b.remove())}}return FreshDropdown.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(a){var b;b=a.memo.collection;if(!b.is_anonymous){this._collections.unshift(b)}this._gid_to_collection[b.gid]=b;this._url_to_collection[b.url]=b;return this.refresh_album_views()},_collection_changed:function(a){this._collections.removeItem(a);this._collections.unshift(a);return this.refresh_album_views()},_collection_photos_added:function(i){var h,f,d,j,k,c,a,b,l,g;h=i.memo.collection;l=i.memo.photos;j=i.memo.num_items_added;c=i.memo.num_photos_added;b=i.memo.num_videos_added;if(i.memo.promote_collection&&j>0){this._collection_changed(h)}else{this.refresh_album_views()}if(l===PhotosSelection.get()){PhotosSelection.clear()}if(j<1){g=PhotosUtil.categorize_files(l),k=g[0],a=g[1];if(k&&a){d=ungettext("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",l.length)}else{if(k){d=ungettext("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",l.length)}else{d=ungettext("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",l.length)}}}else{if(c&&b){d=ungettext("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",l.length)}else{if(c){d=ungettext("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",l.length)}else{d=ungettext("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",l.length)}}}f=h.name.escapeHTML();d=d.format({collection_name:"<a data-gid='"+h.gid+"' class='show-collection-target'>"+f+"</a>"});return Notify.server_success(new HTML(d))},_collection_photos_removed:function(b){var c,d,a;c=b.memo.collection;d=b.memo.photos;a=Photos.undo_enabled?b.memo.undo_changeset:null;Photos.get_timeline().remove_photos(d);this._collection_changed(c);return Notify.server_success(_("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:PhotosUtil.file_desc(d),collection_name:c.name}),null,null,a,(function(){return c.undo_remove(a)}))},_collection_undid_remove:function(a){var b;b=a.memo.collection;Photos.get_timeline().restore_removed_photos();PhotosCollections.refresh_album_views([b.gid]);return Notify.server_success(_("Undo complete"))},_collection_renamed:function(b){var c,a;c=b.memo.collection;if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-title").text(c.name.em_snippet(this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+c.name+" - Dropbox"}this._collection_changed(c);return Notify.server_success(_("Renamed '%(collection_name)s'").format({collection_name:c.name}))},_collection_deleted:function(b){var c,a;c=b.memo.collection;this._collections.removeItem(c);if(!this._all_collections_loaded){this._removed_pre_load.push(c.gid)}this.refresh_album_views();if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){Photos.show_all_collections()}delete this._gid_to_collection[c.gid];delete this._url_to_collection[c.url];return Notify.server_success(_("Deleted '%(collection_name)s'").format({collection_name:c.name}))},_collection_shared:function(b){var c,a;c=b.memo.collection;this._collection_changed(c);if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-share-status").text(_("Shared"));return $j("#single-collection-share-status").attr("href",c.shmodel_url)}},_collection_unshared:function(b){var c,a;c=b.memo.collection;if(((a=Photos.get_current_collection())!=null?a.gid:void 0)===c.gid){$j("#single-collection-share-status").text("")}return Notify.server_success(_("Unshared '%(collection_name)s'").format({collection_name:c.name}))},_collection_cover_changed:function(a){var c,b;c=a.memo.collection;this._collection_changed(c);b=_("Changed cover photo for '%(collection_name)s'");b=b.format({collection_name:c.name.escapeHTML()});return Notify.server_success(b)},_albums_list_item_contextmenu:function(b,a){ContextMenu.show_photo_collection(b,this.get(a.readAttribute("data-gid")),a);a.removeClassName("album-flash");return a.addClassName("context-selected")},_show_collection_click:function(c,a){var b;b=$(c.target);if(b.hasClassName("inplaceeditor-form")||(b.up(".inplaceeditor-form")!=null)){return}return Photos.show_collection(a.readAttribute("data-gid"))},_collection_shmodel_click:function(b,a){return this.go_to_link(this.get(a.readAttribute("data-gid")))},_add_to_album_click:function(b,a){if(PhotosSelection._context_selected){this.add_photos(this.get(a.readAttribute("data-gid")),PhotosSelection._context_selected);PhotosSelection._context_selected=null}else{this.add_photos(this.get(a.readAttribute("data-gid")),PhotosSelection.get())}delete Modal.onHide;Modal.hide();return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_RECENT_ALBUM,PhotosTriggers.SAH,{num_photos:PhotosSelection.get().length})},_drop_target_mouseover:function(b,a){if(PhotosSelection._drag_drop.active){a.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(b,a){if(PhotosSelection._drag_drop.active){a.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(b,a){var c;if(a.hasClassName("hovered")){a.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(PhotosSelection._drag_drop.single_photo!=null){c=[PhotosSelection._drag_drop.single_photo]}else{c=PhotosSelection.get()}if(a.readAttribute("data-gid")!=null){this.add_photos(this.get(a.readAttribute("data-gid")),c,false)}if(a.identify()==="add-to-album-sidebar-new"){return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_NEW_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}else{if(a.identify()==="all-albums-sidebar"){return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_OTHER_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}else{return PhotosLogger.log_interaction(PhotosEvents.ADD_TO_RECENT_ALBUM,PhotosTriggers.DROP_TARGET,{num_photos:PhotosSelection.get().length})}}}},_create_album_click:function(a,b){if(PhotosSelection._context_selected){this.create(a,b.down(".collection-name"),PhotosSelection._context_selected,true);return PhotosSelection._context_selected=null}else{return this.create(a,b.down(".collection-name"),PhotosSelection.get(),true)}},_window_scroll:function(){if(Photos.in_all_collections_view()){return this._all_albums_scroll_position=Util.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(a){return this._url_to_collection[a]},get:function(a){return this._gid_to_collection[a]},go_to_link:function(a){return window.open(a.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(c,b){var a,e,d;a=c.em_snippet(b,1);e=a.lastIndexOf(" ");if(e===-1){return a}else{a=a.slice(0,e+1||9000000000);d=c.slice(e+1).em_snippet(b,1);return a+d}},get_default_album_name:function(){var a;a=_("Untitled album");return this.increment_collection_name_until_valid(a)},collection_name_in_use:function(b){var e,d,a,c;c=this.get_all();for(d=0,a=c.length;d<a;d++){e=c[d];if(e.name===b.trim()){return true}}return false},increment_collection_name_until_valid:function(b){var c,a;c=this.collection_name_in_use(b);a=0;while(c){a++;c=this.collection_name_in_use(b+(" ("+a+")"))}return(a===0?b:b+(" ("+a+")"))},flash_sidebar_album:function(e){var f,d,b,c,a;c=$$(".sidebar-album");a=[];for(d=0,b=c.length;d<b;d++){f=c[d];if(f.readAttribute("data-gid")===e){f.removeClassName("album-flash");f.addClassName("album-flash");break}else{a.push(void 0)}}return a}};var PhotoTimeline;PhotoTimeline=(function(){a.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";a.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";a.prototype.THUMB_SIZE=null;a.prototype.HEADER_HEIGHT=null;a.prototype.THUMBS_PER_ROW=4;a.prototype.RENDER_SCROLL_WAIT=100;a.prototype.RENDER_SCROLL_MAX_WAIT=750;a.prototype.HIDE_TIMELINE_NAV_DELAY=1500;a.prototype.THUMBS_BATCH_SIZE=12;a.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;a.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;a.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;a.prototype.TIMELINE_NAV_ELM_HEIGHT=20;a.prototype.TIMELINE_DOT_HTML=Sprite.html("web","timeline_dot");a.container;a.scroll_container;a.events;a.current_event;a.key_to_photo;a.preview_objs;a.tmpl;a.last_render_scroll_timeout;a.start_render_scroll_time;a.last_scroll_position;a.hide_timeline_nav_timeout;a.grid;a._skip_scroll_update;a.header_id_to_sel_items;a.event_remove_info;a.opts;function a(c,d,g,e,f,h,i,j,b){this.container=c;this.scroll_container=d;this.tmpl=i;this.opts=b;this.THUMB_SIZE=j.thumb_size;this.HEADER_HEIGHT=j.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=h;this.event_remove_info=[];this._init_events(g,e,f);this.update_offsets(j.top_offset,j.left_offset);this.listen();Velocity.start_capture(this.scroll_container)}a.prototype._init_events=function(j,d,f){var c,h,m,e,g,k,b,i,l;if(j.length<1){this.events=new SuperDictionary([],{});return}h=[];g={};m=false;for(i=0,l=j.length;i<l;i++){e=j[i];e=String(e);b=e in this.header_id_to_sel_items?this.header_id_to_sel_items[e]:[];k=false;if(b.length&&!m){m=true;k=true}c=new PhotoEvent(this,e,d[e],f[e],b,k);h.push(e);g[e]=c}return this.events=new SuperDictionary(h,g)};a.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(PhotoEvent.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};a.prototype.unlisten=function(){var c,b,d;if((c=this._body_mousemove_handler)!=null){c.stop()}if((b=this._timeline_elm_click_handler)!=null){b.stop()}if((d=this._show_missing_timestamp_bucket_handler)!=null){d.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(PhotoEvent.EVENT_MISCOUNT_EVT)};a.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};a.prototype.update_offsets=function(d,c){var e,g,f,b;this.top_offset=d;this.refresh_row_offsets();this.left_offset=c;this.grid.photo_col_offsets=[];b=[];for(e=g=0,f=this.THUMBS_PER_ROW;0<=f?g<=f:g>=f;e=0<=f?++g:--g){b.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*e))}return b};a.prototype.refresh_row_offsets=function(){var h,e,d,g,c,f,b;this.grid.photo_row_offsets=[];h=this.top_offset;f=this.events.getValues();b=[];for(g=0,c=f.length;g<c;g++){e=f[g];e.top_offset=h;h+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(h);b.push((function(){var k,i,j;j=[];for(d=k=0,i=e.get_num_rows();0<=i?k<i:k>i;d=0<=i?++k:--k){h+=this.THUMB_SIZE;j.push(this.grid.photo_row_offsets.push(h))}return j}).call(this))}return b};a.prototype._render_empty_grid=function(){var c,f,e,b,d;this.container.__date();d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];if(!(c.is_missing_timestamp_bucket()&&this.events.length()>1)){c.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){f=$j('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(_("Show photos with missing dates"));return $j(this.container).append(f)}};a.prototype._render_viewport=function(e){var c,n,f,m,p,k,j,h,o,d,b,l,i,g;if(e==null){e=false}this.start_render_scroll_time=-1;p=this.get_viewport_info();n=[];l=this.events.getValues();for(k=0,o=l.length;k<o;k++){c=l[k];if(!(c.has_loaded_metadata()||c.loading_metadata||(c.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(c.in_current_viewport(p,false)){n.unshift(c)}else{if(c.in_current_viewport(p,true)){n.push(c)}}}}for(j=0,d=n.length;j<d;j++){c=n[j];i=c.get_photo_range_to_render(p,true),f=i[0],m=i[1];if(m!=null){c.load_metadata(m)}}if(e){p=this.get_viewport_info();g=this.events.getValues();for(h=0,b=g.length;h<b;h++){c=g[h];if(c.in_current_viewport(p,false)){c.timing_stopped_scrolling_on_event=Util.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};a.prototype._load_metadata_for_sel_events=function(){var d,f,b,e,c;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}e=this.header_id_to_sel_items;c=[];for(f in e){b=e[f];d=this.events.valueFromKey(f);if(d!=null){d.load_metadata()}c.push(assert(d!=null,"Missing "+f+" in list of events with selected photos"))}return c};a.prototype._load_visible_photos=function(){var d,f,c,e,b;e=this.events.getValues();b=[];for(f=0,c=e.length;f<c;f++){d=e[f];if(!(d.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){b.push(d.update_photo_divs())}else{b.push(void 0)}}return b};a.prototype._body_mousemove=function(b){if(!this.opts.uses_timeline_nav){return}if((b.clientX+Util.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};a.prototype._timeline_elm_click=function(f,d){var b,c;c=d.readAttribute("data-event-id");if(c){b=this.events.valueFromKey(c)}this._update_timeline_position(b);if(b.is_missing_timestamp_bucket()){PhotosLogger.log_interaction(PhotosViews.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(b)};a.prototype._scroll_to_event=function(d,b){var c;if(b==null){b=false}c=d.top_offset-this.top_offset;if(d&&(Util.scroll_offsets().top!==c)){if(b){return $j("html, body").animate({scrollTop:c},200)}else{this._skip_scroll_update=true;return window.scrollTo(Util.scroll_offsets().left,c)}}};a.prototype._window_scroll=function(){var e,d,h,g,c,f,b,i=this;d=Util.time();BatchThumbLoader.batch_load_thumbs_queue=[];if(this.start_render_scroll_time===-1||d-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=d}h=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),h);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout((function(){return $("timeline-nav").removeClassName("scroll-active")}),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=Util.scroll_offsets().top;Photos.scroll_count++;f=this.events.getValues();b=[];for(g=0,c=f.length;g<c;g++){e=f[g];b.push(e.logged_thumbs_arrived=false)}return b};a.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};a.prototype.init_timeline_nav=function(){var c,e,b,d;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();d=this.events.getValues().reverse();for(e=0,b=d.length;e<b;e++){c=d[e];c.add_to_timeline_nav(c===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};a.prototype._resize_timeline_nav=function(){var b;if(!this.opts.uses_timeline_nav){return}b=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:b+"px"})};a.prototype._update_timeline_position=function(h){var l,i,b,k,f,e,j,c,g,d;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(!(h!=null)){k=this.get_viewport_info();if(this.scroll_container==null){k.top=document.viewport.getScrollOffsets().top}l=k.top+k.height/2;g=this.events.getValues();for(f=0,j=g.length;f<j;f++){b=g[f];if(b.top_offset>l){break}h=b}}if(!(h!=null)||h===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");d=$$(".timeline-elm");for(e=0,c=d.length;e<c;e++){i=d[e];if(i.readAttribute("data-event-id")===h.unique_id){i.addClassName("current");break}}return this.current_event=h};a.prototype._show_hide_timeline_elms=function(){var i,f,d,e,h,c,g,b;if(!this.opts.uses_timeline_nav){return}d=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();f=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();g=$$(".timeline-elm");b=[];for(h=0,c=g.length;h<c;h++){i=g[h];i.show();e=i.cumulativeOffset();if(e.top<f&&e.left<d){b.push(i.hide())}else{b.push(void 0)}}return b};a.prototype._event_miscount=function(b){this.refresh_row_offsets();return this._load_visible_photos()};a.prototype.remove_photos=function(i){var e,g,h,d,c,f,b;i=i.slice(0);this.event_remove_info=[];h={};for(f=0,b=i.length;f<b;f++){d=i[f];g=d.event.unique_id;if(g in h){h[g].push(d)}else{h[g]=[d]}}for(g in h){i=h[g];e=this.events.valueFromKey(g);c=e.remove_photos(i);this.event_remove_info.push({event:e,remove_info:c})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(a.PHOTOS_REMOVED_EVT,this)};a.prototype.restore_removed_photos=function(){var c,q,m,p,n,e,l,j,i,g,o,d,b,k,h,f;PhotosSelection.clear();k=this.event_remove_info.reverse();for(j=0,o=k.length;j<o;j++){q=k[j];c=q.event;n=q.remove_info;if(n.removed_event_index!=null){this.events.insertAtIndex(n.removed_event_index,c.unique_id,c);c.restore()}c.add_photos(n.removed_photos_and_indexes.reverse());h=n.removed_photos_and_indexes;for(i=0,d=h.length;i<d;i++){p=h[i];PhotosSelection._add(p.photo)}}e=null;l=null;f=this.event_remove_info;for(g=0,b=f.length;g<b;g++){q=f[g];c=q.event;n=q.remove_info;m=this.events.indexOfKey(c.unique_id);if(!(e!=null)||e>m){e=m;l=n.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(l!=null){this.scroll_to_photo_with_key(l.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(a.PHOTOS_ADDED_EVT,this)};a.prototype.get_photos=function(){var c,f,e,b,d;f=[];d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];f=f.concat(c.photos)}return f};a.prototype.num_photos=function(){var d,c,f,b,e;c=0;e=this.events.getValues();for(f=0,b=e.length;f<b;f++){d=e[f];c+=d.photos.length}return c};a.prototype.get_preview_objs=function(){var b,c,i,g,f,j,d,h,e;i=[];h=this.events.getValues();for(g=0,j=h.length;g<j;g++){b=h[g];e=b.photos;for(f=0,d=e.length;f<d;f++){c=e[f];i.push(c.preview_obj)}}return i};a.prototype.index_of_photo=function(d){var e,c,g,b,f;c=0;f=this.events.getValues();for(g=0,b=f.length;g<b;g++){e=f[g];if(e===d.event){c+=e.photos.indexOf(d);break}else{c+=e.photos.length}}return c};a.prototype.photo_at_index=function(d){var b,e,g,c,f;b=0;f=this.events.getValues();for(g=0,c=f.length;g<c;g++){e=f[g];if(b+e.photos.length>d){return e.photos[d-b]}else{b+=e.photos.length}}return null};a.prototype.get_thumb_elm_for_photo=function(b){return $(b.uniqueness_key)};a.prototype.get_photo_for_thumb_elm=function(b){if(!b.hasClassName("cu-thumb")){b=b.up(".cu-thumb")}if(b){return this.key_to_photo[b.identify()]}else{return null}};a.prototype.get_viewport_info=function(){var b,c;if(this.scroll_container!=null){c=this.scroll_container.scrollTop;b=this.scroll_container.getHeight();return{top:c,height:b,bottom:c+b}}else{return Util.get_viewport()}};a.prototype.scroll_to_photo_with_key=function(c){var g,d,b,f,e;g=$(c);if(g!=null?g.visible():void 0){Util.scroll_to_thumb(g)}else{b=this.key_to_photo[c];d=b.event;if(b.event!=null){f=Math.floor(d.photos.indexOf(b)/this.THUMBS_PER_ROW);e=this.get_viewport_info().height;Util.scroll_to(0,d.top_offset+this.HEADER_HEIGHT+f*this.THUMB_SIZE-e/2)}}return this._load_visible_photos()};a.prototype.restore_scroll_position=function(){if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};a.prototype.visible_thumbs_loaded=function(){var c,e,b,d;d=this.events.getValues();for(e=0,b=d.length;e<b;e++){c=d[e];if(!c.visible_thumbs_loaded()){return false}}return true};a.prototype.has_missing_timestamp_bucket=function(){var b;b=this.events.getValues();return b[b.length-1].is_missing_timestamp_bucket()};a.prototype.is_missing_timestamp_bucket_shown=function(){var b,c;if(!this.has_missing_timestamp_bucket()){return false}b=this.events.getValues();c=b[b.length-1].unique_id;return $j("#p-"+c).length>0};a.prototype._show_missing_timestamp_bucket=function(b,e){var d,c;if(b==null){b=true}if(e==null){e=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}c=this.events.getValues();d=c[c.length-1];$j("#show-missing-timestamps-button").hide();d.add_html_elements_to(this.container);if(!e){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(d,b);this._render_viewport()}return this.init_timeline_nav()};return a})();var PhotoEvent;PhotoEvent=(function(){a.EVENT_MISCOUNT_EVT="db:photoevent:miscount";a.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";a.prototype.MONTH_PREFIX="m_";a.prototype.COLLECTION_PREFIX="c_";a.prototype.EVENT_PREFIX="e_";a.prototype.MISSING_TIMESTAMP_PREFIX="a_";a.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;a.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;a.timeline;a.unique_id;a.name;a.init_num_photos;a.photos;a.header_html;a.placeholder_html;a.top_offset;a.loading_metadata;a.cursor;a.num_photos_loaded;a.last_photo_to_load;a.on_load_all_metadata;a.init_sel_items;a.scroll_to_first_sel;a.num_to_select;a.logged_thumbs_arrived;a.timing_metadata_received;a.timing_stopped_scrolling_on_event;a.scroll_count;function a(k,g,c,h,b,f){var e,l,d,j;this.timeline=k;this.unique_id=g;this.name=c;this.init_num_photos=h;this.photos=(function(){var m,i;i=[];for(e=m=0;0<=h?m<h:m>h;e=0<=h?++m:--m){i.push(new Photo(this))}return i}).call(this);this.init_sel_items={};for(d=0,j=b.length;d<j;d++){l=b[d];this.init_sel_items[l]=true}this.num_to_select=b.length;this.scroll_to_first_sel=f;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.last_photo_to_load=-1;this.loading_metadata=false;if(h===0){$("single-album-empty").show()}}a.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};a.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};a.prototype.get_month=function(){var b;assert(this.is_month(),"this must be a month event");b=parseInt(this.unique_id.slice(6,8),10);assert(!isNaN(b),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return b};a.prototype.get_year=function(){var b;assert(this.is_month(),"this must be a month event");b=parseInt(this.unique_id.slice(2,6),10);assert(!isNaN(b),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return b};a.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};a.prototype.get_collection_gid=function(){assert(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};a.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};a.prototype._generate_container_html=function(){var e,c,f,h,d,b,g;h=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(h);e=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});e.__date(Sprite.html("web","event_add_to_album"));this.header_html.__sert(e);g=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});g.__date(Sprite.html("web","event_share"));this.header_html.__sert(g);b=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});b.__date(Sprite.html("web","event_select"));this.header_html.__sert(b)}else{this.header_html=new HTML("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+h+"</span></h1>")}c=this.get_content_height();d=this.photos.length%this.timeline.THUMBS_PER_ROW;f=d===0?0:(this.timeline.THUMBS_PER_ROW-d)*this.timeline.THUMB_SIZE;return this.placeholder_html=new HTML('<div style="height: '+c+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+c+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+f+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};a.prototype.add_html_elements_to=function(c){var b;if(this.is_event()){b=new Element("div",{"class":"photo-event"});b.__sert(this.header_html);b.__sert(this.placeholder_html);return c.__sert(b)}else{c.__sert(this.header_html);return c.__sert(this.placeholder_html)}};a.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};a.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};a.prototype.add_to_timeline_nav=function(i){var b,g,j,c,k,f,e,h,d;if(i==null){i=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}d=this.timeline.get_viewport_info().height;k=this.timeline.TIMELINE_NAV_ELM_HEIGHT;f=$(document.body).getHeight();e=this.top_offset/f*100;if(this.is_event()){c=this.name}else{if(this.is_missing_timestamp_bucket()){c=_("Missing dates")}else{c=Util.monthAbrWithYear(this.get_month()-1,this.get_year())}}j=false;for(h in this.timeline.grid.side_nav){b=Math.abs(this.timeline.events.valueFromKey(h).top_offset-this.top_offset);if(b/f*d<k){j=true;if(i){$j("#timeline-nav-"+h).remove()}}}g=$j("#timeline-nav-"+this.unique_id);if(!j||i){if(g.length){g.css("top",""+e+"%")}else{g=$j("<div/>");g.addClass("timeline-elm");g.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});g.css("top",""+e+"%");g.text(c);$j("#timeline-nav").append(g)}return this.timeline.grid.side_nav[this.unique_id]=e}else{if(g.length){return g.remove()}}};a.prototype.marquee_highlight=function(b,i,f){var d,j,c,k,m,e,h,g,l;if(this.top_offset>i||this.top_offset+this.get_height()<b){return}if(b<this.top_offset){i-=this.top_offset;if(i<this.timeline.HEADER_HEIGHT){return}e=0;m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(i>this.top_offset+this.get_height()){b-=this.top_offset;m=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(b<this.timeline.HEADER_HEIGHT){e=0}else{e=Math.floor((b-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{b-=this.top_offset;i-=this.top_offset;if(b<this.timeline.HEADER_HEIGHT&&i<this.timeline.HEADER_HEIGHT){return}else{if(b<this.timeline.HEADER_HEIGHT){e=0;m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{e=Math.floor((b-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);m=Math.floor((i-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(k=h=e;e<=m?h<=m:h>=m;k=e<=m?++h:--h){for(g=0,l=f.length;g<l;g++){d=f[g];j=this.timeline.THUMBS_PER_ROW*k+d;if(j<this.photos.length){c=this.photos[j];if(c.status!==Photo.PLACEHOLDER&&!PhotosSelection.contains(c)){PhotosSelection._highlight(c)}}}}};a.prototype.add_photos=function(e){var d,c,f,g,b;for(g=0,b=e.length;g<b;g++){f=e[g];c=f.photo;d=f.index;assert(d<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(d,0,c);if(c.status>=Photo.LOADED){c.status=Photo.LOADED;this.num_photos_loaded++}}return this._num_photos_changed()};a.prototype.remove_photos=function(j){var g,b,f,h,c,d,i,e;g=this.timeline.events.indexOfKey(this.unique_id);c=[];for(d=0,i=j.length;d<i;d++){b=j[d];f=this.photos.indexOf(b);assert(f>-1,"Photo not found in the photos array!");this.photos.splice(f,1);if(b.status>=Photo.LOADED){this.num_photos_loaded--;if((e=$(b.uniqueness_key))!=null){e.remove()}b.status=Photo.LOADED}PhotosSelection._remove(b);c.push({photo:b,index:f})}this._num_photos_changed();h={removed_photos_and_indexes:c};if(this.photos.length===0){h.removed_event_index=g}return h};a.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};a.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};a.prototype._update_placeholder_container=function(){var c,b;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});b=this.photos.length%this.timeline.THUMBS_PER_ROW;c=b!==0?(this.timeline.THUMBS_PER_ROW-b)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+c+"px"})};a.prototype.load_metadata=function(b){var d,j,e,g,i,c,h,f=this;if((!(b!=null))||(b>this.photos.length-1)||this.num_to_select>0){b=this.photos.length-1}if(this.has_loaded_metadata()||(this.num_photos_loaded>b)){return}if(this.loading_metadata){this.last_photo_to_load=Math.max(this.last_photo_to_load,b);return}e=this.load_cached_metadata();if(e){return}this.loading_metadata=true;i={show_hidden:Photos.show_hidden};if(this.cursor!=null){i.cursor=this.cursor}i.limit=b+1-this.num_photos_loaded;if(i.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){this.last_photo_to_load=b;i.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){c=this.unique_id.split("_");d=c[2];j=c[1];i.filters=Util.to_json({date_begin:d,date_end:j})}else{if(this.is_missing_timestamp_bucket()){i.filters=Util.to_json({other:true})}else{if(this.is_month()){h=this.get_year();g=this.get_month();d=Util.to_iso8601_date(new Date(h,g-1,1,0,0,0,0),false,true);j=Util.to_iso8601_date(new Date(h,g,1,0,0,0),false,true);i.filters=Util.to_json({date_begin:d,date_end:j})}else{if(this.is_collection()){i.filters=Util.to_json({collection_gid:this.get_collection_gid()})}else{assert(false,"invalid photo event id: "+this.unique_id)}}}}return new Ajax.DBRequest("/photos_event_metadata",{parameters:i,allow_retries:true,onSuccess:function(k){var l;l=Util.from_json(k.responseText);f.timing_metadata_received=Util.time();f.cursor=l.cursor;return f._load_metadata_callback(l.photos,l.key_to_duplicates,(l.more!=null)&&l.more)}})};a.prototype.load_cached_metadata=function(){var b,c;if(this.loading_metadata||this.num_photos_loaded>0||!(((c=Photos.event_metadata_cache)!=null?c[this.unique_id]:void 0)!=null)){return false}b=Photos.event_metadata_cache[this.unique_id];this.cursor=b.cursor;this._load_metadata_callback(b.photos,b.key_to_duplicates,b.more);return true};a.prototype._load_metadata_callback=function(r,n,l){var k,o,e,c,d,q,b,p,g,j,h,m,f;e=[];b=[];g=false;for(k=j=0,m=r.length;j<m;k=++j){q=r[k];if(this.num_photos_loaded===this.photos.length){d=new Photo(this);this.photos.push(d);g=true}else{if(this.num_photos_loaded<this.photos.length){d=this.photos[this.num_photos_loaded]}else{assert(false,"num_photos_loaded should never be greater than photos.length")}}d.init_metadata(q);if(d.uniqueness_key in n){d.set_duplicates(n[d.uniqueness_key])}if(k<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){b.push(d.preview_obj)}e.push(d)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var u,t,s,i;i=[];for(t=0,s=b.length;t<s;t++){u=b[t];i.push(u.preload())}return i}),500)}PhotosSelection.refresh(e);for(h=0,f=e.length;h<f;h++){d=e[h];if(d.item_counter in this.init_sel_items){PhotosSelection._add(d);this.num_to_select--;if(this.num_to_select===0){PhotosSelection.dec_num_loading_events_before_select()}delete this.init_sel_items[d.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;p=this.timeline;o=d.uniqueness_key;$j(document).ready(function(){return p.scroll_to_photo_with_key(o)})}}}if(!l){if(this.num_photos_loaded<this.photos.length){c=this.photos.length-this.num_photos_loaded;this.photos.splice(this.num_photos_loaded,c)}if(g||c){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(a.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.last_photo_to_load>this.num_photos_loaded-1){return this.load_metadata(this.last_photo_to_load)}};a.prototype._fix_photo_miscount=function(){var d,c,b;d=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);c=this.get_num_rows()-d;if(typeof PhotosLogger!=="undefined"&&PhotosLogger!==null){PhotosLogger.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}b=Util.scroll_offsets().top;if(this.top_offset+this.get_height()<b){Util.scroll_to(0,b+c*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(a.EVENT_MISCOUNT_EVT,this)};a.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};a.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};a.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};a.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};a.prototype.visible_thumbs_loaded=function(d){var h,g,c,b,f,e;if(d==null){d=this.timeline.get_viewport_info()}e=this.get_photo_range_to_render(d,false),h=e[0],g=e[1];if(h===null&&g===null){return true}for(b=f=h;h<=g?f<=g:f>=g;b=h<=g?++f:--f){c=this.photos[b];if(!(c!=null)||!(c.status>=Photo.RENDERED)){return false}}return true};a.prototype.update_photo_divs=function(){var d,c,s,r,w,z,t,o,i,A,q,x,m,j,g,e,B,C,b,y,p,n,l,h,f,k,v,u;if(!this.num_photos_loaded){return}x=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(x)){return}y=this.get_photo_range_to_render(x),s=y[0],r=y[1];assert((s!=null)&&(r!=null),"This line is after @hide_photos_if_not_in_      current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&r>this.num_photos_loaded-1){this.load_metadata(r);r=this.num_photos_loaded-1;if(s>this.num_photos_loaded-1){return}}z=Math.floor(s/this.timeline.THUMBS_PER_ROW);q=z*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:q+"px"});w=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(r/this.timeline.THUMBS_PER_ROW);c=w*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:c+"px"});this._hide_photos((function(){k=[];for(var D=0;0<=s?D<s:D>s;0<=s?D++:D--){k.push(D)}return k}).apply(this));this._hide_photos((function(){v=[];for(var D=p=r+1,E=this.num_photos_loaded;p<=E?D<E:D>E;p<=E?D++:D--){v.push(D)}return v}).apply(this));this._show_photos((function(){u=[];for(var D=s;s<=r?D<=r:D>=r;s<=r?D++:D--){u.push(D)}return u}).apply(this));l=PhotosSelection.get();for(e=0,B=l.length;e<B;e++){o=l[e];if((h=$(o.uniqueness_key))!=null){h.addClassName("selected")}}this.scroll_count=Photos.scroll_count;d=[];f=this.get_thumb_indexes_to_load(x);for(b=0,C=f.length;b<C;b++){i=f[b];o=this.photos[i];if((o!=null)&&o.status>=Photo.RENDERED){A=$(o.uniqueness_key);if((A!=null?A.down("img"):void 0)!=null){d.push(A.down("img"))}}}t=function(D){return D.up(".cu-thumb").addClassName("thumb-loaded")};return BatchThumbLoader.batch_load_thumbs(d,this.timeline.THUMBS_BATCH_SIZE,t,this.log_thumb_load.bind(this))};a.prototype._hide_photos=function(f){var d,e,c,b;b=[];for(e=0,c=f.length;e<c;e++){d=f[e];b.push(this._hide_photo(d))}return b};a.prototype._hide_photo=function(b){var c;c=this.photos[b];if(!(c!=null)||!(c.status===Photo.DISPLAYED)){return}$(c.uniqueness_key).hide();return c.status=Photo.RENDERED};a.prototype._show_photos=function(s){var o,n,r,f,p,l,e,m,k,h,g,q,d,c,b,j;f=[];for(m=0,q=s.length;m<q;m++){n=s[m];p=this._get_photo_insert_info(n);if(!p){continue}r=p[0],e=p[1];l=false;for(k=0,d=f.length;k<d;k++){o=f[k];if(o.after===r){o.photos.push(e);l=true;break}}if(!l){f.push({after:r,photos:[e]})}}for(h=0,c=f.length;h<c;h++){o=f[h];o.after.__sert({after:o.photos})}j=[];for(g=0,b=s.length;g<b;g++){n=s[g];j.push(this.photos[n].status=Photo.DISPLAYED)}return j};a.prototype._get_photo_insert_info=function(b){var e,c,d,j,f,h,g;d=this.photos[b];if(!(d!=null)||d.status===Photo.DISPLAYED){return}if(d.status===Photo.RENDERED){$(d.uniqueness_key).show()}else{c=$("p-top-"+this.unique_id);if(b!==0){for(e=h=g=b-1;g<=0?h<=0:h>=0;e=g<=0?++h:--h){j=this.photos[e];if((j!=null)&&j.status>=Photo.RENDERED){f=$(j.uniqueness_key);assert(f!=null,"photo "+e+" was marked as rendered, but its thumb elm doesn't exist");c=f;break}}}return[c,d.thumb_html]}};a.prototype.in_y_range=function(c,b){return !(this.top_offset+this.timeline.HEADER_HEIGHT>b||this.top_offset+this.get_height()<c)};a.prototype.in_current_viewport=function(d,f){var b,c,e;if(d==null){d=this.timeline.get_viewport_info()}if(f==null){f=true}c=d.top;b=d.top+d.height;if(f){e=this._blur_range(c,b,d),c=e[0],b=e[1]}return this.in_y_range(c,b)};a.prototype.hide_photos_if_not_in_current_viewport=function(c){var b,e,d;if(!this.in_current_viewport(c)){for(b=e=0,d=this.num_photos_loaded;0<=d?e<d:e>d;b=0<=d?++e:--e){this._hide_photo(b)}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};a.prototype._blur_range=function(e,b,g){var d,c,f;if(g==null){g=this.timeline.get_viewport_info()}f=Velocity.get();if(f>=0){c=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;d=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(f<0){c=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;d=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}e-=c*g.height;b+=d*g.height;return[e,b]};a.prototype.get_photo_range_to_render=function(j,d){var h,c,g,i,f,b,e;if(d==null){d=true}b=j.top;f=j.bottom;if(d){e=this._blur_range(b,f,j),b=e[0],f=e[1]}if(!this.in_y_range(b,f)){return[null,null]}i=Math.floor((b-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);h=Math.floor((f-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);c=Math.min(this.photos.length-1,i*this.timeline.THUMBS_PER_ROW);g=Math.min(this.photos.length-1,(h+1)*this.timeline.THUMBS_PER_ROW-1);assert(!isNaN(g),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+j.bottom+" ")+("viewport_data.height="+j.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+h+" "),true,["photo_event_nan_limit"]);return[Math.max(0,c),g]};a.prototype.get_photo_range_to_render_with_blur=function(e){var c,h,d,g,f,b;f=this.get_photo_range_to_render(e,true),h=f[0],g=f[1];b=this.get_photo_range_to_render(e,false),c=b[0],d=b[1];return[h,c,d,g]};a.prototype.get_thumb_indexes_to_load=function(o){var v,l,j,i,s,u,r,t,p,f,d,c,b,q,h,g,e,n,m,k;q=this.get_photo_range_to_render_with_blur(o),l=q[0],v=q[1],j=q[2],i=q[3];if(v==null){s=(function(){e=[];for(var w=l;l<=i?w<=i:w>=i;l<=i?w++:w--){e.push(w)}return e}).apply(this);if(this.top_offset>o.bottom){return s}else{return s.reverse()}}t=(function(){n=[];for(var w=v;v<=j?w<=j:w>=j;v<=j?w++:w--){n.push(w)}return n}).apply(this);u=[];r=[];if(l<v){u=(function(){m=[];for(var w=h=v-1;h<=l?w<=l:w>=l;h<=l?w++:w--){m.push(w)}return m}).apply(this)}if(i>j){r=(function(){k=[];for(var w=g=j+1;g<=i?w<=i:w>=i;g<=i?w++:w--){k.push(w)}return k}).apply(this)}p=Velocity.get();if(p>=0){return t.concat(r).concat(u)}else{return t.concat(u).concat(r)}};a.prototype.log_thumb_load=function(c,d){var f,b,e;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===Photos.scroll_count&&!this.logged_thumbs_arrived){if((c+1)%this.timeline.THUMBS_PER_ROW===0||c+1===d){if(this.visible_thumbs_loaded()){b=this.timeline.get_viewport_info();f=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<b.bottom&&b.bottom<this.top_offset+this.get_height())||f){if(Photos.scroll_count<2&&((e=PhotosLogger.get_current_view())===PhotosViews.PHOTOS_VIEW||e===PhotosViews.CAMERA_VIEW)){this.log_timing_event(PhotosTimingEvents.viewport_initial_load);Photos.scroll_count+=2}else{this.log_timing_event(PhotosTimingEvents.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};a.prototype.log_timing_event=function(e){var b,c,f,d;c=Util.time();b={};if(e===PhotosTimingEvents.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(d=performance.timing)!=null?d.navigationStart:void 0:void 0)!=null){f=Util.time()-performance.timing.navigationStart;b={current_view:PhotosLogger.get_current_view()};WebTimingLogger.log_ajax_transition(f,e,b,e)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(e===PhotosTimingEvents.viewport_loaded){f=c-this.timing_stopped_scrolling_on_event}return WebTimingLogger.log_ajax_transition(f,e,b,e)};return a})();var Photo;Photo=(function(){a.PLACEHOLDER=0;a.LOADED=1;a.RENDERED=2;a.DISPLAYED=3;a.uniqueness_key;a.item_counter;a.filename;a.ns_id;a.ns_path;a.fq_path;a.href;a.thumbnail_url;a.large_thumbnail_url;a.time_taken;a.display_time_taken;a.preview_type;a.mtime;a.block_hash;a.is_visible;a.event;a.status;a.thumb_html;a.preview_obj;a.duplicates_info;function a(b){this.event=b;this.status=a.PLACEHOLDER;this.preview_obj=b.unique_id}a.prototype.init_metadata=function(b){this.uniqueness_key=b.uniqueness_key;this.item_counter=b.item_counter;this.filename=b.filename;this.ns_id=b.ns_id;this.ns_path=b.ns_path;this.fq_path=b.path;this.href=b.href;this.thumbnail_url=b.thumbnail_url;this.large_thumbnail_url=b.large_thumbnail_url;this.time_taken=b.time_taken;this.display_time_taken=b.display_time_taken;this.preview_type=b.preview_type;this.mtime=b.mtime;this.block_hash=b.block_hash;this.is_visible=b.is_visible;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true});this.preview_obj=this._get_preview_obj();this.status=a.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};a.prototype.set_duplicates=function(d){var c,e,b;for(e=0,b=d.length;e<b;e++){c=d[e];c.fq_path=c.path}return this.duplicates_info=d};a.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(Photos.in_single_collection_view()){return new SingleCollectionPhotoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:this.href+"&dl=1",original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new AllPhotosPhotoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:this.href+"&dl=1",original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(Photos.in_single_collection_view()){return new SingleCollectionVideoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:"https://"+Constants.LIVE_TRANSCODE_SERVER+"/transcode_video/w/"+this.block_hash+(Util.urlquote(this.fq_path)),dl_url:this.href+"&dl=1",display_time:this.display_time_taken,photo:this})}else{return new AllPhotosVideoPreview({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:"https://"+Constants.LIVE_TRANSCODE_SERVER+"/transcode_video/w/"+this.block_hash+(Util.urlquote(this.fq_path)),dl_url:this.href+"&dl=1",display_time:this.display_time_taken,photo:this})}}}return null};a.prototype._get_display_date=function(){var b;if(this.time_taken!=null){b=new Date(this.time_taken);return Util.niceDateWithMonthName(b,b.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return a})();var PhotoCollection;PhotoCollection=(function(){a.CREATE_EVT="db:photocollection:create";a.ADD_EVT="db:photocollection:add";a.REMOVE_EVT="db:photocollection:remove";a.UNDO_REMOVE_EVT="db:photocollection:undo_remove";a.RENAME_EVT="db:photocollection:rename";a.DELETE_EVT="db:photocollection:delete";a.SHARE_EVT="db:photocollection:share";a.UNSHARE_EVT="db:photocollection:unshare";a.COVER_CHANGE_EVT="db:photocollection:cover_change";a.gid;a.name;a.num_items;a.num_photos;a.num_videos;a.thumbnail_url_32;a.thumbnail_url_256;a.is_anonymous;a.share_tkey;a.shmodel_url;a.short_url;a.is_creator;a.member_fnames;function a(c,b){if(b==null){b=true}assert((c.gid!=null)&&(c.url!=null)&&(c.name!=null)&&(c.num_items!=null)&&(c.num_photos!=null)&&(c.num_videos!=null),"missing required PhotoCollection params");this.gid=c.gid;this.url=c.url;this.name=c.name;this.num_items=c.num_items;this.num_photos=c.num_photos;this.num_videos=c.num_videos;this.thumbnail_url_32=c.thumbnail_url_32||null;this.thumbnail_url_256=c.thumbnail_url_256||null;this.is_anonymous=c.is_anonymous!=null?c.is_anonymous:false;this.share_tkey=c.share_tkey||null;this.shmodel_url=c.shmodel_url||null;this.short_url=c.short_url||null;this.is_creator=c.is_creator!=null?c.is_creator:true;this.member_fnames=c.member_fnames||[_("You")];if(b){document.fire(a.CREATE_EVT,{collection:this})}}a.prototype.add_photos=function(i,h,d,f){var b,e,c,g=this;if(h==null){h=null}if(d==null){d=false}if(f==null){f=true}b=(function(){var l,k,j;j=[];for(l=0,k=i.length;l<k;l++){c=i[l];j.push(c.item_counter)}return j})();assert(b.length,"Have to add at least one photo");e={collection_gid:this.gid,item_counters:Util.to_json(b)};if(h!=null){e.source_collection_gid=h}return new Ajax.DBRequest("/collection_add",{parameters:e,job:d,progress_text:_("Adding to album..."),onSuccess:function(l){var j,m,k,n;n=Util.from_json(l.responseText);g.thumbnail_url_32=n.thumbnail_url_32;g.thumbnail_url_256=n.thumbnail_url_256;m=n.new_num_photos-g.num_photos;k=n.new_num_videos-g.num_videos;j=n.new_num_items-g.num_items;g.num_photos=n.new_num_photos;g.num_videos=n.new_num_videos;g.num_items=n.new_num_items;return document.fire(a.ADD_EVT,{collection:g,photos:i,num_items_added:j,num_photos_added:m,num_videos_added:k,promote_collection:f})}})};a.prototype.remove_photos=function(f,d){var b,c,e=this;if(d==null){d=false}b=(function(){var i,h,g;g=[];for(i=0,h=f.length;i<h;i++){c=f[i];g.push(c.item_counter)}return g})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:Util.to_json(b),is_shared:this.share_tkey!=null,num_items:this.num_items},job:d,progress_text:_("Removing from album..."),onSuccess:function(g){var h;h=Util.from_json(g.responseText);e.thumbnail_url_32=h.thumbnail_url_32;e.thumbnail_url_256=h.thumbnail_url_256;e.num_photos=h.new_num_photos;e.num_videos=h.new_num_videos;e.num_items=h.new_num_items;return document.fire(a.REMOVE_EVT,{collection:e,photos:f,undo_changeset:h.undo_changeset})}})};a.prototype.undo_remove=function(c){var b=this;return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:c},html_in_error_msg:true,progress_text:_("Undoing..."),onSuccess:function(){return document.fire(a.UNDO_REMOVE_EVT,{collection:b})}})};a.prototype.rename=function(c){var b,d=this;Photos.enable_selection();b=new Ajax.InPlaceEditor(c,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return $j("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:_("Saving..."),onLeaveEditMode:Photos.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:function(e){d.name=e.responseText;return document.fire(a.RENAME_EVT,{collection:d})}},callback:function(e,f){return{collection_gid:d.gid,new_collection_name:f,is_shared:d.share_tkey!=null}}});return b.enterEditMode()};a.prototype["delete"]=function(){var b=this;if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey)}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},onSuccess:function(){return document.fire(a.DELETE_EVT,{collection:b})}})};a.prototype.attach_to_token=function(d,g,c,f,b){var e=this;return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:d,collection_gid:this.gid,num_items:this.num_items},onSuccess:function(){e.share_tkey=d;e.shmodel_url=g;e.short_url=c;if(typeof f==="function"){f()}return document.fire(a.SHARE_EVT,{collection:e})},onFailure:function(){return typeof b==="function"?b():void 0}})};a.prototype.send_link=function(j,c,b,h,g,e){var i,d,f=this;i=function(){f.share_tkey=c;f.shmodel_url=b;f.short_url=h;if(typeof g==="function"){g()}return document.fire(a.SHARE_EVT,{collection:f})};d={collection_gid:this.gid,share_tkey:c,num_items:this.num_items};return Forms.ajax_submit(j,"/collection_share",i,e,j.down(".tokenizer-submit-button"),d)};a.prototype.unshare=function(){var b=this;assert(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:function(){b.share_tkey=null;b.shmodel_url=null;b.short_url=null;return document.fire(a.UNSHARE_EVT,{collection:b})}})};a.prototype.set_cover=function(b){var c=this;return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:b.item_counter},onSuccess:function(d){var e;e=Util.from_json(d.responseText);c.thumbnail_url_32=e.thumbnail_url_32;c.thumbnail_url_256=e.thumbnail_url_256;return document.fire(a.COVER_CHANGE_EVT,{collection:c})}})};return a})();var FilePreview;FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,init_pdf:function(e,c,b){var a,d,f=this;this._log_pdf_render_time(e);if(e==="pdf-embedded"||e==="pdf-js"){Util.smart_window_load(function(){return f._fire_pdf_render_event()});if($j.browser.chrome){d=function(){var g;g=$j('link[rel="shortcut icon"]').remove();return $j("head").append(g)};setTimeout(d,1000)}a=$$("#pdf-embed-container iframe");return window.setTimeout((function(){return a.invoke("setStyle",{visibility:"visible"})}),200)}},init_font:function(){var a=this;return Util.smartLoad(function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}})},init_photo:function(d,g){var i,e,h,f,c,a,b;$("preview-img").observe("error",this._preview_failed.bind(this));if(IE7_OR_LESS){$(document.body).removeClassName("preview-photo");Util.smartLoad(this.resize_preview_img.bind(this));setInterval(this.resize_preview_img,500)}if((f=window.performance)!=null?(c=f.timing)!=null?c.navigationStart:void 0:void 0){$("preview-img").observe("load",function(){var j;j=Util.time()-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(j,"file-preview-photo")})}$("full-img").src=d;a=$$("#preview-img, #full-img");b=[];for(e=0,h=a.length;e<h;e++){i=a[e];i.setAttribute("data-original-href",g);b.push(i.on("contextmenu","img",ContextMenu.show_shmodel.bind(ContextMenu)))}return b},init_text:function(g,b,i,e){var a,d,f,h,c=this;if(e==null){e=true}a=0;f=function(k){var j;if(!k.responseText){return}j=k.responseText.length;if(a===0&&j>c.PARTIAL_TEXT_LENGTH_THRESHOLD){h(k.responseText,true);return a=j}};d=function(j){return h(j.responseText)};window.got_text=function(j){if(j){j=Util.decode_b64(j)}return h(j)};h=function(j,k){var l,m;if(!j||!j.length){$("code-wrapper").remove();return}$j("#code-loading").hide();if(typeof i==="function"){i()}l=$("code").className;m=j.substring(a);$("code").appendChild(document.createTextNode(m));if(b&&!k){SyntaxHighlighter.defaults.toolbar=false;SyntaxHighlighter.defaults["quick-code"]=false;SyntaxHighlighter.highlight($("code"))}return window.filled_text=1};return Util.smartLoad(function(){var j,k;j=function(){return Util.add_script(Util.add_qstring(g,{js_callback:"got_text",b64:"1"}))};if(Prototype.BrowserFeatures.DB_CORS){k={method:"GET",parameters:{},log_timing:true,onInteractive:f,onSuccess:d,onFailure:j};if(e){k.withCredentials=true}new Ajax.DBRequest(g,k)}else{j()}return setTimeout((function(){if(!window.filled_text){return c._preview_failed()}}),10000)})},init_htmlified:function(){var a=this;if(window.htmlified_height){htmlified_loaded();return}if(!window.postMessage){this._preview_failed();return}return setTimeout((function(){if(!window.htmlified_height){return a._preview_failed()}}),10000)},htmlified_loaded:function(){var a;if((a=$("htmlified-loading"))!=null){a.remove()}$("htmlified").style.height=window.htmlified_height+"px";return $("htmlified").style.visibility=""},init_video:function(f,b,d,g,h,a){var i,c,e=this;if(a){c=(Util.viewport_dimensions().width-a)*0.9}else{c=Util.viewport_dimensions().width*0.9}i=c*0.55;return Util.smartLoad(function(){var j;j=e._preview_failed;if(g==="hls"){return VideoUtil.embed("#video",{src:d,type:"application/vnd.apple.mpegurl",width:c,height:i,controls:true,poster:h,onError:j})}else{if(f){$("video").__date();if(b){return VideoUtil.embed("#video",{src:d,type:"video/mp4",width:c,height:i,controls:true,poster:h,onError:j})}else{return j()}}else{if(FlashDetect.installed){$("video").__date();return VideoUtil.embed("#video",{src:d,type:"video/flv",width:c,height:i,controls:true,poster:h,onError:j})}else{return j()}}}})},photo_loaded:function(c){var b,a;if((b=window.performance)!=null?(a=b.timing)!=null?a.navigationStart:void 0:void 0){c=c-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(c,"file-preview-photo")}},resize_preview_img:function(){var c,b,a;c=document.viewport.getDimensions();a=(c.width-56)+"px";b=(c.height-103)+"px";return $("preview-img").setStyle({maxHeight:b,maxWidth:a})},_preview_failed:function(){var a;a=$j(document.body);if(a.hasClass("shmodel-body")){a.removeClass("file-preview-body")}return Notify.server_error(_("Video preview failed."))},_fire_pdf_render_event:function(){var a;if(document.createEvent&&window.dispatchEvent){a=document.createEvent("UIEvents");a.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(a)}},_log_pdf_render_time:function(b){var a;a=function(f){var d,e,c;if((e=window.performance)!=null?(c=e.timing)!=null?c.navigationStart:void 0:void 0){d=Util.time()-window.performance.timing.navigationStart;return WebTimingLogger.log_ajax_transition(d,f)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return a(b)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return a(""+b+"-parse")})}};var parse_color_to_rgba;Effect.BlindFadeUp=function(d,c){var b,a;b=new Effect.BlindUp(d,c);a=new Effect.Fade(d,c);this.cancel=function(){b.cancel();return a.cancel()}};Effect.BlindFadeDown=function(d,c){var b,a;b=new Effect.BlindDown(d,c);a=new Effect.Appear(d,c);this.cancel=function(){b.cancel();return a.cancel()}};Effect.Flash=function(c,b,a){assert(b.startcolor&&b.endcolor,"Start and end colors must be specified");assert(b.cycles,"Fade cycles must be specified");a=a||0;return new Effect.Highlight(c,{duration:1,startcolor:b.startcolor,endcolor:b.endcolor,restorecolor:b.endcolor,afterFinish:function(){return new Effect.Highlight(c,{duration:1,startcolor:b.endcolor,endcolor:b.startcolor,restorecolor:b.startcolor,afterFinish:function(){if(a<b.cycles){return Effect.Flash(c,b,a+1)}}})}})};Effect.ScaleComprehensive=Class.create(Effect.Scale,{setup:function(){var r,p,x,l,q,s,m,n,h,e,c,b,y,D,B,z,w,v,u,t,a,E,C,A,o,j,i,g,d,f;this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};o=["top","left","width","height","fontSize"];for(h=0,y=o.length;h<y;h++){s=o[h];this.originalStyle[s]=this.element.style[s]}this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;l=this.element.getStyle("font-size")||"100%";j=["em","px","%","pt"];for(e=0,D=j.length;e<D;e++){q=j[e];if(l.indexOf(q)>0){this.fontSize=parseFloat(l);this.fontSizeType=q}}this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;if(this.options.scaleMode==="box"){this.dims={height:this.element.offsetHeight,width:this.element.offsetWidth}}if(/^content/.test(this.options.scaleMode)){this.dims={height:this.element.scrollHeight,width:this.element.scrollWidth}}if(!this.dims){this.dims={height:this.options.scaleMode.originalHeight,width:this.options.scaleMode.originalWidth}}this.full_height=this.dims.height;this.full_width=this.dims.width;p=["border%sWidth","margin%s","padding%s"];for(c=0,B=p.length;c<B;c++){m=p[c];i=["Top","Bottom","Left","Right"];for(b=0,z=i.length;b<z;b++){x=i[b];n=m.format(x);this.dims[n]=parseFloat(this.element.getStyle(n));if(x==="Top"||x==="Bottom"){this.full_height+=this.dims[n]}else{this.full_width+=this.dims[n]}}}this.attrs_vertical=[];this.attrs_horizontal=[];if(this.options.scaleX){for(a=0,w=p.length;a<w;a++){r=p[a];this.attrs_horizontal.push(r.format("Left"))}this.attrs_horizontal.push("width");g=p.reverse();for(E=0,v=g.length;E<v;E++){r=g[E];this.attrs_horizontal.push(r.format("Right"))}}if(this.options.scaleY){for(C=0,u=p.length;C<u;C++){r=p[C];this.attrs_vertical.push(r.format("Top"))}this.attrs_vertical.push("height");d=p.reverse();f=[];for(A=0,t=d.length;A<t;A++){r=d[A];f.push(this.attrs_vertical.push(r.format("Bottom")))}return f}},update:function(a){var b;b=(this.options.scaleFrom/100)+(this.factor*a);b=(-0.5+1/(1+Math.exp((0.5-b)*7)))*1.055+0.5;if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*b+this.fontSizeType})}return this.setDimensions(b)},setDimensions:function(f){var k,n,l,i,j,b,g,e,m,a,h,c;l={};h=[[this.full_width,this.attrs_horizontal],[this.full_height,this.attrs_vertical]];for(g=0,m=h.length;g<m;g++){c=h[g],i=c[0],n=c[1];j=i*f;for(e=0,a=n.length;e<a;e++){k=n[e];b=this.dims[k];if(b<j){l[k]=b+"px";j-=b}else{l[k]=j.round()+"px";j=0}}}return this.element.setStyle(l)}});Effect.BlindUpComprehensive=function(a){a=$(a);a.makeClipping();return new Effect.ScaleComprehensive(a,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(b){return b.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDownComprehensive=function(b){var a;b=$(b);a=b.getDimensions();return new Effect.ScaleComprehensive(b,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:a.height,originalWidth:a.width},restoreAfterFinish:true,afterSetup:function(c){return c.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(c){return c.element.undoClipping()}},arguments[1]||{}))};Effect.HighlightForcedWithAlpha=Class.create(Effect.Highlight,{setup:function(){var k,h,c,g,j,d,l,f,b,a;this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._supports_alpha=false;try{h=new Element("div");j="rgba(1, 1, 1, 0)";h.setStyle({backgroundColor:j});this._supports_alpha=(h.getStyle("background-color"))===j}catch(m){}this._base=parse_color_to_rgba(this.options.startcolor);if((f=this.options.endcolor)==="transparent"||f==="rgba(0, 0, 0, 0)"){if(this._supports_alpha){c=this._base.slice(0);c[3]=0}else{c=[255,255,255,1]}}else{c=parse_color_to_rgba(this.options.endcolor)}this._delta=[];b=this._base;a=[];for(g=d=0,l=b.length;d<l;g=++d){k=b[g];a.push(this._delta.push(c[g]-k))}return a},update:function(a){var h,c,g,d,f,b,e;g=[];e=this._base;for(d=f=0,b=e.length;f<b;d=++f){h=e[d];c=h+this._delta[d]*a;if(!(d>2)){c=Math.round(c)}g.push(c)}if(this._supports_alpha){return this.element.setStyle({backgroundColor:"rgba("+(g.join(", "))+")"})}else{return this.element.setStyle({backgroundColor:"rgb("+(g.slice(0,3).join(", "))+")"})}}});parse_color_to_rgba=function(c){var d,g,f,e,a,b,h,j,i;b=/^rgb\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)$/;a=/^rgba\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}), ?(\d+?\.?\d*)\)$/;e=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i;g=/^#([0-9A-F])([0-9A-F])([0-9A-F])([0-9A-F])$/i;f=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;d=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;if(j=c.match(b)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,10))}return k})()}else{if(j=c.match(a)){i=(function(){var n,l,m,k;m=j.slice(1,4);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,10))}return k})();i[3]=parseFloat(j[4])}else{if(j=c.match(e)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c+c,16))}return k})()}else{if(j=c.match(g)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c+c,16))}return k})()}else{if(j=c.match(f)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,16))}return k})()}else{if(j=c.match(d)){i=(function(){var n,l,m,k;m=j.slice(1);k=[];for(n=0,l=m.length;n<l;n++){c=m[n];k.push(parseInt(c,16))}return k})()}}}}}}i=i||[255,255,255,1];h=i.length;if(h===3){i.push(1)}else{if(h===4&&i[h-1]>1){i[h-1]=i[h-1]/255}}return i};var ClientDownload;ClientDownload=(function(){function a(){}a.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(b){var c;c=new Element("div",{"class":"brodal-header"});c.__sert(_("Install Dropbox"));return Modal.show(c,$("client-download"),{},false,450)}})};return a})();var WebTimingLogger;WebTimingLogger={init:function(){if(!Constants.WEB_TIMING_ENABLED||!window.performance){return}return Util.smart_window_load(function(){return WebTimingLogger._log_navigation.defer()})},_log_navigation:function(){var a,c,d,b;b=window.performance&&window.performance.timing;if(!b){return}d=b.navigationStart||b.fetchStart;if(!d){return}a={};if(Constants.GSLB_ENABLED){a.gslb_enabled=true}if(Constants.IS_SPDY){a.is_spdy=true}c={navigation_type:WebTimingLogger._get_navigation_type(),redirect_time:b.fetchStart-d,connect_time:b.requestStart-d,time_to_first_byte:b.responseStart-d,dom_load_time:b.domContentLoadedEventEnd-d,page_load_time:b.loadEventEnd-d,extra_columns:Util.to_json(a)};return WebTimingLogger._log(c)},log_ajax_transition:function(g,a,d,c,f,b){var e;e={navigation_type:"ajax",page_load_time:g,url:b};if(f!=null){e.server_response_time=f}if(Constants.GSLB_ENABLED){d=d||{};d.gslb_enabled=true}if(d!=null){e.extra_columns=Util.to_json(d)}if(c!=null){e.stopwatch_suffix=c}return WebTimingLogger._log(e,a)},_log:function(b,a,c){if(c==null){c="/web_timing_log"}if(!Constants.WEB_TIMING_ENABLED){return}b.url=b.url||window.location.href;b.request_id=Constants.REQUEST_ID;b.source_type="web";if(a){b.url_info=a}return new Ajax.DBRequest(c,{noAutonotify:true,no_watch:true,parameters:b})},_get_navigation_type:function(){switch(window.performance.navigation.type){case 0:return"navigate";case 1:return"reload";case 2:return"back_forward"}}};var HiRes,_this=this;HiRes=(function(){var a;a=false;if("devicePixelRatio" in window&&window.devicePixelRatio>1){a=true}return{init:function(){var i,h,f,e,d,g,b,c;if(!a){return}g=$$("[data-hi-res]");for(h=0,e=g.length;h<e;h++){i=g[h];this._replace(i,i.readAttribute("data-hi-res"),this._replace_img)}b=$$("[data-hi-res-background]");c=[];for(f=0,d=b.length;f<d;f++){i=b[f];c.push(this._replace(i,i.readAttribute("data-hi-res-background"),this._replace_background))}return c},get_background:function(c,b){if(!a){return}return this._replace(c,b,this._replace_background)},_replace:function(e,c,d){var b;if(!c){return}b=new Image();b.src=c;return b.observe("load",function(){return d(e,c,b.width,b.height)})},_replace_img:function(e,c,b,d){e.src=c;e.width=b/2;return e.height=d/2},_replace_background:function(f,b,c,d){var e;e="url('%(src)s')".format({src:b});return f.setStyle({backgroundImage:e})}}})();Util.smartLoad(function(){return HiRes.init()});var TwoFactorAuth;TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){$j("#resend-link").on("click",this.resend_phone_code.bind(this));return $j("#code").focus()},account_init:function(b,f){var e,d,a,c;this._email=b;this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";c=$$(".email-placeholder");for(d=0,a=c.length;d<a;d++){e=c[d];e.__date(b)}this.account_listen();return Util.async_load_script(f)},account_listen:function(){var k,a,c,d,i,h,o,p,b,n,j,e,m,l,f,g=this;f=$j("#enable-twofactor, #disable-twofactor, #toggle-qr");for(e=0,m=f.length;e<m;e++){i=f[e];i.on("click",function(q){return q.preventDefault()})}n={name:"delivery_choice",enter:function(q){var r;g.hide_error();r=0;$j(".delivery-choice").each(function(){var s;s=$j(this).height();return r=Math.max(s,r)});$j(".delivery-choice").height(r);return $j(".delivery-choice.selected > input").prop("checked",true)},contents:$j("#twofactor-delivery-choice"),onSubmit:function(q,r,s){q.vars.sms=!!($j("#use-sms")[0].getValue()==="on");if(!q.vars.sms){return g.fetch_offline_key(q,r)}else{return r.next()}}};j={name:"enter_phone_number",enter:function(r){var s,q;g.hide_error();g._is_offline_setup=false;g._phone_number=null;s=$("twofactor-enter-phone");q=g.fill_phone_number_for_edit(s,$j("#twofactor-sms-number").text());return q.focus()},contents:$j("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};l={name:"offline_setup",enter:function(q){g.hide_error();g._is_offline_setup=true;return g._phone_number=null},contents:$j("#twofactor-offline-setup")};b={name:"confirm_phone",enter:function(q){var r;g._invalid_code_count=0;if(g._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{r=q.vars.phone_number;assert(r,"expected a display_phone argument");$("phone-number-placeholder").__date(r);$("twofactor-enable-confirm").removeClassName("offline")}g.hide_error();$("phone-code").clear().focus();return g.fill_delivery_choice(r)},onSubmit:this.submit_phone_code.bind(this),contents:$j("#twofactor-enable-confirm")};p={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:$j("#twofactor-enter-backup-phone")};h=new ModalFlow(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:$j("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,function(q,r){g.successfully_enabled=false;q.vars.mode="ENABLE";q.vars.passed_password=true;return r.next()}),contents:$j("#twofactor-enter-password")},n,j,l,b,p,{name:"recovery_code",enter:function(){g.fill_backup_phone(g._backup_phone);return g.hide_error.bind(g)},onSubmit:this.submit_finish.bind(this),contents:$j("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:_("Congrats! You've enabled two-step verification!"),contents:$j("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(q){if(q.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(q){if(q.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});h.addExitListener(function(q){if(h.vars.passed_password&&q&&!g.successfully_enabled){return Notify.server_error(_("Two-step verification is not enabled"))}});d=new ModalFlow(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(r,s){var q;g.successfully_enabled=false;$j(".delivery-choice").removeClass("selected");q=!$j("#twofactor-row").hasClass("with-sms");$j(q?"#app-choice":"#sms-choice").addClass("selected");$j("#twofactor-recovery").addClass("edit-mode");r.vars.passed_password=true;return s.next()}),contents:$j("#twofactor-enter-password")},n,j,l,b,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(q){if(q.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(q){if(q.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});d.addExitListener(function(q){if(d.vars.passed_password&&q&&!g.successfully_enabled){return Notify.server_error(_("Two-step verification has not been changed"))}});a=new ModalFlow(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,function(q,r){g.successfully_disabled=false;q.vars.passed_password=true;return r.next()}),contents:$j("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:$j("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});a.addExitListener(function(q){if(a.vars.passed_password&&q&&!g.successfully_disabled){return Notify.server_error(_("Two-step verification is still enabled"))}});k=new ModalFlow(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(q,r){return r.next()}),contents:$j("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");c=new ModalFlow(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(q,r){return r.next()}),contents:$j("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:$j("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");o=new ModalFlow(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(q,r){return new Ajax.DBRequest(g.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:g._checkpoint_token},onSuccess:function(s){var t;t=s.responseText.strip();if(t.startsWith("OK:")){g.fill_recovery_code(t.substr(3),"backup-code-div-edit");return r.next()}else{switch(t){case"EXPIRED":return g.show_error_expired();case"ALREADY_DISABLED":$j("#twofactor-row").removeClass("twofactor-enabled");Notify.server_success(_("Two-step verification is already disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:g.show_error500.bind(g),cleanUp:g.hide_loading.bind(g)})}),contents:$j("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:$j("#twofactor-recovery-edit"),onSubmit:function(q,r){g._checkpoint_token=null;return r.next()}}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");$j("#enable-twofactor").on("click",this.start_flow.bind(this,h));$j("#disable-twofactor").on("click",this.start_flow.bind(this,a));$j("#add-twofactor-backup-link").on("click",this.start_flow.bind(this,k));$j("#edit-twofactor-backup").on("click",this.start_flow.bind(this,c));$j("#edit-twofactor-recovery").on("click",this.start_flow.bind(this,o));$j("#edit-twofactor-sms, #edit-twofactor-offline").on("click",this.start_flow.bind(this,d));$j("#generate-new-recovery-code").on("click",function(q){g.show_loading();return new Ajax.DBRequest(g.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:g._checkpoint_token},onSuccess:function(r){var s;s=r.responseText.strip();if(s.startsWith("OK:")){return g.fill_recovery_code(s.substr(3),"backup-code-div-edit")}else{switch(s){case"EXPIRED":o.to_state("password");return g.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Notify.server_success(_("Two-step verification is disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:g.show_error500.bind(g),cleanUp:g.hide_loading.bind(g)})});$j("#twofactor-enter-phone #country-code")[0].on("change",this.reset_phone_field_and_backup_country.bind(this));$j("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));$j("#resend-link").on("click",this.enable_resend_phone_code.bind(this));$j("#twofactor-delivery-choice input").change(function(){$j(".delivery-choice").removeClass("selected");return $j(this).parents(".delivery-choice").addClass("selected")});$j("#show-qr").on("click",function(q){$j("#twofactor-offline-setup").addClass("showing-qr");return false});$j("#hide-qr").on("click",function(q){$j("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&$j("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(k)}},start_flow:function(a){this._current_flow=a;a.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return $j("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(b){var a,c=this;if(this.is_resending()){return}this.show_resending();a="/twofactor_resend";if($j("#twofactor-confirm").hasClass("backup")){a+="?backup=true"}new Ajax.DBRequest(a,{onSuccess:function(d){switch(d.responseText.strip()){case"OK":c.hide_error();return c.notify_resent();case"UNREACHABLE":return c.show_error_unreachable(true);case"BADCARRIER":return c.show_error_bad_carrier();case"INVALIDNUMBER":return c.show_error_invalid_number();case"NOTAMOBILE":return c.show_error_not_a_mobile();case"RATELIMIT":return Notify.server_error(_("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(a){var b=this;if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:function(c){switch(c.responseText.strip()){case"OK":b.hide_error();return b.notify_resent();case"UNREACHABLE":return Notify.server_error(error_unreachable(true));case"BADCARRIER":return Notify.server_error(error_bad_carrier());case"INVALIDNUMBER":return b.show_error_invalid_number();case"NOTAMOBILE":return Notify.server_error(error_not_a_mobile());case"RATELIMIT":return Notify.server_error(_("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}},onFailure:function(c){return Notify.server_error(b.error500())},cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(a){var b=this;if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:function(c){switch(c.responseText.strip()){case"OK":b.hide_error();return b.notify_resent();case"UNREACHABLE":return b.show_error_unreachable();case"BADCARRIER":return b.show_error_bad_carrier();case"INVALIDNUMBER":return b.show_error_invalid_number();case"NOTAMOBILE":return b.show_error_not_a_mobile();case"RATELIMIT":return Notify.server_error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":b._current_flow.to_state("password");return b.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:_("Enable two-step verification"),DEFAULT_EDIT_TITLE:_("Edit two-step verification"),DEFAULT_DISABLE_TITLE:_("Disable two-step verification"),ADD_BACKUP_TITLE:_("Add a backup phone number"),EDIT_BACKUP_TITLE:_("Edit backup phone number"),EDIT_RECOVERY_TITLE:_("View recovery code"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var a;this.hide_error();$j("#twofactor-recovery").removeClass("edit-mode");a=$("twofactor-enter-password");$j("#password",a).val("").focus();return false},submit_password:function(c,h,a,d,f){var b,g=this;b=$("password").getValue();if(!b){this.show_error(_("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(c,{parameters:{password:b},onSuccess:function(e){var i;i=e.responseText.strip();if(i.startsWith("OK:")){g._checkpoint_token=i.substr(3);return h(a,d)}else{switch(i){case"EXPIRED_PASSWORD":return g.show_error_expired_password();case"INVALID":return g.show_error(_("Invalid password"));case"RATELIMIT":return g.show_error(_("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");Notify.server_success(_("Two-step verification is already enabled. Did you maybe enable it in another window?"));return Modal.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Notify.server_success(_("Two-step verification is already disabled. Did you maybe disable it in another window?"));return Modal.hide()}}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},fetch_offline_key:function(a,b){var c=this;this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:function(d){var e;e=d.responseText.strip();if(e.startsWith("OK:")){c.fill_key(e.substr(3));return b.next()}else{switch(e){case"EXPIRED":a.to_state("password");return c.show_error_expired()}}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},fill_key:function(b){var a,d,c;b=b.replace(new RegExp("=+$"),"");a=b.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(a);$("qr-div").__date();c=Constants.IS_PROD?"Dropbox":"DropboxDev";d={text:"otpauth://totp/"+c+":"+this._email+"?secret="+b+"&issuer="+c,width:200,height:200};if(!Modernizr.canvas){d.render="table"}$j("#qr-div").qrcode(d);if(!Modernizr.canvas){return $j("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(a,d,f){var c,b,g=this;b=$j.trim($j("#phone-number").val());if(!b){this.show_error(_("Please enter your phone number"));return}c=$j.trim($j("#country-code",f.currentTarget).val());b=this.validate_phone_number(c,b);if(!b){this.show_error(_("Invalid phone number"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:b},onSuccess:function(e){switch(e.responseText.strip()){case"OK":g._phone_number=b;a.vars.phone_number=b;return d.next();case"EXPIRED":a.to_state("password");return g.show_error_expired();case"UNREACHABLE":return g.show_error_unreachable();case"BADCARRIER":return g.show_error_bad_carrier();case"INVALIDNUMBER":return g.show_error_invalid_number();case"NOTAMOBILE":return g.show_error_not_a_mobile();case"RATELIMIT":return g.show_error(_("You've added too many phone numbers. Please try again in a few minutes."))}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},validate_phone_number:function(b,a){var c;a=a.replace(/\D/g,"");c=""+b+" "+a;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){if(!phone_helpers.is_valid(c)){return}return""+b+" "+(phone_helpers.format(b,a))}if(b==="+1"){if(a.length!==10){return}}else{if(!(a.length>=4)){return}}return c},submit_phone_code:function(a,b,d){var c,f=this;c=$("phone-code").getValue().strip();if(!c){this.show_error(_("Please enter the security code"));return}if(c.search(/^\d{6}$/)===-1){this.show_error(_("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:c},onSuccess:function(e){var h,g;g=e.responseText.strip();if(g.startsWith("OK:")){f.fill_recovery_code(g.substr(3),"backup-code-div");return b.next()}else{switch(g){case"INVALID":f._invalid_code_count+=1;h=f._invalid_code_count<=2?_("Invalid code"):f._is_offline_setup?_("Invalid code. Check the clock on your phone: it must be accurate to the minute."):_("Invalid code");return f.show_error(h);case"EXPIRED":a.to_state("password");return f.show_error_expired();case"RATELIMIT":return f.show_error(_("Too many invalid codes. Try again in a few minutes."))}}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},enter_backup_phone_number_shown:function(d,b){var c,a;this.hide_error();c=$("twofactor-enter-backup-phone");a=this.fill_phone_number_for_edit(c,$j("#twofactor-backup-number").text());a.focus();if(d==="back_next"){$j("#twofactor-backup-back-next").show();$j("#twofactor-backup-cancel-save").hide();return $j("#twofactor-backup-back-save").hide()}else{if(d==="cancel_save"){$j("#twofactor-backup-back-next").hide();$j("#twofactor-backup-cancel-save").show();return $j("#twofactor-backup-back-save").hide()}else{if(d==="back_save"){$j("#twofactor-backup-back-next").hide();$j("#twofactor-backup-cancel-save").hide();return $j("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(f,c,a,g,h){var d,b;b=$j.trim($j("#backup-phone-number").val());if(b){d=$j.trim($j("#country-code",h.currentTarget).val());b=this.validate_phone_number(d,b);if(!b){this.show_error(_("Invalid phone number"));return}if(this.is_primary_number(b)){this.show_error(_("You can't use your primary phone as your backup"));return}}else{if(f){this.show_error(_("Please enter phone number"));return}}this._backup_phone=b;if(c==="save_backup_phone"){this.save_added_backup_phone(a,f,b)}else{if(c==="save_everything"){this.submit_finish(a,g,h)}else{if(c==="save_none"){return g.next()}}}},is_same_phone_number:function(b,a){if(!b||!a){return false}return b.replace(/\D+/g,"")===a.replace(/\D+/g,"")},is_primary_number:function(a){if(this._is_offline_setup){return false}if(this.is_same_phone_number(a,$j("#confirm-phone-primary-number").text())){return true}if(this.is_same_phone_number(a,$j("#twofactor-sms-number").text())){return true}return false},save_added_backup_phone:function(a,c,b){var d=this;this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:b},onSuccess:function(e){switch(e.responseText.strip()){case"OK":d.hide_error();$j("#twofactor-backup-number").text(b);$j("#twofactor-row").toggleClass("with-backup",!!b);Util.syncHeight();if(!b){Notify.server_success(_("Backup phone number removed"))}else{if(!c){Notify.server_success(_("Backup phone number updated"))}else{Notify.server_success(_("Backup phone number added"))}}return Modal.hide();case"EXPIRED":a.to_state("password");return d.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},fill_phone_number_for_edit:function(d,f){var e,b,c,a;b=$j(".sick-input > input",d);if(!f){return b.val("")}a=$j('select[name="country_code"]',d);e=/^\+\d+/.exec(f);e=e?e[0]:"";c=this.option_for_country_code(a,e);if(c!=null){c.selected=true}b.val($j.trim(f.slice(e.length)));if(b.length){b[0].select()}return b},option_for_country_code:function(a,c){var b;if(c){b=$j('option[value="'+c+'"]',a);if(b.length>1){b=b.filter("[selected]")}if(b.length){return b[0]}}return $j("option[selected]",a)[0]},fill_delivery_choice:function(a){$j("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!a);$j("#twofactor-delivery-offline-label").toggle(!a);return $j("#confirm-phone-primary-number").text(a)},fill_backup_phone:function(a){$j("#confirm-phone-backup").toggle(!!a);return $j("#confirm-phone-backup-number").text(a)},fill_recovery_code:function(b,a){b=b.toLowerCase().replace(/(.{4})/g,"$1 ");return $(a).__date(b)},submit_finish:function(a,b,c){var d,f=this;this.show_loading();d={checkpoint_token:this._checkpoint_token};if(this._backup_phone){d.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:d,onSuccess:function(e){switch(e.responseText.strip()){case"OK":f.successfully_enabled=true;if(a.vars.mode!=="ENABLE"){return f.after_enabled(a,b)}else{return b.next()}break;case"EXPIRED":a.to_state("password");return f.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},after_enabled:function(a,b){var c;this._checkpoint_token=null;this.hide_error();c=$j("#twofactor-row");c.toggleClass("with-sms",!!this._phone_number);$j("#twofactor-sms-number").text(this._phone_number||"");c.toggleClass("with-backup",!!this._backup_phone);$j("#twofactor-backup-number").text(this._backup_phone||"");c.addClass("twofactor-enabled");Util.syncHeight();if(a.vars.mode!=="ENABLE"){Notify.server_success(_("Two-step verification updated"));return b!=null?b.next():void 0}},disable_submit:function(a,b){var c=this;this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:function(d){switch(d.responseText.strip()){case"OK":c.successfully_disabled=true;c._checkpoint_token=null;$j("#twofactor-row").removeClass("twofactor-enabled with-sms with-backup");$j("#twofactor-sms-number,#twofactor-backup-number").text("");Util.syncHeight();Notify.server_success(_("Two-step verification is now disabled."));return b.next();case"EXPIRED":a.to_state("password");return c.show_error_expired()}},onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this)})},show_error:function(b){var a;a=$$(this._error_selector);if(b===this.error_expired_password()||b===this.error_unreachable(true)){a.invoke("update",b)}else{a.invoke("__date",b)}return a.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(){return this.show_error(this.error_bad_carrier())},show_error_invalid_number:function(){return this.show_error(this.error_invalid_number())},show_error_not_a_mobile:function(){return this.show_error(this.error_not_a_mobile())},show_error_unreachable:function(a){if(a==null){a=false}return this.show_error(this.error_unreachable(a))},show_error_expired:function(){return this.show_error(this.error_expired())},show_error_expired_password:function(){return this.show_error(this.error_expired_password())},error_500:function(){return _("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return _("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return _("That is not a valid phone number.")},error_not_a_mobile:function(){return _("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(a){if(a==null){a=false}if(a){return _('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return _("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return _("Since it's been a while, please enter your password again.")},error_expired_password:function(){return _('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return Notify.server_success(_("We sent you another code. Keep in mind that it might take a few minutes."))},reset_phone_field:function(b){var a,c;a=b.element();c=$j(".sick-input",a.form);$j("input",c).val("").focus();return this.fill_example_phone_number(a,c)},fill_example_phone_number:function(a,d){var c,b;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){c=$j(a).val().substr(1);b=phone_helpers.get_example_mobile_number(c);return $j("label",d).text(_("Example: ")+b)}},reset_phone_field_and_backup_country:function(b){var a;this.reset_phone_field(b);if($j("#backup-phone-number").val()===""){a=$j("#twofactor-enter-backup-phone #country-code");a.val(b.element().getValue());return this.fill_example_phone_number(a,$j(".sick-input",a[0].form))}}};var PseudoLocalStorage;PseudoLocalStorage={_store:{},getItem:function(a){return this._store[a]},setItem:function(a,b){return this._store[a]=b},removeItem:function(a){return delete this._store[a]},clear:function(){return this._store={}}};var DBLocalStorage;DBLocalStorage={dbstore:Modernizr.localstorage?window.localStorage:PseudoLocalStorage,_access_order_key:"ao",_get_access_order:function(){var a;a=this.dbstore.getItem(this._access_order_key);try{a=Util.from_json(a)}catch(b){a=[]}if(a instanceof Array){return a}else{return[]}},_to_key:function(a){return Util.to_json(a)},attemptWrite:function(g,d){var i,c,e,h,f,j,b;i=0;c=10;f=0;b=[];while(i<c&&!f){e=this._get_access_order();e.push(g);try{this.dbstore.setItem(g,d);this.dbstore.setItem(this._access_order_key,Util.to_json(e));f=1}catch(a){h=this._get_access_order();if(h.length){j=h.shift();this.dbstore.removeItem(j);this.dbstore.setItem(this._access_order_key,Util.to_json(h))}else{this.dbstore.clear()}}b.push(i+=1)}return b},getItem:function(b){var c,a,d;b=this._to_key(b);d=this.dbstore.getItem(b);if(d){c=this._get_access_order();c.removeItem(b);c.push(b);this.dbstore.setItem(this._access_order_key,Util.to_json(c));a=Util.from_json(d);return a}},setItem:function(a,b){return this.attemptWrite(this._to_key(a),Util.to_json(b))},removeItem:function(a){var b;a=this._to_key(a);b=this._get_access_order();b.removeItem(a);this.dbstore.setItem(this._access_order_key,Util.to_json(b));return this.dbstore.removeItem(a)},clear:function(){return this.dbstore.clear()}};var FileViewer;FileViewer={KEY_SCOPE:"fileviewer",file:null,has_preview:false,shown:false,is_loaded:false,has_key_listener:false,is_file_private:true,history_length:null,show:function(a,b){var c;this.file=a;this.is_file_private=b;this.shown=true;this.history_length=window.history.length;if(this.file.preview_type==="download"){return window.location.href=this.file.href}else{this._render_viewer();this._listen();c=$j("#file-viewer").show();return c.trigger("preview-show",{file:this.file})}},_log_view:function(){var a;a={mode:"file-preview",file_ext:Util.file_extension_for_logging(this.file.filename),preview_type:this.file.preview_type,has_preview:this.has_preview&&this.file.bytes>0,has_pdf_preview:this.file.has_pdf_preview,file_bytes:this.file.bytes};return UserActivityLogger.log("web","file_view",Util.to_json(a))},_render_viewer:function(){var a,c,d,b;$j("html").addClass("no-scroll");$j("body").addClass("full_no_overflow");d=$j("#file-viewer");a=""+this.file.href+"&dl=1";this.has_preview=((this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="doc"&&this.file.has_pdf_preview&&this.file.bytes<Constants.MAX_DOC_FILE_SIZE_B))||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"));this._log_view();if(this.has_preview&&this.file.bytes>0){d.find(".title-bar .filename").text(this.file.filename.snippet(70));d.addClass("has-preview");if(this.file.htmlified_link){d.addClass("markdown-preview")}else{if(this.file.code_class){d.addClass("code-preview")}else{d.addClass(""+this.file.preview_type+"-preview")}}d.find(".loading").show();this._render_preview();d.find(".download-img-button").attr({href:a})}else{d.find(".title-bar .filename").text(this.file.filename.snippet(40));d.addClass("no-preview");d.find(".file-thumbnail img").attr({src:"/static/images/icons128/"+(Util.filename_to_icon(this.file.filename))+".png"});d.find(".file-type").text(typeof(b=this.file).get_category==="function"?b.get_category().capitalize():void 0);d.find(".file-size").text(this.file.size);d.find(".file-modified").text(this.file.ago);d.find(".download-button").attr({href:a});if(this.file.preview_type==="doc"&&this.file.bytes<Constants.MAX_DOC_FILE_SIZE_B&&this.file.bytes>0){c="/extract_metadata"+this.file.fq_path;new Ajax.DBRequest(c,{noAutonotify:true,no_watch:true})}}return this._initial_resize()},_remove_loading:function(){$j("#file-viewer .loading").hide();return this.is_loaded=true},_initial_resize:function(){if(this.is_loaded){return}return setTimeout($j.proxy(this._resize,this),100)},_render_preview:function(){var c,b,d,a,f,e=this;d=$j("#file-viewer .preview");if(this.file.preview_type==="text"&&!this.file.htmlified_link){f=$j("<div/>",{id:"code-wrapper"});f.append($j("<pre/>",{id:"code","class":this.file.code_class||"plain-text"}));d.append(f);window.addEventListener("message",function(g){if(g.data==="syntax.js"){FilePreview.init_text(e.file.href,true,$j.proxy(e._remove_loading,e),e.is_file_private);return window._syntax_js_loaded=true}});if(!window._syntax_js_loaded){Util.async_load_script(VflMap.syntax_js);return Util.async_load_css("/static/css/syntax.css")}else{return FilePreview.init_text(this.file.href,true,$j.proxy(this._remove_loading,this),this.is_file_private)}}else{if(this.file.htmlified_link){b=$j("<iframe/>",{src:this.file.htmlified_link});d.append(b);return b.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){a=Util.add_qstring(this.file.href,{disable_range:1,convert_doc_to_pdf:1});c=a.substring(0,a.indexOf("/",a.indexOf("//")+2));if(Constants.PDF_PREVIEW_MODE==="pdf-js"){a=c+VflMap.pdfjs_viewer+encodeURIComponent(a)}b=$j("<iframe/>",{src:a});d.append(b);return b.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){b=$j("<iframe/>",{src:this.file.href,sandbox:true});d.append(b);return b.on("load",this._remove_loading)}}}}},_listen:function(){var a;a=$j("#file-viewer");a.on("click",$j.proxy(this._hide,this));a.find("#file-viewer-container").on("click",function(b){return b.stopPropagation()});a.find(".close-img-button").on("click",$j.proxy(this._hide,this));if(!this.has_key_listener){key("esc",this.KEY_SCOPE,$j.proxy(this._hide,this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.has_preview){a.find(".share-img-button").on("click",$j.proxy(this._share,this))}else{a.find(".share-button").on("click",$j.proxy(this._share,this))}a.find(".edit-img-button").on("click",$j.proxy(this._edit,this));return $j(window).on("resize",$j.proxy(this._resize,this))},_unlisten:function(){var a;a=$j("#file-viewer");a.off("click",$j.proxy(this._hide,this));a.find("#file-viewer-container").off("click",function(b){return b.stopPropagation()});a.find(".close-img-button").off("click",$j.proxy(this._hide,this));if(this.has_preview){a.find(".share-img-button").off("click",$j.proxy(this._share,this))}else{a.find(".share-button").off("click",$j.proxy(this._share,this))}a.find(".edit-img-button").off("click",$j.proxy(this._edit,this));$j(window).off("resize",$j.proxy(this._resize,this));return key.setScope(this.prev_scope)},_resize:function(b){var a,c;c=$j("#file-viewer");a=c.find("#file-viewer-container").height()-(c.find(".title-bar").height()+1);c.find(".preview").height(a);return c.trigger("height-resize",{height:a})},_share:function(a){a.preventDefault();return Forms.postRequest("/sm/create"+Util.urlquote(this.file.fq_path),{},{target:"_blank"})},_edit:function(a){a.preventDefault();return FileOps.show_open_with([this.file],$j.proxy(this._show_edit_iframe,this))},_show_edit_iframe:function(e,a){var b,c,d;d=$j("#file-viewer");d.removeClass("has-preview").removeClass("no-preview").addClass("edit");d.find(".loading").show();d.find(".editor-name").text(e.name);if(e.icon_url){d.find(".editor-icon").attr("src",e.icon_url)}d.off("click",$j.proxy(this._hide,this));b=$j("<iframe/>",{src:Util.open_with_url(e.landing,a)});c=d.find(".preview");c.empty();c.append(b);this.is_loaded=false;return b.on("load",this._remove_loading)},_hide:function(){var a;BrowseSelection.set_selected_files(this.file);a=$j("#file-viewer");$j("html").removeClass("no-scroll");$j("body").removeClass("full_no_overflow");a.hide().removeClass("has-preview").removeClass("no-preview");a.find(".preview").empty();if(this.has_preview){this.has_preview=false}else{a.find(".file-thumbnail img").attr({src:""});a.find(".file-size").text("")}a.find(".file-thumbnail img").attr({src:""});a.find(".title-bar .filename").text("");a.attr({"class":""});this._unlisten();this._remove_loading();this.last_file=this.file;this.file=null;this.shown=false;return this.is_loaded=false}};var Index;Index={init:function(a){var c,b,d,e;if(Cookies.check_cookies_enabled()){WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}if(!FlashDetect.versionAtLeast(9)&&!Util.supports_video()){d=$j("#take-tour");d.show();WebMiscActivityLogger.log("take_tour_shown",{session_id:Constants.sess_id});d.on("click",function(){return window.location.href="/tour"})}else{b=$j("#play-video");b.show();WebMiscActivityLogger.log("commoncraft_video_shown",{session_id:Constants.sess_id});c=b.find("img");c.hover((function(){return c.fadeTo(0.2,1)}),(function(){return c.fadeTo(0.2,0.8)}));e=$j("<div />",{id:"video-container",style:"display:none"})[0];b.on("click",function(){var g,h,f;Modal.onHide=function(){$j("#video-container").empty();Modal.onHide=null;return Modal.hide()};f=900;g=1;h=f+2*g;Modal.show("",e,false,false,h,false,"landing-page-modal");Index.showScreencast("video-container",true,f);return false})}if(a.lastname_goes_first){$j("#lname").focus()}else{$j("#fname").focus()}},showScreencast:function(e,i,c){var b,g,d,j,h,a,f;a=localized_path("https://scast.s3.amazonaws.com/cc/dropbox_intro.mp4",["de","es","es_ES","fr","id","it","ja","ko","ms","pl","pt_BR","ru","zh_CN","zh_TW"]);d="/static/images/cc_endframe_en.jpg";h=352/640;if((f=Constants.USER_LOCALE)==="ms"||f==="id"){h=352/626}j=parseInt(h*c,10);$j("#"+e).height(j);g="commoncraft-embed";b=new Element("div",{id:g,style:"display: inline-block;"});$(e).__date(b);VideoUtil.embed("#"+g,{src:a,type:"video/mp4",width:c,height:j,controls:true,preload:"auto",poster:d,autoplay:i});WebMiscActivityLogger.log("commoncraft_video_view")}};var Index2;Index2={init:function(h){var f,b,i,e,a,c,d,g;PasswordStrengthWatcher.watch("#password-field");$j("#sign-in").on("click",function(j){j.preventDefault();Modal.show(_("Sign in"),$j("#sign-in-form")[0],false,false,390,false,"sign-in-modal");return $j("#login_email").focus()});f=function(){if(!$j("#signup-form").hasClass("form_shown")){$j.when($j("#register-partial-container").animate({height:251},{easing:"easeInOutCubic",duration:500}).promise(),$j("#signup-form").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){return $j("#signup-form").addClass("form_shown")})}return $j("#fname").focus()};if(!h){$j("#register-submit").on("click",function(j){if(!$j("#signup-form").hasClass("form_shown")){j.preventDefault();return f()}});Index2.animate()}else{$j(".photo").show();$j("#fname").focus()}$j(".buttons .freshbutton-blue").on("click",function(j){j.preventDefault();$j("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:f});return false});$j("#learn-more").on("click",function(j){j.preventDefault();$j("html, body").animate({scrollTop:$j("#divider").offset().top},{queue:false,duration:500});return false});if(Cookies.check_cookies_enabled()){WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}a=["#devices-background","#register-submit","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];c=function(j){return $j(j).on("click",function(){return WebMiscActivityLogger.log("index_page",{event_name:"click",id:j})})};for(d=0,g=a.length;d<g;d++){b=a[d];c(b)}e=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];i={};return $j(window).scroll(function(){var p,q,o,m,l,n,k,j;j=[];for(n=0,k=e.length;n<k;n++){o=e[n];if($j(o).length&&!i[o]){q=$j(window).scrollTop();p=q+$j(window).outerHeight();l=$j(o).offset().top;m=l+$j(o).outerHeight();if(m<=p){WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:o});j.push(i[o]=true)}else{j.push(void 0)}}else{j.push(void 0)}}return j})},_animate_points:function(g,h,k,b,m,f,a){var d,c,e,l;if(a==null){a=0}a=Math.min(Math.max(a,0),1);e=f(a);l=[(function(){var n,j,i;i=[];for(d=n=0,j=h.length;0<=j?n<j:n>j;d=0<=j?++n:--n){i.push([(function(){var p,o;o=[];for(c=p=0;p<2;c=++p){o.push(h[d][c]+(k[d][c]-h[d][c])*e)}return o})()])}return i})()];g.attr("points",Index2.points_array_to_str(l));if(a>=1){return m.resolve()}else{return setTimeout(function(){return Index2._animate_points(g,h,k,b,m,f,a+(10/b))},10)}},animate_points:function(b,g,f,c,e,d){var a;if(d==null){d=jQuery.easing.linear}a=$j.Deferred();Index2._animate_points(b,g,f,c,a,d);return a.done(function(){return typeof e==="function"?e():void 0}).promise()},animate_hide_rects:function(b,f,h){var a,c,g,e,d;a=$j.Deferred().resolve().promise();g=function(j){var o,l,n,k,m;k=$j(b[j]);o=Index2.points_str_to_array(k.attr("points"));m=[o[1],o[1],o[2],o[2]];l=Index2.inverse(jQuery.easing.linear);n=f*(l((j+1)/b.length)-l(j/b.length));return a=a.then(function(){return Index2.animate_points(k,o,m,n)})};for(c=e=0,d=b.length;0<=d?e<d:e>d;c=0<=d?++e:--e){g(c)}return a.done(function(){return typeof h==="function"?h():void 0}).promise()},animate_delay:function(b){var a;a=$j.Deferred();setTimeout(a.resolve,b);return a.promise()},animate:function(){return $j.Deferred().resolve().promise().then(function(){return Index2.animate_docs()}).then(function(){return Index2.animate_graphs()}).then(function(){return Index2.animate_photos()})},inverse:function(b,a){if(a==null){a=0.000001}return function(f){var d,e,c;e=0;d=1;while(d-e>a){c=(e+d)/2;if(b(c)<f){e=c}else{d=c}}return e}},points_str_to_array:function(g){var c,f,e,b,d,a;d=g.split(" ");a=[];for(e=0,b=d.length;e<b;e++){f=d[e];a.push((function(){var k,i,h,j;h=f.split(",");j=[];for(k=0,i=h.length;k<i;k++){c=h[k];j.push(parseFloat(c))}return j})())}return a},points_array_to_str:function(b){var a;return((function(){var e,d,c;c=[];for(e=0,d=b.length;e<d;e++){a=b[e];c.push(a.join(","))}return c})()).join(" ")},animate_docs:function(){var g,a,d,c,f,b,e;b=[[5,6],[177,1],[184,157],[13,180]];a="";for(f=e=0.475;0.475<=0.625?e<=0.625:e>=0.625;f=e+=0.05){g=f+0.05;d=[[b[0][0]+(b[3][0]-b[0][0])*f,b[0][1]+(b[3][1]-b[0][1])*f],[b[1][0]+(b[2][0]-b[1][0])*f,b[1][1]+(b[2][1]-b[1][1])*f],[b[1][0]+(b[2][0]-b[1][0])*g,b[1][1]+(b[2][1]-b[1][1])*g],[b[0][0]+(b[3][0]-b[0][0])*g,b[0][1]+(b[3][1]-b[0][1])*g]];d=Index2.points_array_to_str(d);a+="<polygon points='"+d+"' style='fill:#f5f9fc;stroke:none;' />"}c=$j('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+a+"\n</svg>");return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".comp.doc").append(c);return $j(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return Index2.animate_hide_rects(c.find("polygon"),2500,c.remove)}).then(function(){return Index2.animate_delay(500)}).then(function(){return $j(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return Index2.animate_delay(1500)}).then(function(){return $j(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var b,a;b=[[83,98],[158,37],[241,77],[171,145]];a=$j('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');a.find("polygon").attr("points",Index2.points_array_to_str(b));return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".tablet.graph .graph-grid").hide();$j(".tablet.graph").append(a);return $j(".tablet.graph").show("fade",{},500).promise()}).then(function(){var c;c=[b[0],b[1],b[1],b[0]];return Index2.animate_points(a.find("polygon"),b,c,600,a.remove)}).then(function(){if(!($j.browser.msie&&parseInt($j.browser.version,10)<9)){return $j(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return Index2.animate_delay(500)}).then(function(){return $j(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return Index2.animate_delay(2000)}).then(function(){return $j(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return $j.Deferred().resolve().promise().then(function(){$j(".doc, .graph, .photo").hide();$j(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});$j(".phone.photo").show();return $j.when((function(){if(!($j.browser.msie&&parseInt($j.browser.version,10)<9)){return $j(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return $j.Deferred().resolve().promise().then(function(){return $j(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return Index2.animate_delay(750)}).then(function(){return $j(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var PasswordStrengthWatcher;PasswordStrengthWatcher={watch:function(a){var c,h,e,d,b,j,g,f=this;a=$j(a);c=_("Good passwords are hard to guess. Use uncommon words or inside jokes, non-standard uPPercasing, creative spelllling, and non-obvious numbers and symbols.");h=$j('<div class="db-password-bubble db-left-arrow">\n  <div class="db-arrow-border" />\n  <div class="db-arrow" />\n  <div class="password-bubble-title"></div>\n  <div class="password-bubble-desc">'+c+"</div>\n</div>").hide();j=function(){var i;i=$j(window).width()-($j("#password-field").offset().left+$j("#password-field").outerWidth())-40;h.width(Math.min(Math.max(120,i),160));return DbBubble.position(h,a,"right+4px")};b=$j('<div class="db-password-meter"/>').append((function(){var k,i;i=[];for(e=k=0;k<4;e=++k){i.push($j('<div class="db-password-dot"/>'))}return i})()).hover((function(){h.show();return j()}),(function(){return h.hide()}));if($j.browser.msie&&parseInt($j.browser.version,10)<10){b.css("background-color","white")}a.append(h).append(b);d="";g=function(){var k,m,l,i;k=a.find("input").val();if(d===k){return}d=k;if(k==="correcthorsebatterystaple"||k==="Tr0ub4dour&3"||k==="Tr0ub4dor&3"){m=0;l=_("lol");$j(".password-bubble-title").text(l);if(k==="correcthorsebatterystaple"){$j(".password-bubble-desc").text(_("Whoa there, don't take advice from a webcomic too literally ;)"))}else{$j(".password-bubble-desc").text(_("Guess again"))}}else{i=["",_("Weak"),_("So-so"),_("Good"),_("Great!")];m=f.score(k);l=i[m];$j(".password-bubble-title").text(l);$j(".password-bubble-desc").text(c)}j();return b.find("div").css("background-color","#cce6f9").slice(4-m,4).css("background-color","#4093e0")};return setInterval(g,200)},get_user_inputs:function(){var b,a;a=["dropbox","votebox"];return a.concat((function(){var f,d,e,c;e=$j("#fname, #lname, #email");c=[];for(f=0,d=e.length;f<d;f++){b=e[f];c.push($j(b).val())}return c})())},score:function(a){if(!(window.zxcvbn&&a)){return 0}return Math.max(1,zxcvbn(a,this.get_user_inputs()).score)}};var VflMap;VflMap={};var BatchThumbLoader;BatchThumbLoader={MAX_THUMB_BATCH_REQUESTS:24,MAX_URL_LENGTH:6000,batch_load_thumbs_queue:[],num_pending_batch_requests:0,batch_load_thumbs:function(c,d,f,b){var h,g,e,a;g=[];for(e=0,a=c.length;e<a;e++){h=c[e];h=$j(h);if(h.data("src")){if($j.support.cors&&Constants.BATCH_THUMB_ENDPOINTS.length){g.push(h);if(g.length===d){this.batch_load_thumbs_queue.push(g);g=[]}}else{Util.thumb_load(h,f)}}}if(g.length){this.batch_load_thumbs_queue.push(g)}if(this.num_pending_batch_requests<this.MAX_THUMB_BATCH_REQUESTS){return this._do_batch_load(f,b)}},_do_batch_load:function(f,m){var n,d,k,e,g,b,j,a,c,h,l,i=this;if(this.batch_load_thumbs_queue.length===0){return}e=this.batch_load_thumbs_queue.shift();g=[];k=[];for(h=0,l=e.length;h<l;h++){d=e[h];a=d.data("src");if(a){d.data("src",null);d.data("loading-src",a);a=a.replace(/https?:\/\/[^\/]+\//,"/");g.push(a);k.push(d)}}if(!g.length){return}n=Constants.BATCH_THUMB_ENDPOINTS[Math.abs(Util.string_hash(Util.to_json(g))%Constants.BATCH_THUMB_ENDPOINTS.length)];c=n+"?image_urls="+encodeURIComponent(Util.to_json(g));b=(c.length<this.MAX_URL_LENGTH?"GET":"POST");j=function(t,x){var w,A,y,B,v,z,u,s,q,p,o,r;if(x==null){x=false}if(!t){return}B=t.split("\n");if(B.length<2){return}B.splice(B.length-1);v=function(E,D,C){if(!C){E.load(function(){return typeof f==="function"?f(E[0]):void 0});E.error(function(){return E.attr("src",E.data("fail-src")||Sprite.SPACER)})}E.attr("src",D);E.data("loading-src",null);if(C){return typeof f==="function"?f(E[0]):void 0}};for(y=s=0,p=B.length;s<p;y=++s){A=B[y];z=A.indexOf(":");if(z===-1){continue}u=A.substring(0,z).split("-");w=parseInt(u[0],10);A=A.substring(z+1);d=k[w];if(!d.length||!d.data("loading-src")){continue}if(A.indexOf("data:image")!==0){v(d,d.data("loading-src"),false);continue}v(d,A,true);if(typeof m==="function"){m(y,k.length)}}if(x){r=[];for(q=0,o=e.length;q<o;q++){d=e[q];if(d.data("loading-src")){r.push(v(d,d.data("loading-src"),false))}else{r.push(void 0)}}return r}};this.num_pending_batch_requests++;$j.ajax({url:n,type:b,data:{image_urls:Util.to_json(g),parallel:true},dataType:"text",xhrFields:{withCredentials:true},progress:j,error:$j.ajax.retryOnce,success:function(o){return j(o,true)},complete:function(){i.num_pending_batch_requests--}});return this._do_batch_load(f,m)}};var NotificationUIButton,UserNotifier,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1},__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};UserNotifier={THUMBS_BATCH_SIZE:16,USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,FEED_ROW_HEIGHT:49,MAX_NUM_ROWS:100,NUM_ROWS_TO_INITIALIZE:5,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_acked:{},_num_event_rows:0,_client_feed_list:[],_server_feed_list:[],_unread_count:0,_sticky_index:-1,_thumb_cache:{},_has_more:false,file:{},_shown:{},_has_acked:false,_full_sticky_list:[],_last_sticky_dict:{},_animation_dict:{},_feed_dict:{},init:function(){var a,b=this;this.NUM_ROWS_TO_INITIALIZE=10;this._num_event_rows=this.NUM_ROWS_TO_INITIALIZE;this.refresh_feed();$j("#event-feed-container").scroll(function(){if(UserNotifier._has_more){if(UserNotifier._scroller_within_offset_to_bottom(UserNotifier.SCROLLING_OFFSET)){return UserNotifier._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));$j("#event-feed").on("click",this._mouseclick.bind(this));return a=Notclient.subscribe_user({name:"NotificationFeedUpdater",handler:function(){return b.refresh_feed(a)}})},_mouseclick:function(c){var g,j,d,i,f,a,h,b=this;d=$j(c.target);if(d.is("a")){if(d.hasClass("option")){c.preventDefault();j=d.attr("data-mount");i=parseInt(d.attr("data-nsid",10));return Sharing.get_sharing_options(j)}else{if(d.hasClass("view")){c.preventDefault();h=d.attr("data-mount");return window.open(h)}else{if(d.hasClass("open-file-preview")){c.preventDefault();f=d.attr("data-key");g=d.attr("data-target");if(f&&g){a="/pfp/"+f+"/"+(Util.urlquote(Util.filename(g)));return new Ajax.DBRequest(a,{onSuccess:function(e){var k;k=Util.from_json(e.responseText);b.file=k;return FileViewer.show(b.file,false)},onFailure:function(e){h=d.attr("data-mount");return window.open(h)}})}}}}}},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this._ack();return this._has_acked=true}},_append_event_rows:function(k){var o,q,b,m,g,i,l,h,f,n,a,d,c,p,e,j=this;if(k==null){k=false}this._has_acked=false;if(k){$j("#event-feed").empty();for(m in this._shown){delete this._shown[m]}if(this._num_event_rows===this._client_feed_list.length-1&&this._num_event_rows<this.NUM_ROWS_TO_INITIALIZE){this._num_event_rows=this._client_feed_list.length}}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND}this._num_event_rows=Math.min(this._num_event_rows,this._client_feed_list.length);n=$j(".feed-row").size();o=[];e=this._client_feed_list;for(l=c=0,p=e.length;c<p;l=++c){f=e[l];if(n>=this._num_event_rows){break}m=this._identifier(f);if(m in this._shown){continue}this._shown[m]=true;d=f.status;b=$j(f.notification_div);$j("#event-feed").append(b);n++;i=b.find("img");g=i.get(0);if(g){q=$j(g).attr("data-src");if(q){if(q in this._thumb_cache&&!(this._thumb_cache[q]===m)){h=this._thumb_cache[q];$j(g).attr("src",h);if(!h.endsWith(Sprite.SPACER)){this._add_thumbnail_frame($j(g))}}else{this._thumb_cache[m]=q;o.push($(g))}}}if(!b.hasClass("feed-row")){b=b.find(".feed-row")}if(d===this.USER_NOTIFICATION_STATUS_INVISIBLE){b.addClass("invisible");if(m in this._acked){delete this._acked[m]}}else{if(d===this.USER_NOTIFICATION_STATUS_READ){if(!(m in this._acked)){b.addClass("read")}}}if(l===(this._full_sticky_list.length-1)){b.addClass("sticky-bound")}if(m in this._animation_dict){b.addClass("animate")}}a=function(t){var r,s;if(!t.src.endsWith(Sprite.SPACER)){j._add_thumbnail_frame($j(t));m=$j(t).closest(".feed-row").data("identifier");s=j._thumb_cache[m];r=$j(t).attr("src");delete j._thumb_cache[m];return j._thumb_cache[s]=r}};BatchThumbLoader.batch_load_thumbs(o,this.THUMBS_BATCH_SIZE,a);this._has_more=this._num_event_rows<this._client_feed_list.length;if($j(".feed-row").length===0){return $j("#event-feed-container").addClass("empty")}else{return $j("#event-feed-container").removeClass("empty")}},_add_thumbnail_frame:function(a){$j(a).addClass("thumbnail");return $j(a).parent(".feed-thumbnail").addClass("has-frame")},_identifier:function(a){return""+a.type_id+" "+a.target_object_key},_ack:function(){var a=this;this.update_jewel_ui(0);return new Ajax.DBRequest("/web/notifications/user/ack_all",{onSuccess:function(e){var d,g,h,f,c,b;h=Util.from_json(e.responseText);b=[];for(f=0,c=h.length;f<c;f++){g=h[f];d=a._identifier(g);b.push(a._acked[d]=true)}return b}})},render_feed:function(){var d,m,n,r,a,s,q,p,i,g,e,b,t,x,w,u,o,l,j,h,f,c;d=[];s={};o=this._full_sticky_list;for(n=i=0,t=o.length;i<t;n=++i){m=o[n];if(!(m in this._feed_dict)){this._full_sticky_list.remove(n)}}if(this._server_feed_list&&this._sticky_index>=0){l=this._server_feed_list.slice(0,this._sticky_index+1||9000000000);for(g=0,x=l.length;g<x;g++){a=l[g];m=this._identifier(a);s[m]=true;if(__indexOf.call(this._full_sticky_list,m)<0){d.push(m)}}[].splice.apply(this._full_sticky_list,[0,0].concat(d)),d}this._animation_dict={};j=this._last_sticky_dict;for(r in j){p=j[r];if(!(__indexOf.call(d,r)>=0)){this._animation_dict[r]=true}}this._last_sticky_dict=s;this._client_feed_list=[];h=this._full_sticky_list;for(e=0,w=h.length;e<w;e++){q=h[e];this._client_feed_list.push(this._feed_dict[q])}f=this._server_feed_list;for(b=0,u=f.length;b<u;b++){a=f[b];if(c=this._identifier(a),__indexOf.call(this._full_sticky_list,c)<0){this._client_feed_list.push(a)}}return this._append_event_rows(true)},refresh_feed:function(a){var b=this;this._is_retrieving_feed=true;return new $j.ajax("/web/notifications/user/retrieve",{data:{count:this.MAX_NUM_ROWS},dataType:"json",type:"POST",success:function(d){var g,f,c,e;b._unread_count=d.jewel_count;b._sticky_index=d.sticky_index;b.update_jewel_ui(b._unread_count);b._server_feed_list=d.notifications;b._feed_dict={};e=b._server_feed_list;for(f=0,c=e.length;f<c;f++){g=e[f];b._feed_dict[b._identifier(g)]=g}b.render_feed();if(a!=null){Notclient.handler_success(a,{nid:d.latest_nid})}if(Sharing){return Sharing.refresh_inbox_count()}},error:function(){if(a!=null){return Notclient.handler_failure(a)}},complete:function(){return b._is_retrieving_feed=false}})},update_jewel_ui:function(a){$j("#new-notification-count").text(a).toggleClass("show",a>0);if(a>0){$j(".notifications-bell").addClass("shake")}return setTimeout((function(){return $j(".notifications-bell").removeClass("shake")}),500)},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._full_sticky_list=[];this._acked={};return this.render_feed()},preventDefault:function(a){if(typeof a.preventDefault==="function"){a.preventDefault()}return a.returnValue=false},_scroller_within_offset_to_bottom:function(b){var a;a=$("event-feed-container");return a.scrollTop+a.offsetHeight+b>=a.scrollHeight},scrolling:function(a){var b;if(a.originalEvent){a=a.originalEvent}b=a.detail?a.detail*(-40):a.wheelDelta;if(!this._has_more&&b<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(a)}else{if(b>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(a)}}}};NotificationUIButton=(function(b){__extends(a,b);a.prototype.selector=function(){return".notification-button"};function a(){this.clear=__bind(this.clear,this);this.active=__bind(this.active,this);this._clear_sticky_notification_on_popover_close=__bind(this._clear_sticky_notification_on_popover_close,this);a.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}a.prototype._clear_sticky_notification_on_popover_close=function(){if(!$j(this.selector())[0].hasClassName("active")){return UserNotifier.clear_cached_client_states()}};a.prototype.active=function(c,f){var d;d=c.target.hasClassName("feed-row")?c.target:$(c.target).up(".feed-row");if(d){if(!d.hasClassName("clickable")){return}}a.__super__.active.call(this,c,f);return this._clear_sticky_notification_on_popover_close()};a.prototype.clear=function(c){a.__super__.clear.call(this,c);return this._clear_sticky_notification_on_popover_close()};return a})(UIButton);var InstallBar,TopNotificationBar,UnsupportedBrowser;TopNotificationBar={SHOW_EVENT:"db:topnotificationbar:show",HIDE_EVENT:"db:topnotificationbar:hide",show:function(){var b,a;b=$j("#top-notification-bar-container");a=b.find(".top-notification-bar").attr("data-style-class");b.addClass(a).show();$j("#outer-frame").addClass("top-notification-bar");$j("#notify-wrapper").addClass("has-top-notification-bar");return $j(document).trigger(this.SHOW_EVENT)},hide:function(){$j("#top-notification-bar-container").hide();$j("#outer-frame").removeClass("top-notification-bar");$j("#notify-wrapper").removeClass("has-top-notification-bar");return $j(document).trigger(this.HIDE_EVENT)}};InstallBar={init:function(a){$j("#install-bar-dismiss-link").on("click",function(b){b.preventDefault();TopNotificationBar.hide();return GrowthWebActivityLogger.log("install-bar-dismiss")});$j("#install-bar-button").on("click",function(b){b.stopPropagation();return GrowthWebActivityLogger.log("install-bar-button-click")});return $j("#install-bar #over-content.clickable").on("click",function(b){b.preventDefault();GrowthWebActivityLogger.log("install-bar-click");return window.location.href=a})}};UnsupportedBrowser={init:function(){return $j("#unsupported-browser-dismiss").on("click",function(a){a.preventDefault();TopNotificationBar.hide();return new Ajax.DBRequest("/dismiss_browser_msg")})}};var GroupsAjax;GroupsAjax={ajax:function(a){var b,c,d,e;b=a.button!=null?$j(a.button):null;if(b!=null){Forms.add_loading(b[0]);b.hide()}if(!(a.type!=null)){a.type="post"}e=a.success;d=a.error;a.success=function(k,l,j){var f,i,h;f=function(m){Notify.server_error(m);if(d!=null){return d(j,l,m)}};if(typeof k==="string"){if(k.toLowerCase().startsWith("err:")){return f(k.slice(4))}}try{h=k.evalJSON()}catch(g){return f(_("An unexpected error occurred"))}if((h.status!=null)&&h.status.toLowerCase()==="ok"){if(h.message!=null){Notify.server_success(h.message)}if(a.modal!=null){a.modal.hide()}if(e!=null){return e(h,l,j)}}else{i=h.message!=null?h.message:_("An unexpected error occurred");return f(i)}};a.error=function(f,h,g){Notify.server_error(_("An unexpected error occurred"));if(d!=null){return d(f,h,g)}};c=a.complete;a.complete=function(f,g){if(b!=null){b.show();Forms.remove_loading()}if(c!=null){return c(f,g)}};return $j.ajax(a)},handle_form_response:function(a){var c;try{c=a.responseText.evalJSON()}catch(b){return Notify.server_error("An unexpected error occurred")}if(!(c.status!=null)){return Notify.server_error("An unexpected error occurred")}if(c.status.toLowerCase()==="ok"){if(c.message!=null){return Notify.server_success(c.message)}}else{if(c.message!=null){return Notify.server_error(c.message)}}}};var CollabInput;CollabInput={reset:function(b){var a;if($j("#"+b+"-new-collab-input").length===0){return false}SuggestionInput.reset(b+"-new-collab-input");this.tokenizers={};if(this.tokenizers[b]!=null){this.tokenizers[b].clearTokens()}else{this.tokenizers[b]=Sharing.create_teams_tokenizer(b,true);a=this;(function(e,c){var f,d;f=$(e+"-new-collab-input");d=$j("#"+e+"-new-collab-input").closest("#tokenized_autocompleter_container").siblings(".external-invite-message");d.hide();f.observe("token:add",function(g){return c._update_contacts(g,e)});f.observe("token:remove",function(g){return c._update_contacts(g,e)});return f.observe("sf:token:external",function(h){var g;g=h.memo.count;if(g===0){return d.hide()}else{return d.show()}})})(b,a)}this.removed_emails={};this.removed_emails[b]={};return true},_update_contacts:function(b,d){var c,a,f,e=this;a=b.memo.value.toString();if(b.eventName==="token:add"){if(a in this.removed_emails[d]){this.removed_emails[d][a]+=1}else{this.removed_emails[d][a]=1}}else{if(b.eventName==="token:remove"){if(a in this.removed_emails[d]){this.removed_emails[d][a]-=1}}else{return}}c=Sharing.contacts.filter(function(g){return !(e.removed_emails[d][g.email.toString()]>0)});f=Sharing.lcontacts.filter(function(g){return !(e.removed_emails[d][g.email.toString()]>0)});return this.tokenizers[d].updateContacts(c,f)}};var AddFoldersModal,AdminSettingsModal,GroupFoldersModal,GroupMembersModal,GroupSettingsModal,GroupsModals,NewGroupModal,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c();d.__super__=b.prototype;return d};GroupsModals={show_new_group_modal:function(b){var a;if(b==null){b=false}a=new NewGroupModal({element_id:"new-group-modal",parameters:{admin_page:b}});return a.show()},show_view_group_members_modal:function(b,d,c){var a;if(c==null){c=false}a=new GroupMembersModal({element_id:"group-members-modal",title:d,endpoint_url:"/groups/get_members",parameters:{group_id:b,group_name:d,admin_page:c,manage:false}});return a.show()},show_manage_group_members_modal:function(b,d,c){var a;if(c==null){c=false}a=new GroupMembersModal({element_id:"group-members-modal",title:d,endpoint_url:"/groups/get_members",parameters:{group_id:b,group_name:d,admin_page:c,manage:true}});return a.show()},show_manage_folders_modal:function(b,d,c){var a;if(c==null){c=false}a=new GroupFoldersModal({element_id:"manage-folders-modal",title:d,endpoint_url:"/groups/manage_folders",parameters:{group_id:b,admin_page:c,group_name:d}});return a.show()},show_group_settings_modal:function(a,d,c){var b;if(c==null){c=false}b=new GroupSettingsModal({element_id:"group-settings-modal",title:d,endpoint_url:"/groups/group_settings",parameters:{group_id:a,admin_page:c}});return b.show()},show_admin_settings:function(){if(!(this.settings_modal!=null)){this.settings_modal=new AdminSettingsModal({element_id:"admin-settings-modal"})}return this.settings_modal.show()}};NewGroupModal=(function(b){__extends(a,b);function a(){this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_show=function(){CollabInput.reset("new-group-form");return SickInput.init()};a.prototype.on_confirm_button_click=function(f){var c,d;f.preventDefault();d=$j("#new-group-form")[0];c=$j("#new-group-form .confirm-button")[0];return Forms.ajax_submit(d,false,this.success_callback,false,c)};a.prototype.success_callback=function(d){var f,e,c;GroupsAjax.handle_form_response(d);c=d.responseText.evalJSON();if(this.options.parameters.admin_page){e=function(){return window.location.reload(true)}}else{e=function(){return Groups.show_new_group(c.group_info)}}this.hide();f=new AddFoldersModal({element_id:"add-folders-modal",on_hide_callback:e,parameters:{group_id:c.group_info.group_id}});return f.show()};return a})(DBModal);GroupMembersModal=(function(a){__extends(b,a);function b(){this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_load=function(){var e,d,c=this;e=this.options.parameters.admin_page;d=this.options.parameters.group_name;assert(e!=null,"GroupMembersModal missing admin_page");assert(d!=null,"GroupMembersModal missing group_name");CollabInput.reset("group_members_modal");SickInput.init();BrowseStyleRows.register_all();$j("#group-members-modal").on("click",".leave-group-button",function(g){var f;g.preventDefault();f=$j(g.target).attr("data-group-id");return GroupsAjax.ajax({url:"/groups/leave",button:"#group-members-modal .leave-group-button",data:{group_id:f},success:function(h){if(e){return window.location.reload(true)}else{c.hide();return Groups.update_group(h.group_info)}}})});$j(".remove_manager_link").click(function(h){var g,f;f=$j(h.target).closest(".bs-row").attr("data-user-id");g=$j(h.target).closest(".list-container").attr("data-group-id");Dropdown.close_all();GroupsAjax.ajax({url:"/groups/remove_manager",button:$j(h.target).closest(".dropdown_container").find(".dropdown_button"),data:{group_id:g,user_id:f},success:function(i){if(e){return window.location.reload(true)}else{c.hide();return GroupsModals.show_manage_group_members_modal(g,d,e)}}});return false});$j(".make_manager_link").click(function(h){var g,f;f=$j(h.target).closest(".bs-row").attr("data-user-id");g=$j(h.target).closest(".list-container").attr("data-group-id");Dropdown.close_all();GroupsAjax.ajax({url:"/groups/make_manager",button:$j(h.target).closest(".dropdown_container").find(".dropdown_button"),data:{group_id:g,user_id:f},success:function(i){if(e){return window.location.reload(true)}else{c.hide();return GroupsModals.show_manage_group_members_modal(g,d,e)}}});return false});$j(".accept_member_link").click(function(h){var g,f;f=$j(h.target).closest(".bs-row").attr("data-user-email");g=$j(h.target).closest(".list-container").attr("data-group-id");Dropdown.close_all();GroupsAjax.ajax({url:"/groups/join",button:$j(h.target).closest(".dropdown_container").find(".dropdown_button"),data:{group_id:g,emails:f},success:function(i){if(e){return window.location.reload(true)}else{c.hide();return GroupsModals.show_manage_group_members_modal(g,d,e)}}});return false});$j(".reject_member_link").click(function(h){var g,f;f=$j(h.target).closest(".bs-row").attr("data-user-id");g=$j(h.target).closest(".list-container").attr("data-group-id");Dropdown.close_all();GroupsAjax.ajax({url:"/groups/leave",button:$j(h.target).closest(".dropdown_container").find(".dropdown_button"),data:{group_id:g,user_id:f},success:function(i){if(e){return window.location.reload(true)}else{c.hide();return GroupsModals.show_manage_group_members_modal(g,d,e)}}});return false});return $j(".remove_member_link").click(function(h){var g,f;f=$j(h.target).closest(".bs-row").attr("data-user-id");g=$j(h.target).closest(".list-container").attr("data-group-id");Dropdown.close_all();GroupsAjax.ajax({url:"/groups/leave",button:$j(h.target).closest(".dropdown_container").find(".dropdown_button"),data:{group_id:g,user_id:f},success:function(i){if(e){return window.location.reload(true)}else{c.hide();return GroupsModals.show_manage_group_members_modal(g,d,e)}}});return false})};b.prototype.on_confirm_button_click=function(i){var h,c,d,g,f,j=this;i.preventDefault();c=$j(i.target).closest("div.group-access");h=c.attr("data-action");if(h==="join"){f=c.attr("data-group-id");GroupsAjax.ajax({url:"/groups/join",button:i.target,data:{group_id:f},success:function(e){var k;k=j.options.parameters.admin_page;assert(k!=null,"GroupMembersModal missing admin_page");if(k){return window.location.reload(true)}else{j.hide();return Groups.update_group(e.group_info)}}})}if(h==="add_members"){Forms.add_loading($j("#group-members-modal .confirm-button")[0]);g=$j("#add-members-form")[0];d=$j("#add-members-form .confirm-button")[0];Forms.ajax_submit(g,false,this.success_callback,false,d)}if(h==="close"){return this.hide()}};b.prototype.success_callback=function(d){var e,c;GroupsAjax.handle_form_response(d);e=this.options.parameters.admin_page;assert(e!=null,"GroupMembersModal missing admin_page");c=d.responseText.evalJSON();if(e){return window.location.reload(true)}else{this.hide();return Groups.update_group(c.group_info)}};return b})(DBModalLoading);GroupFoldersModal=(function(a){__extends(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype.on_load=function(){var f,c,e,d=this;c=this.options.parameters.group_id;e=this.options.parameters.group_name;f=this.options.parameters.admin_page;assert(c!=null,"GroupFoldersModal missing group_id");assert(e!=null,"GroupFoldersModal missing group_name");assert(f!=null,"GroupFoldersModal missing admin_page");BrowseStyleRows.register_all();$j(".remove_folder_link").click(function(g){var h;h=$j(g.target).closest(".bs-row").find(".folder-title").text();Dropdown.close_all();GroupsAjax.ajax({url:"/share_ajax/kick_group",button:$j(g.target).closest(".dropdown_container").find(".dropdown_button"),data:{group_id:c,ns_id:$j(g.target).attr("data-ns-id")},success:function(i){if(f){return window.location.reload(true)}else{d.hide();return GroupsModals.show_manage_folders_modal(c,e,f)}}});return false});return $j(".add-more-folders-container").click(function(g){var h;d.hide();h=new AddFoldersModal({element_id:"add-folders-modal",on_hide_callback:function(){return GroupsModals.show_manage_folders_modal(c,e,f)},parameters:{group_id:c}});h.show();return false})};return b})(DBModalLoading);AddFoldersModal=(function(a){__extends(b,a);function b(){this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);this.update_folder_list=__bind(this.update_folder_list,this);this.deselect_folder=__bind(this.deselect_folder,this);this.select_folder=__bind(this.select_folder,this);this.multiselect_shareable_folders=__bind(this.multiselect_shareable_folders,this);return b.__super__.constructor.apply(this,arguments)}b.prototype.on_show=function(){var c,d=this;TreeView.init(this.multiselect_shareable_folders,c=false,"add-folders-treeview");TreeView.set_params({can_expand_shared_folders:false});TreeView.reset();this.selected_paths={};return $j("#selected-folders").on("click",".remove-link",function(g){var f;f=$j(g.target).attr("data-path");return d.deselect_folder(f)})};b.prototype.on_hide=function(){if(this.options.on_hide_callback!=null){return this.options.on_hide_callback()}};b.prototype.multiselect_shareable_folders=function(e,d){var c;c=$j(d).closest("div");if(c.hasClass("highlight")){return this.deselect_folder(e)}else{return this.select_folder(e,d,c)}};b.prototype.select_folder=function(e,d,c){if(e==="/"){return}c.addClass("highlight");this.selected_paths[e]=d;return this.update_folder_list()};b.prototype.deselect_folder=function(e){var c,d;d=this.selected_paths[e];c=$j(d).closest("div");c.removeClass("highlight");delete this.selected_paths[e];return this.update_folder_list()};b.prototype.update_folder_list=function(){var e,d,g,i,h,f,c;g=$j("#selected-folders");g.html("");f=this.selected_paths;c=[];for(h in f){i=f[h];e=$j("<li />",{html:$j(i).html()});d=$j("<a />",{text:"(remove)","class":"remove-link","data-path":h});e.append(d);c.push(g.prepend(e))}return c};b.prototype.on_confirm_button_click=function(h){var c,f,d,g,j,i;f=$j("#add-folders-form")[0];c=$j("#add-folders-form .confirm-button")[0];d=this.options.parameters.group_id;assert(d!=null,"AddFoldersModal missing group_id");i=[];for(g in this.selected_paths){i.push(g)}j={paths:i,group_id:d};Forms.clear_errors(f);return Forms.ajax_submit(f,"/groups/add_folders",this.success_callback,false,c,j)};b.prototype.success_callback=function(c){GroupsAjax.handle_form_response(c);return this.hide()};return b})(DBModal);GroupSettingsModal=(function(b){__extends(a,b);function a(){this.success_callback=__bind(this.success_callback,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_load=function(){var c=this;SickInput.init();return $j(".delete-group-button").click(function(f){var g,d;d=c.options.parameters.group_id;g=c.options.parameters.admin_page;GroupsAjax.ajax({button:f.target,url:"/groups/delete",data:{group_id:d},success:function(e){if(g){return window.location.reload(true)}else{c.hide();return Groups.delete_group(e.group_id)}}});return false})};a.prototype.success_callback=function(d){var e,c;GroupsAjax.handle_form_response(d);e=this.options.parameters.admin_page;assert(e!=null,"GroupSettingsModal missing admin_page");c=d.responseText.evalJSON();if(e){return window.location.reload(true)}else{this.hide();return Groups.update_group(c.group_info)}};a.prototype.on_confirm_button_click=function(f){var c,d;d=$j("#group-settings-form")[0];c=$j("#group-settings-form .confirm-button")[0];return Forms.ajax_submit(d,false,this.success_callback,false,c)};return a})(DBModalLoading);AdminSettingsModal=(function(b){__extends(a,b);function a(){this.success_callback=__bind(this.success_callback,this);this.on_confirm_button_click=__bind(this.on_confirm_button_click,this);return a.__super__.constructor.apply(this,arguments)}a.prototype.on_confirm_button_click=function(f){var c,d;f.preventDefault();d=$j("#admin-settings-form")[0];c=$j("#admin-settings-form .confirm-button")[0];return Forms.ajax_submit(d,false,this.success_callback,false,c)};a.prototype.success_callback=function(c){GroupsAjax.handle_form_response(c);return this.hide()};return a})(DBModal);var Groups;Groups={GROUPS_VIEWS:{ALL:"all",MINE:"mine"},init:function(d){var c,b,a,e=this;d.each(function(f){return e.decode_sort_key(f)});this._state={groups_info:d,view:this.GROUPS_VIEWS.ALL};this.listen();b=$j("#groups_list_item_tmpl");a=b.text();c=a.replace(/INSERT_GROUP_ID_HERE/g,"<%= group.group_id %>");c=c.replace(/INSERT_GROUP_NAME_HERE/g,"<%= group.name %>");c=c.replace(/INSERT_GROUP_NAME_URI_HERE/g,"<%= Groups.get_group_name_uri(group) %>");b.text(c);this._tmpl=HTML.tmpl("groups_list_item_tmpl");return this._render()},get_group_name_uri:function(a){return encodeURIComponent(a.name.replace(/\s+/g,"-"))},decode_sort_key:function(a){assert((a.encoded_sort_key!=null)&&!(a.sort_key!=null),"expected encoded sort keys on each elm");a.sort_key=Util.decode_sort_key(a.encoded_sort_key);delete a.encoded_sort_key;return a},_render:function(){var a,c,b;b=this._get_current_groups_list();b.sort(this._name_cmp);a=(function(){var f,e,d;d=[];for(f=0,e=b.length;f<e;f++){c=b[f];d.push(this._tmpl({group:c}))}return d}).call(this);$("groups-list").__date(a);return this._empty_check()},_empty_check:function(){if(this._get_current_groups_list().length){return $j("#groups-container").removeClass("empty-list")}else{return $j("#groups-container").addClass("empty-list")}},_get_current_groups_list:function(){switch(this._state.view){case this.GROUPS_VIEWS.ALL:return this._state.groups_info;case this.GROUPS_VIEWS.MINE:return this._state.groups_info.filter(function(a){return a.am_member});default:return assert(false,"invalid state")}},listen:function(){var a=this;$j("#groups-list").on("click",".group-name-link",function(d){var b,c,f;b=$j(d.target).closest(".group-row");c=b.attr("data-group-id");f=b.attr("data-group-name");if($j(d.target).hasClass("view-group-members-link")){GroupsModals.show_view_group_members_modal(c,f,false);return false}});$j(document).on("change",".blue-radio input[type=radio]",function(b){return $j(b.target).closest(".blue-radio").parent().find("input[type=radio]").each(function(c,d){return $j(d).closest(".blue-radio").toggleClass("selected",$j(d).is(":checked"))})});$j("#groups-list").on("click",".manage_members_link",function(d){var b,c,f;b=$j(d.target).closest(".group-row");c=b.attr("data-group-id");f=b.attr("data-group-name");GroupsModals.show_manage_group_members_modal(c,f,false);Dropdown.close_all();return false});$j("#groups-list").on("click",".manage_folders_link",function(d){var b,c,f;b=$j(d.target).closest(".group-row");c=b.attr("data-group-id");f=b.attr("data-group-name");GroupsModals.show_manage_folders_modal(c,f,false);Dropdown.close_all();return false});$j("#groups-list").on("click",".group_settings_link",function(d){var b,c,f;b=$j(d.target).closest(".group-row");c=b.attr("data-group-id");f=b.attr("data-group-name");GroupsModals.show_group_settings_modal(c,f,false);Dropdown.close_all();return false});$j(".filter-option").on("click",function(c){var d,b;c.preventDefault();d=$j(c.target);b=d.attr("data-filter");$j(".current-filter").text(d.text());return a._filter(b)});$j(".create-group").on("click",function(b){b.preventDefault();return GroupsModals.show_new_group_modal(false)});$j("#groups-list").on("click",".group-member-action",function(c){var b,f,d;c.preventDefault();d=$j(c.target).closest("li.group-row");b=d.attr("data-group-id");f=d.attr("data-group-name");return GroupsModals.show_view_group_members_modal(b,f,false)});return $j("#groups-list").on("click",".group-nonmember-action",function(c){var b,d;c.preventDefault();d=$j(c.target).closest("li.group-row");b=d.attr("data-group-id");return GroupsAjax.ajax({url:"/groups/join",button:c.target,data:{group_id:b},success:function(e){return a.update_group(e.group_info)}})})},show_new_group:function(b){var a;a=this.decode_sort_key(b);this._state.groups_info.push(a);this._render();return this._highlight_group(a.group_id)},update_group:function(d){var c,g,b,f,a,e;c=this.decode_sort_key(d);e=this._state.groups_info;for(b=f=0,a=e.length;f<a;b=++f){g=e[b];if(g.group_id===c.group_id){this._state.groups_info[b]=c;break}}this._render();return this._highlight_group(c.group_id)},delete_group:function(a){var b;this._state.groups_info=(function(){var f,d,e,c;e=this._state.groups_info;c=[];for(f=0,d=e.length;f<d;f++){b=e[f];if(b.group_id!==a){c.push(b)}}return c}).call(this);return this._render()},_highlight_group:function(a){var b,d,c;c=$j("li[data-group-id='%(gid)s']".format({gid:a}));b=c.css("backgroundColor");d=c.css("borderColor");c.animate({backgroundColor:d},500).animate({backgroundColor:b},500);return $j("html, body").animate({scrollTop:c.offset().top},{queue:false,duration:500})},_filter:function(a){if(this._state.view===a){return}this._state.view=a;return this._render()},_name_cmp:function(a,b){return Util.sort_by_rank_or_key(a,b)},group_members_snippet:function(d,a,e){var c,b,f;if(d.length+a===0){return _("This group has no members")}b=Util.list_em_snippet(d,e);c=a+b.snipped;f=b.str;if(c===0){return f}if(f===""){return ungettext("This group has %(missed)s member","This group has %(missed)s members",c).format({missed:c})}else{return f+ungettext(" and %(missed)s other"," and %(missed)s others",c).format({missed:c})}}};var GroupFolders;GroupFolders={init:function(a){var b=this;$j(".sync-button").click(function(c){return GroupsAjax.ajax({url:"/groups/sync",button:c.target,data:{group_id:a,ns_id:$j(c.target).closest(".team_admin_table_row").find(".folder-metadata").attr("data-ns-id")},success:function(){return window.location.reload(true)}})});return $j(".unsync-button").click(function(c){return GroupsAjax.ajax({url:"/groups/unsync",button:c.target,data:{group_id:a,ns_id:$j(c.target).closest(".team_admin_table_row").find(".folder-metadata").attr("data-ns-id")},success:function(){return window.location.reload(true)}})})}};var Dropdown;Dropdown={init:function(){var a=this;return $j(document).click(function(c){var b;b=$j(c.target);a.close_all();if(b.closest(".dropdown_container .dropdown_button").length>0){b.closest(".dropdown_container").find(".dropdown_options").show();return false}})},close_all:function(){return $j(".dropdown_container .dropdown_options").hide()}};var GroupsAdmin;GroupsAdmin={init:function(a){this.groups_info=a;return this.listen()},listen:function(){var a=this;$j(document).on("change",".blue-radio input[type=radio]",function(b){return $j(b.target).closest(".blue-radio").parent().find("input[type=radio]").each(function(c,d){return $j(d).closest(".blue-radio").toggleClass("selected",$j(d).is(":checked"))})});$j(".team_admin_groups_table").on("click",".manage_members_link",function(d){var b,c,f;b=$j(d.target).closest(".team_admin_table_row").find(".group-metadata");c=b.attr("data-group-id");f=b.attr("data-group-name");GroupsModals.show_manage_group_members_modal(c,f,true);Dropdown.close_all();return false});$j(".team_admin_groups_table").on("click",".manage_folders_link",function(d){var b,c,f;b=$j(d.target).closest(".team_admin_table_row").find(".group-metadata");c=b.attr("data-group-id");f=b.attr("data-group-name");GroupsModals.show_manage_folders_modal(c,f,true);Dropdown.close_all();return false});$j(".team_admin_groups_table").on("click",".group_settings_link",function(d){var b,c,f;b=$j(d.target).closest(".team_admin_table_row").find(".group-metadata");c=b.attr("data-group-id");f=b.attr("data-group-name");GroupsModals.show_group_settings_modal(c,f,true);Dropdown.close_all();return false});$j(".create-group").on("click",function(b){b.preventDefault();return GroupsModals.show_new_group_modal(true)});return $j(".general-settings").on("click",function(b){b.preventDefault();return GroupsModals.show_admin_settings()})}};var handler,listener,_i,_j,_len,_len1,_ref,_ref1;Util.smart_window_load(function(){var b,a;b=$("footer");if(b){a=(b.getStyle("display")==="none")||(b.getWidth()<900);if(!a){return assert(false,"HTML Broken on "+window.location.pathname)}}});if(!Constants.is_test){Util.smartLoad(Timezone.check_timezone)}if(window._document_observe_listeners){_ref=window._document_observe_listeners;for(_i=0,_len=_ref.length;_i<_len;_i++){listener=_ref[_i];if(document.loaded){listener.func()}else{document.observe(listener.event,listener.func)}}}if(window._jquery_ready_handlers){_ref1=window._jquery_ready_handlers;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){handler=_ref1[_j];$j(handler)}}Util.smartLoad(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});window.LoadedJsSuccessfully=true;